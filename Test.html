<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scalpel Master Pro V6.2</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <style>
        :root { --bg: #0e1621; --card: #17212b; --text: #ffffff; --border: #2b5278; --accent: #5288c1; --input-bg: #0e1621; }
        html, body { height: 100%; margin: 0; padding: 0; background: var(--bg); color: var(--text); }
        
        body { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            padding: 15px; 
            box-sizing: border-box; 
            overflow-y: auto; 
            min-height: 100vh;
        }
        
        .container { width: 100%; max-width: 420px; display: flex; flex-direction: column; align-items: center; text-align: center; }
        
        .header-ui { width: 100%; display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .user-badge { background: rgba(82, 136, 193, 0.2); border: 1px solid var(--accent); padding: 8px 12px; border-radius: 15px; font-size: 11px; color: var(--accent); font-weight: bold; text-align: right; line-height: 1.3; }
        .user-badge span { display: block; }
        .user-id-tag { opacity: 0.7; font-size: 9px; font-family: monospace; }

        .logo { width: 85px; height: 85px; border-radius: 50%; border: 4px solid var(--accent); margin-bottom: 10px; box-shadow: 0 0 15px rgba(82,136,193,0.3); }
        h1 { color: var(--accent); font-size: 22px; margin: 5px 0; font-weight: bold; text-transform: uppercase; }
        
        .exam-dashboard { background: rgba(82, 136, 193, 0.15); border: 1px solid var(--accent); padding: 12px; border-radius: 15px; width: 100%; margin-bottom: 15px; box-sizing: border-box; }
        .exam-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .exam-item { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 10px; border: 1px solid rgba(82, 136, 193, 0.3); transition: all 0.3s ease; }
        
        /* New Style for Locked Target Exams */
        .exam-item.target-locked { border: 1px solid #2ecc71; background: rgba(46, 204, 113, 0.2); box-shadow: 0 0 10px rgba(46, 204, 113, 0.3); transform: scale(1.02); }

        .exam-days { font-size: 16px; font-weight: bold; color: var(--accent); display: block; }
        .exam-item.target-locked .exam-days { color: #2ecc71; } /* Green text for locked */
        
        .exam-label { font-size: 8px; text-transform: uppercase; opacity: 0.9; letter-spacing: 0.5px; margin-top: 2px; display: block; }

        .streak-section { margin-bottom: 10px; }
        .streak-text { font-size: 18px; font-weight: bold; color: #f39c12; }
        .quote { font-family: 'Oswald', sans-serif; color: #ef5350; font-weight: 700; font-size: 11px; text-transform: uppercase; margin: 10px 0; line-height: 1.2; }

        .nav-tabs { display: flex; width: 100%; background: var(--card); border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); overflow: hidden; }
        .tab-btn { flex: 1; padding: 12px 5px; font-size: 10px; font-weight: bold; cursor: pointer; border: none; background: none; color: white; opacity: 0.5; }
        .tab-btn.active { opacity: 1; background: var(--accent); }
        .tab-content { width: 100%; display: none; }
        .tab-content.active { display: block; }

        .card { background: var(--card); padding: 12px; border-radius: 20px; border: 1px solid var(--border); width: 100%; box-sizing: border-box; margin-bottom: 15px; position: relative; }
        .setting-label { font-size: 9px; color: #888; text-transform: uppercase; margin: 6px 0 2px 0; display: block; font-weight: bold; text-align: left; }
        .sub-label { font-size: 8px; color: #5288c1; text-transform: uppercase; margin-top: 2px; font-weight: bold; }
        
        input, select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); text-align: center; font-size: 13px; box-sizing: border-box; }
        input[type="date"] { color-scheme: dark; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); }

        #timer-display { font-size: 52px; font-weight: bold; margin: 5px 0; font-variant-numeric: tabular-nums; }
        .btn { background: #2481cc; color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; font-size: 14px; }
        .sm-btn { padding: 6px 12px; font-size: 10px; border-radius: 6px; }

        .log-table { width: 100%; font-size: 10px; text-align: left; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        .log-table th, .log-table td { padding: 8px 4px; border-bottom: 1px solid rgba(255,255,255,0.05); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .col-date { width: 23%; } .col-hrs { width: 15%; } .col-cyc { width: 12%; } .col-mcq { width: 15%; } .col-sub { width: 35%; }

        .goal-row { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .phase-block { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border); }
        .phase-block.completed { border-color: #f39c12; }
        .phase-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .phase-title { font-size: 13px; font-weight: bold; color: var(--accent); }
        .phase-badge { font-size: 24px; filter: grayscale(100%); opacity: 0.3; transition: all 0.5s; }
        .phase-badge.unlocked { filter: grayscale(0%); opacity: 1; transform: scale(1.2); }
        
        .sub-grid-container { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: rgba(0,0,0,0.2); border-radius: 8px; margin-top: 5px; }
        .sub-grid-container.open { max-height: 500px; padding: 8px; overflow-y: auto; }
        .sub-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: left; }
        .sub-check-item { display: flex; align-items: center; gap: 5px; font-size: 9px; color: #aaa; }

        .pyq-nav-container { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
        .pyq-tab { background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: #888; padding: 8px 12px; font-size: 10px; border-radius: 8px; cursor: pointer; white-space: nowrap; flex: 1; text-align: center; position: relative; overflow: visible; }
        .pyq-tab.active { background: var(--accent); color: white; border-color: var(--accent); font-weight: bold; }
        .pyq-tab-cup { display: none; position: absolute; top: -12px; right: -5px; font-size: 18px; text-shadow: 0 0 10px gold; z-index: 100; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .pyq-tab-cup.show { display: block; }
        .pyq-panel { display: none; animation: fadeIn 0.3s; }
        .pyq-panel.active { display: block; }
        .pyq-list-row { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.03); margin-bottom: 5px; padding: 8px; border-radius: 6px; }
        .pyq-col-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .pyq-col-header { font-size: 10px; color: #5288c1; text-transform: uppercase; font-weight: bold; margin-bottom: 8px; border-bottom: 1px dashed rgba(255,255,255,0.2); padding-bottom: 4px; }
        
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        .matrix-table { width: 100%; font-size: 9px; border-collapse: collapse; margin-top: 15px; }
        .matrix-table th, .matrix-table td { border: 1px solid rgba(255,255,255,0.1); padding: 4px; text-align: center; }
        .matrix-table th { background: rgba(82, 136, 193, 0.2); color: white; }
        .matrix-row-head { text-align: left !important; font-weight: bold; background: rgba(0,0,0,0.2); }
        .matrix-total { font-weight: bold; color: #f39c12; background: rgba(243, 156, 18, 0.1); }

        .calc-preview { background: rgba(82, 136, 193, 0.1); padding: 8px; border-radius: 10px; margin-top: 8px; font-size: 11px; border: 1px dashed var(--accent); display: flex; justify-content: space-around; align-items: center; }
        .chart-container { width: 100%; height: 160px; margin: 10px 0; }
        
        #popup-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.96); z-index:2000; justify-content:center; align-items:center; flex-direction: column;}
        .popup-card { background: var(--card); padding: 25px; border-radius: 20px; border: 2px solid var(--accent); width: 85%; max-width: 320px; text-align: center; }
        
        .danger-zone { margin-top: 30px; padding: 15px; border-top: 1px dashed rgba(255,255,255,0.1); width: 100%; opacity: 0.9; }
        .clear-btn { background: none; border: 1px solid #ef5350; color: #ef5350; padding: 8px; border-radius: 8px; font-size: 10px; cursor: pointer; width: 100%; }
        .backup-btn { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 12px; width: 100%; font-weight: bold; margin-bottom: 8px; cursor: pointer;}
        .restore-btn { background: #2ecc71; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 12px; width: 100%; font-weight: bold; cursor: pointer;}

        .strong-weak-container { display: flex; flex-direction: column; gap: 8px; margin: 15px 0; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 10px; text-align: left; }
        .performance-label { font-family: 'Oswald', sans-serif; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; justify-content: space-between; align-items: center;}
        .stat-strong { color: #2ecc71; } .stat-weak { color: #ef5350; }
        .reminder-box { background: rgba(230, 126, 34, 0.15); border: 1px solid #e67e22; color: #e67e22; padding: 12px; border-radius: 10px; margin-top: 15px; display: none; text-align: left; }
    </style>
</head>
<body>
    <div id="popup-overlay">
        <div class="popup-card" id="mcq-popup">
            <h3>Cycle Complete</h3>
            <p>Enter MCQs solved:</p>
            <input type="number" id="cycleMcqs" placeholder="0" style="width:100%;">
            <button class="btn" onclick="startBreak()" style="margin-top:15px; width:100%;">Record & Start Break</button>
        </div>
        <div class="popup-card" id="break-popup" style="display:none;">
            <h3>Break Finished!</h3>
            <button class="btn" onclick="continueNextCycle()" style="background:#2ecc71; width:100%;">Start Next Cycle</button>
            <button class="btn" onclick="stopEntireSession()" style="background:#ef5350; margin-top:10px; width:100%;">End Session</button>
        </div>
        <div class="popup-card" id="restore-popup" style="display:none;">
            <h3>Restore Data</h3>
            <p style="font-size:11px; color:#aaa; margin-bottom:10px;">Paste the code from your Saved Messages:</p>
            <textarea id="restoreInput" style="width:100%; height:80px; background:#0e1621; color:white; border:1px solid var(--border); border-radius:8px; padding:5px; font-size:10px;"></textarea>
            <button class="btn" onclick="processRestore()" style="background:#2ecc71; margin-top:10px; width:100%;">Import Data</button>
            <button class="btn" onclick="closeRestore()" style="background:transparent; border:1px solid #888; color:#888; margin-top:5px; width:100%;">Cancel</button>
        </div>
    </div>

    <div class="container">
        <div class="header-ui">
            <div class="user-badge">
                <span id="uFullName">...</span>
                <span id="uID" class="user-id-tag">ID: 0</span>
            </div>
        </div>
        
        <img src="https://github.com/dhruvathaare/Scaslpel-Study-Squad-Apps/blob/main/photo_2026-02-12_20-08-36.jpg?raw=true" class="logo">
        <h1>Scalpel Study Squad</h1>

        <div class="exam-dashboard">
            <div class="exam-grid">
                <div class="exam-item" id="dash_ini_jul"><span id="daysIniJuly" class="exam-days">--</span><span class="exam-label">INICET JULY</span></div>
                <div class="exam-item" id="dash_upsc"><span id="daysUpsc" class="exam-days">--</span><span class="exam-label">UPSC CMS</span></div>
                <div class="exam-item" id="dash_neet"><span id="daysNeet" class="exam-days">--</span><span class="exam-label">NEET PG 2026</span></div>
                <div class="exam-item" id="dash_ini_jan"><span id="daysIniJan" class="exam-days">--</span><span class="exam-label">INICET JAN '27</span></div>
            </div>
        </div>

        <div class="streak-section">
            <div id="streakText" class="streak-text">Consistency: 0 Days</div>
            <div id="streakIcons" style="font-size:24px; margin:5px 0;"></div>
            <div style="font-size:9px; color:#888;">üî• per 25 days | ü•á per 75 days</div>
        </div>
        <div class="quote">"I AM HERE TO WIN, CONSISTENCY IS MY KITH AND KIN"</div>

        <div class="nav-tabs">
            <div class="tab-btn" onclick="switchTab('tab-goal', this)">Goal</div>
            <div class="tab-btn active" onclick="switchTab('tab-daily', this)">Daily Analytics</div>
            <div class="tab-btn" onclick="switchTab('tab-swt', this)">SWT Analysis</div>
            <div class="tab-btn" onclick="switchTab('tab-gt', this)">GT Analysis</div>
        </div>

        <div id="tab-goal" class="tab-content">
            <div class="card">
                <h3 style="margin-top:0; color:#5288c1;">Target Exams</h3>
                <div class="goal-row"><span>INICET July</span><input type="checkbox" id="goal_ini_jul" onchange="saveGoals()"></div>
                <div class="goal-row"><span>UPSC CMS</span><input type="checkbox" id="goal_upsc" onchange="saveGoals()"></div>
                <div class="goal-row"><span>NEET PG 2026</span><input type="checkbox" id="goal_neet" onchange="saveGoals()"></div>
                <div class="goal-row"><span>INICET Jan '27</span><input type="checkbox" id="goal_ini_jan" onchange="saveGoals()"></div>
                
                <button class="btn sm-btn" style="width:100%; margin-top:10px; background:var(--accent); font-weight:bold; font-size:12px; padding:12px;" onclick="lockExamGoals()">Lock & Let's Go!</button>
            </div>
            
            <div class="card">
                <h3 style="margin-top:0; color:#2ecc71;">PYQ PAPERS GOAL</h3>
                
                <div class="pyq-nav-container">
                    <div class="pyq-tab active" onclick="switchPyq('neet', this)">NEET PG<span id="cup_neet" class="pyq-tab-cup">üèÜ</span></div>
                    <div class="pyq-tab" onclick="switchPyq('ini', this)">INICET<span id="cup_ini" class="pyq-tab-cup">üèÜ</span></div>
                    <div class="pyq-tab" onclick="switchPyq('fmge', this)">FMGE<span id="cup_fmge" class="pyq-tab-cup">üèÜ</span></div>
                    <div class="pyq-tab" onclick="switchPyq('upsc', this)">UPSC<span id="cup_upsc" class="pyq-tab-cup">üèÜ</span></div>
                </div>

                <div id="pyq-panels-root"></div>

            </div>

            <div class="card" id="goal-phases-container">
                <h3 style="margin-top:0; color:#f39c12;">Reading Phases</h3>
            </div>
        </div>

        <div id="tab-daily" class="tab-content active">
            <div class="card">
                <span class="setting-label">Reading Phase</span>
                <select id="studyPhase">
                    <option value="First Reading">First Reading</option>
                    <option value="Second Reading">Second Reading</option>
                    <option value="Third Reading">Third Reading</option>
                    <option value="Extra Bonus">Extra Bonus Reading</option>
                </select>

                <span class="setting-label">Subject</span>
                <select id="subject">
                    <option value="" disabled selected>Select Subject</option>
                    <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option><option>Mixed Bag</option><option>Integrated Systems</option>
                </select>
                
                <div style="display:flex; gap:10px; margin-top:8px; text-align:center;">
                    <div style="flex:2;">
                        <span class="setting-label" style="text-align:center;">Study Duration</span>
                        <div style="display:flex; gap:5px;">
                            <div style="flex:1;"><input type="number" id="studyHr" value="2"><div class="sub-label">Hours</div></div>
                            <div style="flex:1;"><input type="number" id="studyMin" value="0"><div class="sub-label">Minutes</div></div>
                        </div>
                    </div>
                    <div style="flex:1;">
                        <span class="setting-label" style="text-align:center;">Break</span>
                        <input type="number" id="breakTime" value="15"><div class="sub-label">Minutes</div>
                    </div>
                </div>

                <div id="timer-display">00:00:00</div>
                <button id="startBtn" class="btn" style="width:100%;">Start Session</button>
                <div id="timer-controls" style="display:none; width:100%;">
                    <div style="display:flex; gap:8px;"><button id="pauseBtn" class="btn" style="background:#f39c12;flex:1;" onclick="togglePause()">Pause</button><button class="btn" style="background:#8e44ad;flex:1;" onclick="handleTransition()">Skip</button></div>
                    <button class="btn" style="background:#ef5350; margin-top:12px; width:100%;" onclick="stopEntireSession()">End Session</button>
                </div>
            </div>
            
            <div class="card">
                <h3 style="margin:0; color:#f39c12; font-size:16px;">Daily Progress</h3>
                <div class="chart-container"><canvas id="hoursChart"></canvas></div>
                <div class="chart-container"><canvas id="mcqChart"></canvas></div>
                <table class="log-table">
                    <thead><tr><th class="col-date">Date</th><th class="col-hrs">Hrs</th><th class="col-cyc">Cyc</th><th class="col-mcq">MCQ</th><th class="col-sub">Subjects</th></tr></thead>
                    <tbody id="dailyLogBody"></tbody>
                </table>

                <h3 style="margin:15px 0 5px 0; color:#5288c1; font-size:14px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">Phase Matrix (Days Spent)</h3>
                <div style="overflow-x:auto;"><table class="matrix-table"><thead><tr><th style="text-align:left;">Subject</th><th>1st</th><th>2nd</th><th>3rd</th><th>Bonus</th></tr></thead><tbody id="matrixBody"></tbody></table></div>

                <h3 style="margin:15px 0 5px 0; color:#2ecc71; font-size:14px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">Phase Matrix (MCQs Solved)</h3>
                <div style="overflow-x:auto;"><table class="matrix-table"><thead><tr><th style="text-align:left;">Subject</th><th>1st</th><th>2nd</th><th>3rd</th><th>Bonus</th></tr></thead><tbody id="mcqMatrixBody"></tbody></table></div>
            </div>
        </div>

        <div id="tab-swt" class="tab-content">
            <div class="card">
                <h3>SWT Analysis</h3>
                <select id="swtSubject" onchange="renderSWT()">
                    <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option><option>Mixed Bag</option><option>Integrated Systems</option>
                </select>
                <div style="display:flex; gap:5px; margin-top:8px;"><div style="flex:1.5;"><span class="setting-label">Date</span><input type="date" id="swtDate"></div><div style="flex:1;"><span class="setting-label">Total Qs</span><input type="number" id="swtTotal" oninput="calcSWT()"></div></div>
                <div style="display:flex; gap:5px; margin-top:5px;"><div style="flex:1;"><span class="setting-label">Correct</span><input type="number" id="swtCorrect" oninput="calcSWT()"></div><div style="flex:1;"><span class="setting-label">Unattempted</span><input type="number" id="swtUnat" oninput="calcSWT()"></div></div>
                <div class="calc-preview"><span>Wrong: <b id="swtW">0</b></span><span>Accuracy: <b id="swtP">0%</b></span></div>
                <button class="btn" onclick="saveSWT()" style="background:var(--accent); margin-top:10px; width:100%;">Save Result</button>
                
                <h4 style="margin: 15px 0 5px 0; font-size: 11px; opacity: 0.7;">Subject Trend</h4>
                <div class="chart-container"><canvas id="swtChart"></canvas></div>
                
                <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #f39c12; text-transform: uppercase;">Cumulative Performance (All Subjects)</h4>
                <div class="chart-container"><canvas id="swtCumulativeChart"></canvas></div>

                <div id="swtAnalysis" style="font-size:11px; text-align:left; line-height:1.5; max-height:100px; overflow-y:auto;"></div>
                
                <div class="strong-weak-container">
                    <div class="performance-label stat-strong">
                        <span>Strong Subject:</span>
                        <strong id="swtStrong">--</strong>
                    </div>
                    <div class="performance-label stat-weak">
                        <span>Weak Subject:</span>
                        <strong id="swtWeak">--</strong>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-gt" class="tab-content">
            <div class="card">
                <h3>GT Intelligence</h3>
                <div style="display:flex; margin-bottom:10px;"><div class="gt-tab-btn active" id="tabNeet" style="flex:1; padding:10px; text-align:center; background:var(--border); font-size:10px; cursor:pointer;" onclick="switchGT('NEET')">NEET PG (+4/-1)</div><div class="gt-tab-btn" id="tabInicet" style="flex:1; padding:10px; text-align:center; background:rgba(0,0,0,0.2); font-size:10px; cursor:pointer;" onclick="switchGT('INICET')">INICET (+1/-0.33)</div></div>
                <div style="display:flex; gap:5px;"><div style="flex:1.5;"><span class="setting-label">Date</span><input type="date" id="gtDate"></div><div style="flex:1;"><span class="setting-label">Correct</span><input type="number" id="gtCorrect" oninput="calcGT()"></div><div style="flex:1;"><span class="setting-label">Unattempted</span><input type="number" id="gtUnat" oninput="calcGT()"></div></div>
                <div class="calc-preview"><span>Wrong: <b id="gtW">0</b></span><span>Score: <b id="gtS">0</b></span></div>
                <button class="btn" onclick="saveGT()" style="background:#2ecc71; margin-top:10px; width:100%;">Save Result</button>
                <div id="neet-area"><h4 style="color:#f39c12; margin-top:15px; font-size:13px;">NEET PG Progress</h4><div class="chart-container"><canvas id="gtNeetChart"></canvas></div><div id="gtNeetAnalysis" style="font-size:11px; text-align:left;"></div></div>
                <div id="inicet-area" style="display:none;"><h4 style="color:#2ecc71; margin-top:15px; font-size:13px;">INICET Progress</h4><div class="chart-container"><canvas id="gtInicetChart"></canvas></div><div id="gtInicetAnalysis" style="font-size:11px; text-align:left;"></div></div>
            </div>
        </div>

        <div class="danger-zone">
            <h3 style="color:#f39c12; margin:0 0 10px 0;">Data Safety</h3>
            <button class="backup-btn" onclick="exportData()">Backup Data (Copy Code)</button>
            <button class="restore-btn" onclick="openRestore()">Restore Data</button>
            <button class="clear-btn" onclick="clearData()" style="margin-top:10px;">Clear All Local Data</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
        const tgUser = tg.initDataUnsafe?.user || { id: "OFFLINE", first_name: "Local", last_name: "User" };
        const fullName = `${tgUser.first_name || ""} ${tgUser.last_name || ""}`.trim();
        document.getElementById('uFullName').innerText = fullName || "Guest User";
        document.getElementById('uID').innerText = `ID: ${tgUser.id}`;

        const prefix = `SSS_PRO_V3_${tgUser.id}_`;
        const KEYS = { LOGS: prefix+'LOGS', NEET: prefix+'NEET', INI: prefix+'INI', SWT: prefix+'SWT', GOALS: prefix+'GOALS', PYQ: prefix+'PYQ' };
        
        const SUBJECTS_19 = ["Anatomy", "Physiology", "Biochemistry", "Pathology", "Microbiology", "Pharmacology", "FMT", "PSM", "Ophthalmology", "ENT", "Medicine", "Surgery", "OBG", "Pediatrics", "Anaesthesia", "Dermatology", "Orthopedics", "Psychiatry", "Radiology"];
        const SUBJECTS_EXTRA = ["Mixed Bag", "Integrated Systems"];
        const ALL_SWT_SUBS = [...SUBJECTS_19, ...SUBJECTS_EXTRA];

        const PHASES_CONFIG = [{ id: 'r1', name: '1. First Reading', badge: 'ü•â' },{ id: 'r2', name: '2. Second Reading', badge: 'ü•à' },{ id: 'r3', name: '3. Third Reading', badge: 'ü•á' },{ id: 'r4', name: '4. Extra Bonus', badge: 'üèÜ' }];
        
        const PYQ_CATS = [
            { id: 'neet', label: 'NEET PG', type: 'list', start: 2025, end: 2020 },
            { id: 'ini', label: 'INICET', type: 'cols', col1: 'May', col2: 'Nov', start: 2025, end: 2014 },
            { id: 'fmge', label: 'FMGE', type: 'cols', col1: 'July', col2: 'Dec', start: 2025, end: 2020 },
            { id: 'upsc', label: 'UPSC CMS', type: 'list', start: 2025, end: 2020 }
        ];

        let timerInterval, activeSub = "", activePhase = "", wakeLock = null, timeLeft = 0, mode = "idle", isPaused = false, currentGTMode = "NEET";
        const requestWakeLock = async () => { if ('wakeLock' in navigator) try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {} };
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep(f, d) { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value = f; g.gain.value = 0.1; o.start(); setTimeout(() => o.stop(), d); }
        let alarmInterval = null;
        function startAlarm(f) { stopAlarm(); alarmInterval = setInterval(() => playBeep(f, 200), 1000); }
        function stopAlarm() { if(alarmInterval) { clearInterval(alarmInterval); alarmInterval = null; } }

        document.getElementById('startBtn').onclick = () => { if (!document.getElementById('subject').value) return tg.showAlert("Select Subject!"); audioCtx.resume(); requestWakeLock(); activeSub = document.getElementById('subject').value; activePhase = document.getElementById('studyPhase').value; startStudyTimer(); };
        function startStudyTimer() { mode = "study"; isPaused = false; timeLeft = (parseInt(document.getElementById('studyHr').value)*3600) + (parseInt(document.getElementById('studyMin').value)*60); if(timeLeft <= 0) return; document.getElementById('startBtn').style.display='none'; document.getElementById('timer-controls').style.display='block'; runTimer(); }
        function togglePause() { isPaused = !isPaused; document.getElementById('pauseBtn').innerText = isPaused ? "Resume" : "Pause"; }
        
        function runTimer() { 
            clearInterval(timerInterval); 
            timerInterval = setInterval(() => { 
                if (!isPaused) { 
                    timeLeft--; 
                    let h=Math.floor(timeLeft/3600), m=Math.floor((timeLeft%3600)/60), s=timeLeft%60; 
                    document.getElementById('timer-display').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; 
                    if (timeLeft<=0) handleTransition(); 
                } 
            }, 1000); 
        }

        function handleTransition() { clearInterval(timerInterval); startAlarm(mode==="study"?880:440); document.getElementById('popup-overlay').style.display='flex'; document.getElementById('mcq-popup').style.display=mode==="study"?'block':'none'; document.getElementById('break-popup').style.display=mode==="study"?'none':'block'; }
        function startBreak() { stopAlarm(); const m = parseInt(document.getElementById('cycleMcqs').value)||0; saveStudyLog(activeSub, m, (parseInt(document.getElementById('studyHr').value)*60)+parseInt(document.getElementById('studyMin').value), activePhase); document.getElementById('cycleMcqs').value=''; document.getElementById('popup-overlay').style.display='none'; mode="break"; isPaused=false; timeLeft=parseInt(document.getElementById('breakTime').value)*60; runTimer(); }
        function continueNextCycle() { stopAlarm(); document.getElementById('popup-overlay').style.display = 'none'; startStudyTimer(); }
        function stopEntireSession() { stopAlarm(); clearInterval(timerInterval); if (wakeLock) { wakeLock.release(); wakeLock=null; } document.getElementById('popup-overlay').style.display='none'; document.getElementById('timer-display').innerText="00:00:00"; document.getElementById('startBtn').style.display='block'; document.getElementById('timer-controls').style.display='none'; mode="idle"; updateUI(); }

        function saveStudyLog(s, m, d, ph) { 
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]"); 
            logs.unshift({ date: new Date().toLocaleDateString('en-GB'), subject: s, mcqs: m, duration: d, phase: ph }); 
            localStorage.setItem(KEYS.LOGS, JSON.stringify(logs)); 
        }

        let hChart, mChart, gNeetChart, gIniChart, sChart, scuChart;
        function renderData() {
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]");
            const grouped = {};
            logs.forEach(l => { 
                if (!grouped[l.date]) grouped[l.date] = {h:0, m:0, subs:new Set(), cyc:0}; 
                grouped[l.date].h += l.duration/60; 
                grouped[l.date].m += l.mcqs; 
                grouped[l.date].subs.add(l.subject); 
                grouped[l.date].cyc++; 
            });
            const labels = Object.keys(grouped).reverse().slice(-7);
            const hours = labels.map(l => grouped[l].h), mcqs = labels.map(l => grouped[l].m);
            const avgH = hours.length ? (hours.reduce((a,b)=>a+b,0)/hours.length).toFixed(1) : 0;
            const avgM = mcqs.length ? Math.round(mcqs.reduce((a,b)=>a+b,0)/mcqs.length) : 0;
            
            if(hChart) hChart.destroy(); 
            hChart = new Chart(document.getElementById('hoursChart'), { 
                type:'line', data:{labels, datasets:[{label:'Hours', data:hours, borderColor:'#f39c12', tension:0.3}]}, 
                options:{maintainAspectRatio:false, scales:{y:{ticks:{color:'#fff'}}}, plugins:{annotation:{annotations:{l1:{type:'line', yMin:avgH, yMax:avgH, borderColor:'rgba(255,255,255,0.3)', borderDash:[5,5]}}}}}
            });
            if(mChart) mChart.destroy(); 
            mChart = new Chart(document.getElementById('mcqChart'), { 
                type:'line', data:{labels, datasets:[{label:'MCQs', data:mcqs, borderColor:'#5288c1', tension:0.3}]}, 
                options:{maintainAspectRatio:false, scales:{y:{ticks:{color:'#fff'}}}, plugins:{annotation:{annotations:{l1:{type:'line', yMin:avgM, yMax:avgM, borderColor:'rgba(255,255,255,0.3)', borderDash:[5,5]}}}}}
            });
            let html = ""; 
            Object.keys(grouped).reverse().forEach(d => { 
                html += `<tr><td>${d}</td><td>${grouped[d].h.toFixed(1)}h</td><td>${grouped[d].cyc}</td><td>${grouped[d].m}</td><td>${Array.from(grouped[d].subs).join(', ')}</td></tr>`; 
            });
            document.getElementById('dailyLogBody').innerHTML = html;
        }

        function renderMatrix() {
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]");
            const mapKey = { "First Reading": 0, "Second Reading": 1, "Third Reading": 2, "Extra Bonus": 3 };
            const dMatrix = {}, mMatrix = {};
            SUBJECTS_19.forEach(s => { dMatrix[s] = [new Set(), new Set(), new Set(), new Set()]; mMatrix[s] = [0, 0, 0, 0]; });
            
            logs.forEach(l => {
                const s = l.subject, ph = l.phase || "First Reading", idx = mapKey[ph];
                if (dMatrix[s] && idx !== undefined) { dMatrix[s][idx].add(l.date); mMatrix[s][idx] += (parseInt(l.mcqs)||0); }
            });

            let dHtml = "", mHtml = "";
            const dTotals = [0,0,0,0], mTotals = [0,0,0,0];
            SUBJECTS_19.forEach(s => {
                const days = dMatrix[s].map(set => set.size), mcqs = mMatrix[s];
                days.forEach((d, i) => dTotals[i] += d); mcqs.forEach((m, i) => mTotals[i] += m);
                dHtml += `<tr><td class="matrix-row-head">${s}</td>${days.map(d => `<td>${d||'-'}</td>`).join('')}</tr>`;
                mHtml += `<tr><td class="matrix-row-head">${s}</td>${mcqs.map(m => `<td>${m||'-'}</td>`).join('')}</tr>`;
            });
            dHtml += `<tr><td class="matrix-total">TOTAL</td>${dTotals.map(t => `<td class="matrix-total">${t}</td>`).join('')}</tr>`;
            mHtml += `<tr><td class="matrix-total">TOTAL</td>${mTotals.map(t => `<td class="matrix-total">${t}</td>`).join('')}</tr>`;
            document.getElementById('matrixBody').innerHTML = dHtml;
            document.getElementById('mcqMatrixBody').innerHTML = mHtml;
        }

        function renderPYQ() {
            const container = document.getElementById('pyq-panels-root');
            if(container.innerHTML !== "") return;

            let html = "";
            PYQ_CATS.forEach((cat, index) => {
                const activeClass = index === 0 ? "active" : "";
                
                html += `<div id="pyq_panel_${cat.id}" class="pyq-panel ${activeClass}">`;
                
                if (cat.type === 'list') {
                    for(let y=cat.start; y>=cat.end; y--) {
                        html += `
                        <label class="pyq-list-row">
                            <span>${cat.label} ${y}</span>
                            <input type="checkbox" id="pyq_${cat.id}_${y}">
                        </label>`;
                    }
                } else {
                    html += `<div class="pyq-col-grid">
                        <div>
                            <div class="pyq-col-header">${cat.col1}</div>`;
                            for(let y=cat.start; y>=cat.end; y--) {
                                html += `<label class="pyq-list-row" style="font-size:10px;">
                                    <span>${y}</span><input type="checkbox" id="pyq_${cat.id}_${y}_1">
                                </label>`;
                            }
                    html += `</div>
                        <div>
                            <div class="pyq-col-header">${cat.col2}</div>`;
                            for(let y=cat.start; y>=cat.end; y--) {
                                html += `<label class="pyq-list-row" style="font-size:10px;">
                                    <span>${y}</span><input type="checkbox" id="pyq_${cat.id}_${y}_2">
                                </label>`;
                            }
                    html += `</div></div>`;
                }

                html += `<button class="btn sm-btn" style="margin-top:15px; width:100%; background:var(--accent);" onclick="saveLockPYQ('${cat.id}')">Save & Lock Progress</button>`;
                html += `</div>`;
            });

            container.innerHTML = html;
            loadPYQ();
        }

        function switchPyq(id, btn) {
            document.querySelectorAll('.pyq-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            document.querySelectorAll('.pyq-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`pyq_panel_${id}`).classList.add('active');
        }

        function saveLockPYQ(catId) {
            const data = JSON.parse(localStorage.getItem(KEYS.PYQ)) || {};
            const catConfig = PYQ_CATS.find(c => c.id === catId);
            
            data[catId] = {}; 
            
            let allChecked = true;

            if(catConfig.type === 'list') {
                for(let y=catConfig.start; y>=catConfig.end; y--) {
                    const isChecked = document.getElementById(`pyq_${catId}_${y}`).checked;
                    data[catId][y] = isChecked;
                    if(!isChecked) allChecked = false;
                }
            } else {
                for(let y=catConfig.start; y>=catConfig.end; y--) {
                    const c1 = document.getElementById(`pyq_${catId}_${y}_1`).checked;
                    const c2 = document.getElementById(`pyq_${catId}_${y}_2`).checked;
                    data[catId][`${y}_1`] = c1;
                    data[catId][`${y}_2`] = c2;
                    if(!c1 || !c2) allChecked = false;
                }
            }

            localStorage.setItem(KEYS.PYQ, JSON.stringify(data));
            
            const cup = document.getElementById(`cup_${catId}`);
            if(allChecked) {
                cup.classList.add('show');
                alert(`üèÜ Congratulations! You have completed all ${catConfig.label} PYQs!`);
            } else {
                cup.classList.remove('show');
                alert("Progress Saved.");
            }
        }

        function loadPYQ() {
            const data = JSON.parse(localStorage.getItem(KEYS.PYQ)) || {};
            
            PYQ_CATS.forEach(cat => {
                if(!data[cat.id]) return;
                
                let allChecked = true;

                if(cat.type === 'list') {
                    for(let y=cat.start; y>=cat.end; y--) {
                        const el = document.getElementById(`pyq_${cat.id}_${y}`);
                        if(el) {
                            el.checked = data[cat.id][y] || false;
                            if(!el.checked) allChecked = false;
                        }
                    }
                } else {
                    for(let y=cat.start; y>=cat.end; y--) {
                        const el1 = document.getElementById(`pyq_${cat.id}_${y}_1`);
                        const el2 = document.getElementById(`pyq_${cat.id}_${y}_2`);
                        if(el1) {
                            el1.checked = data[cat.id][`${y}_1`] || false;
                            if(!el1.checked) allChecked = false;
                        }
                        if(el2) {
                            el2.checked = data[cat.id][`${y}_2`] || false;
                            if(!el2.checked) allChecked = false;
                        }
                    }
                }

                if(allChecked) {
                    document.getElementById(`cup_${cat.id}`).classList.add('show');
                }
            });
        }

        function renderGoalHTML() {
            const container = document.getElementById('goal-phases-container'); container.innerHTML = "<h3>Reading Phases</h3>";
            PHASES_CONFIG.forEach((p, idx) => {
                container.innerHTML += `<div class="phase-block" id="pb_${idx}"><div class="phase-header"><span>${p.name}</span><span id="badge_${idx}" class="phase-badge">${p.badge}</span></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px"><div><span class="setting-label">From</span><input type="date" id="d_${idx}_f" onchange="saveGoals()"></div><div><span class="setting-label">To</span><input type="date" id="d_${idx}_t" onchange="saveGoals()"></div></div><button class="btn sm-btn" style="margin-top:8px;background:rgba(255,255,255,0.1);width:100%" onclick="document.getElementById('sg_${idx}').classList.toggle('open')">Subjects</button><div id="sg_${idx}" class="sub-grid-container"><div class="sub-grid">${SUBJECTS_19.map((s, si) => `<label class="sub-check-item"><input type="checkbox" id="chk_${idx}_${si}" onchange="saveGoals()"> <span>${s.substring(0,4)}..</span></label>`).join('')}</div></div></div>`;
            }); loadGoalsToUI();
        }
        function saveGoals() { 
            const g = { 
                exams: { 
                    i_j: document.getElementById('goal_ini_jul').checked, 
                    u: document.getElementById('goal_upsc').checked, 
                    n: document.getElementById('goal_neet').checked, 
                    i_jan: document.getElementById('goal_ini_jan').checked 
                }, 
                phases: PHASES_CONFIG.map((_, idx) => { 
                    const s = {}; 
                    SUBJECTS_19.forEach((_, si) => s[si] = document.getElementById(`chk_${idx}_${si}`).checked); 
                    return { f: document.getElementById(`d_${idx}_f`).value, t: document.getElementById(`d_${idx}_t`).value, s }; 
                }) 
            }; 
            localStorage.setItem(KEYS.GOALS, JSON.stringify(g)); 
            checkMedals(g); 
        }

        // NEW FUNCTION FOR LOCK BUTTON
        function lockExamGoals() {
            saveGoals(); // Ensure state is saved first
            const g = JSON.parse(localStorage.getItem(KEYS.GOALS));
            
            // Map IDs to DOM Elements in dashboard
            const map = {
                'i_j': 'dash_ini_jul',
                'u': 'dash_upsc',
                'n': 'dash_neet',
                'i_jan': 'dash_ini_jan'
            };

            // Apply Classes based on checkbox state
            Object.keys(map).forEach(key => {
                const el = document.getElementById(map[key]);
                if (g.exams[key]) {
                    el.classList.add('target-locked');
                } else {
                    el.classList.remove('target-locked');
                }
            });

            alert("Targets Locked! Let's Go! üöÄ");
        }

        function loadGoalsToUI() { 
            const g = JSON.parse(localStorage.getItem(KEYS.GOALS)) || { exams:{}, phases:[] }; 
            
            // Set Checkboxes
            document.getElementById('goal_ini_jul').checked = g.exams.i_j; 
            document.getElementById('goal_upsc').checked = g.exams.u; 
            document.getElementById('goal_neet').checked = g.exams.n; 
            document.getElementById('goal_ini_jan').checked = g.exams.i_jan; 
            
            // Restore visual lock state on load
            if(g.exams) {
                const map = { 'i_j': 'dash_ini_jul', 'u': 'dash_upsc', 'n': 'dash_neet', 'i_jan': 'dash_ini_jan' };
                Object.keys(map).forEach(key => {
                    const el = document.getElementById(map[key]);
                    if (g.exams[key]) el.classList.add('target-locked');
                    else el.classList.remove('target-locked');
                });
            }

            PHASES_CONFIG.forEach((_, idx) => { 
                const d = g.phases[idx] || {}; 
                document.getElementById(`d_${idx}_f`).value = d.f || ""; 
                document.getElementById(`d_${idx}_t`).value = d.t || ""; 
                const sd = d.s || {}; 
                SUBJECTS_19.forEach((_, si) => { 
                    const el = document.getElementById(`chk_${idx}_${si}`); 
                    if(el) el.checked = sd[si] || false; 
                }); 
            }); 
            checkMedals(g); 
        }
        function checkMedals(g) { if(!g.phases) return; PHASES_CONFIG.forEach((_, idx) => { const d = g.phases[idx]; if(!d) return; let done = true; for(let i=0; i<SUBJECTS_19.length; i++) if(!d.s[i]) done=false; const b = document.getElementById(`badge_${idx}`), block = document.getElementById(`pb_${idx}`); if(done) { b.classList.add('unlocked'); block.classList.add('completed'); } else { b.classList.remove('unlocked'); block.classList.remove('completed'); } }); }

        function exportData() { const b = {}; Object.keys(KEYS).forEach(k => b[k] = localStorage.getItem(KEYS[k])); const code = btoa(JSON.stringify(b)); navigator.clipboard.writeText(code).then(() => alert("Code Copied!")); }
        function openRestore() { document.getElementById('popup-overlay').style.display='flex'; document.getElementById('restore-popup').style.display='block'; }
        function closeRestore() { document.getElementById('popup-overlay').style.display='none'; document.getElementById('restore-popup').style.display='none'; }
        function processRestore() { try { const d = JSON.parse(atob(document.getElementById('restoreInput').value)); Object.keys(d).forEach(k => localStorage.setItem(k, d[k])); alert("Restored!"); location.reload(); } catch(e) { alert("Invalid Code!"); } }

        function switchTab(id, btn) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(id).classList.add('active'); updateUI(); }
        
        function updateCountdowns() { 
            const n = new Date();
            const istStr = new Date().toLocaleDateString('en-CA', {timeZone:'Asia/Kolkata'});
            const swtInp = document.getElementById('swtDate');
            const gtInp = document.getElementById('gtDate');
            if(swtInp) swtInp.max = istStr;
            if(gtInp) gtInp.max = istStr;

            const dates = { iniJuly: new Date("2026-05-17"), upsc: new Date("2026-08-02"), neet: new Date("2026-08-30"), iniJan: new Date("2026-11-01") }; 
            Object.keys(dates).forEach(k => { 
                const d = Math.ceil((dates[k] - n) / 86400000); 
                const el = document.getElementById('days' + k.charAt(0).toUpperCase() + k.slice(1)); 
                if(el) el.innerText = d > 0 ? d : "LIVE"; 
            }); 
        }

        function updateConsistency() { const logs = JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]"); const u = new Set(logs.map(l => l.date)).size; document.getElementById('streakText').innerText = `Consistency: ${u} Days`; document.getElementById('streakIcons').innerText = "ü•á".repeat(Math.floor(u/75)) + "üî•".repeat(Math.floor((u%75)/25)); }
        function clearData() { if(confirm("Delete everything?")) { Object.values(KEYS).forEach(k => localStorage.removeItem(k)); location.reload(); } }
        function calcSWT() { const t=parseInt(document.getElementById('swtTotal').value)||0, c=parseInt(document.getElementById('swtCorrect').value)||0, u=parseInt(document.getElementById('swtUnat').value)||0; document.getElementById('swtW').innerText=Math.max(0, t-c-u); document.getElementById('swtP').innerText=t>0?((c/t)*100).toFixed(1)+"%":"0%"; }
        function calcGT() { const c=parseInt(document.getElementById('gtCorrect').value)||0, u=parseInt(document.getElementById('gtUnat').value)||0, w=Math.max(0, 200-c-u); const s=(currentGTMode==='NEET')?(c*4-w):(c-(w*0.333)); document.getElementById('gtW').innerText=w; document.getElementById('gtS').innerText=s.toFixed(2); }
        function saveSWT() { const d=document.getElementById('swtDate').value, t=parseInt(document.getElementById('swtTotal').value), sub=document.getElementById('swtSubject').value; if(!d || isNaN(t)) return; const data = JSON.parse(localStorage.getItem(KEYS.SWT)||"[]"); data.push({ date: d, total: t, correct: parseInt(document.getElementById('swtCorrect').value), unat: parseInt(document.getElementById('swtUnat').value), wrong: Math.max(0, t-parseInt(document.getElementById('swtCorrect').value)-parseInt(document.getElementById('swtUnat').value)), percent: ((parseInt(document.getElementById('swtCorrect').value)/t)*100).toFixed(1), subject: sub }); data.sort((a,b)=>new Date(a.date)-new Date(b.date)); localStorage.setItem(KEYS.SWT, JSON.stringify(data)); updateUI(); }
        function saveGT() { const d=document.getElementById('gtDate').value, c=parseInt(document.getElementById('gtCorrect').value), u=parseInt(document.getElementById('gtUnat').value); if(!d) return; const w=Math.max(0,200-c-u), score=(currentGTMode==='NEET'?(c*4-w):(c-w*0.333)); const data = JSON.parse(localStorage.getItem(currentGTMode==='NEET'?KEYS.NEET:KEYS.INI)||"[]"); data.push({ date: d, score, correct: c, unat: u, wrong: w }); data.sort((a,b)=>new Date(a.date)-new Date(b.date)); localStorage.setItem(currentGTMode==='NEET'?KEYS.NEET:KEYS.INI, JSON.stringify(data)); updateUI(); }
        function switchGT(m) { currentGTMode=m; document.querySelectorAll('.gt-tab-btn').forEach(b=>b.style.background='rgba(0,0,0,0.2)'); document.getElementById(m==='NEET'?'tabNeet':'tabInicet').style.background='var(--border)'; document.getElementById('neet-area').style.display=m==='NEET'?'block':'none'; document.getElementById('inicet-area').style.display=m==='INICET'?'block':'none'; calcGT(); renderGT(); }

        function renderSWT() {
            const all = JSON.parse(localStorage.getItem(KEYS.SWT)||"[]"), sub = document.getElementById('swtSubject').value, f = all.filter(x => x.subject === sub);
            
            // 1. Subject Specific Trend
            if(sChart) sChart.destroy(); 
            if(f.length>0) sChart = new Chart(document.getElementById('swtChart'), { type:'line', data:{labels:f.map(x=>x.date), datasets:[{label:sub+'%', data:f.map(x=>x.percent), borderColor:'#5288c1', tension:0.3}]}, options:{maintainAspectRatio:false, scales:{y:{min:0, max:100, ticks:{color:'#fff'}}}}});
            document.getElementById('swtAnalysis').innerHTML = f.map(x => `‚Ä¢ ${x.date}: <b>${x.percent}%</b> (C:${x.correct} W:${x.wrong})`).reverse().join('<br>');

            // 2. Cumulative Line Graph (Average per Subject)
            if(scuChart) scuChart.destroy();
            const perfData = {};
            ALL_SWT_SUBS.forEach(s => perfData[s] = {sum:0, count:0});
            
            all.forEach(l => {
                if(perfData[l.subject]) {
                    perfData[l.subject].sum += parseFloat(l.percent);
                    perfData[l.subject].count++;
                }
            });

            const xLabels = ALL_SWT_SUBS.map(s => s.substring(0,4)); // Shortened for chart
            const yData = ALL_SWT_SUBS.map(s => {
                return perfData[s].count > 0 ? (perfData[s].sum / perfData[s].count).toFixed(1) : null;
            });

            scuChart = new Chart(document.getElementById('swtCumulativeChart'), {
                type: 'line',
                data: {
                    labels: xLabels,
                    datasets: [{
                        label: 'Avg Accuracy %',
                        data: yData,
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        fill: true,
                        tension: 0.4,
                        spanGaps: true,
                        pointRadius: 3
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: 0, max: 100, ticks: { color: '#fff', font: { size: 9 } } },
                        x: { ticks: { color: '#aaa', font: { size: 8 } } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // 3. Performance Indicators (Strongest/Weakest)
            if(all.length>0) {
                let maxAvg = -1, minAvg = 101, sSub = "--", wSub = "--";
                Object.keys(perfData).forEach(k => {
                    if(perfData[k].count > 0) {
                        const avg = perfData[k].sum / perfData[k].count;
                        if(avg > maxAvg) { maxAvg = avg; sSub = k; }
                        if(avg < minAvg) { minAvg = avg; wSub = k; }
                    }
                });
                document.getElementById('swtStrong').innerText = sSub;
                document.getElementById('swtWeak').innerText = wSub;
            }
        }

        function renderGT() {
            const nd = JSON.parse(localStorage.getItem(KEYS.NEET)||"[]"), id = JSON.parse(localStorage.getItem(KEYS.INI)||"[]");
            if(gNeetChart) gNeetChart.destroy(); if(nd.length>0) gNeetChart = new Chart(document.getElementById('gtNeetChart'), { type:'line', data:{labels:nd.map(x=>x.date), datasets:[{label:'NEET', data:nd.map(x=>x.score), borderColor:'#f39c12', tension:0.3}]}, options:{maintainAspectRatio:false, scales:{y:{min:0, max:800, ticks:{color:'#fff'}}}}});
            if(gIniChart) gIniChart.destroy(); if(id.length>0) gIniChart = new Chart(document.getElementById('gtInicetChart'), { type:'line', data:{labels:id.map(x=>x.date), datasets:[{label:'INICET', data:id.map(x=>x.score), borderColor:'#2ecc71', tension:0.3}]}, options:{maintainAspectRatio:false, scales:{y:{min:0, max:200, ticks:{color:'#fff'}}}}});
        }

        function updateUI() { renderData(); renderSWT(); renderGT(); updateConsistency(); renderMatrix(); renderGoalHTML(); renderPYQ(); updateCountdowns(); }
        updateUI();
    </script>
</body>
</html>

