<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scalpel Master Pro V7.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <style>
        :root { --bg: #0e1621; --card: #17212b; --text: #ffffff; --border: #2b5278; --accent: #5288c1; --input-bg: #0e1621; }
        html, body { height: 100%; margin: 0; padding: 0; background: var(--bg); color: var(--text); }
        
        body { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            padding: 15px; 
            box-sizing: border-box; 
            overflow-y: auto; 
            min-height: 100vh;
        }
        
        .container { width: 100%; max-width: 420px; display: flex; flex-direction: column; align-items: center; text-align: center; }
        
        .header-ui { width: 100%; display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .user-badge { background: rgba(82, 136, 193, 0.2); border: 1px solid var(--accent); padding: 8px 12px; border-radius: 15px; font-size: 11px; color: var(--accent); font-weight: bold; text-align: right; line-height: 1.3; }
        .user-badge span { display: block; }
        .user-id-tag { opacity: 0.7; font-size: 9px; font-family: monospace; }

        .logo { width: 85px; height: 85px; border-radius: 50%; border: 4px solid var(--accent); margin-bottom: 10px; box-shadow: 0 0 15px rgba(82,136,193,0.3); }
        h1 { color: var(--accent); font-size: 22px; margin: 5px 0; font-weight: bold; text-transform: uppercase; }
        
        /* Dashboard & Exam Grid */
        .exam-dashboard { background: rgba(82, 136, 193, 0.15); border: 1px solid var(--accent); padding: 12px; border-radius: 15px; width: 100%; margin-bottom: 15px; box-sizing: border-box; }
        .exam-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .exam-item { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 10px; border: 1px solid rgba(82, 136, 193, 0.3); }
        .exam-days { font-size: 16px; font-weight: bold; color: var(--accent); display: block; }
        .exam-label { font-size: 8px; text-transform: uppercase; opacity: 0.9; letter-spacing: 0.5px; margin-top: 2px; display: block; }

        .streak-section { margin-bottom: 10px; }
        .streak-text { font-size: 18px; font-weight: bold; color: #f39c12; }
        .quote { font-family: 'Oswald', sans-serif; color: #ef5350; font-weight: 700; font-size: 11px; text-transform: uppercase; margin: 10px 0; line-height: 1.2; }

        /* Navigation */
        .nav-tabs { display: flex; width: 100%; background: var(--card); border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); overflow: hidden; }
        .tab-btn { flex: 1; padding: 12px 5px; font-size: 10px; font-weight: bold; cursor: pointer; border: none; background: none; color: white; opacity: 0.5; }
        .tab-btn.active { opacity: 1; background: var(--accent); }
        .tab-content { width: 100%; display: none; }
        .tab-content.active { display: block; }

        /* Accordion Style Cards */
        .accordion-wrapper { width: 100%; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: var(--card); }
        .accordion-header { background: var(--accent); padding: 12px; color: white; font-weight: bold; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .accordion-header:after { content: '‚ñº'; font-size: 10px; transition: transform 0.3s; }
        .accordion-wrapper.open .accordion-header:after { transform: rotate(180deg); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background: var(--card); }
        .accordion-wrapper.open .accordion-content { max-height: 2000px; } /* Large max-height for animation */
        .accordion-inner { padding: 15px; }

        /* Standard Card (for other tabs) */
        .card { background: var(--card); padding: 12px; border-radius: 20px; border: 1px solid var(--border); width: 100%; box-sizing: border-box; margin-bottom: 15px; position: relative; }
        
        .setting-label { font-size: 9px; color: #888; text-transform: uppercase; margin: 6px 0 2px 0; display: block; font-weight: bold; text-align: left; }
        .sub-label { font-size: 8px; color: #5288c1; text-transform: uppercase; margin-top: 2px; font-weight: bold; }
        
        input, select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); text-align: center; font-size: 13px; box-sizing: border-box; }
        input[type="date"] { color-scheme: dark; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); }

        /* Timer & Buttons */
        #timer-display { font-size: 52px; font-weight: bold; margin: 5px 0; font-variant-numeric: tabular-nums; }
        .btn { background: #2481cc; color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; font-size: 14px; }
        .sm-btn { padding: 6px 12px; font-size: 10px; border-radius: 6px; }

        /* Tables */
        .log-table { width: 100%; font-size: 10px; text-align: left; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        .log-table th, .log-table td { padding: 8px 4px; border-bottom: 1px solid rgba(255,255,255,0.05); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .col-date { width: 23%; } .col-hrs { width: 15%; } .col-cyc { width: 12%; } .col-mcq { width: 15%; } .col-sub { width: 35%; }

        /* Goal & Matrix Styles */
        .goal-row { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .goal-row:last-child { border-bottom: none; }
        .phase-block { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border); transition: border-color 0.3s; }
        .phase-block.completed { border-color: #f39c12; box-shadow: 0 0 10px rgba(243, 156, 18, 0.1); }
        .phase-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .phase-title { font-size: 13px; font-weight: bold; color: var(--accent); }
        .phase-badge { font-size: 24px; filter: grayscale(100%); opacity: 0.3; transition: all 0.5s; }
        .phase-badge.unlocked { filter: grayscale(0%); opacity: 1; transform: scale(1.2); text-shadow: 0 0 15px rgba(255,215,0,0.6); }
        .date-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; }
        .days-calc { font-size: 10px; color: #f39c12; margin-top: 5px; text-align: right; font-weight: bold; }

        /* New Subject Grid in Goal */
        .sub-grid-container { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: rgba(0,0,0,0.2); border-radius: 8px; margin-top: 5px; }
        .sub-grid-container.open { max-height: 500px; padding: 8px; overflow-y: auto; }
        .sub-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: left; }
        .sub-check-item { display: flex; align-items: center; gap: 5px; font-size: 9px; color: #aaa; }
        .sub-check-item input:checked + span { color: #2ecc71; font-weight: bold; }
        
        .target-row { display: flex; align-items: flex-end; gap: 8px; margin-top: 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.1); }

        /* PYQ Specifics */
        .pyq-header-bar { display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; cursor:pointer; margin-bottom:5px; border:1px solid rgba(82, 136, 193, 0.2); transition: background 0.3s;}
        .pyq-header-bar:hover { background:rgba(255,255,255,0.1); }
        .pyq-content { display:none; padding:10px; background:rgba(0,0,0,0.2); border-radius:8px; margin-bottom:15px; }
        .pyq-content.open { display:block; animation: fadeIn 0.3s; }
        .pyq-col-container { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
        .pyq-col-header { font-size:10px; color:#5288c1; text-transform:uppercase; font-weight:bold; margin-bottom:5px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:3px; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(-5px); } to { opacity:1; transform:translateY(0); } }

        .matrix-table { width: 100%; font-size: 9px; border-collapse: collapse; margin-top: 15px; }
        .matrix-table th, .matrix-table td { border: 1px solid rgba(255,255,255,0.1); padding: 4px; text-align: center; }
        .matrix-table th { background: rgba(82, 136, 193, 0.2); color: white; }
        .matrix-row-head { text-align: left !important; font-weight: bold; color: #ddd; background: rgba(0,0,0,0.2); }
        .matrix-total { font-weight: bold; color: #f39c12; background: rgba(243, 156, 18, 0.1); }

        /* Misc */
        .calc-preview { background: rgba(82, 136, 193, 0.1); padding: 8px; border-radius: 10px; margin-top: 8px; font-size: 11px; border: 1px dashed var(--accent); display: flex; justify-content: space-around; align-items: center; }
        .chart-container { width: 100%; height: 160px; margin: 10px 0; }
        
        #popup-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.96); z-index:2000; justify-content:center; align-items:center; flex-direction: column;}
        .popup-card { background: var(--card); padding: 25px; border-radius: 20px; border: 2px solid var(--accent); width: 85%; max-width: 320px; text-align: center; }
        
        .danger-zone { margin-top: 30px; padding: 15px; border-top: 1px dashed rgba(255,255,255,0.1); width: 100%; opacity: 0.9; }
        .clear-btn { background: none; border: 1px solid #ef5350; color: #ef5350; padding: 8px; border-radius: 8px; font-size: 10px; cursor: pointer; margin-top: 10px; width: 100%; }
        .backup-btn { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 12px; cursor: pointer; width: 100%; font-weight: bold; margin-bottom: 8px; }
        .restore-btn { background: #2ecc71; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 12px; cursor: pointer; width: 100%; font-weight: bold; }

        /* Revision Radar */
        .radar-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top:10px; }
        .radar-item { padding: 8px; border-radius: 8px; font-size: 10px; text-align: left; display: flex; justify-content: space-between; align-items: center; }
        .radar-warn { background: rgba(230, 126, 34, 0.2); border: 1px solid #e67e22; color: #e67e22; }
        .radar-crit { background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c; color: #e74c3c; }
        .radar-days { font-weight: bold; font-size: 12px; }

        /* SWT Analytics Extras */
        .strong-weak-container { display: flex; justify-content: space-between; margin: 15px 0; font-size: 12px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; }
        .stat-box strong { display: block; font-size: 14px; margin-bottom: 2px; }
        .stat-strong { color: #2ecc71; }
        .stat-weak { color: #ef5350; }
        
        .reminder-box { background: rgba(230, 126, 34, 0.15); border: 1px solid #e67e22; color: #e67e22; padding: 12px; border-radius: 10px; margin-top: 15px; display: none; text-align: left; }
        .reminder-title { font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px; text-transform: uppercase; }
        .reminder-list { font-size: 10px; line-height: 1.4; opacity: 0.9; }
    </style>
</head>
<body>
    <div id="popup-overlay">
        <div class="popup-card" id="mcq-popup">
            <h3>Cycle Complete</h3>
            <p>Enter MCQs solved:</p>
            <input type="number" id="cycleMcqs" placeholder="0" style="width:100%;">
            <button class="btn" onclick="startBreak()" style="margin-top:15px; width:100%;">Record & Start Break</button>
        </div>
        <div class="popup-card" id="break-popup" style="display:none;">
            <h3>Break Finished!</h3>
            <button class="btn" onclick="continueNextCycle()" style="background:#2ecc71; width:100%;">Start Next Cycle</button>
            <button class="btn" onclick="stopEntireSession()" style="background:#ef5350; margin-top:10px; width:100%;">End Session</button>
        </div>
        <div class="popup-card" id="restore-popup" style="display:none;">
            <h3>Restore Data</h3>
            <p style="font-size:11px; color:#aaa; margin-bottom:10px;">Paste the code from your Saved Messages below:</p>
            <textarea id="restoreInput" style="width:100%; height:80px; background:#0e1621; color:white; border:1px solid var(--border); border-radius:8px; padding:5px; font-size:10px;"></textarea>
            <button class="btn" onclick="processRestore()" style="background:#2ecc71; margin-top:10px; width:100%;">Import Data</button>
            <button class="btn" onclick="closeRestore()" style="background:transparent; border:1px solid #888; color:#888; margin-top:5px; width:100%;">Cancel</button>
        </div>
    </div>

    <div class="container">
        <div class="header-ui">
            <div class="user-badge">
                <span id="uFullName">...</span>
                <span id="uID" class="user-id-tag">ID: 0</span>
            </div>
        </div>
        
        <img src="https://github.com/dhruvathaare/Scaslpel-Study-Squad-Apps/blob/main/photo_2026-02-12_20-08-36.jpg?raw=true" class="logo">
        <h1>Scalpel Study Squad</h1>

        <div class="exam-dashboard">
            <div class="exam-grid">
                <div class="exam-item">
                    <span id="daysIniJuly" class="exam-days">--</span>
                    <span class="exam-label">INICET JULY</span>
                </div>
                <div class="exam-item">
                    <span id="daysUpsc" class="exam-days">--</span>
                    <span class="exam-label">UPSC CMS</span>
                </div>
                <div class="exam-item">
                    <span id="daysNeet" class="exam-days">--</span>
                    <span class="exam-label">NEET PG 2026</span>
                </div>
                <div class="exam-item">
                    <span id="daysIniJan" class="exam-days">--</span>
                    <span class="exam-label">INICET JAN '27</span>
                </div>
            </div>
        </div>

        <div class="streak-section">
            <div id="streakText" class="streak-text">Consistency: 0 Days</div>
            <div id="streakIcons" style="font-size:24px; margin:5px 0;"></div>
            <div style="font-size:9px; color:#888;">üî• per 25 days | ü•á per 75 days</div>
        </div>
        <div class="quote">"I AM HERE TO WIN, CONSISTENCY IS MY KITH AND KIN"</div>

        <div class="nav-tabs">
            <div class="tab-btn" onclick="switchTab('tab-goal', this)">Goal</div>
            <div class="tab-btn active" onclick="switchTab('tab-daily', this)">Daily Analytics</div>
            <div class="tab-btn" onclick="switchTab('tab-swt', this)">SWT Analysis</div>
            <div class="tab-btn" onclick="switchTab('tab-gt', this)">GT Analysis</div>
        </div>

        <div id="tab-goal" class="tab-content">
            <div class="accordion-wrapper open" id="acc-target">
                <div class="accordion-header" onclick="toggleAccordion('acc-target')">Target Exams</div>
                <div class="accordion-content">
                    <div class="accordion-inner">
                        <div class="goal-row"><span>INICET July</span><input type="checkbox" id="goal_ini_jul" onchange="saveGoals()"></div>
                        <div class="goal-row"><span>UPSC CMS</span><input type="checkbox" id="goal_upsc" onchange="saveGoals()"></div>
                        <div class="goal-row"><span>NEET PG 2026</span><input type="checkbox" id="goal_neet" onchange="saveGoals()"></div>
                        <div class="goal-row"><span>INICET Jan '27</span><input type="checkbox" id="goal_ini_jan" onchange="saveGoals()"></div>
                        <button class="btn" style="background:#2ecc71; margin-top:10px; height:35px; line-height:35px; padding:0; font-size:12px;" onclick="saveExamTargets()">Save Targets</button>
                    </div>
                </div>
            </div>

            <div class="accordion-wrapper" id="acc-pyq">
                <div class="accordion-header" onclick="toggleAccordion('acc-pyq')">PYQ Papers Goal</div>
                <div class="accordion-content">
                    <div class="accordion-inner">
                        <div id="pyq-container"></div>
                    </div>
                </div>
            </div>

            <div class="accordion-wrapper" id="acc-phases">
                <div class="accordion-header" onclick="toggleAccordion('acc-phases')">Reading Phases</div>
                <div class="accordion-content">
                    <div class="accordion-inner" id="goal-phases-container"></div>
                </div>
            </div>
        </div>

        <div id="tab-daily" class="tab-content active">
            <div class="accordion-wrapper open" id="acc-radar">
                <div class="accordion-header" onclick="toggleAccordion('acc-radar')">Revision Radar</div>
                <div class="accordion-content">
                    <div class="accordion-inner">
                        <p style="font-size:10px; color:#aaa; margin:0;">Subjects neglected for >10 days (Orange) or >20 days (Red)</p>
                        <div id="radar-container" class="radar-grid"></div>
                        <div id="radar-empty" style="display:none; font-size:11px; color:#2ecc71; margin-top:10px;">All subjects revised recently! ‚úÖ</div>
                    </div>
                </div>
            </div>

            <div class="accordion-wrapper open" id="acc-timer">
                <div class="accordion-header" onclick="toggleAccordion('acc-timer')">Study Timer</div>
                <div class="accordion-content">
                    <div class="accordion-inner">
                        <span class="setting-label">Reading Phase</span>
                        <select id="studyPhase">
                            <option value="First Reading">First Reading</option>
                            <option value="Second Reading">Second Reading</option>
                            <option value="Third Reading">Third Reading</option>
                            <option value="Extra Bonus">Extra Bonus Reading</option>
                        </select>

                        <span class="setting-label">Subject</span>
                        <select id="subject">
                            <option value="" disabled selected>Select Subject</option>
                            <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option>
                            <option>Pathology</option><option>Microbiology</option><option>Pharmacology</option>
                            <option>FMT</option><option>PSM</option>
                            <option>Ophthalmology</option><option>ENT</option>
                            <option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option>
                            <option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option>
                            <option>Mixed Bag</option><option>Integrated Systems</option>
                        </select>
                        
                        <div style="display:flex; gap:10px; margin-top:8px; text-align:center;">
                            <div style="flex:2;">
                                <span class="setting-label" style="text-align:center;">Study Duration</span>
                                <div style="display:flex; gap:5px;">
                                    <div style="flex:1;"><input type="number" id="studyHr" value="2"><div class="sub-label">Hours</div></div>
                                    <div style="flex:1;"><input type="number" id="studyMin" value="0"><div class="sub-label">Minutes</div></div>
                                </div>
                            </div>
                            <div style="flex:1;">
                                <span class="setting-label" style="text-align:center;">Break</span>
                                <input type="number" id="breakTime" value="15">
                                <div class="sub-label">Minutes</div>
                            </div>
                        </div>

                        <div id="timer-display">00:00:00</div>
                        <button id="startBtn" class="btn" style="width:100%;">Start Session</button>
                        <div id="timer-controls" style="display:none; width:100%;">
                            <div style="display:flex; gap:8px;"><button id="pauseBtn" class="btn" style="background:#f39c12;flex:1;" onclick="togglePause()">Pause</button><button class="btn" style="background:#8e44ad;flex:1;" onclick="handleTransition()">Skip</button></div>
                            <button class="btn" style="background:#ef5350; margin-top:12px; width:100%;" onclick="stopEntireSession()">End Session</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="accordion-wrapper" id="acc-progress">
                <div class="accordion-header" onclick="toggleAccordion('acc-progress')">Daily Progress</div>
                <div class="accordion-content">
                    <div class="accordion-inner">
                        <div class="chart-container"><canvas id="hoursChart"></canvas></div>
                        <div class="chart-container"><canvas id="mcqChart"></canvas></div>
                        <table class="log-table">
                            <thead><tr><th class="col-date">Date</th><th class="col-hrs">Hrs</th><th class="col-cyc">Cyc</th><th class="col-mcq">MCQ</th><th class="col-sub">Subjects</th></tr></thead>
                            <tbody id="dailyLogBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="accordion-wrapper" id="acc-matrix">
                <div class="accordion-header" onclick="toggleAccordion('acc-matrix')">Phase Matrices</div>
                <div class="accordion-content">
                    <div class="accordion-inner">
                        <h3 style="margin:0 0 5px 0; color:#5288c1; font-size:14px; padding-top:10px;">Phase Matrix (Days Spent)</h3>
                        <div style="overflow-x:auto;">
                            <table class="matrix-table" id="readingMatrix">
                                <thead>
                                    <tr>
                                        <th style="text-align:left;">Subject</th>
                                        <th>1st</th>
                                        <th>2nd</th>
                                        <th>3rd</th>
                                        <th>Bonus</th>
                                    </tr>
                                </thead>
                                <tbody id="matrixBody"></tbody>
                            </table>
                        </div>

                        <h3 style="margin:15px 0 5px 0; color:#2ecc71; font-size:14px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">Phase Matrix (MCQs Solved)</h3>
                        <div style="overflow-x:auto;">
                            <table class="matrix-table" id="mcqMatrix">
                                <thead>
                                    <tr>
                                        <th style="text-align:left;">Subject</th>
                                        <th>1st</th>
                                        <th>2nd</th>
                                        <th>3rd</th>
                                        <th>Bonus</th>
                                    </tr>
                                </thead>
                                <tbody id="mcqMatrixBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-swt" class="tab-content">
            <div class="card">
                <h3>SWT Analysis</h3>
                <select id="swtSubject" onchange="renderSWT()"><option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option><option>Mixed Bag</option><option>Integrated Systems</option></select>
                <div style="display:flex; gap:5px; margin-top:8px;"><div style="flex:1.5;"><span class="setting-label">Date</span><input type="date" id="swtDate"></div><div style="flex:1;"><span class="setting-label">Total Qs</span><input type="number" id="swtTotal" oninput="calcSWT()"></div></div>
                <div style="display:flex; gap:5px; margin-top:5px;"><div style="flex:1;"><span class="setting-label">Correct</span><input type="number" id="swtCorrect" oninput="calcSWT()"></div><div style="flex:1;"><span class="setting-label">Unattempted</span><input type="number" id="swtUnat" oninput="calcSWT()"></div></div>
                <div class="calc-preview"><span>Wrong: <b id="swtW">0</b></span><span>Accuracy: <b id="swtP">0%</b></span></div>
                <button class="btn" onclick="saveSWT()" style="background:var(--accent); margin-top:10px; width:100%;">Save Result</button>
                
                <h4 style="color:#5288c1; margin:15px 0 5px 0; font-size:13px; text-align:left;">Subject Performance</h4>
                <div class="chart-container"><canvas id="swtChart"></canvas></div>
                <div id="swtAnalysis" style="font-size:11px; text-align:left; line-height:1.5; max-height:100px; overflow-y:auto;"></div>

                <h4 style="color:#f39c12; margin:20px 0 5px 0; font-size:13px; text-align:left; border-top:1px dashed rgba(255,255,255,0.1); padding-top:10px;">Cumulative Average Trend</h4>
                <div class="chart-container"><canvas id="swtTrendChart"></canvas></div>

                <div class="strong-weak-container">
                    <div class="stat-box" style="text-align:left;">
                        <span style="opacity:0.7;">Strongest</span>
                        <strong class="stat-strong" id="swtStrong">--</strong>
                        <span id="swtStrongVal">0%</span>
                    </div>
                    <div class="stat-box" style="text-align:right;">
                        <span style="opacity:0.7;">Weakest</span>
                        <strong class="stat-weak" id="swtWeak">--</strong>
                        <span id="swtWeakVal">0%</span>
                    </div>
                </div>

                <div id="swtReminder" class="reminder-box">
                    <span class="reminder-title">‚ö†Ô∏è Pending Subjects</span>
                    <div id="swtReminderList" class="reminder-list"></div>
                </div>
            </div>
        </div>

        <div id="tab-gt" class="tab-content">
            <div class="card">
                <h3>GT Intelligence</h3>
                <div style="display:flex; margin-bottom:10px;"><div class="gt-tab-btn active" id="tabNeet" style="flex:1; padding:10px; text-align:center; background:var(--border); font-size:10px; cursor:pointer;" onclick="switchGT('NEET')">NEET PG (+4/-1)</div><div class="gt-tab-btn" id="tabInicet" style="flex:1; padding:10px; text-align:center; background:rgba(0,0,0,0.2); font-size:10px; cursor:pointer;" onclick="switchGT('INICET')">INICET (+1/-0.33)</div></div>
                <div style="display:flex; gap:5px;"><div style="flex:1.5;"><span class="setting-label">Date</span><input type="date" id="gtDate"></div><div style="flex:1;"><span class="setting-label">Correct</span><input type="number" id="gtCorrect" oninput="calcGT()"></div><div style="flex:1;"><span class="setting-label">Unattempted</span><input type="number" id="gtUnat" oninput="calcGT()"></div></div>
                <div class="calc-preview"><span>Wrong: <b id="gtW">0</b></span><span>Score: <b id="gtS">0</b></span></div>
                <button class="btn" onclick="saveGT()" style="background:#2ecc71; margin-top:10px; width:100%;">Save Result</button>
                <div id="neet-area"><h4 style="color:#f39c12; margin-top:15px; font-size:13px;">NEET PG Progress</h4><div class="chart-container"><canvas id="gtNeetChart"></canvas></div><div id="gtNeetAnalysis" style="font-size:11px; text-align:left;"></div></div>
                <div id="inicet-area" style="display:none;"><h4 style="color:#2ecc71; margin-top:15px; font-size:13px;">INICET Progress</h4><div class="chart-container"><canvas id="gtInicetChart"></canvas></div><div id="gtInicetAnalysis" style="font-size:11px; text-align:left;"></div></div>
            </div>
        </div>

        <div class="danger-zone">
            <h3 style="color:#f39c12; margin:0 0 10px 0;">Data Safety</h3>
            <p style="font-size:10px; color:#aaa; line-height:1.4; margin-bottom:10px;">
                1. Tap <b>Backup</b> to copy your secret code.<br>
                2. Paste it in your Telegram <b>Saved Messages</b>.<br>
                3. Use <b>Restore</b> to load it back anytime.
            </p>
            <button class="backup-btn" onclick="exportData()">Backup Data (Copy Code)</button>
            <button class="restore-btn" onclick="openRestore()">Restore Data</button>
            <button class="clear-btn" onclick="clearData()">Clear All Local Data</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
        const tgUser = tg.initDataUnsafe?.user || { id: "OFFLINE", first_name: "Local", last_name: "User" };
        const fullName = `${tgUser.first_name || ""} ${tgUser.last_name || ""}`.trim();
        document.getElementById('uFullName').innerText = fullName || "Guest User";
        document.getElementById('uID').innerText = `ID: ${tgUser.id}`;

        const prefix = `SSS_PRO_V3_${tgUser.id}_`;
        const KEYS = { LOGS: prefix+'LOGS', NEET: prefix+'NEET', INI: prefix+'INI', SWT: prefix+'SWT', GOALS: prefix+'GOALS', PYQ: prefix+'PYQ' };
        
        const SUBJECTS_19 = [
            "Anatomy", "Physiology", "Biochemistry", "Pathology", "Microbiology", 
            "Pharmacology", "FMT", "PSM", "Ophthalmology", "ENT", "Medicine", 
            "Surgery", "OBG", "Pediatrics", "Anaesthesia", "Dermatology", 
            "Orthopedics", "Psychiatry", "Radiology"
        ];
        // For SWT Analysis including extras
        const SUBJECTS_ALL_SWT = [...SUBJECTS_19, "Mixed Bag", "Integrated Systems"];
        
        const PHASES_CONFIG = [
            { id: 'r1', name: '1. First Reading', badge: 'ü•â' },
            { id: 'r2', name: '2. Second Reading', badge: 'ü•à' },
            { id: 'r3', name: '3. Third Reading', badge: 'ü•á' },
            { id: 'r4', name: '4. Extra Bonus', badge: 'üèÜ' }
        ];

        // PYQ CONFIGURATION
        const PYQ_CATS = [
            { id: 'neet', name: 'NEET PG', type:'single', start:2025, end:2016 },
            { id: 'ini', name: 'INICET/AIIMS', type:'dual', start:2025, end:2014, c1:'May', c2:'Nov' },
            { id: 'fmge', name: 'FMGE', type:'dual', start:2025, end:2021, c1:'July', c2:'Dec' },
            { id: 'upsc', name: 'UPSC CMS', type:'single', start:2025, end:2021 }
        ];

        function toggleAccordion(id) {
            document.getElementById(id).classList.toggle('open');
        }

        function updateCountdowns() {
            const now = new Date();
            const dates = {
                iniJuly: new Date("2026-05-17"),
                upsc: new Date("2026-08-02"),
                neet: new Date("2026-08-30"),
                iniJan: new Date("2026-11-01")
            };
            
            Object.keys(dates).forEach(key => {
                const diff = dates[key] - now;
                const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
                const elementId = 'days' + key.charAt(0).toUpperCase() + key.slice(1);
                const el = document.getElementById(elementId);
                if(el) el.innerText = days > 0 ? days : "LIVE";
            });
        }
        updateCountdowns();

        function clearData() {
            if(confirm("Are you sure? This will delete all your streaks, charts, test logs, and goals on this device.")) {
                Object.values(KEYS).forEach(k => localStorage.removeItem(k));
                location.reload();
            }
        }

        let timerInterval, activeSub = "", activePhase = "", wakeLock = null, timeLeft = 0, mode = "idle", isPaused = false, currentGTMode = "NEET";

        const requestWakeLock = async () => { if ('wakeLock' in navigator) try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {} };
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep(f, d) { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value = f; g.gain.value = 0.1; o.start(); setTimeout(() => o.stop(), d); }
        let alarmInterval = null;
        function startAlarm(f) { stopAlarm(); alarmInterval = setInterval(() => playBeep(f, 200), 1000); }
        function stopAlarm() { if(alarmInterval) { clearInterval(alarmInterval); alarmInterval = null; } }

        function switchTab(id, btn) { document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active'); b.style.background = 'none'; }); btn.classList.add('active'); btn.style.background = 'var(--accent)'; document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(id).classList.add('active'); updateUI(); }

        document.getElementById('startBtn').onclick = () => { 
            if (!document.getElementById('subject').value) return tg.showAlert("Select Subject!"); 
            audioCtx.resume(); 
            requestWakeLock(); 
            activeSub = document.getElementById('subject').value; 
            activePhase = document.getElementById('studyPhase').value;
            startStudyTimer(); 
        };
        function startStudyTimer() { mode = "study"; isPaused = false; timeLeft = (parseInt(document.getElementById('studyHr').value)*3600) + (parseInt(document.getElementById('studyMin').value)*60); if(timeLeft <= 0) return; document.getElementById('startBtn').style.display='none'; document.getElementById('timer-controls').style.display='block'; runTimer(); }
        function togglePause() { isPaused = !isPaused; document.getElementById('pauseBtn').innerText = isPaused ? "Resume" : "Pause"; }
        
        function runTimer() { 
            clearInterval(timerInterval); 
            timerInterval = setInterval(() => { 
                if (!isPaused) { 
                    timeLeft--; 
                    let h=Math.floor(timeLeft/3600), m=Math.floor((timeLeft%3600)/60), s=timeLeft%60; 
                    document.getElementById('timer-display').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; 
                    if (timeLeft<=0) handleTransition(); 
                } 
            }, 1000); 
        }

        function handleTransition() { clearInterval(timerInterval); startAlarm(mode==="study"?880:440); document.getElementById('popup-overlay').style.display='flex'; document.getElementById('mcq-popup').style.display=mode==="study"?'block':'none'; document.getElementById('break-popup').style.display=mode==="study"?'none':'block'; }
        function startBreak() { stopAlarm(); const m = parseInt(document.getElementById('cycleMcqs').value)||0; saveStudyLog(activeSub, m, (parseInt(document.getElementById('studyHr').value)*60)+parseInt(document.getElementById('studyMin').value), activePhase); document.getElementById('cycleMcqs').value=''; document.getElementById('popup-overlay').style.display='none'; mode="break"; isPaused=false; timeLeft=parseInt(document.getElementById('breakTime').value)*60; runTimer(); }
        function continueNextCycle() { stopAlarm(); document.getElementById('popup-overlay').style.display = 'none'; startStudyTimer(); }
        function stopEntireSession() { stopAlarm(); clearInterval(timerInterval); if (wakeLock) { wakeLock.release(); wakeLock=null; } document.getElementById('popup-overlay').style.display='none'; document.getElementById('timer-display').innerText="00:00:00"; document.getElementById('startBtn').style.display='block'; document.getElementById('timer-controls').style.display='none'; mode="idle"; updateUI(); }

        function saveStudyLog(s, m, d, ph) { 
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]"); 
            logs.unshift({ date: new Date().toLocaleDateString('en-GB'), subject: s, mcqs: m, duration: d, phase: ph || "First Reading" }); 
            localStorage.setItem(KEYS.LOGS, JSON.stringify(logs)); 
        }

        // --- PYQ LOGIC ---
        function renderPYQ() {
            const container = document.getElementById('pyq-container');
            if(container.innerHTML !== "") return; // Render once

            PYQ_CATS.forEach(cat => {
                let html = `
                    <div class="pyq-header-bar" onclick="togglePYQ('${cat.id}')">
                        <span style="font-weight:bold; font-size:12px;">${cat.name}</span>
                        <span id="pyq_badge_${cat.id}" class="phase-badge">üèÜ</span>
                    </div>
                    <div id="pyq_content_${cat.id}" class="pyq-content">
                `;

                if (cat.type === 'single') {
                    html += `<div class="sub-grid">`;
                    for(let y=cat.start; y>=cat.end; y--) {
                        html += `
                            <label class="sub-check-item">
                                <input type="checkbox" id="pyq_${cat.id}_${y}" onchange="savePYQ()">
                                <span>${y}</span>
                            </label>`;
                    }
                    html += `</div>`;
                } else {
                    html += `<div class="pyq-col-container">
                        <div>
                            <div class="pyq-col-header">${cat.c1} Session</div>
                            <div style="display:flex; flex-direction:column; gap:8px;">`;
                            for(let y=cat.start; y>=cat.end; y--) {
                                html += `<label class="sub-check-item"><input type="checkbox" id="pyq_${cat.id}_${y}_1" onchange="savePYQ()"> <span>${y}</span></label>`;
                            }
                    html += `</div></div>
                        <div>
                            <div class="pyq-col-header">${cat.c2} Session</div>
                            <div style="display:flex; flex-direction:column; gap:8px;">`;
                            for(let y=cat.start; y>=cat.end; y--) {
                                html += `<label class="sub-check-item"><input type="checkbox" id="pyq_${cat.id}_${y}_2" onchange="savePYQ()"> <span>${y}</span></label>`;
                            }
                    html += `</div></div></div>`;
                }
                html += `</div>`;
                container.innerHTML += html;
            });
            loadPYQ();
        }

        function togglePYQ(id) {
            document.getElementById(`pyq_content_${id}`).classList.toggle('open');
        }

        function savePYQ() {
            const data = {};
            PYQ_CATS.forEach(cat => {
                data[cat.id] = {};
                if(cat.type === 'single') {
                    for(let y=cat.start; y>=cat.end; y--) {
                        data[cat.id][y] = document.getElementById(`pyq_${cat.id}_${y}`).checked;
                    }
                } else {
                    for(let y=cat.start; y>=cat.end; y--) {
                        data[cat.id][`${y}_1`] = document.getElementById(`pyq_${cat.id}_${y}_1`).checked;
                        data[cat.id][`${y}_2`] = document.getElementById(`pyq_${cat.id}_${y}_2`).checked;
                    }
                }
            });
            localStorage.setItem(KEYS.PYQ, JSON.stringify(data));
            checkPYQMedals(data);
        }

        function loadPYQ() {
            const data = JSON.parse(localStorage.getItem(KEYS.PYQ)) || {};
            PYQ_CATS.forEach(cat => {
                if(!data[cat.id]) return;
                if(cat.type === 'single') {
                    for(let y=cat.start; y>=cat.end; y--) {
                        const el = document.getElementById(`pyq_${cat.id}_${y}`);
                        if(el) el.checked = data[cat.id][y] || false;
                    }
                } else {
                    for(let y=cat.start; y>=cat.end; y--) {
                        const el1 = document.getElementById(`pyq_${cat.id}_${y}_1`);
                        const el2 = document.getElementById(`pyq_${cat.id}_${y}_2`);
                        if(el1) el1.checked = data[cat.id][`${y}_1`] || false;
                        if(el2) el2.checked = data[cat.id][`${y}_2`] || false;
                    }
                }
            });
            checkPYQMedals(data);
        }

        function checkPYQMedals(data) {
            if(!data) return;
            PYQ_CATS.forEach(cat => {
                const catData = data[cat.id] || {};
                let allDone = true;
                if(cat.type === 'single') {
                    for(let y=cat.start; y>=cat.end; y--) {
                        if(!catData[y]) { allDone = false; break; }
                    }
                } else {
                    for(let y=cat.start; y>=cat.end; y--) {
                        if(!catData[`${y}_1`] || !catData[`${y}_2`]) { allDone = false; break; }
                    }
                }
                const badge = document.getElementById(`pyq_badge_${cat.id}`);
                if(allDone) badge.classList.add('unlocked');
                else badge.classList.remove('unlocked');
            });
        }

        // --- DATA BACKUP SYSTEM (MAGIC COPY) ---
        function exportData() {
            const backup = {};
            Object.keys(KEYS).forEach(k => {
                backup[k] = localStorage.getItem(KEYS[k]);
            });
            const code = btoa(JSON.stringify(backup));
            
            navigator.clipboard.writeText(code).then(() => {
                alert("Backup Code Copied! Paste it in Telegram Saved Messages.");
            }).catch(err => {
                alert("Failed to copy. Please allow clipboard permissions.");
            });
        }

        function openRestore() {
            document.getElementById('popup-overlay').style.display='flex';
            document.getElementById('restore-popup').style.display='block';
            document.getElementById('mcq-popup').style.display='none';
            document.getElementById('break-popup').style.display='none';
        }

        function closeRestore() {
            document.getElementById('popup-overlay').style.display='none';
            document.getElementById('restore-popup').style.display='none';
        }

        function processRestore() {
            const input = document.getElementById('restoreInput').value.trim();
            if(!input) return alert("Please paste the code first.");
            
            try {
                const decoded = atob(input);
                const data = JSON.parse(decoded);
                
                if(!data || typeof data !== 'object') throw new Error("Invalid Format");

                if(confirm("Warning: This will OVERWRITE all current data on this device. Are you sure?")) {
                    Object.keys(data).forEach(k => {
                        if(Object.values(KEYS).includes(k)) {
                            localStorage.setItem(k, data[k]);
                        }
                    });
                    alert("Data Restored Successfully!");
                    location.reload();
                }
            } catch(e) {
                alert("Invalid Code! Please copy the exact code from your backup.");
            }
        }


        // --- GOAL MANAGEMENT ---
        function renderGoalHTML() {
            const container = document.getElementById('goal-phases-container');
            container.innerHTML = ``;
            
            PHASES_CONFIG.forEach((p, idx) => {
                const div = document.createElement('div');
                div.className = 'phase-block';
                div.id = `phase_block_${idx}`;
                div.innerHTML = `
                    <div class="phase-header">
                        <span class="phase-title">${p.name}</span>
                        <span id="badge_${idx}" class="phase-badge">${p.badge}</span>
                    </div>
                    <div class="date-grid">
                        <div><span class="setting-label">From</span><input type="date" id="date_${idx}_from" onchange="saveGoals()"></div>
                        <div><span class="setting-label">To</span><input type="date" id="date_${idx}_to" onchange="saveGoals()"></div>
                    </div>
                    <div id="days_${idx}" class="days-calc">0 Days</div>
                    
                    <button class="btn sm-btn" style="margin-top:8px; background:rgba(255,255,255,0.1); width:100%;" onclick="toggleSubGrid(${idx})">Show/Hide Subjects</button>
                    
                    <div id="sub_grid_${idx}" class="sub-grid-container">
                        <div class="sub-grid">
                            ${SUBJECTS_19.map((s, sIdx) => `
                                <label class="sub-check-item">
                                    <input type="checkbox" id="chk_${idx}_${sIdx}" onchange="saveGoals()">
                                    <span>${s.substring(0,4)}..</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <div class="target-row">
                        <div style="flex:1;">
                            <span class="setting-label">Target SWTs</span>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <input type="number" id="swt_target_${idx}" placeholder="0" oninput="saveGoals()">
                                <input type="checkbox" id="swt_done_${idx}" onchange="saveGoals()">
                            </div>
                        </div>
                        <div style="flex:1;">
                            <span class="setting-label">Target GTs</span>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <input type="number" id="gt_target_${idx}" placeholder="0" oninput="saveGoals()">
                                <input type="checkbox" id="gt_done_${idx}" onchange="saveGoals()">
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            loadGoalsToUI();
        }

        function toggleSubGrid(idx) {
            document.getElementById(`sub_grid_${idx}`).classList.toggle('open');
        }

        function saveExamTargets() {
            saveGoals();
            alert("Target Exams Locked & Saved!");
        }

        function saveGoals() {
            const goals = {
                exams: {
                    ini_jul: document.getElementById('goal_ini_jul').checked,
                    upsc: document.getElementById('goal_upsc').checked,
                    neet: document.getElementById('goal_neet').checked,
                    ini_jan: document.getElementById('goal_ini_jan').checked,
                },
                phases: PHASES_CONFIG.map((_, idx) => {
                    const subjects = {};
                    SUBJECTS_19.forEach((s, sIdx) => {
                        subjects[sIdx] = document.getElementById(`chk_${idx}_${sIdx}`).checked;
                    });
                    
                    return {
                        from: document.getElementById(`date_${idx}_from`).value,
                        to: document.getElementById(`date_${idx}_to`).value,
                        subjects: subjects,
                        swtTarget: document.getElementById(`swt_target_${idx}`).value,
                        swtDone: document.getElementById(`swt_done_${idx}`).checked,
                        gtTarget: document.getElementById(`gt_target_${idx}`).value,
                        gtDone: document.getElementById(`gt_done_${idx}`).checked
                    };
                })
            };
            localStorage.setItem(KEYS.GOALS, JSON.stringify(goals));
            checkMedals(goals);
        }

        function loadGoalsToUI() {
            const goals = JSON.parse(localStorage.getItem(KEYS.GOALS)) || { exams:{}, phases:[] };
            document.getElementById('goal_ini_jul').checked = goals.exams.ini_jul || false;
            document.getElementById('goal_upsc').checked = goals.exams.upsc || false;
            document.getElementById('goal_neet').checked = goals.exams.neet || false;
            document.getElementById('goal_ini_jan').checked = goals.exams.ini_jan || false;

            PHASES_CONFIG.forEach((_, idx) => {
                const data = goals.phases[idx] || {};
                document.getElementById(`date_${idx}_from`).value = data.from || "";
                document.getElementById(`date_${idx}_to`).value = data.to || "";
                
                const subData = data.subjects || {};
                SUBJECTS_19.forEach((s, sIdx) => {
                    document.getElementById(`chk_${idx}_${sIdx}`).checked = subData[sIdx] || false;
                });

                document.getElementById(`swt_target_${idx}`).value = data.swtTarget || "";
                document.getElementById(`swt_done_${idx}`).checked = data.swtDone || false;
                document.getElementById(`gt_target_${idx}`).value = data.gtTarget || "";
                document.getElementById(`gt_done_${idx}`).checked = data.gtDone || false;

                if(data.from && data.to) {
                    const start = new Date(data.from);
                    const end = new Date(data.to);
                    const diff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                    document.getElementById(`days_${idx}`).innerText = diff >= 0 ? `${diff} Days` : "Invalid Date";
                }
            });
            checkMedals(goals);
        }

        function checkMedals(goals) {
            if(!goals || !goals.phases) return;
            PHASES_CONFIG.forEach((_, idx) => {
                const data = goals.phases[idx];
                if (!data) return;
                const subData = data.subjects || {};
                let allSubjectsDone = true;
                for(let i=0; i<SUBJECTS_19.length; i++) {
                    if(!subData[i]) { allSubjectsDone = false; break; }
                }
                const isComplete = allSubjectsDone && data.swtDone && data.gtDone;
                const badge = document.getElementById(`badge_${idx}`);
                const block = document.getElementById(`phase_block_${idx}`);
                if(isComplete) {
                    badge.classList.add('unlocked');
                    block.classList.add('completed');
                } else {
                    badge.classList.remove('unlocked');
                    block.classList.remove('completed');
                }
            });
        }

        // --- REVISION RADAR ---
        function renderRevisionRadar() {
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS) || "[]");
            const lastStudied = {};
            const today = new Date();
            today.setHours(0,0,0,0);

            SUBJECTS_19.forEach(s => lastStudied[s] = null);

            logs.forEach(l => {
                if (!SUBJECTS_19.includes(l.subject)) return;
                // Parse DD/MM/YYYY
                const parts = l.date.split('/'); 
                const logDate = new Date(parts[2], parts[1]-1, parts[0]);
                
                if (!lastStudied[l.subject] || logDate > lastStudied[l.subject]) {
                    lastStudied[l.subject] = logDate;
                }
            });

            const neglected = [];
            SUBJECTS_19.forEach(s => {
                let days = 999;
                if (lastStudied[s]) {
                    const diffTime = Math.abs(today - lastStudied[s]);
                    days = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                }
                // Only show if > 10 days
                if(days > 10) neglected.push({ subject: s, days: days });
            });

            neglected.sort((a, b) => b.days - a.days);

            const container = document.getElementById('radar-container');
            const emptyMsg = document.getElementById('radar-empty');
            
            if(neglected.length === 0) {
                container.innerHTML = "";
                emptyMsg.style.display = 'block';
            } else {
                emptyMsg.style.display = 'none';
                let html = "";
                neglected.forEach(n => {
                    const isCrit = n.days > 20;
                    const cssClass = isCrit ? 'radar-crit' : 'radar-warn';
                    const dayText = n.days === 999 ? "NEVER" : `${n.days}d`;
                    html += `<div class="radar-item ${cssClass}"><span>${n.subject}</span><span class="radar-days">${dayText}</span></div>`;
                });
                container.innerHTML = html;
            }
        }

        function updateUI() { 
            renderData(); renderSWT(); renderGT(); updateConsistency(); 
            renderMatrix(); renderMCQMatrix(); renderPYQ(); renderRevisionRadar(); 
        }
        
        function updateConsistency() { const logs = JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]"); const unique = new Set(logs.map(l => l.date)).size; document.getElementById('streakText').innerText = `Consistency: ${unique} Days`; const medals = Math.floor(unique / 75), fires = Math.floor((unique % 75) / 25); document.getElementById('streakIcons').innerText = "ü•á".repeat(medals) + "üî•".repeat(fires); }
        function calcSWT() { const t=parseInt(document.getElementById('swtTotal').value)||0, c=parseInt(document.getElementById('swtCorrect').value)||0, u=parseInt(document.getElementById('swtUnat').value)||0; document.getElementById('swtW').innerText=Math.max(0, t-c-u); document.getElementById('swtP').innerText=t>0?((c/t)*100).toFixed(1)+"%":"0%"; }
        function calcGT() { const c=parseInt(document.getElementById('gtCorrect').value)||0, u=parseInt(document.getElementById('gtUnat').value)||0; const w = Math.max(0, 200 - c - u); const s = (currentGTMode === 'NEET') ? (c * 4 - w) : (c - (w * 0.333)); document.getElementById('gtW').innerText = w; document.getElementById('gtS').innerText = s.toFixed(currentGTMode==='NEET'?0:2); }

        function saveSWT() {
            const dStr=document.getElementById('swtDate').value;
            if(!dStr) return;

            // Security Check: No Future Dates
            const selectedDate = new Date(dStr);
            const today = new Date();
            selectedDate.setHours(0,0,0,0);
            today.setHours(0,0,0,0);

            if(selectedDate > today) {
                alert("Future dates are not allowed!");
                return;
            }

            const t=parseInt(document.getElementById('swtTotal').value), c=parseInt(document.getElementById('swtCorrect').value), u=parseInt(document.getElementById('swtUnat').value), sub=document.getElementById('swtSubject').value;
            if(isNaN(t)) return;
            const data = JSON.parse(localStorage.getItem(KEYS.SWT)||"[]");
            data.push({ date: dStr, total: t, correct: c, unat: u, wrong: Math.max(0, t-c-u), percent: ((c/t)*100).toFixed(1), subject: sub });
            data.sort((a,b)=>new Date(a.date)-new Date(b.date)); localStorage.setItem(KEYS.SWT, JSON.stringify(data)); updateUI();
        }

        function saveGT() {
            const dStr=document.getElementById('gtDate').value;
            if(!dStr) return;

            // Security Check: No Future Dates
            const selectedDate = new Date(dStr);
            const today = new Date();
            selectedDate.setHours(0,0,0,0);
            today.setHours(0,0,0,0);

            if(selectedDate > today) {
                alert("Future dates are not allowed!");
                return;
            }

            const c=parseInt(document.getElementById('gtCorrect').value), u=parseInt(document.getElementById('gtUnat').value);
            const w = Math.max(0, 200 - c - u); const score = parseFloat(((currentGTMode === 'NEET') ? (c * 4 - w) : (c - (w * 0.333))).toFixed(2));
            const data = JSON.parse(localStorage.getItem(currentGTMode === 'NEET' ? KEYS.NEET : KEYS.INI)||"[]");
            data.push({ date: dStr, score, correct: c, unat: u, wrong: w });
            data.sort((a,b)=>new Date(a.date)-new Date(b.date)); localStorage.setItem(currentGTMode === 'NEET' ? KEYS.NEET : KEYS.INI, JSON.stringify(data)); updateUI();
        }

        function switchGT(m) { 
            currentGTMode = m; document.querySelectorAll('.gt-tab-btn').forEach(b => b.style.background = 'rgba(0,0,0,0.2)');
            document.getElementById(m==='NEET'?'tabNeet':'tabInicet').style.background = 'var(--border)';
            document.getElementById('neet-area').style.display = m==='NEET'?'block':'none';
            document.getElementById('inicet-area').style.display = m==='INICET'?'block':'none';
            calcGT(); renderGT(); 
        }

        let hChart, mChart, gNeetChart, gIniChart, sChart, sTrendChart;
        function renderData() {
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]");
            const grouped = {};
            logs.forEach(l => { if (!grouped[l.date]) grouped[l.date] = {h:0, m:0, subs:new Set(), cyc:0}; grouped[l.date].h += l.duration/60; grouped[l.date].m += l.mcqs; grouped[l.date].subs.add(l.subject); grouped[l.date].cyc++; });
            const labels = Object.keys(grouped).reverse().slice(-7);
            const hours = labels.map(l => grouped[l].h), mcqs = labels.map(l => grouped[l].m);
            const avgH = hours.length ? (hours.reduce((a,b)=>a+b,0)/hours.length).toFixed(1) : 0;
            const avgM = mcqs.length ? Math.round(mcqs.reduce((a,b)=>a+b,0)/mcqs.length) : 0;
            if(hChart) hChart.destroy(); hChart = new Chart(document.getElementById('hoursChart'), { type:'line', data:{labels, datasets:[{label:'Hours', data:hours, borderColor:'#f39c12', tension:0.3}]}, options:{maintainAspectRatio:false, scales:{y:{ticks:{color:'#fff', callback:v=>v+'h'}}}, plugins:{annotation:{annotations:{l1:{type:'line', yMin:avgH, yMax:avgH, borderColor:'rgba(255,255,255,0.3)', borderDash:[5,5]}}}}}});
            if(mChart) mChart.destroy(); mChart = new Chart(document.getElementById('mcqChart'), { type:'line', data:{labels, datasets:[{label:'MCQs', data:mcqs, borderColor:'#5288c1', tension:0.3}]}, options:{maintainAspectRatio:false, scales:{y:{ticks:{color:'#fff', stepSize:1}}}, plugins:{annotation:{annotations:{l1:{type:'line', yMin:avgM, yMax:avgM, borderColor:'rgba(255,255,255,0.3)', borderDash:[5,5]}}}}}});
            let html = ""; Object.keys(grouped).reverse().forEach(d => { html += `<tr><td>${d}</td><td>${grouped[d].h.toFixed(1)}h</td><td>${grouped[d].cyc}</td><td>${grouped[d].m}</td><td>${Array.from(grouped[d].subs).join(', ')}</td></tr>`; });
            document.getElementById('dailyLogBody').innerHTML = html;
        }

        function renderSWT() {
            const allSwts = JSON.parse(localStorage.getItem(KEYS.SWT)||"[]");
            const sub = document.getElementById('swtSubject').value; 
            const filtered = allSwts.filter(x => x.subject === sub);
            
            // 1. Individual Subject Chart
            if(sChart) sChart.destroy(); 
            if(filtered.length > 0) {
                sChart = new Chart(document.getElementById('swtChart'), { type:'line', data:{labels:filtered.map(x=>x.date), datasets:[{label:sub+'%', data:filtered.map(x=>x.percent), borderColor:'#5288c1', tension:0.3}]}, options:{maintainAspectRatio:false, scales:{y:{min:0, max:100, ticks:{color:'#fff'}}}}});
                document.getElementById('swtAnalysis').innerHTML = filtered.map(x => `‚Ä¢ ${x.date}: <b>${x.percent}%</b> (C:${x.correct} W:${x.wrong} U:${x.unat})`).reverse().join('<br>');
            } else {
                document.getElementById('swtAnalysis').innerHTML = "No tests recorded for this subject.";
            }

            // 2. Cumulative Trend Chart (All Subjects)
            if(sTrendChart) sTrendChart.destroy();
            if(allSwts.length > 0) {
                // Sort by date for proper trend
                const sortedAll = [...allSwts].sort((a,b) => new Date(a.date) - new Date(b.date));
                const trendLabels = sortedAll.map(x => x.date);
                
                // Calculate Cumulative Average at each point
                let sum = 0;
                const trendData = sortedAll.map((x, i) => {
                    sum += parseFloat(x.percent);
                    return (sum / (i + 1)).toFixed(1);
                });

                sTrendChart = new Chart(document.getElementById('swtTrendChart'), { 
                    type:'line', 
                    data:{
                        labels: trendLabels, 
                        datasets:[{
                            label:'Cumulative Avg %', 
                            data: trendData, 
                            borderColor:'#f39c12', 
                            backgroundColor:'rgba(243, 156, 18, 0.1)',
                            fill: true,
                            tension:0.4,
                            pointRadius: 2
                        }]
                    }, 
                    options:{
                        maintainAspectRatio:false, 
                        scales:{y:{min:0, max:100, ticks:{color:'#fff'}}},
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // 3. Strong vs Weak Analysis
            if(allSwts.length > 0) {
                const subPerf = {};
                allSwts.forEach(log => {
                    if(!subPerf[log.subject]) subPerf[log.subject] = { sum:0, count:0 };
                    subPerf[log.subject].sum += parseFloat(log.percent);
                    subPerf[log.subject].count++;
                });
                
                let maxAvg = -1, minAvg = 101, strongSub = "--", weakSub = "--";
                Object.keys(subPerf).forEach(s => {
                    const avg = subPerf[s].sum / subPerf[s].count;
                    if(avg > maxAvg) { maxAvg = avg; strongSub = s; }
                    if(avg < minAvg) { minAvg = avg; weakSub = s; }
                });

                document.getElementById('swtStrong').innerText = strongSub;
                document.getElementById('swtStrongVal').innerText = maxAvg.toFixed(1) + "%";
                document.getElementById('swtWeak').innerText = weakSub;
                document.getElementById('swtWeakVal').innerText = minAvg.toFixed(1) + "%";
            }

            // 4. Missing Subjects Reminder
            const attemptedSubs = new Set(allSwts.map(x => x.subject));
            const missing = SUBJECTS_ALL_SWT.filter(s => !attemptedSubs.has(s));
            const remBox = document.getElementById('swtReminder');
            if(missing.length > 0) {
                remBox.style.display = 'block';
                document.getElementById('swtReminderList').innerText = missing.join(", ");
            } else {
                remBox.style.display = 'none';
            }
        }

        function renderMatrix() {
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]");
            const subjects = Array.from(document.getElementById('subject').options)
                                 .map(o=>o.value)
                                 .filter(v => v && v !== "Mixed Bag" && v !== "Integrated Systems");
            const mapKey = { "First Reading": 0, "Second Reading": 1, "Third Reading": 2, "Extra Bonus": 3 };
            const matrix = {};
            subjects.forEach(s => matrix[s] = [new Set(), new Set(), new Set(), new Set()]);

            logs.forEach(l => {
                const s = l.subject; const p = l.phase || "First Reading"; const idx = mapKey[p];
                if (matrix[s] && idx !== undefined) matrix[s][idx].add(l.date);
            });

            const tbody = document.getElementById('matrixBody'); tbody.innerHTML = "";
            const colTotals = [0, 0, 0, 0];
            subjects.forEach(s => {
                const days = matrix[s].map(set => set.size);
                days.forEach((d, i) => colTotals[i] += d);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="matrix-row-head">${s}</td>` + days.map(d => `<td>${d > 0 ? d : '-'}</td>`).join('');
                tbody.appendChild(tr);
            });
            const trTotal = document.createElement('tr');
            trTotal.innerHTML = `<td class="matrix-total">TOTAL DAYS</td>` + colTotals.map(d => `<td class="matrix-total">${d}</td>`).join('');
            tbody.appendChild(trTotal);
        }

        function renderMCQMatrix() {
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]");
            const subjects = Array.from(document.getElementById('subject').options)
                                 .map(o=>o.value)
                                 .filter(v => v && v !== "Mixed Bag" && v !== "Integrated Systems");
            const mapKey = { "First Reading": 0, "Second Reading": 1, "Third Reading": 2, "Extra Bonus": 3 };
            const matrix = {}; // Store MCQs count
            subjects.forEach(s => matrix[s] = [0, 0, 0, 0]);

            logs.forEach(l => {
                const s = l.subject; const p = l.phase || "First Reading"; const idx = mapKey[p];
                const m = parseInt(l.mcqs) || 0;
                if (matrix[s] && idx !== undefined) matrix[s][idx] += m;
            });

            const tbody = document.getElementById('mcqMatrixBody'); tbody.innerHTML = "";
            const colTotals = [0, 0, 0, 0];
            subjects.forEach(s => {
                const counts = matrix[s];
                counts.forEach((c, i) => colTotals[i] += c);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="matrix-row-head">${s}</td>` + counts.map(c => `<td>${c > 0 ? c : '-'}</td>`).join('');
                tbody.appendChild(tr);
            });
            const trTotal = document.createElement('tr');
            trTotal.innerHTML = `<td class="matrix-total">TOTAL MCQs</td>` + colTotals.map(c => `<td class="matrix-total">${c}</td>`).join('');
            tbody.appendChild(trTotal);
        }

        renderGoalHTML();
        updateUI();
    </script>
</body>
</html>

