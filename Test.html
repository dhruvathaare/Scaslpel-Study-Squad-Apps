<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Scalpel Master Pro V6.2</title>

<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap" rel="stylesheet">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>

<style>
/* ===== YOUR NEW VERSION CSS â€” UNCHANGED ===== */
:root { --bg:#0e1621; --card:#17212b; --text:#fff; --border:#2b5278; --accent:#5288c1; --input-bg:#0e1621; }
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
.container{max-width:420px;margin:auto;padding:15px}
.logo{width:85px;height:85px;border-radius:50%;border:4px solid var(--accent);box-shadow:0 0 15px rgba(82,136,193,.3)}
.card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:12px;margin-bottom:15px}
.setting-label{font-size:9px;color:#888;text-transform:uppercase;font-weight:bold;text-align:left}
input,select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--input-bg);color:#fff}
.btn{background:#2481cc;color:#fff;border:none;padding:15px;border-radius:12px;font-weight:bold;width:100%}
#timer-display{font-size:52px;font-weight:bold;text-align:center}
.log-table{width:100%;font-size:10px;border-collapse:collapse}
.log-table td,.log-table th{padding:6px;border-bottom:1px solid rgba(255,255,255,.05)}
.chart-container{height:160px}
</style>
</head>

<body>

<div id="popup-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:2000;align-items:center;justify-content:center;flex-direction:column">
  <div class="card" id="mcq-popup">
    <h3>Cycle Complete</h3>
    <input type="number" id="cycleMcqs" placeholder="MCQs">
    <button class="btn" onclick="startBreak()">Record & Start Break</button>
  </div>
  <div class="card" id="break-popup" style="display:none">
    <h3>Break Finished</h3>
    <button class="btn" onclick="continueNextCycle()">Start Next Cycle</button>
    <button class="btn" onclick="stopEntireSession()" style="background:#ef5350">End Session</button>
  </div>
</div>

<div class="container">

<img src="https://github.com/dhruvathaare/Scaslpel-Study-Squad-Apps/blob/main/photo_2026-02-12_20-08-36.jpg?raw=true" class="logo">

<div class="card">
  <span class="setting-label">Subject</span>
  <select id="subject">
    <option disabled selected>Select Subject</option>
    <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option>
    <option>Pathology</option><option>Microbiology</option><option>Pharmacology</option>
    <option>FMT</option><option>PSM</option><option>Medicine</option><option>Surgery</option>
  </select>

  <div style="display:flex;gap:5px;margin-top:8px">
    <input type="number" id="studyHr" value="2">
    <input type="number" id="studyMin" value="0">
    <input type="number" id="breakTime" value="15">
  </div>

  <div id="timer-display">00:00:00</div>
  <button id="startBtn" class="btn">Start Session</button>

  <div id="timer-controls" style="display:none">
    <button class="btn" onclick="togglePause()">Pause</button>
    <button class="btn" onclick="handleTransition()" style="background:#8e44ad">Skip</button>
    <button class="btn" onclick="stopEntireSession()" style="background:#ef5350">End</button>
  </div>
</div>

<div class="card">
  <h3>Daily Progress</h3>
  <div class="chart-container"><canvas id="hoursChart"></canvas></div>
  <div class="chart-container"><canvas id="mcqChart"></canvas></div>

  <table class="log-table">
    <thead>
      <tr><th>Date</th><th>Hrs</th><th>Cyc</th><th>MCQ</th><th>Subjects</th></tr>
    </thead>
    <tbody id="dailyLogBody"></tbody>
  </table>
</div>

</div>

<script>
/* ================= TELEGRAM ================= */
const tg = window.Telegram.WebApp;
tg.ready(); tg.expand();

/* ================= STORAGE ================= */
const prefix = "SSS_PRO_V3_"+(tg.initDataUnsafe?.user?.id||"OFFLINE")+"_";
const KEYS = { LOGS: prefix+"LOGS" };

/* ================= TIMER (RESTORED) ================= */
let timerInterval,timeLeft=0,isPaused=false,mode="idle",activeSub="";

startBtn.onclick=()=>{
  if(!subject.value) return tg.showAlert("Select subject");
  activeSub=subject.value;
  mode="study";
  isPaused=false;
  timeLeft=(+studyHr.value*3600)+(+studyMin.value*60);
  startBtn.style.display="none";
  timer-controls.style.display="block";
  runTimer();
};

function runTimer(){
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    if(isPaused) return;
    timeLeft--;
    let h=Math.floor(timeLeft/3600),m=Math.floor(timeLeft%3600/60),s=timeLeft%60;
    timer-display.innerText=`${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
    if(timeLeft<=0) handleTransition();
  },1000);
}

function togglePause(){
  isPaused=!isPaused;
}

function handleTransition(){
  clearInterval(timerInterval);
  popup-overlay.style.display="flex";
  mcq-popup.style.display=mode==="study"?"block":"none";
  break-popup.style.display=mode==="study"?"none":"block";
}

function startBreak(){
  saveStudyLog(activeSub,+cycleMcqs.value||0,(+studyHr.value*60)+(+studyMin.value));
  cycleMcqs.value="";
  popup-overlay.style.display="none";
  mode="break";
  timeLeft=+breakTime.value*60;
  runTimer();
}

function continueNextCycle(){
  popup-overlay.style.display="none";
  startBtn.onclick();
}

function stopEntireSession(){
  clearInterval(timerInterval);
  popup-overlay.style.display="none";
  timer-display.innerText="00:00:00";
  startBtn.style.display="block";
  timer-controls.style.display="none";
  renderData();
}

/* ================= DAILY ANALYTICS (RESTORED) ================= */
let hChart,mChart;

function saveStudyLog(sub,mcq,dur){
  const logs=JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]");
  logs.unshift({date:new Date().toLocaleDateString("en-GB"),subject:sub,mcqs:mcq,duration:dur});
  localStorage.setItem(KEYS.LOGS,JSON.stringify(logs));
}

function renderData(){
  const logs=JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]");
  const g={};
  logs.forEach(l=>{
    if(!g[l.date]) g[l.date]={h:0,m:0,subs:new Set(),c:0};
    g[l.date].h+=l.duration/60;
    g[l.date].m+=l.mcqs;
    g[l.date].subs.add(l.subject);
    g[l.date].c++;
  });

  const labels=Object.keys(g).reverse().slice(-7);
  const hrs=labels.map(d=>g[d].h);
  const mcqs=labels.map(d=>g[d].m);

  if(hChart) hChart.destroy();
  hChart=new Chart(hoursChart,{type:"line",data:{labels,datasets:[{data:hrs,borderColor:"#f39c12"}]},options:{maintainAspectRatio:false}});

  if(mChart) mChart.destroy();
  mChart=new Chart(mcqChart,{type:"line",data:{labels,datasets:[{data:mcqs,borderColor:"#5288c1"}]},options:{maintainAspectRatio:false}});

  dailyLogBody.innerHTML=labels.map(d=>`
    <tr>
      <td>${d}</td>
      <td>${g[d].h.toFixed(1)}</td>
      <td>${g[d].c}</td>
      <td>${g[d].m}</td>
      <td>${[...g[d].subs].join(", ")}</td>
    </tr>`).join("");
}

renderData();
</script>

</body>
</html>
