<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Scalpel Study Squad V3 Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getDatabase, ref, set, get, update, onValue, child, query, orderByChild, limitToLast } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAsS-REPLACE_WITH_YOUR_KEY",
        authDomain: "sss-pro-v3.firebaseapp.com",
        databaseURL: "https://sss-pro-v3-default-rtdb.firebaseio.com",
        projectId: "sss-pro-v3",
        storageBucket: "sss-pro-v3.appspot.com",
        messagingSenderId: "123456789",
        appId: "1:123456789:web:abcdef"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // GLOBALS FOR MODULE ACCESS
      window.db = db;
      window.ref = ref;
      window.set = set;
      window.get = get;
      window.update = update;
      window.child = child;
      window.query = query;
      window.orderByChild = orderByChild;
      window.limitToLast = limitToLast;

      // USER AUTH MAPPING
      const user = window.Telegram.WebApp.initDataUnsafe?.user;
      window.userId = user ? user.id.toString() : "OFFLINE";
      window.userName = user ? (user.first_name + (user.last_name ? " " + user.last_name : "")) : "Guest Doctor";
      // --- 1. PERSONAL BACKUP SYNC ---
      window.syncToCloud = function() {
          const dataToSync = {};
          const keysToBackup = ['LOGS', 'NEET', 'INI', 'FMGE', 'SWT', 'GOALS', 'PYQ', 'TOUGH', 'FACTS', 'SWT_MISTAKES', 'GT_MISTAKES'];
          
          keysToBackup.forEach(key => {
              const prefix = `SSS_PRO_V3_${window.userId}_`;
              const localVal = localStorage.getItem(prefix + key);
              if (localVal) dataToSync[key] = JSON.parse(localVal);
          });

          if (window.userId !== "OFFLINE") {
              const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
              const statusEl = document.getElementById('cloud-sync-status');
              if(statusEl) statusEl.innerText = "Syncing...";

              window.set(window.ref(window.db, 'users/' + window.userId), dataToSync)
              .then(() => {
                  console.log("Auto-Sync Successful: " + now);
                  if(statusEl) {
                      statusEl.innerText = "Cloud: Online " + now + " ‚úÖ";
                      statusEl.style.color = "#2ecc71";
                  }
                  if(typeof window.calculateAndPushLeaderboard === 'function') {
                      window.calculateAndPushLeaderboard();
                  }
              })
              .catch((error) => {
                  console.error("Cloud Sync Failed", error);
                  if(statusEl) {
                      statusEl.innerText = "Sync Failed (Offline)";
                      statusEl.style.color = "#ef5350";
                  }
              });
          }
      };

      // --- 2. LEADERBOARD WRITE FUNCTION ---
      window.pushToLeaderboard = function(stats) {
          if (window.userId === "OFFLINE") return;
          const updates = {};
          if(stats.streak > 0) updates['/leaderboard/streak/' + window.userId] = { name: window.userName, score: stats.streak, vol: stats.streakVol };
          if(stats.neet > 0) updates['/leaderboard/neet/' + window.userId] = { name: window.userName, score: stats.neet };
          if(stats.ini > 0) updates['/leaderboard/ini/' + window.userId] = { name: window.userName, score: stats.ini };
          if(stats.fmge > 0) updates['/leaderboard/fmge/' + window.userId] = { name: window.userName, score: stats.fmge };

          Object.keys(stats.swt).forEach(sub => {
              if(stats.swt[sub] > 0) {
                  updates[`/leaderboard/swt/${sub}/${window.userId}`] = { name: window.userName, accuracy: stats.swt[sub] };
              }
          });
          window.update(window.ref(window.db), updates).catch(e => console.error("LB Update Error", e));
      };

      // --- 3. LEADERBOARD READ FUNCTION ---
      window.fetchLeaderboard = function(category, subject) {
          let path = `leaderboard/${category}`;
          if (category === 'swt' && subject) path += `/${subject}`;
          const qKey = category === 'swt' ? 'accuracy' : 'score';
          const lbQuery = window.query(window.ref(window.db, path), window.orderByChild(qKey), window.limitToLast(50));
          window.get(lbQuery).then((snapshot) => {
              if (snapshot.exists()) {
                  const data = [];
                  snapshot.forEach((child) => { data.push(child.val()); });
                  if(typeof window.renderLeaderboardUI === 'function') {
                      window.renderLeaderboardUI(data.reverse(), category);
                  }
              } else {
                  if(typeof window.renderLeaderboardUI === 'function') window.renderLeaderboardUI([], category);
              }
          }).catch((error) => console.error(error));
      };
      // --- 4. DATA PULL FUNCTION ---
      window.pullFromCloud = function() {
          if (window.userId === "OFFLINE") return;
          const dbRef = window.ref(window.db);
          window.get(window.child(dbRef, `users/${window.userId}`)).then((snapshot) => {
              if (snapshot.exists()) {
                  const cloudData = snapshot.val();
                  const prefix = `SSS_PRO_V3_${window.userId}_`;
                  Object.keys(cloudData).forEach(key => {
                      localStorage.setItem(prefix + key, JSON.stringify(cloudData[key]));
                  });
                  if(typeof updateUI === 'function') updateUI();
              }
          }).catch((error) => console.error(error));
      };

      window.pullFromCloud();
      setTimeout(() => { window.syncToCloud(); }, 3000); 
      setInterval(() => { window.syncToCloud(); }, 600000);
    </script>

    <style>
        /* CSS VARIABLES */
        :root { 
            --bg: #0e1621; 
            --card: #17212b; 
            --text: #ffffff; 
            --border: #2b5278; 
            --accent: #5288c1; 
            --input-bg: #0e1621; 
            --chart-text: #ffffff;
            --chart-grid: #aaaaaa;
            --instruction-bg: rgba(255,255,255,0.05);
            --tab-blue: #2481cc; 
            --tab-blue-dark: #1a5c96;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
        }
        [data-theme="light"] {
            --bg: #f2f2f7; 
            --card: #ffffff; 
            --text: #000000; 
            --border: #d1d1d6; 
            --accent: #007aff; 
            --input-bg: #ffffff;
            --chart-text: #000000;
            --chart-grid: #555555;
            --instruction-bg: rgba(0,0,0,0.05);
        }

        html, body { height: 100%; margin: 0; padding: 0; background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s; }
        body { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            padding: 15px; 
            padding-bottom: 90px;
            box-sizing: border-box; 
            overflow-y: auto !important; 
            -webkit-overflow-scrolling: touch;
            min-height: 100vh;
        }
        
        .container { width: 100%; max-width: 420px; display: flex; flex-direction: column; align-items: center; text-align: center; }

        /* --- RESTORED: QUANTITATIVE ROUNDED BLUE TABS --- */
        .nav-tabs { 
            display: flex; 
            justify-content: space-around; 
            gap: 5px; 
            margin-bottom: 15px; 
            width: 100%; 
        }

        .tab-btn { 
            background: rgba(82, 136, 193, 0.1); 
            border: 1px solid var(--border); 
            color: #888; 
            padding: 10px 5px; 
            font-size: 10px; 
            border-radius: 12px; 
            cursor: pointer; 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 4px; 
            transition: all 0.2s; 
            font-weight: bold; 
            text-transform: uppercase; 
        }

        .tab-btn.active { 
            background: var(--tab-blue); 
            color: white; 
            border-color: var(--tab-blue); 
            box-shadow: 0 4px 12px rgba(36, 129, 204, 0.3); 
            transform: translateY(-2px); 
        }

        .tab-btn span { font-size: 16px; margin-bottom: 2px; }

        /* TAB CONTENT VISIBILITY */
        .tab-content { display: none; width: 100%; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        /* CORE CARDS */
        .card { 
            background: var(--card); 
            border-radius: 15px; 
            padding: 15px; 
            margin-bottom: 15px; 
            width: 100%; 
            box-sizing: border-box; 
            border: 1px solid var(--border); 
            text-align: left;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .card h3 { 
            margin-top: 0; 
            color: var(--accent); 
            font-size: 16px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
        }

        /* EXAM DASHBOARD & COUNTDOWNS */
        .exam-dashboard { width: 100%; margin-bottom: 20px; }
        .exam-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .exam-item { 
            background: var(--card); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 10px; 
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            min-height: 60px;
        }
        .exam-days { font-family: 'Oswald', sans-serif; font-size: 22px; color: var(--accent); line-height: 1; }
        .exam-label { font-size: 9px; text-transform: uppercase; margin-top: 4px; opacity: 0.8; font-weight: bold; letter-spacing: 0.5px; }
        /* FORM ELEMENTS */
        input, select, textarea { 
            width: 100%; 
            padding: 10px; 
            margin: 8px 0; 
            background: var(--input-bg); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            color: var(--text); 
            font-size: 13px; 
            box-sizing: border-box; 
            outline: none;
        }

        .btn { 
            background: var(--accent); 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: 0.2s; 
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:active { transform: scale(0.98); opacity: 0.9; }

        /* TIMER DISPLAY */
        #timer-display { 
            font-family: 'Oswald', sans-serif; 
            font-size: 48px; 
            text-align: center; 
            margin: 15px 0; 
            color: var(--accent); 
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(82,136,193,0.3);
        }

        /* TABLES */
        .matrix-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
        .matrix-table th, .matrix-table td { 
            border: 1px solid var(--border); 
            padding: 8px 4px; 
            text-align: center; 
        }
        .matrix-table th { background: rgba(82,136,193,0.1); color: var(--accent); text-transform: uppercase; font-size: 9px; }
        /* CHART CONTAINERS */
        .chart-scroller { width: 100%; overflow-x: auto; margin-top: 10px; }
        .chart-scroll-content { min-width: 400px; height: 180px; }

        /* ACCORDIONS */
        .accordion-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 0; 
            cursor: pointer; 
            border-bottom: 1px solid var(--border);
        }
        .accordion-content { display: none; padding: 10px 0; }
        .accordion-content.open { display: block; }
        .arrow { transition: transform 0.3s; font-size: 10px; opacity: 0.5; }
        .active .arrow { transform: rotate(180deg); }

        /* QUALITATIVE (FACT SALAD) STYLES */
        .qual-card { background: var(--card); border-radius: 15px; border: 1px solid var(--border); padding: 15px; margin-bottom: 15px; width: 100%; box-sizing: border-box; }
        .qual-input-group { margin-bottom: 15px; }
        .qual-input-group label { display: block; font-size: 10px; text-transform: uppercase; color: var(--accent); margin-bottom: 5px; font-weight: bold; }
        .qual-input-group textarea { height: 60px; resize: none; font-size: 12px; }

        .slide-container { 
            background: var(--input-bg); 
            border-radius: 12px; 
            padding: 20px; 
            min-height: 120px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            text-align: center; 
            margin-bottom: 15px; 
            border: 1px dashed var(--border);
        }
        /* RANKING / LEADERBOARD LIST */
        .rank-list { margin-top: 10px; }
        .rank-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px; 
            background: rgba(255,255,255,0.03); 
            border-radius: 8px; 
            margin-bottom: 5px; 
            border-left: 3px solid var(--border);
        }
        .rank-name { font-weight: bold; font-size: 13px; }
        .rank-score { color: var(--accent); font-weight: bold; font-size: 13px; }
        .rank-pos { font-family: 'Oswald', sans-serif; opacity: 0.5; width: 25px; }

        /* MAIN BOTTOM DOCK NAV */
        .main-nav-dock { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: var(--card); 
            display: flex; 
            justify-content: space-around; 
            padding: 10px 0; 
            border-top: 1px solid var(--border); 
            z-index: 1000;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }
        .main-nav-btn { 
            background: none; 
            border: none; 
            color: #888; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-size: 10px; 
            font-weight: bold;
            transition: 0.2s;
        }
        .main-nav-btn.active { color: var(--accent); }
        .main-nav-btn span { font-size: 20px; margin-bottom: 2px; }

        /* POPUP OVERLAYS */
        .popup-overlay { 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 2000; 
            backdrop-filter: blur(5px);
        }
        .popup-card { background: var(--card); border-radius: 20px; padding: 25px; width: 85%; max-width: 320px; text-align: center; border: 1px solid var(--border); }
        /* UTILITY CLASSES */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-online { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .status-offline { background: #ef5350; }
        
        .badge { font-size: 8px; padding: 2px 6px; border-radius: 10px; text-transform: uppercase; font-weight: bold; margin-left: 5px; }
        .badge-r1 { background: var(--bronze); color: white; }
        .badge-r2 { background: var(--silver); color: black; }
        .badge-r3 { background: var(--gold); color: black; }
        
        .danger-zone { border: 1px solid #ef5350; padding: 10px; border-radius: 10px; margin-top: 10px; background: rgba(239, 83, 80, 0.05); }
        
        .pyq-nav-container { display: flex; overflow-x: auto; gap: 5px; padding-bottom: 5px; margin-bottom: 10px; scrollbar-width: none; }
        .pyq-nav-container::-webkit-scrollbar { display: none; }
        .pyq-tab { 
            white-space: nowrap; padding: 6px 12px; border-radius: 15px; background: rgba(255,255,255,0.05); 
            font-size: 10px; border: 1px solid var(--border); color: #888; 
        }
        .pyq-tab.active { background: var(--accent); color: white; border-color: var(--accent); }

        .rank-nav { display: flex; gap: 5px; margin-bottom: 15px; }
        .rank-nav-btn { flex: 1; padding: 8px; font-size: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; color: var(--text); }
        .rank-nav-btn.active { background: var(--accent); border-color: var(--accent); }

        .calc-preview { background: rgba(82,136,193,0.1); padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: center; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div style="margin-top: 20px; text-align: center;">
            <img src="https://github.com/dhruvathaare/Scaslpel-Study-Squad-Apps/blob/main/photo_2026-02-12_20-08-36.jpg?raw=true" class="logo" style="width:90px; height:90px; border-radius:50%; border:3px solid var(--accent); margin-bottom: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
            <h1 style="font-family:'Oswald'; font-size:28px; color:var(--text); margin:0; letter-spacing:1px;">SCALPEL STUDY SQUAD</h1>
            <div id="cloud-sync-status" style="font-size: 10px; margin-top: 5px; color: #888; font-weight: bold;">Initializing Core...</div>
        </div>

        <div style="width:100%; display:flex; justify-content:space-between; align-items:flex-end; margin-top:20px; margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px;">
            <div style="text-align:left;">
                <div style="font-size:10px; text-transform:uppercase; color:var(--accent); font-weight:bold; letter-spacing:0.5px;">Candidate Profile</div>
                <div id="uFullName" style="font-size:16px; font-weight:bold; font-family:'Oswald';">Loading...</div>
                <div id="uID" style="font-size:9px; opacity:0.6;">ID: --</div>
            </div>
            <div style="text-align:right;">
                <div style="display:flex; align-items:center; justify-content:flex-end; margin-bottom:3px;">
                    <span id="statusDot" class="status-dot"></span>
                    <span id="onlineText" style="font-size:10px; font-weight:bold;">Online</span>
                </div>
                <div id="streakIcons" style="font-size:14px;">üåë</div>
                <div id="streakText" style="font-size:9px; font-weight:bold; color:var(--accent);">Consistency: 0 Days</div>
            </div>
        </div>
        <div class="exam-dashboard">
            <div class="exam-grid">
                <div class="exam-item" id="dash_neet">
                    <span id="daysNeet" class="exam-days">--</span>
                    <span class="exam-label">NEET PG 2026</span>
                </div>
                <div class="exam-item" id="dash_ini_jul">
                    <span id="daysIniJuly" class="exam-days">--</span>
                    <span class="exam-label">INICET JULY</span>
                </div>
                <div class="exam-item" id="dash_fmge_jun">
                    <span id="daysFmgeJun" class="exam-days">--</span>
                    <span class="exam-label">FMGE JUNE 26</span>
                </div>
                <div class="exam-item" id="dash_upsc">
                    <span id="daysUpsc" class="exam-days">--</span>
                    <span class="exam-label">UPSC CMS</span>
                </div>
            </div>
        </div>

        <div id="section-quant" class="section-container" style="width:100%;">
            <div class="nav-tabs">
                <button class="tab-btn active" onclick="switchTab('tab-daily', this)">
                    <span>üìÖ</span>DAILY
                </button>
                <button class="tab-btn" onclick="switchTab('tab-swt', this)">
                    <span>üß™</span>SWT
                </button>
                <button class="tab-btn" onclick="switchTab('tab-gt', this)">
                    <span>üéØ</span>GT
                </button>
                <button class="tab-btn" onclick="switchTab('tab-rank', this)">
                    <span>üèÖ</span>RANKS
                </button>
                <button class="tab-btn" onclick="switchTab('tab-goal', this)">
                    <span>‚öôÔ∏è</span>SET
                </button>
            </div>

            <div id="tab-goal" class="tab-content">
                <div class="card">
                    <div class="accordion-header" onclick="toggleAccordion('acc_exams', this)">
                        <h3>Target Configuration</h3>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div id="acc_exams" class="accordion-content">
                        <p style="font-size:10px; color:#888; margin-bottom:10px;">Select which exams you are targeting to show on dashboard.</p>
                        <div style="display:grid; grid-template-columns:1fr; gap:8px;">
                            <label style="font-size:11px; display:flex; align-items:center; gap:10px;">
                                <input type="checkbox" id="goal_neet" onchange="saveGoals()" style="width:15px; margin:0;"> NEET PG 2026
                            </label>
                            <label style="font-size:11px; display:flex; align-items:center; gap:10px;">
                                <input type="checkbox" id="goal_ini_jul" onchange="saveGoals()" style="width:15px; margin:0;"> INICET JULY '26
                            </label>
                            <label style="font-size:11px; display:flex; align-items:center; gap:10px;">
                                <input type="checkbox" id="goal_fmge_jun" onchange="saveGoals()" style="width:15px; margin:0;"> FMGE JUNE '26
                            </label>
                            <label style="font-size:11px; display:flex; align-items:center; gap:10px;">
                                <input type="checkbox" id="goal_upsc" onchange="saveGoals()" style="width:15px; margin:0;"> UPSC CMS '26
                            </label>
                        </div>
                        <button class="btn" style="width:100%; margin-top:15px; font-size:11px; padding:8px;" onclick="lockExamGoals()">Lock Targets üîí</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Tough Subjects Radar</h3>
                    <div id="tough-dashboard" style="margin-bottom:10px;"></div>
                    <div class="accordion-header" onclick="toggleAccordion('acc_tough', this)">
                        <span style="font-size:11px; font-weight:bold; color:var(--accent);">Select Tough Subjects</span>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div id="acc_tough" class="accordion-content">
                        <div id="tough-subject-selector" style="display:grid; grid-template-columns:1fr 1fr; gap:5px; font-size:10px; text-align:left;">
                            </div>
                    </div>
                </div>

                <div class="card">
                    <div class="accordion-header" onclick="toggleAccordion('acc_pyq', this)">
                        <h3>PYQ Completion Goals</h3>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div id="acc_pyq" class="accordion-content">
                        <div class="pyq-nav-container" id="pyq-nav">
                            <div class="pyq-tab active" onclick="switchPyq('neet', this)">NEET PG</div>
                            <div class="pyq-tab" onclick="switchPyq('ini', this)">INICET</div>
                            <div class="pyq-tab" onclick="switchPyq('fmge', this)">FMGE</div>
                            <div class="pyq-tab" onclick="switchPyq('upsc', this)">UPSC CMS</div>
                        </div>
                        <div id="pyq-content" style="max-height: 250px; overflow-y: auto; padding: 5px; background: rgba(0,0,0,0.1); border-radius: 8px;">
                            </div>
                    </div>
                </div>
            </div>

            <div id="tab-daily" class="tab-content active">
                <div class="card">
                    <h3>Study Session Timer</h3>
                    <div class="timer-setup">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <div>
                                <label class="setting-label">Subject</label>
                                <select id="subject" style="margin-bottom:5px;">
                                    <option value="" disabled selected>Choose Subject</option>
                                    <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option>
                                    <option>Mixed Bag</option><option>Integrated Systems</option>
                                </select>
                            </div>
                            <div>
                                <label class="setting-label">Phase</label>
                                <select id="studyPhase" style="margin-bottom:5px;">
                                    <option value="r1">1st Reading ü•â</option>
                                    <option value="r2">2nd Reading ü•à</option>
                                    <option value="r3">3rd Reading ü•á</option>
                                    <option value="r4">Bonus/Rev üèÜ</option>
                                </select>
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:5px;">
                            <div>
                                <label class="setting-label">Session (Hr:Min)</label>
                                <div style="display:flex; gap:5px;">
                                    <input type="number" id="studyHr" value="2" min="0" max="12" style="margin:0;">
                                    <input type="number" id="studyMin" value="30" min="0" max="59" style="margin:0;">
                                </div>
                            </div>
                            <div>
                                <label class="setting-label">Break (Min)</label>
                                <input type="number" id="breakTime" value="15" min="0" style="margin:0;">
                            </div>
                        </div>

                        <div id="timer-display">00:00:00</div>
                        
                        <button id="startBtn" class="btn" style="width:100%;">Initialize Session üöÄ</button>
                        
                        <div id="timer-controls" style="display:none; gap:10px; margin-top:10px;">
                            <button id="pauseBtn" class="btn" style="flex:1; background:#f39c12;" onclick="togglePause()">Pause</button>
                            <button class="btn" style="flex:1; background:#ef5350;" onclick="handleTransition()">Skip to Log</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>Performance Analytics</h3>
                        <div style="display:flex; gap:10px;">
                            <button class="btn" style="padding:4px 8px; font-size:10px;" onclick="changeViewMonth(-1)">‚óÄ</button>
                            <span id="currentMonthYear" style="font-size:11px; font-weight:bold; width:80px; text-align:center;"></span>
                            <button class="btn" style="padding:4px 8px; font-size:10px;" onclick="changeViewMonth(1)">‚ñ∂</button>
                        </div>
                    </div>
                    
                    <div class="chart-scroller">
                        <div class="chart-scroll-content">
                            <canvas id="hoursChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-scroller" style="margin-top:10px;">
                        <div class="chart-scroll-content">
                            <canvas id="mcqChart"></canvas>
                        </div>
                    </div>

                    <div class="accordion-header" onclick="toggleAccordion('acc_logs', this)" style="margin-top:15px;">
                        <span style="font-size:11px; font-weight:bold; color:var(--accent);">View Detailed History</span>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div id="acc_logs" class="accordion-content">
                        <div style="max-height: 200px; overflow-y: auto;">
                            <table class="matrix-table">
                                <thead>
                                    <tr><th>Date</th><th>Hrs</th><th>Cyc</th><th>MCQ</th><th>Subjects</th></tr>
                                </thead>
                                <tbody id="dailyLogBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="tab-swt" class="tab-content">
                <div class="card">
                    <h3>Log Subject-Wise Test (SWT)</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label class="setting-label" style="font-size:10px; color:var(--accent); font-weight:bold;">Subject</label>
                            <select id="swtSubject">
                                <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option>
                                <option>Mixed Bag</option>
                            </select>
                        </div>
                        <div>
                            <label class="setting-label" style="font-size:10px; color:var(--accent); font-weight:bold;">Reading Phase</label>
                            <select id="swtPhase">
                                <option value="r1">1st Reading ü•â</option>
                                <option value="r2">2nd Reading ü•à</option>
                                <option value="r3">3rd Reading ü•á</option>
                                <option value="r4">Bonus/Rev üèÜ</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:5px;">
                        <div>
                            <label class="setting-label" style="font-size:10px; color:var(--accent); font-weight:bold;">Correct MCQs</label>
                            <input type="number" id="swtCorrect" placeholder="0" oninput="calculateSWTPerc()">
                        </div>
                        <div>
                            <label class="setting-label" style="font-size:10px; color:var(--accent); font-weight:bold;">Total MCQs</label>
                            <input type="number" id="swtTotal" placeholder="0" oninput="calculateSWTPerc()">
                        </div>
                    </div>
                    <div id="swt-calc-preview" class="calc-preview">
                        <span>Predicted Accuracy: <b id="swtAccPreview">0%</b></span>
                    </div>
                    <button class="btn" style="width:100%; background:var(--tab-blue);" onclick="saveSWT()">Log Score üß†</button>
                </div>

                <div class="card">
                    <h3>Subject Mastery Matrix</h3>
                    <div style="font-size: 10px; color: #888; margin-bottom: 10px;">Tracking cumulative performance across all reading phases.</div>
                    <div style="overflow-x: auto;">
                        <table class="matrix-table" id="swtMatrixTable">
                            <thead>
                                <tr>
                                    <th style="width: 35%;">Subject</th>
                                    <th>Total MCQ</th>
                                    <th>Accuracy</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="swtMatrixBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
                <div class="card">
                    <h3>Reading Phase Analysis</h3>
                    <div style="font-size: 10px; color: #888; margin-bottom: 10px;">MCQ Volume and Accuracy split by Reading Phase.</div>
                    <div class="chart-scroller">
                        <div class="chart-scroll-content">
                            <canvas id="swtPhaseCountChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-scroller" style="margin-top:10px;">
                        <div class="chart-scroll-content">
                            <canvas id="swtPhaseAvgChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-gt" class="tab-content">
                <div class="card">
                    <h3>Log Grand Test (GT)</h3>
                    <div style="display:flex; gap:5px; margin-bottom:15px;">
                        <button class="btn gt-tab-btn active" onclick="switchGTMode('NEET', this)" style="flex:1; background:rgba(82,136,193,0.1); color:var(--text); font-size:10px;">NEET PG</button>
                        <button class="btn gt-tab-btn" onclick="switchGTMode('INI', this)" style="flex:1; background:rgba(82,136,193,0.1); color:var(--text); font-size:10px;">INICET</button>
                        <button class="btn gt-tab-btn" onclick="switchGTMode('FMGE', this)" style="flex:1; background:rgba(82,136,193,0.1); color:var(--text); font-size:10px;">FMGE</button>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label class="setting-label" style="font-size:10px; color:var(--accent); font-weight:bold;">Score (Marks/%)</label>
                            <input type="number" id="gtScore" placeholder="Enter Score">
                        </div>
                        <div>
                            <label class="setting-label" style="font-size:10px; color:var(--accent); font-weight:bold;">Rank / Percentile</label>
                            <input type="number" id="gtRank" placeholder="Enter Rank">
                        </div>
                    </div>
                    
                    <div class="qual-input-group" style="margin-top:5px;">
                        <label style="font-size:10px; color:var(--accent); font-weight:bold;">Exam Platform / Source</label>
                        <select id="gtPlatform">
                            <option>Marrow</option><option>Prepladder</option><option>Bhatia</option><option>DAMS</option><option>Cerebellum</option><option>Other</option>
                        </select>
                    </div>

                    <button class="btn" style="width:100%; background:#8e44ad;" onclick="saveGT()">Log GT Result üìà</button>
                </div>
                <div class="card">
                    <h3>Grand Test Trends</h3>
                    <div id="gt-chart-container-neet" class="chart-scroller">
                        <div style="font-size:10px; font-weight:bold; color:var(--accent); margin-bottom:5px;">NEET PG PROGRESSION</div>
                        <div class="chart-scroll-content">
                            <canvas id="gtNeetChart"></canvas>
                        </div>
                    </div>
                    <div id="gt-chart-container-ini" class="chart-scroller" style="margin-top:15px; display:none;">
                        <div style="font-size:10px; font-weight:bold; color:#8e44ad; margin-bottom:5px;">INICET PROGRESSION</div>
                        <div class="chart-scroll-content">
                            <canvas id="gtIniChart"></canvas>
                        </div>
                    </div>
                    <div id="gt-chart-container-fmge" class="chart-scroller" style="margin-top:15px; display:none;">
                        <div style="font-size:10px; font-weight:bold; color:#2ecc71; margin-bottom:5px;">FMGE PROGRESSION</div>
                        <div class="chart-scroll-content">
                            <canvas id="gtFmgeChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="accordion-header" onclick="toggleAccordion('acc_gt_logs', this)">
                        <h3>GT Detailed Log</h3>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div id="acc_gt_logs" class="accordion-content">
                        <div style="max-height: 250px; overflow-y: auto;">
                            <table class="matrix-table">
                                <thead>
                                    <tr><th>Date</th><th>Type</th><th>Score</th><th>Rank</th><th>Platform</th></tr>
                                </thead>
                                <tbody id="gtLogBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-rank" class="tab-content">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0;">Global Leaderboard</h3>
                        <button class="btn" onclick="fetchLeaderboard(currentRankCat, currentRankSub)" style="padding:5px 10px; font-size:10px;">üîÑ Refresh</button>
                    </div>
                    
                    <div class="rank-nav">
                        <button id="rankBtnStreak" class="rank-nav-btn active" onclick="switchRankCat('streak', this)">Consistency</button>
                        <button id="rankBtnNeet" class="rank-nav-btn" onclick="switchRankCat('neet', this)">NEET PG</button>
                        <button id="rankBtnSwt" class="rank-nav-btn" onclick="switchRankCat('swt', this)">SWT Mastery</button>
                    </div>
                    <div id="rankSubjectSelector" style="display:none; margin-bottom:10px;">
                        <label style="font-size:10px; color:var(--accent); font-weight:bold; display:block; margin-bottom:5px;">Select Subject Leaderboard</label>
                        <select id="rankSub" onchange="switchRankSub(this.value)">
                            <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option>
                        </select>
                    </div>

                    <div id="rank-list-container" class="rank-list">
                        <div style="text-align:center; padding:20px; opacity:0.5; font-size:12px;">Fetching competitors...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-qual" class="section-container" style="width:100%; display:none;">
            <div class="card" style="border-left: 5px solid #e67e22;">
                <h3 style="color:#e67e22;">Active Recall: Fact Salad Bowl ü•ó</h3>
                <div style="font-size:10px; color:#888; margin-bottom:15px;">Randomized facts from your own database for rapid fire revision.</div>
                
                <div id="fact-slideshow" class="slide-container">
                    <div style="opacity:0.5; font-size:12px;">Your bowl is currently empty.<br>Add facts below to start the slideshow.</div>
                </div>

                <div style="display:flex; gap:10px;">
                    <button id="slideShowBtn" class="btn" style="flex:1; background:#f39c12; font-size:11px;" onclick="toggleSlideShow()">‚èØ Play Slideshow (30s)</button>
                    <button class="btn" style="flex:1; background:#34495e; font-size:11px;" onclick="showRandomFact()">üé≤ Next Fact</button>
                </div>
            </div>

            <div class="card">
                <h3>Toss a New Fact into the Bowl</h3>
                <div class="qual-input-group">
                    <label>Subject</label>
                    <select id="factSubject">
                        <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option>
                        <option>High Yield Fact</option>
                    </select>
                </div>
                <div class="qual-input-group">
                    <label>The Question (One Liner/Concept)</label>
                    <textarea id="factQuestion" placeholder="e.g. Most common cause of..."></textarea>
                </div>
                <div class="qual-input-group">
                    <label>The Answer (Short & Sharp)</label>
                    <textarea id="factAnswer" placeholder="Keep it brief for rapid recall"></textarea>
                </div>
                <button class="btn" style="width:100%; background:#27ae60;" onclick="saveFact()">Toss into Bowl ü•ó</button>
            </div>

            <div class="card" style="border-left: 5px solid #ef5350;">
                <h3 style="color:#ef5350;">Mistake Autopsy / Weakness Log üî¨</h3>
                <div style="font-size:10px; color:#888; margin-bottom:15px;">Log high-yield mistakes from your GTs and SWTs for focused revision.</div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div>
                        <label class="setting-label" style="font-size:10px; color:#ef5350; font-weight:bold;">Source</label>
                        <select id="mistakeType">
                            <option value="SWT">SWT Mistake</option>
                            <option value="GT">GT Mistake</option>
                        </select>
                    </div>
                    <div>
                        <label class="setting-label" style="font-size:10px; color:#ef5350; font-weight:bold;">Subject</label>
                        <select id="mistakeSub">
                            <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option>
                        </select>
                    </div>
                </div>

                <div class="qual-input-group" style="margin-top:10px;">
                    <label>The Mistake (Question context)</label>
                    <textarea id="mistakeQ" placeholder="What was the question?"></textarea>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="qual-input-group">
                        <label>Correct Answer</label>
                        <input type="text" id="mistakeCorrect" placeholder="Right Ans">
                    </div>
                    <div class="qual-input-group">
                        <label>My Wrong Choice</label>
                        <input type="text" id="mistakeWrong" placeholder="My Ans">
                    </div>
                </div>
                <div class="qual-input-group">
                    <label>Why did I miss it? (Reasoning/Fact)</label>
                    <textarea id="mistakeReason" placeholder="e.g. Concept error, Silly mistake, New info..."></textarea>
                </div>
                <button class="btn" style="width:100%; background:#ef5350;" onclick="saveMistake()">Log for Revision üìå</button>
            </div>
            <div class="card">
                <div class="accordion-header" onclick="toggleAccordion('acc_mistake_list', this)">
                    <h3>Mistake History</h3>
                    <span class="arrow">‚ñº</span>
                </div>
                <div id="acc_mistake_list" class="accordion-content">
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table class="matrix-table">
                            <thead>
                                <tr><th>Sub</th><th>Mistake</th><th>Correct</th><th>Reason</th></tr>
                            </thead>
                            <tbody id="mistakeLogBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card" style="background: linear-gradient(135deg, var(--card) 0%, #1a1a1a 100%); border: 1px solid #ffd700;">
                <h3 style="color:#ffd700;">Revision Reports üìÑ</h3>
                <div style="font-size:10px; color:#888; margin-bottom:15px;">Generate PDF summaries of your logged data for offline revision or printing.</div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button class="btn" style="background:#34495e; font-size:11px; flex-direction:column; padding:15px;" onclick="generatePDF('daily')">
                        <span style="font-size:20px;">ü•ó</span>
                        Daily Fact Bowl
                    </button>
                    <button class="btn" style="background:#34495e; font-size:11px; flex-direction:column; padding:15px;" onclick="generatePDF('monthly')">
                        <span style="font-size:20px;">üî¨</span>
                        Mistake Autopsy
                    </button>
                </div>
            </div>
        </div>

        <div id="section-sys" class="section-container" style="width:100%; display:none;">
            <div class="card">
                <h3>Cloud Sync & Data Security</h3>
                <div style="padding:10px; background:rgba(46, 204, 113, 0.1); border-radius:10px; margin-bottom:15px;">
                    <div style="font-size:12px; font-weight:bold; color:#2ecc71; margin-bottom:5px;">Real-time Cloud Sync is ACTIVE</div>
                    <div style="font-size:9px; color:#888;">All your progress is automatically linked to your Telegram ID and stored in the Firebase encrypted vault.</div>
                </div>
                <button class="btn" style="width:100%; margin-bottom:10px;" onclick="window.syncToCloud()">Manual Cloud Push ‚òÅÔ∏è</button>
                <button class="btn" style="width:100%; background:#34495e;" onclick="window.pullFromCloud()">Force Cloud Pull ‚¨áÔ∏è</button>
            </div>
            <div class="card">
                <h3>Local Backup & Migration</h3>
                <div style="font-size:10px; color:#888; margin-bottom:10px;">Export a coded string to move your data to another device or for local backup.</div>
                <button class="btn" style="width:100%; background:#34495e; margin-bottom:10px;" onclick="exportData()">Generate Backup Code üì§</button>
                <input type="text" id="restoreCode" placeholder="Paste backup code here..." style="font-size:10px;">
                <button class="btn" style="width:100%; background:#e67e22;" onclick="importData()">Restore from Code üì•</button>
            </div>

            <div class="card danger-zone">
                <h3 style="color:#ef5350;">Danger Zone</h3>
                <p style="font-size:10px; color:#888;">This will wipe ALL local data from this device. Cloud data remains safe until overwritten.</p>
                <button class="btn" style="width:100%; background:#ef5350;" onclick="clearAllData()">Wipe Local Storage üß®</button>
            </div>
        </div>

        <nav class="main-nav-dock">
            <button id="nav-quant" class="main-nav-btn active" onclick="navigate('section-quant', this)">
                <span>üìä</span>QUANT
            </button>
            <button id="nav-qual" class="main-nav-btn" onclick="navigate('section-qual', this)">
                <span>ü•ó</span>QUAL
            </button>
            <button id="nav-sys" class="main-nav-btn" onclick="navigate('section-sys', this)">
                <span>‚öôÔ∏è</span>SYS
            </button>
            <button class="main-nav-btn" onclick="toggleTheme()" style="border-left: 1px solid var(--border); padding-left:15px; margin-left:10px;">
                <span>üåó</span>THEME
            </button>
        </nav>

        <div id="popup-overlay" class="popup-overlay">
            <div id="mcq-popup" class="popup-card" style="display:none;">
                <h2 style="font-family:'Oswald'; color:var(--accent);">Cycle Complete! ‚ö°</h2>
                <p style="font-size:14px;">Great focus, Doctor. How many MCQs did you solve in this cycle?</p>
                <input type="number" id="cycleMcqs" placeholder="0" style="text-align:center; font-size:24px; height:60px;">
                <button class="btn" style="width:100%; margin-top:15px;" onclick="startBreak()">Log & Take Break</button>
            </div>
            <div id="break-popup" class="popup-card" style="display:none;">
                <h2 style="font-family:'Oswald'; color:#2ecc71;">Break Time! ‚òï</h2>
                <p id="breakStatus">Refreshing your mind...</p>
                <div id="break-timer-display" style="font-family:'Oswald'; font-size:40px; margin:15px 0;">00:00</div>
                <button class="btn" style="width:100%;" onclick="continueNextCycle()">Back to Study üìö</button>
                <button class="btn" style="width:100%; margin-top:10px; background:#34495e;" onclick="stopEntireSession()">End Mission</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & CONSTANTS ---
        const prefix = `SSS_PRO_V3_${window.userId}_`;
        const KEYS = {
            LOGS: prefix + 'LOGS',
            NEET: prefix + 'NEET',
            INI: prefix + 'INI',
            FMGE: prefix + 'FMGE',
            SWT: prefix + 'SWT',
            GOALS: prefix + 'GOALS',
            PYQ: prefix + 'PYQ',
            TOUGH: prefix + 'TOUGH',
            FACTS: prefix + 'FACTS',
            SWT_MISTAKES: prefix + 'SWT_MISTAKES',
            GT_MISTAKES: prefix + 'GT_MISTAKES'
        };

        const SUBJECTS_19 = [
            'Anatomy', 'Physiology', 'Biochemistry', 'Pathology', 'Microbiology', 
            'Pharmacology', 'FMT', 'PSM', 'Ophthalmology', 'ENT', 'Medicine', 
            'Surgery', 'OBG', 'Pediatrics', 'Anaesthesia', 'Dermatology', 
            'Orthopedics', 'Psychiatry', 'Radiology'
        ];

        // --- 2. NAVIGATION LOGIC ---
        function navigate(sectionId, btn) {
            document.querySelectorAll('.section-container').forEach(s => s.style.display = 'none');
            document.getElementById(sectionId).style.display = 'block';
            document.querySelectorAll('.main-nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Re-render specific logic when switching main sections
            if(sectionId === 'section-quant') renderCharts();
            if(sectionId === 'section-qual') showRandomFact();
        }

        function switchTab(tabId, btn) {
            const container = btn.closest('.section-container');
            container.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            container.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            if(tabId === 'tab-rank') fetchLeaderboard(currentRankCat, currentRankSub);
            if(tabId === 'tab-swt') renderSWTMatrix();
        }
        /* --- 3. COUNTDOWN & GOALS LOGIC --- */
        function updateCountdowns() {
            const exams = {
                neet: new Date('2026-03-01T09:00:00'),
                ini_jul: new Date('2026-05-10T09:00:00'),
                fmge_jun: new Date('2026-06-18T09:00:00'),
                upsc: new Date('2026-07-20T09:00:00')
            };

            const now = new Date();
            for (let key in exams) {
                const diff = exams[key] - now;
                const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
                const el = document.getElementById('days' + key.charAt(0).toUpperCase() + key.slice(1).replace('_', ''));
                if (el) {
                    el.innerText = days > 0 ? days : "LIVE";
                    if (days <= 30 && days > 0) el.style.color = "#ef5350";
                }
            }
        }

        function saveGoals() {
            const goals = {
                neet: document.getElementById('goal_neet').checked,
                ini_jul: document.getElementById('goal_ini_jul').checked,
                fmge_jun: document.getElementById('goal_fmge_jun').checked,
                upsc: document.getElementById('goal_upsc').checked
            };
            localStorage.setItem(KEYS.GOALS, JSON.stringify(goals));
            renderGoalHTML();
        }

        function renderGoalHTML() {
            const goals = JSON.parse(localStorage.getItem(KEYS.GOALS) || "{}");
            document.getElementById('dash_neet').style.display = goals.neet ? 'flex' : 'none';
            document.getElementById('dash_ini_jul').style.display = goals.ini_jul ? 'flex' : 'none';
            document.getElementById('dash_fmge_jun').style.display = goals.fmge_jun ? 'flex' : 'none';
            document.getElementById('dash_upsc').style.display = goals.upsc ? 'flex' : 'none';
        }

        function loadGoalsToUI() {
            const goals = JSON.parse(localStorage.getItem(KEYS.GOALS) || "{}");
            document.getElementById('goal_neet').checked = !!goals.neet;
            document.getElementById('goal_ini_jul').checked = !!goals.ini_jul;
            document.getElementById('goal_fmge_jun').checked = !!goals.fmge_jun;
            document.getElementById('goal_upsc').checked = !!goals.upsc;
        }

        /* --- 4. PYQ TRACKER LOGIC --- */
        let currentPyqCat = 'neet';
        function switchPyq(cat, btn) {
            currentPyqCat = cat;
            document.querySelectorAll('.pyq-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            renderPyq();
        }

        function renderPyq() {
            const container = document.getElementById('pyq-content');
            const data = JSON.parse(localStorage.getItem(KEYS.PYQ) || "{}");
            const catData = data[currentPyqCat] || {};
            
            let years = [];
            if(currentPyqCat === 'neet') years = [2025, 2024, 2023, 2022, 2021, 2020, 2019, 2018];
            else if(currentPyqCat === 'ini') years = ["Nov 25", "May 25", "Nov 24", "May 24", "Nov 23", "May 23"];
            else if(currentPyqCat === 'fmge') years = ["Jan 26", "July 25", "Jan 25", "July 24", "Jan 24"];
            else years = [2025, 2024, 2023, 2022];

            container.innerHTML = years.map(yr => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid rgba(255,255,255,0.05);">
                    <span style="font-size:12px; font-weight:bold;">${currentPyqCat.toUpperCase()} ${yr}</span>
                    <input type="checkbox" ${catData[yr] ? 'checked' : ''} onchange="togglePyq('${yr}', this.checked)" style="width:18px; height:18px; margin:0;">
                </div>
            `).join('');
        }
        function togglePyq(yr, val) {
            const data = JSON.parse(localStorage.getItem(KEYS.PYQ) || "{}");
            if(!data[currentPyqCat]) data[currentPyqCat] = {};
            data[currentPyqCat][yr] = val;
            localStorage.setItem(KEYS.PYQ, JSON.stringify(data));
            window.syncToCloud();
        }

        /* --- 5. TOUGH SUBJECTS LOGIC --- */
        function renderToughSubjects() {
            const container = document.getElementById('tough-subject-selector');
            const dash = document.getElementById('tough-dashboard');
            const tough = JSON.parse(localStorage.getItem(KEYS.TOUGH) || "[]");
            
            container.innerHTML = SUBJECTS_19.map(s => `
                <label style="display:flex; align-items:center; gap:5px;">
                    <input type="checkbox" ${tough.includes(s) ? 'checked' : ''} onchange="toggleTough('${s}', this.checked)" style="width:12px; margin:0;"> ${s}
                </label>
            `).join('');

            dash.innerHTML = tough.map(s => `
                <span class="badge" style="background:rgba(231, 76, 60, 0.2); color:#ef5350; border:1px solid #ef5350; margin-bottom:5px; display:inline-block;">${s}</span>
            `).join(' ') || '<span style="font-size:10px; opacity:0.5;">No subjects marked as tough yet.</span>';
        }

        function toggleTough(sub, val) {
            let tough = JSON.parse(localStorage.getItem(KEYS.TOUGH) || "[]");
            if(val) tough.push(sub);
            else tough = tough.filter(s => s !== sub);
            localStorage.setItem(KEYS.TOUGH, JSON.stringify([...new Set(tough)]));
            renderToughSubjects();
            window.syncToCloud();
        }

        /* --- 6. SESSION TIMER ENGINE --- */
        let timerInterval;
        let totalSeconds = 0;
        let isPaused = false;
        let sessionStartTime = null;

        document.getElementById('startBtn').addEventListener('click', function() {
            const sub = document.getElementById('subject').value;
            if(!sub) { alert("Please select a subject first, Doctor."); return; }
            
            const h = parseInt(document.getElementById('studyHr').value) || 0;
            const m = parseInt(document.getElementById('studyMin').value) || 0;
            totalSeconds = (h * 3600) + (m * 60);
            
            if(totalSeconds <= 0) { alert("Set a valid study duration."); return; }

            sessionStartTime = new Date();
            this.style.display = 'none';
            document.getElementById('timer-controls').style.display = 'flex';
            startInterval();
        });

        function startInterval() {
            timerInterval = setInterval(() => {
                if(!isPaused) {
                    if(totalSeconds > 0) {
                        totalSeconds--;
                        updateTimerDisplay();
                    } else {
                        handleTransition();
                    }
                }
            }, 1000);
        }
        function updateTimerDisplay() {
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            document.getElementById('timer-display').innerText = 
                `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('pauseBtn');
            btn.innerText = isPaused ? "Resume" : "Pause";
            btn.style.background = isPaused ? "#2ecc71" : "#f39c12";
        }

        function handleTransition() {
            clearInterval(timerInterval);
            document.getElementById('popup-overlay').style.display = 'flex';
            document.getElementById('mcq-popup').style.display = 'block';
        }

        function startBreak() {
            const mcqs = parseInt(document.getElementById('cycleMcqs').value) || 0;
            saveCycleData(mcqs);
            document.getElementById('mcq-popup').style.display = 'none';
            document.getElementById('break-popup').style.display = 'block';
            // Simple break timer logic can be added here
        }

        function continueNextCycle() {
            document.getElementById('popup-overlay').style.display = 'none';
            document.getElementById('break-popup').style.display = 'none';
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('timer-controls').style.display = 'none';
            document.getElementById('timer-display').innerText = "00:00:00";
            document.getElementById('cycleMcqs').value = "";
        }

        function stopEntireSession() {
            const mcqs = parseInt(document.getElementById('cycleMcqs').value) || 0;
            saveCycleData(mcqs);
            location.reload();
        }

        /* --- 7. DATA PERSISTENCE: LOGS & STREAKS --- */
        function saveCycleData(mcqCount) {
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS) || "[]");
            const today = new Date().toISOString().split('T')[0];
            const sub = document.getElementById('subject').value || "Mixed Bag";
            const phase = document.getElementById('studyPhase').value;

            const endTime = new Date();
            const hrs = Math.max(0.01, (endTime - sessionStartTime) / (1000 * 60 * 60));

            const entry = {
                date: today,
                hrs: parseFloat(hrs.toFixed(2)),
                mcqs: mcqCount,
                subject: sub,
                phase: phase,
                timestamp: Date.now()
            };

            logs.push(entry);
            localStorage.setItem(KEYS.LOGS, JSON.stringify(logs));
            updateStreak();
            window.syncToCloud();
        }

        function updateStreak() {
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS) || "[]");
            if (logs.length === 0) return;
            const dailyStats = {};
            logs.forEach(log => { dailyStats[log.date] = (dailyStats[log.date] || 0) + log.mcqs; });
            const dates = Object.keys(dailyStats).sort().reverse();
            let streak = 0, vol = 0;
            for (let i = 0; i < dates.length; i++) {
                if (dailyStats[dates[i]] >= 50) { streak++; vol += dailyStats[dates[i]]; }
                else break;
            }
            document.getElementById('streakText').innerText = `Consistency: ${streak} Days`;
            renderStreakIcons(streak);
            if(window.pushToLeaderboard) window.pushToLeaderboard({ streak, streakVol: vol, neet: 0, ini: 0, fmge: 0, swt: {} });
        }

        function renderStreakIcons(count) {
            const container = document.getElementById('streakIcons');
            const fires = Math.floor(count / 10);
            const medals = Math.floor(count / 50);
            container.innerHTML = "üî•".repeat(fires) + "ü•á".repeat(medals) || "üåë";
        }
        /* --- 8. ANALYTICS & CHART RENDERING --- */
        let hrsChart, mcqChart;
        function renderCharts() {
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS) || "[]");
            const ctxHrs = document.getElementById('hoursChart').getContext('2d');
            const ctxMcq = document.getElementById('mcqChart').getContext('2d');
            const labels = []; const hrData = []; const mcqData = [];
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const ds = d.toISOString().split('T')[0];
                labels.push(ds.split('-').slice(1).join('/'));
                const dayLogs = logs.filter(l => l.date === ds);
                hrData.push(dayLogs.reduce((acc, curr) => acc + curr.hrs, 0));
                mcqData.push(dayLogs.reduce((acc, curr) => acc + curr.mcqs, 0));
            }
            if(hrsChart) hrsChart.destroy(); if(mcqChart) mcqChart.destroy();
            const cfg = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } } } };
            hrsChart = new Chart(ctxHrs, { type: 'line', data: { labels, datasets: [{ data: hrData, borderColor: '#5288c1', tension: 0.3, fill: true, backgroundColor: 'rgba(82,136,193,0.1)' }]}, options: cfg });
            mcqChart = new Chart(ctxMcq, { type: 'bar', data: { labels, datasets: [{ data: mcqData, backgroundColor: '#2ecc71', borderRadius: 5 }]}, options: cfg });
            
            const logBody = document.getElementById('dailyLogBody');
            logBody.innerHTML = logs.slice(-10).reverse().map(l => `<tr><td>${l.date.split('-').slice(1).join('/')}${(l.phase === 'r3' || l.phase === 'r4') ? 'üî•' : ''}</td><td>${l.hrs}h</td><td>1</td><td>${l.mcqs}</td><td>${l.subject}</td></tr>`).join('');
        }

        /* --- 9. SWT & MASTERY MATRIX --- */
        function calculateSWTPerc() {
            const c = parseInt(document.getElementById('swtCorrect').value) || 0;
            const t = parseInt(document.getElementById('swtTotal').value) || 0;
            document.getElementById('swtAccPreview').innerText = t > 0 ? Math.round((c/t)*100) + "%" : "0%";
        }

        function saveSWT() {
            const sub = document.getElementById('swtSubject').value;
            const correct = parseInt(document.getElementById('swtCorrect').value) || 0;
            const total = parseInt(document.getElementById('swtTotal').value) || 0;
            const phase = document.getElementById('swtPhase').value;
            if(total <= 0) return;
            const data = JSON.parse(localStorage.getItem(KEYS.SWT) || "[]");
            data.push({ subject: sub, correct, total, phase, date: new Date().toISOString().split('T')[0] });
            localStorage.setItem(KEYS.SWT, JSON.stringify(data));
            renderSWTMatrix(); window.syncToCloud();
            alert("SWT Logged! üß†");
        }

        function renderSWTMatrix() {
            const data = JSON.parse(localStorage.getItem(KEYS.SWT) || "[]");
            const summary = {}; SUBJECTS_19.forEach(s => summary[s] = { t: 0, c: 0 });
            data.forEach(d => { if(summary[d.subject]) { summary[d.subject].t += d.total; summary[d.subject].c += d.correct; } });
            document.getElementById('swtMatrixBody').innerHTML = SUBJECTS_19.map(s => {
                const acc = summary[s].t > 0 ? Math.round((summary[s].c / summary[s].t) * 100) : 0;
                let icon = acc >= 80 ? 'üü¢' : (acc >= 60 ? 'üü°' : (summary[s].t > 0 ? 'üî¥' : '‚ö™'));
                return `<tr><td style="text-align:left;">${s}</td><td>${summary[s].t}</td><td style="font-weight:bold; color:${acc>=60?'#2ecc71':'#ef5350'}">${acc}%</td><td>${icon}</td></tr>`;
            }).join('');
        }

        /* --- 10. SYSTEM & UTILS --- */
        function toggleTheme() {
            const b = document.body;
            const t = b.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            b.setAttribute('data-theme', t);
            localStorage.setItem(prefix + 'THEME', t);
        }

        function exportData() {
            const b = {}; Object.keys(KEYS).forEach(k => b[k] = localStorage.getItem(KEYS[k]));
            navigator.clipboard.writeText(btoa(JSON.stringify(b))); alert("Backup Code Copied! üì§");
        }

        function importData() {
            try {
                const d = JSON.parse(atob(document.getElementById('restoreCode').value));
                Object.keys(d).forEach(k => { if(d[k]) localStorage.setItem(KEYS[k], d[k]); });
                alert("Restored! Reloading..."); location.reload();
            } catch(e) { alert("Invalid Code!"); }
        }

        function clearAllData() {
            if(confirm("Wipe local data? This cannot be undone.")) { localStorage.clear(); location.reload(); }
        }

        function toggleAccordion(id, head) {
            document.getElementById(id).classList.toggle('open');
            head.classList.toggle('active');
        }

        /* --- 11. INITIALIZATION --- */
        window.onload = () => {
            const savedTheme = localStorage.getItem(prefix + 'THEME');
            if(savedTheme) document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('uFullName').innerText = window.userName;
            document.getElementById('uID').innerText = "ID: " + window.userId;
            updateCountdowns(); loadGoalsToUI(); renderGoalHTML(); renderToughSubjects(); renderPyq(); updateStreak();
        };
    </script>
</body>
</html>

