<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Scalpel Study Squad</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Nunito:wght@400;600;700;800&family=Oswald:wght@700&display=swap" rel="stylesheet">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIREBASE MODULE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, set, get, child, update, query, orderByChild, limitToLast }
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAmv7mm6rjaGPNx4IK9LXl3fO61uXxZgCQ",
    authDomain: "scalpel-pro.firebaseapp.com",
    projectId: "scalpel-pro",
    storageBucket: "scalpel-pro.firebasestorage.app",
    messagingSenderId: "244026009766",
    appId: "1:244026009766:web:3299c2dfa37cf378d1ac67"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  const tgUser  = window.Telegram.WebApp.initDataUnsafe?.user || { id:"OFFLINE", first_name:"Guest" };
  const userId  = tgUser.id;
  const userName = tgUser.first_name || "Doctor";

  window.syncToCloud = function() {
    const ALL_KEYS = ['LOGS','NEET','INI','FMGE','SWT','GOALS','PYQ','TOUGH','QUAL'];
    const prefix   = `SSS_PRO_V3_${userId}_`;
    const payload  = {};
    ALL_KEYS.forEach(k => {
      const v = localStorage.getItem(prefix + k);
      if (v) { try { payload[k] = JSON.parse(v); } catch(e){} }
    });
    if (userId === "OFFLINE") return;
    const el = document.getElementById('cloud-sync-status');
    if (el) el.innerText = "Syncing‚Ä¶";
    set(ref(db, 'users/' + userId), payload)
      .then(() => {
        const t = new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
        if (el) { el.innerText = `‚úÖ ${t}`; el.style.color = "#3ecf7c"; }
        if (typeof window.calculateAndPushLeaderboard === 'function')
          window.calculateAndPushLeaderboard();
      })
      .catch(() => {
        if (el) { el.innerText = "‚ö†Ô∏è Offline"; el.style.color = "#f7a94f"; }
      });
  };

  window.pushToLeaderboard = function(stats) {
    if (userId === "OFFLINE") return;
    const updates = {};
    if (stats.streak > 0)
      updates[`/leaderboard/streak/${userId}`] = { name: userName, score: stats.streak, vol: stats.streakVol };
    if (stats.neet  > 0) updates[`/leaderboard/neet/${userId}`]  = { name: userName, score: stats.neet };
    if (stats.ini   > 0) updates[`/leaderboard/ini/${userId}`]   = { name: userName, score: stats.ini };
    if (stats.fmge  > 0) updates[`/leaderboard/fmge/${userId}`]  = { name: userName, score: stats.fmge };
    Object.keys(stats.swt).forEach(sub => {
      if (stats.swt[sub] > 0)
        updates[`/leaderboard/swt/${sub}/${userId}`] = { name: userName, accuracy: stats.swt[sub] };
    });
    update(ref(db), updates).catch(e => console.error("LB Error", e));
  };

  window.fetchLeaderboard = function(category, subject) {
    let path = `leaderboard/${category}`;
    if (category === 'swt' && subject) path += `/${subject}`;
    const qKey    = category === 'swt' ? 'accuracy' : 'score';
    const lbQuery = query(ref(db, path), orderByChild(qKey), limitToLast(50));
    get(lbQuery).then(snap => {
      const data = [];
      if (snap.exists()) snap.forEach(c => data.push(c.val()));
      if (typeof window.renderLeaderboardUI === 'function')
        window.renderLeaderboardUI(data.reverse(), category);
    }).catch(console.error);
  };

  window.pullFromCloud = function() {
    if (userId === "OFFLINE") return;
    const prefix = `SSS_PRO_V3_${userId}_`;
    get(child(ref(db), `users/${userId}`)).then(snap => {
      if (snap.exists()) {
        Object.entries(snap.val()).forEach(([k, v]) =>
          localStorage.setItem(prefix + k, JSON.stringify(v))
        );
        if (typeof updateUI === 'function') updateUI();
      }
    }).catch(console.error);
  };

  window.pullFromCloud();
  setTimeout(() => window.syncToCloud(), 3000);
  setInterval(() => window.syncToCloud(), 600000);
</script>

<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VARIABLES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root{
  --bg:#0f0f16;--bg2:#171722;--card:#1c1c2a;--border:#2a2a42;
  --primary:#4f8ef7;--pglow:rgba(79,142,247,.2);
  --accent:#e05c7a;--accent2:#f7a94f;--green:#3ecf7c;
  --text:#e8e8f2;--muted:#7878a0;
  --shadow:0 8px 32px rgba(0,0,0,.5);
  --gold:#ffd700;--silver:#c0c0c0;--bronze:#cd7f32;
  --inp:#171722;
}
[data-theme="light"]{
  --bg:#f0f2f9;--bg2:#e5e8f4;--card:#ffffff;--border:#cdd2eb;
  --primary:#3a6fd8;--pglow:rgba(58,111,216,.15);
  --accent:#c94066;--accent2:#d4820a;--green:#1fa85a;
  --text:#1a1a2e;--muted:#5a5a80;
  --shadow:0 8px 32px rgba(0,0,0,.1);
  --inp:#ffffff;
}

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{min-height:100vh;background:var(--bg);color:var(--text);
  font-family:'Nunito',sans-serif;transition:background .3s,color .3s;
  overflow-y:auto;-webkit-overflow-scrolling:touch;}
body{padding:12px 12px 50px;}
.wrap{max-width:540px;margin:0 auto;}

.topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.theme-btn{padding:8px 14px;border-radius:20px;border:1px solid var(--border);
  background:var(--card);color:var(--text);cursor:pointer;font-size:12px;
  font-weight:800;letter-spacing:1px;font-family:'Nunito',sans-serif;}
.user-badge{text-align:right;line-height:1.5;}
.u-name{font-size:12px;font-weight:800;color:var(--primary);display:block;}
.u-sync{font-size:9px;color:var(--accent2);display:block;}
.u-id{font-size:9px;color:var(--muted);font-family:monospace;}

.hdr{text-align:center;padding:20px 16px 14px;background:var(--card);
  border-radius:20px;border:1px solid var(--border);box-shadow:var(--shadow);
  position:relative;overflow:hidden;margin-bottom:14px;}
.hdr::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;
  background:linear-gradient(90deg,var(--accent),var(--primary),var(--accent2));}
.hdr-logo{width:78px;height:78px;border-radius:50%;object-fit:cover;
  border:3px solid var(--primary);box-shadow:0 0 20px var(--pglow);margin-bottom:8px;}
.hdr-title{font-family:'Rajdhani',sans-serif;font-size:22px;font-weight:700;
  letter-spacing:2px;color:var(--primary);}
.hdr-sub{font-size:10px;font-weight:800;letter-spacing:3px;color:var(--accent);
  text-transform:uppercase;margin-top:2px;}

.streak-wrap{text-align:center;padding:8px 0 3px;}
.streak-num{font-size:18px;font-weight:800;color:var(--accent2);display:block;}
.streak-ico{font-size:20px;margin:4px 0;}
.streak-hint{font-size:10px;color:var(--muted);}
.quote{font-family:'Oswald',sans-serif;color:var(--accent);font-weight:700;
  font-size:13px;text-transform:uppercase;text-align:center;margin:10px 0 14px;
  line-height:1.4;}

.exam-dash{background:var(--card);border:1px solid var(--border);border-radius:16px;
  padding:12px;margin-bottom:14px;}
.exam-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;}
.exam-item{background:var(--bg2);padding:8px;border-radius:10px;
  border:1px solid rgba(79,142,247,.2);text-align:center;transition:all .3s;}
.exam-item.locked{border-color:var(--green);background:rgba(62,207,124,.1);
  box-shadow:0 0 10px rgba(62,207,124,.2);}
.exam-days{font-size:16px;font-weight:800;color:var(--primary);display:block;}
.exam-item.locked .exam-days{color:var(--green);}
.exam-lbl{font-size:9px;font-weight:800;text-transform:uppercase;
  opacity:.85;letter-spacing:.5px;margin-top:2px;display:block;}

.main-tabs{display:flex;gap:6px;margin-bottom:14px;background:var(--card);
  border-radius:14px;padding:5px;border:1px solid var(--border);}
.m-tab{flex:1;padding:13px 6px;border:none;border-radius:10px;background:transparent;
  color:var(--muted);cursor:pointer;font-weight:800;font-size:13px;
  transition:all .2s;font-family:'Nunito',sans-serif;
  display:flex;flex-direction:column;align-items:center;gap:3px;}
.m-tab .ico{font-size:20px;}
.m-tab.active{background:var(--primary);color:#fff;box-shadow:0 4px 14px var(--pglow);}
.main-pane{display:none;}
.main-pane.active{display:block;}

.sub-tabs{display:flex;gap:4px;margin-bottom:12px;overflow-x:auto;padding-bottom:2px;}
.s-tab{flex:1;min-width:0;padding:9px 3px;border:1px solid var(--border);
  border-radius:10px;background:var(--card);color:var(--muted);cursor:pointer;
  font-weight:800;font-size:9px;text-align:center;transition:all .2s;
  white-space:nowrap;font-family:'Nunito',sans-serif;
  display:flex;flex-direction:column;align-items:center;gap:2px;}
.s-tab .sico{font-size:14px;}
.s-tab.active{background:var(--primary);color:#fff;border-color:var(--primary);
  box-shadow:0 3px 10px var(--pglow);}
.sub-pane{display:none;}
.sub-pane.active{display:block;}

.qual-tabs{display:flex;gap:6px;margin-bottom:12px;background:var(--card);
  border-radius:12px;padding:5px;border:1px solid var(--border);}
.q-tab{flex:1;padding:11px 5px;border:none;border-radius:9px;background:transparent;
  color:var(--muted);cursor:pointer;font-weight:800;font-size:11px;
  transition:all .2s;font-family:'Nunito',sans-serif;}
.q-tab.active{background:var(--accent);color:#fff;}
.qual-pane{display:none;}
.qual-pane.active{display:block;}

.card{background:var(--card);padding:14px;border-radius:16px;
  border:1px solid var(--border);box-shadow:var(--shadow);margin-bottom:13px;}
.card-h{font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:700;
  text-transform:uppercase;color:var(--primary);letter-spacing:1px;}
.acc-hdr{display:flex;justify-content:space-between;align-items:center;
  cursor:pointer;padding:4px 0;}
.acc-arr{transition:transform .3s;font-size:11px;opacity:.7;}
.acc-hdr.open .acc-arr{transform:rotate(180deg);}
.acc-body{display:none;margin-top:12px;}
.acc-body.open{display:block;}

.lbl{display:block;font-size:10px;font-weight:800;letter-spacing:1.5px;
  color:var(--accent);text-transform:uppercase;margin-bottom:5px;margin-top:10px;}
.hint{font-size:9px;color:var(--muted);margin-top:2px;}
input,select,textarea{width:100%;padding:11px 12px;border:1.5px solid var(--border);
  border-radius:10px;background:var(--inp);color:var(--text);font-size:13px;
  font-weight:600;font-family:'Nunito',sans-serif;transition:border .2s;
  box-sizing:border-box;-webkit-appearance:none;appearance:none;resize:vertical;}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);
  box-shadow:0 0 0 3px var(--pglow);}
input[type="date"]{color-scheme:dark;}
[data-theme="light"] input[type="date"]{color-scheme:light;}
input[type="checkbox"]{width:18px;height:18px;cursor:pointer;
  accent-color:var(--primary);-webkit-appearance:checkbox;appearance:checkbox;}
input[type="number"]{text-align:center;}

.btn{padding:13px;border:none;border-radius:11px;font-family:'Rajdhani',sans-serif;
  font-size:15px;font-weight:700;letter-spacing:1.5px;cursor:pointer;
  width:100%;text-transform:uppercase;transition:all .2s;}
.btn:active{transform:scale(.98);}
.btn-p{background:linear-gradient(135deg,var(--primary),#2a5cbe);color:#fff;}
.btn-g{background:linear-gradient(135deg,#27ae60,#1a7a45);color:#fff;}
.btn-r{background:linear-gradient(135deg,var(--accent),#a03050);color:#fff;}
.btn-o{background:linear-gradient(135deg,var(--accent2),#c07020);color:#fff;}
.btn-sm{padding:8px 12px;font-size:11px;border-radius:8px;width:auto;}
.btn-ol{background:transparent;border:1px solid var(--border);color:var(--text);}
.btn-danger{background:none;border:1px solid var(--accent);color:var(--accent);}

#timer-display{font-size:58px;font-weight:800;margin:10px 0;
  font-variant-numeric:tabular-nums;letter-spacing:2px;
  text-align:center;color:var(--primary);}
@media(orientation:landscape){
  #timer-display{font-size:14vh !important;}
  #study-timer-card{min-height:85vh;display:flex;flex-direction:column;justify-content:center;}
}

.chart-wrap{width:100%;height:200px;position:relative;margin:12px 0;}
.chart-scroll{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;
  border-radius:10px;background:rgba(0,0,0,.1);
  border:1px solid rgba(128,128,128,.12);margin-bottom:8px;}
.chart-scroll-inner{height:230px;position:relative;}
.chart-h{font-size:13px;font-weight:800;margin:14px 0 4px;color:var(--accent2);}
.chart-sh{font-size:11px;font-weight:700;text-transform:uppercase;
  letter-spacing:.5px;margin:12px 0 4px;}

/* ‚ïê‚ïê‚ïê LOG TABLE ‚ïê‚ïê‚ïê */
.log-table-wrap{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;margin-top:8px;border-radius:8px;border:1px solid rgba(128,128,128,.12);}
.log-table{width:100%;min-width:380px;font-size:11px;border-collapse:collapse;table-layout:fixed;}
.log-table th,.log-table td{padding:8px 6px;border-bottom:1px solid rgba(128,128,128,.1);overflow:hidden;text-overflow:ellipsis;vertical-align:middle;}
.log-table th{font-size:9px;font-weight:800;color:var(--accent);text-transform:uppercase;letter-spacing:.5px;background:rgba(79,142,247,.08);position:sticky;top:0;white-space:nowrap;text-align:center;}
.log-table td{text-align:center;}
.log-table td.td-date{text-align:left;font-size:10px;font-weight:700;color:var(--accent2);}
.log-table td.td-subs{text-align:left;font-size:10px;color:var(--muted);white-space:normal;word-break:break-word;}
.log-table tr:hover td{background:rgba(79,142,247,.05);}
.log-table .col-date{width:22%;}
.log-table .col-hrs{width:13%;}
.log-table .col-cyc{width:11%;}
.log-table .col-mcq{width:13%;}
.log-table .col-sub{width:41%;}

.matrix-table{width:100%;font-size:10px;border-collapse:collapse;}
.matrix-table th,.matrix-table td{border:1px solid rgba(128,128,128,.12);padding:5px 3px;text-align:center;}
.matrix-table th{background:var(--pglow);font-size:9px;font-weight:800;}
.m-row-h{text-align:left !important;font-weight:700;background:rgba(0,0,0,.1);}
.m-total{font-weight:800;color:var(--accent2);background:rgba(247,169,79,.08);}

.phase-blk{background:var(--bg2);border-radius:12px;padding:12px;
  margin-bottom:12px;border:1px solid var(--border);transition:all .3s;}
.phase-blk.done{border-color:var(--green);background:rgba(62,207,124,.08);
  box-shadow:0 0 14px rgba(62,207,124,.15);}
.phase-badge{font-size:22px;filter:grayscale(1);opacity:.3;transition:all .4s;}
.phase-badge.unlocked{filter:none;opacity:1;transform:scale(1.3);text-shadow:0 0 10px gold;}
.goal-row{display:flex;align-items:center;justify-content:space-between;
  padding:10px 0;border-bottom:1px solid rgba(128,128,128,.08);}
.goal-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:10px 0;}
.goal-box{background:rgba(0,0,0,.2);padding:8px;border-radius:8px;
  text-align:center;position:relative;}
.goal-val{font-size:18px;font-weight:800;color:var(--primary);}
.mini-lock{background:none;border:1px solid var(--border);color:var(--muted);
  border-radius:4px;cursor:pointer;padding:2px 5px;font-size:10px;
  position:absolute;right:4px;top:22px;}
.mini-lock.locked{border-color:var(--green);color:var(--green);pointer-events:none;}
.sub-grid-wrap{max-height:0;overflow:hidden;transition:max-height .3s ease-out;
  background:rgba(0,0,0,.12);border-radius:8px;margin-top:5px;}
.sub-grid-wrap.open{max-height:500px;padding:8px;overflow-y:auto;}
.sub-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px;}
.sub-chk{display:flex;align-items:center;gap:5px;font-size:11px;padding:4px;}
.sub-save-btn{background:var(--green);color:#fff;border:none;padding:11px;
  width:100%;margin-top:8px;border-radius:8px;font-size:12px;font-weight:800;
  cursor:pointer;font-family:'Rajdhani',sans-serif;}

.pyq-nav{display:flex;gap:5px;overflow-x:auto;margin-bottom:12px;padding-bottom:3px;}
.pyq-tab{background:rgba(0,0,0,.2);border:1px solid var(--border);color:var(--muted);
  padding:9px 14px;font-size:11px;border-radius:8px;cursor:pointer;
  white-space:nowrap;flex:1;text-align:center;font-weight:700;position:relative;}
.pyq-tab.active{background:var(--primary);color:#fff;border-color:var(--primary);}
.pyq-panel{display:none;}.pyq-panel.active{display:block;}
.pyq-row{display:flex;align-items:center;justify-content:space-between;
  background:rgba(128,128,128,.07);margin-bottom:4px;padding:8px;
  border-radius:6px;font-size:12px;}
.pyq-col-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.pyq-cup{display:none;position:absolute;top:-12px;right:-5px;
  font-size:18px;z-index:100;animation:popIn .5s ease;}
.pyq-cup.show{display:block;}
@keyframes popIn{from{transform:scale(0)}to{transform:scale(1)}}

.calc-prev{background:var(--pglow);padding:10px;border-radius:8px;
  margin-top:6px;font-size:12px;border:1px dashed var(--primary);
  display:flex;justify-content:space-around;font-weight:800;}

.gt-types{display:flex;margin-bottom:10px;border-radius:8px;
  overflow:hidden;border:1px solid var(--border);}
.gt-type-btn{flex:1;padding:10px;text-align:center;background:var(--bg2);
  font-size:10px;cursor:pointer;border-right:1px solid var(--border);
  font-weight:800;transition:all .2s;}
.gt-type-btn:last-child{border-right:none;}
.gt-type-btn.active{background:var(--primary);color:#fff;}

.month-nav{display:flex;justify-content:space-between;align-items:center;
  background:var(--pglow);border:1px solid var(--border);border-radius:10px;
  padding:8px 12px;margin-bottom:12px;}
.month-btn{background:var(--primary);color:#fff;border:none;padding:5px 12px;
  border-radius:6px;font-weight:800;cursor:pointer;font-size:14px;}
.month-lbl{font-family:'Rajdhani',sans-serif;font-size:15px;
  font-weight:700;color:var(--primary);text-transform:uppercase;}

.gt-stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;}
.gt-stat-box{background:var(--bg2);padding:10px;border-radius:8px;text-align:center;}
.gs-lbl{font-size:9px;color:var(--muted);text-transform:uppercase;
  font-weight:700;margin-bottom:4px;display:block;}
.gs-val{font-size:16px;font-weight:800;}
.v-good{color:var(--green);}.v-bad{color:var(--accent);}

.rank-nav{display:flex;gap:4px;margin-bottom:14px;
  background:rgba(0,0,0,.2);padding:4px;border-radius:10px;}
.rank-nav-btn{flex:1;border:none;background:none;color:var(--muted);
  font-size:10px;font-weight:800;padding:8px 0;border-radius:7px;
  cursor:pointer;font-family:'Nunito',sans-serif;}
.rank-nav-btn.active{background:var(--primary);color:#fff;}
.rank-list{display:flex;flex-direction:column;gap:7px;}
.rank-item{display:flex;align-items:center;background:var(--bg2);
  padding:10px;border-radius:10px;border:1px solid transparent;}
.rank-pos{font-size:14px;font-weight:900;width:28px;text-align:center;
  margin-right:10px;color:var(--muted);}
.rank-info{flex:1;text-align:left;}
.rank-name{font-size:12px;font-weight:800;display:block;}
.rank-meta{font-size:10px;color:var(--primary);opacity:.8;}
.rank-score{font-size:14px;font-weight:800;color:var(--green);}
.r1{border-color:var(--gold);background:rgba(255,215,0,.07);}
.r1 .rank-pos{color:var(--gold);}
.r2{border-color:var(--silver);background:rgba(192,192,192,.07);}
.r2 .rank-pos{color:var(--silver);}
.r3{border-color:var(--bronze);background:rgba(205,127,50,.07);}
.r3 .rank-pos{color:var(--bronze);}
.elite-tag{background:var(--primary);color:#fff;font-size:8px;
  padding:1px 5px;border-radius:4px;margin-left:4px;}

.alert-item{display:flex;justify-content:space-between;align-items:center;
  padding:10px 13px;margin-bottom:5px;border-radius:10px;
  font-size:12px;font-weight:700;border:1px solid transparent;}
.a-safe{background:rgba(62,207,124,.1);color:var(--green);border-color:var(--green);}
.a-warn{background:rgba(241,196,15,.1);color:#f1c40f;border-color:#f1c40f;}
.a-orng{background:rgba(230,126,34,.1);color:#e67e22;border-color:#e67e22;}
.a-crit{background:rgba(224,92,122,.1);color:var(--accent);border-color:var(--accent);
  animation:pls 2s infinite;}
@keyframes pls{0%,100%{box-shadow:none}50%{box-shadow:0 0 8px rgba(224,92,122,.4)}}

/* ‚ïê‚ïê‚ïê SLIDESHOW (upgraded) ‚ïê‚ïê‚ïê */
.slideshow{background:var(--card);border-radius:14px;border:1px solid var(--border);
  border-left:4px solid var(--accent2);padding:15px 16px 44px;margin-bottom:14px;
  min-height:110px;box-shadow:var(--shadow);position:relative;
  user-select:none;-webkit-user-select:none;}
.ss-lbl{font-size:10px;font-weight:800;letter-spacing:2px;
  color:var(--accent2);margin-bottom:8px;text-transform:uppercase;}
.ss-counter{position:absolute;top:12px;right:13px;font-size:10px;
  color:var(--muted);font-weight:700;}
.ss-sub{font-weight:800;color:var(--primary);margin-bottom:4px;font-size:13px;}
.ss-q{color:var(--text);font-size:13px;line-height:1.5;}
.ss-a{color:var(--green);font-weight:700;margin-top:5px;font-size:13px;}
/* progress bar */
.ss-prog-bar{position:absolute;bottom:36px;left:16px;right:16px;
  height:3px;background:rgba(128,128,128,.2);border-radius:3px;overflow:hidden;}
.ss-prog-fill{height:100%;background:var(--accent2);border-radius:3px;
  transition:width 1s linear;}
/* nav row */
.ss-nav{position:absolute;bottom:8px;left:16px;right:16px;
  display:flex;align-items:center;justify-content:space-between;}
.ss-nav-btn{background:rgba(255,255,255,.07);border:1px solid var(--border);
  color:var(--text);border-radius:8px;padding:4px 14px;font-size:16px;
  cursor:pointer;line-height:1;transition:background .2s;}
.ss-nav-btn:active{background:var(--primary);border-color:var(--primary);color:#fff;}
.ss-timer{font-size:10px;color:var(--muted);font-weight:700;}

/* ‚ïê‚ïê‚ïê PDF PROGRESS OVERLAY ‚ïê‚ïê‚ïê */
.pdf-progress-overlay{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);
  z-index:99999;justify-content:center;align-items:center;flex-direction:column;gap:16px;
}
.pdf-progress-overlay.open{display:flex;}
.pdf-spinner{width:48px;height:48px;border:4px solid rgba(79,142,247,.3);
  border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.pdf-prog-text{color:#fff;font-weight:800;font-size:14px;font-family:'Rajdhani',sans-serif;
  letter-spacing:1px;text-align:center;}
.pdf-prog-sub{color:var(--muted);font-size:11px;}
.pdf-share-card{
  background:var(--card);border-radius:16px;border:2px solid var(--primary);
  padding:22px 20px;width:88%;max-width:360px;text-align:center;
}
.pdf-share-card h3{color:var(--primary);margin-bottom:6px;
  font-family:'Rajdhani',sans-serif;font-size:20px;letter-spacing:1px;}
.pdf-share-card .pdf-method-badge{
  display:inline-block;background:var(--green);color:#fff;
  font-size:10px;font-weight:800;padding:2px 10px;border-radius:20px;
  margin-bottom:12px;letter-spacing:1px;
}
.pdf-share-card p{color:var(--muted);font-size:11px;margin-bottom:14px;line-height:1.6;}
.pdf-share-btns{display:flex;flex-direction:column;gap:9px;}

/* ‚ïê‚ïê‚ïê PRINT VIEWER OVERLAY ‚ïê‚ïê‚ïê */
.print-overlay{
  display:none;position:fixed;inset:0;z-index:100000;
  flex-direction:column;background:#f0f2f8;
}
.print-overlay.open{display:flex;}
.print-bar{
  display:flex;align-items:center;gap:8px;
  padding:10px 14px;background:#1a1a2a;border-bottom:2px solid var(--primary);
  flex-shrink:0;
}
.print-bar-title{
  font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;color:#fff;
  letter-spacing:1px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.print-bar-btns{display:flex;gap:7px;flex-shrink:0;}
.pb-btn{padding:9px 14px;border-radius:8px;border:none;
  font-family:'Rajdhani',sans-serif;font-weight:700;font-size:12px;cursor:pointer;
  letter-spacing:.5px;}
.pb-print{background:var(--green);color:#fff;}
.pb-share{background:var(--primary);color:#fff;}
.pb-close{background:var(--accent);color:#fff;}
.print-body{flex:1;overflow-y:auto;padding:14px 10px;}
.print-hint{
  background:#fff3cd;border:1px solid #ffc107;border-radius:8px;
  padding:10px 12px;margin-bottom:12px;font-size:11px;color:#856404;
  font-weight:700;line-height:1.5;text-align:center;
}
@media print{
  body > *{display:none !important;}
  .print-overlay,.print-overlay.open{display:block !important;position:static !important;}
  .print-bar,.print-hint{display:none !important;}
  .print-body{overflow:visible !important;padding:0 !important;}
  .rpt{box-shadow:none !important;}
}

/* ‚ïê‚ïê‚ïê REPORT OVERLAY ‚ïê‚ïê‚ïê */
.roverlay{display:none;position:fixed;inset:0;z-index:9999;flex-direction:column;}
.roverlay.open{display:flex;}
.roverlay-bar{display:flex;align-items:center;justify-content:space-between;
  padding:10px 14px;background:#0f0f14;border-bottom:2px solid var(--primary);
  gap:8px;flex-shrink:0;}
.rov-title{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;
  color:#fff;letter-spacing:1px;flex:1;overflow:hidden;
  text-overflow:ellipsis;white-space:nowrap;}
.rov-btns{display:flex;gap:7px;flex-shrink:0;}
.rbtn{padding:9px 14px;border-radius:8px;border:none;
  font-family:'Rajdhani',sans-serif;font-weight:700;font-size:13px;cursor:pointer;}
.rbtn-dl{background:var(--green);color:#fff;}
.rbtn-dl:disabled{background:#555;cursor:wait;}
.rbtn-cl{background:var(--accent);color:#fff;}
.roverlay-body{flex:1;overflow-y:auto;padding:14px;background:#f0f2f8;}

/* ‚ïê‚ïê‚ïê REPORT HTML STYLES ‚ïê‚ïê‚ïê */
.rpt{max-width:660px;margin:0 auto;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.15);}
.rpt-hd{background:#1a1a2a;padding:20px;text-align:center;position:relative;}
.rpt-u{position:absolute;top:10px;right:14px;text-align:right;font-size:10px;color:#aaccee;line-height:1.6;}
.rpt-u b{color:#fff;}
.rpt-logo{width:60px;height:60px;border-radius:50%;border:3px solid #4f8ef7;margin-bottom:8px;}
.rpt-hd-n{font-family:'Rajdhani',sans-serif;font-size:20px;font-weight:700;color:#fff;letter-spacing:2px;}
.rpt-hd-t{font-size:10px;font-weight:800;letter-spacing:3px;color:#e05c7a;text-transform:uppercase;margin-top:3px;}
.rpt-stripe{height:3px;background:linear-gradient(90deg,#e05c7a,#4f8ef7,#f7a94f);}
.rpt-meta{background:#f7f9ff;padding:11px 20px;text-align:center;border-bottom:1px solid #e0e4f0;}
.rpt-rtype{font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;color:#1a1a2a;}
.rpt-rdate{font-size:11px;color:#666;margin-top:2px;}
.rpt-body{padding:16px;}
.rpt-sec{margin-bottom:20px;}
.rpt-sec-h{font-family:'Rajdhani',sans-serif;font-size:13px;font-weight:700;letter-spacing:2px;color:#fff;padding:8px 13px;border-radius:7px;margin-bottom:9px;text-transform:uppercase;}
.sh-g{background:#1a7a48;}.sh-b{background:#2558b0;}.sh-r{background:#9a2540;}
.rpt-sub-h{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:700;letter-spacing:1.5px;color:#4f8ef7;text-transform:uppercase;border-left:4px solid #4f8ef7;padding:3px 10px;margin:9px 0 5px;}
.rpt-entry{background:#f8f9fc;border-radius:8px;padding:11px 13px;margin-bottom:7px;border:1px solid #e0e4f0;}
.rpt-enum{font-size:9px;font-weight:800;color:#bbb;letter-spacing:1px;margin-bottom:5px;}
.rpt-fl-lbl{font-size:9px;font-weight:800;color:#e05c7a;text-transform:uppercase;letter-spacing:1px;}
.rpt-fl-val{font-size:12px;color:#222;margin-top:1px;line-height:1.5;margin-bottom:5px;}
.rpt-empty{text-align:center;padding:25px;font-size:13px;color:#999;}
.rpt-foot{background:#f0f2f8;padding:9px;text-align:center;font-size:9px;color:#aaa;border-top:1px solid #e0e4f0;}

.pop-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.96);
  z-index:2000;justify-content:center;align-items:center;flex-direction:column;}
.pop-overlay.open{display:flex;}
.pop-card{background:var(--card);padding:22px;border-radius:18px;
  border:2px solid var(--primary);width:85%;max-width:320px;
  text-align:center;overflow-y:auto;max-height:82vh;color:var(--text);display:none;}
.sb-row{display:grid;grid-template-columns:1fr 48px 48px 48px;
  gap:5px;align-items:center;margin-bottom:5px;font-size:10px;}

.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);
  background:var(--green);color:#fff;padding:11px 22px;border-radius:28px;
  font-weight:800;font-size:12px;letter-spacing:1px;
  box-shadow:0 8px 30px rgba(0,0,0,.4);opacity:0;transition:opacity .3s;
  z-index:99999;pointer-events:none;white-space:nowrap;
  max-width:90vw;text-align:center;}
.toast.show{opacity:1;}

.danger-zone{margin-top:26px;padding:16px;border-top:1px dashed rgba(128,128,128,.2);}

.row2{display:flex;gap:8px;}
.row2>*{flex:1;}
.info-box{background:var(--pglow);padding:11px 13px;border-radius:9px;
  margin-top:12px;font-size:11px;line-height:1.5;border-left:3px solid var(--primary);}
.perf-row{display:flex;justify-content:space-between;align-items:center;
  padding:8px 10px;background:rgba(0,0,0,.15);border-radius:8px;
  margin-bottom:6px;font-size:13px;font-weight:800;}
.p-strong{color:var(--green);}.p-weak{color:var(--accent);}
.monthly-table{width:100%;font-size:11px;border-collapse:collapse;}
.monthly-table th,.monthly-table td{padding:8px 5px;border-bottom:1px solid rgba(128,128,128,.08);text-align:center;}
.monthly-table th{color:var(--accent);font-weight:800;font-size:10px;text-transform:uppercase;}
.divider{border:0;border-top:1px solid rgba(128,128,128,.12);margin:14px 0;}

/* PDF section */
.pdf-card{background:var(--card);border-radius:14px;padding:18px;border:1px solid var(--border);margin-top:14px;}
.pdf-title{font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:700;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:12px;text-align:center;}
.warn-box{background:rgba(247,169,79,.1);border:1px solid var(--accent2);border-radius:10px;padding:11px 13px;margin-bottom:14px;font-size:11px;line-height:1.5;color:var(--accent2);}
.pdf-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.pdf-btn{padding:14px 8px;border-radius:11px;border:2px solid var(--primary);background:transparent;color:var(--text);font-weight:800;font-size:12px;letter-spacing:1px;cursor:pointer;font-family:'Rajdhani',sans-serif;text-transform:uppercase;transition:all .2s;}
.pdf-btn.mo{border-color:var(--accent2);}
</style>
</head>
<body data-theme="dark">

<!-- POPUP OVERLAY -->
<div class="pop-overlay" id="pop-overlay">
  <div class="pop-card" id="pop-mcq">
    <h3 style="color:var(--primary)">Cycle Complete!</h3>
    <p style="font-size:12px;margin:10px 0;color:var(--muted)">How many MCQs did you solve?</p>
    <input type="number" id="cycleMcqs" placeholder="0">
    <button class="btn btn-g" style="margin-top:12px" onclick="startBreak()">Record &amp; Start Break</button>
  </div>
  <div class="pop-card" id="pop-break">
    <h3 style="color:var(--accent2)">Break Over!</h3>
    <p style="font-size:12px;margin:10px 0;color:var(--muted)">Ready for the next cycle?</p>
    <button class="btn btn-g" onclick="continueNextCycle()">Start Next Cycle</button>
    <button class="btn btn-r" style="margin-top:8px" onclick="stopSession()">End Session</button>
  </div>
  <div class="pop-card" id="pop-restore">
    <h3 style="color:var(--primary)">Restore Data</h3>
    <p style="font-size:11px;color:var(--muted);margin:10px 0">Paste your backup code below:</p>
    <textarea id="restoreInput" rows="4" style="font-size:10px;" placeholder="Paste code here..."></textarea>
    <button class="btn btn-g" style="margin-top:10px" onclick="processRestore()">Import Data</button>
    <button class="btn btn-ol" style="margin-top:7px" onclick="closePopup()">Cancel</button>
  </div>
  <div class="pop-card" id="pop-gt-breakdown" style="width:95%;max-width:400px;">
    <h3 style="color:var(--primary)">GT Subject Breakdown</h3>
    <p style="font-size:10px;color:var(--muted);margin:8px 0">Total / Correct / Unattempted per subject</p>
    <div class="sb-row" style="font-weight:800;color:var(--accent);font-size:10px;">
      <span>Subject</span><span>Tot</span><span>C</span><span>U</span>
    </div>
    <div id="gt-sub-inputs" style="max-height:300px;overflow-y:auto;margin-bottom:12px;"></div>
    <button class="btn btn-g" onclick="finalizeGTSave()">Save GT</button>
    <button class="btn btn-ol" style="margin-top:7px" onclick="closePopup()">Cancel</button>
  </div>
</div>

<!-- PDF PROGRESS OVERLAY -->
<div class="pdf-progress-overlay" id="pdf-progress-overlay">
  <div id="pdf-spinner-wrap" style="display:flex;flex-direction:column;align-items:center;gap:12px">
    <div class="pdf-spinner"></div>
    <div class="pdf-prog-text" id="pdf-prog-text">Building PDF‚Ä¶</div>
    <div class="pdf-prog-sub">Please wait, do not close</div>
  </div>
  <div class="pdf-share-card" id="pdf-share-card" style="display:none">
    <h3>üìÑ PDF Ready!</h3>
    <div class="pdf-method-badge" id="pdf-method-badge">SHARE</div>
    <p id="pdf-share-desc">Choose how to save your report:</p>
    <div class="pdf-share-btns" id="pdf-share-btns"></div>
    <button class="btn btn-ol" style="margin-top:10px;width:100%;padding:10px;border-radius:8px;font-size:12px;font-weight:800;cursor:pointer;font-family:'Nunito',sans-serif;background:transparent;border:1px solid var(--border);color:var(--text)" onclick="closePdfOverlay()">Close</button>
  </div>
</div>

<!-- PRINT / SCREENSHOT VIEWER OVERLAY -->
<div class="print-overlay" id="print-overlay">
  <div class="print-bar">
    <div class="print-bar-title" id="print-bar-title">üìÑ Report Viewer</div>
    <div class="print-bar-btns">
      <button class="pb-btn pb-print" onclick="doPrint()">üñ®Ô∏è Print/Save</button>
      <button class="pb-btn pb-share" id="pb-native-share" style="display:none" onclick="doNativeShare()">üì§ Share</button>
      <button class="pb-btn pb-close" onclick="closePrintOverlay()">‚úï</button>
    </div>
  </div>
  <div class="print-body">
    <div class="print-hint" id="print-hint">
      üì± <strong>Telegram Tip:</strong> Tap <strong>üñ®Ô∏è Print/Save</strong> ‚Üí select <em>"Save as PDF"</em> from the printer options. Or take screenshots of each page.
    </div>
    <div id="print-content"></div>
  </div>
</div>

<!-- REPORT OVERLAY -->
<div class="roverlay" id="roverlay">
  <div class="roverlay-bar">
    <div class="rov-title" id="rov-title">üìÑ Report</div>
    <div class="rov-btns">
      <button class="rbtn rbtn-dl" id="dl-btn" onclick="downloadPDF()">‚¨áÔ∏è PDF</button>
      <button class="rbtn rbtn-cl" onclick="closeOverlay()">‚úï</button>
    </div>
  </div>
  <div class="roverlay-body" id="roverlay-body"></div>
</div>

<div class="toast" id="toast"></div>

<!-- APP -->
<div class="wrap">

  <!-- TOPBAR -->
  <div class="topbar">
    <button class="theme-btn" onclick="toggleTheme()">üåì THEME</button>
    <div class="user-badge">
      <span class="u-name" id="uName">Connecting‚Ä¶</span>
      <span class="u-sync" id="cloud-sync-status">Cloud: Initializing‚Ä¶</span>
      <span class="u-id" id="uId">ID: ‚Äî</span>
    </div>
  </div>

  <!-- HEADER -->
  <div class="hdr">
    <img src="https://raw.githubusercontent.com/dhruvathaare/Scaslpel-Study-Squad-Apps/789a623092f757f3cd2b32c9bc305aa3a9c0819f/photo_2026-02-12_20-08-36.jpg"
         class="hdr-logo" alt="Logo" onerror="this.style.display='none'">
    <div class="hdr-title">Scalpel Study Squad</div>
    <div class="hdr-sub">Pro Suite V8</div>
  </div>

  <!-- STREAK + QUOTE -->
  <div class="streak-wrap">
    <span class="streak-num" id="streakText">Consistency: 0 Days</span>
    <div class="streak-ico" id="streakIco"></div>
    <div class="streak-hint">üî• per 25 days &nbsp;|&nbsp; ü•á per 75 days</div>
  </div>
  <div class="quote">"I AM HERE TO WIN ‚Äî CONSISTENCY IS MY KITH AND KIN"</div>

  <!-- EXAM COUNTDOWN -->
  <div class="exam-dash">
    <div class="exam-grid">
      <div class="exam-item" id="di_ini_jul"><span class="exam-days" id="d_ini_jul">--</span><span class="exam-lbl">INICET July</span></div>
      <div class="exam-item" id="di_upsc"><span class="exam-days" id="d_upsc">--</span><span class="exam-lbl">UPSC CMS</span></div>
      <div class="exam-item" id="di_neet"><span class="exam-days" id="d_neet">--</span><span class="exam-lbl">NEET PG 2026</span></div>
      <div class="exam-item" id="di_ini_jan"><span class="exam-days" id="d_ini_jan">--</span><span class="exam-lbl">INICET Jan '27</span></div>
      <div class="exam-item" id="di_fmge_jun"><span class="exam-days" id="d_fmge_jun">--</span><span class="exam-lbl">FMGE June '26</span></div>
      <div class="exam-item" id="di_fmge_dec"><span class="exam-days" id="d_fmge_dec">--</span><span class="exam-lbl">FMGE Dec '26</span></div>
    </div>
  </div>

  <!-- MAIN TAB BAR -->
  <div class="main-tabs">
    <button class="m-tab active" onclick="switchMain('quant',this)">
      <span class="ico">üìä</span>QUANTITATIVE
    </button>
    <button class="m-tab" onclick="switchMain('qual',this)">
      <span class="ico">üìù</span>QUALITATIVE
    </button>
  </div>

  <!-- QUANTITATIVE PANE -->
  <div id="pane-quant" class="main-pane active">
    <div class="sub-tabs">
      <div class="s-tab active" onclick="switchSub('sq-goal',this)"><span class="sico">üéØ</span>Goal</div>
      <div class="s-tab" onclick="switchSub('sq-daily',this)"><span class="sico">üìÖ</span>Daily</div>
      <div class="s-tab" onclick="switchSub('sq-swt',this)"><span class="sico">üß†</span>SWT</div>
      <div class="s-tab" onclick="switchSub('sq-gt',this)"><span class="sico">üìà</span>GT</div>
      <div class="s-tab" onclick="switchSub('sq-rank',this)"><span class="sico">üèÜ</span>Ranks</div>
    </div>

    <!-- GOAL TAB -->
    <div id="sq-goal" class="sub-pane active">
      <div class="card">
        <div class="acc-hdr" onclick="toggleAcc('a_exams',this)">
          <div class="card-h">My Target Exams</div><span class="acc-arr">‚ñº</span>
        </div>
        <div id="a_exams" class="acc-body">
          <div class="goal-row"><span>INICET July</span><input type="checkbox" id="g_ini_jul" onchange="saveGoals()"></div>
          <div class="goal-row"><span>UPSC CMS</span><input type="checkbox" id="g_upsc" onchange="saveGoals()"></div>
          <div class="goal-row"><span>NEET PG 2026</span><input type="checkbox" id="g_neet" onchange="saveGoals()"></div>
          <div class="goal-row"><span>INICET Jan '27</span><input type="checkbox" id="g_ini_jan" onchange="saveGoals()"></div>
          <div class="goal-row"><span>FMGE June '26</span><input type="checkbox" id="g_fmge_jun" onchange="saveGoals()"></div>
          <div class="goal-row"><span>FMGE Dec '26</span><input type="checkbox" id="g_fmge_dec" onchange="saveGoals()"></div>
          <button class="btn btn-p" style="margin-top:10px" onclick="lockExams()">Lock &amp; Let's Go! üöÄ</button>
        </div>
      </div>

      <div class="card">
        <div class="acc-hdr" onclick="toggleAcc('a_tough',this)">
          <div class="card-h">My Tough Subjects</div><span class="acc-arr">‚ñº</span>
        </div>
        <div id="a_tough" class="acc-body">
          <div style="font-size:11px;color:var(--muted);margin-bottom:8px">Select subjects to monitor closely:</div>
          <div id="tough-selector" class="sub-grid"></div>
        </div>
      </div>

      <div class="card">
        <div class="acc-hdr" onclick="toggleAcc('a_pyq',this)">
          <div class="card-h">PYQ Papers Goal</div><span class="acc-arr">‚ñº</span>
        </div>
        <div id="a_pyq" class="acc-body">
          <div class="pyq-nav">
            <div class="pyq-tab active" onclick="switchPyq('neet',this)">NEET PG<span id="cup_neet" class="pyq-cup">üèÜ</span></div>
            <div class="pyq-tab" onclick="switchPyq('ini',this)">INICET<span id="cup_ini" class="pyq-cup">üèÜ</span></div>
            <div class="pyq-tab" onclick="switchPyq('fmge',this)">FMGE<span id="cup_fmge" class="pyq-cup">üèÜ</span></div>
            <div class="pyq-tab" onclick="switchPyq('upsc',this)">UPSC<span id="cup_upsc" class="pyq-cup">üèÜ</span></div>
          </div>
          <div id="pyq-root"></div>
        </div>
      </div>

      <div class="card">
        <div class="acc-hdr" onclick="toggleAcc('a_monthly',this)">
          <div class="card-h">Monthly Goals Reached</div><span class="acc-arr">‚ñº</span>
        </div>
        <div id="a_monthly" class="acc-body">
          <div style="overflow-x:auto">
            <table class="monthly-table">
              <thead><tr><th>Month</th><th>MCQs</th><th>SWTs</th><th>GTs</th></tr></thead>
              <tbody id="monthlyBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="acc-hdr" onclick="toggleAcc('a_phases',this)">
          <div class="card-h">Reading Phases</div><span class="acc-arr">‚ñº</span>
        </div>
        <div id="a_phases" class="acc-body">
          <div id="phases-root"></div>
          <div class="info-box">
            <strong>How to use Phases:</strong><br>
            1. Set start/end dates.<br>2. Set SWT &amp; GT targets.<br>
            3. Check off subjects as you complete them.<br>4. Lock to save.
          </div>
        </div>
      </div>
    </div>

    <!-- DAILY TAB -->
    <div id="sq-daily" class="sub-pane">
      <div id="tough-dash" style="margin-bottom:12px"></div>
      <div class="card" id="study-timer-card">
        <span class="lbl">Reading Phase</span>
        <select id="studyPhase">
          <option>First Reading</option><option>Second Reading</option>
          <option>Third Reading</option><option>Extra Bonus</option>
        </select>
        <span class="lbl">Subject</span>
        <select id="subject">
          <option value="" disabled selected>Select Subject</option>
          <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option>
          <option>Pathology</option><option>Microbiology</option><option>Pharmacology</option>
          <option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option>
          <option>Medicine</option><option>Surgery</option><option>OBG</option>
          <option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option>
          <option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option>
          <option>Mixed Bag</option><option>Integrated Systems</option>
        </select>
        <div class="row2" style="margin-top:8px">
          <div>
            <span class="lbl">Duration</span>
            <div class="row2">
              <div><input type="number" id="studyHr" value="2"><span class="hint">Hours</span></div>
              <div><input type="number" id="studyMin" value="0"><span class="hint">Mins</span></div>
            </div>
          </div>
          <div>
            <span class="lbl">Break</span>
            <input type="number" id="breakTime" value="15"><span class="hint">Mins</span>
          </div>
        </div>
        <div id="timer-display">00:00:00</div>
        <button id="startBtn" class="btn btn-g" onclick="startSession()">Start Session</button>
        <div id="timer-controls" style="display:none">
          <div class="row2">
            <button id="pauseBtn" class="btn btn-o" onclick="togglePause()">Pause</button>
            <button class="btn" style="background:var(--primary)" onclick="handleTransition()">Skip</button>
          </div>
          <button class="btn btn-r" style="margin-top:8px" onclick="stopSession()">End Session</button>
        </div>
      </div>

      <div class="card">
        <div class="month-nav">
          <button class="month-btn" onclick="changeViewMonth(-1)">‚óÄ</button>
          <div class="month-lbl" id="monthLabel">Month Year</div>
          <button class="month-btn" onclick="changeViewMonth(1)">‚ñ∂</button>
        </div>
        <div class="chart-h">Study Hours Trend</div>
        <div class="chart-wrap"><canvas id="hoursChart"></canvas></div>
        <div class="chart-h" style="color:var(--primary)">MCQs Solved Trend</div>
        <div class="chart-wrap"><canvas id="mcqChart"></canvas></div>

        <div class="chart-sh" style="color:var(--accent2);margin-top:12px">üìã Study Log</div>
        <div class="log-table-wrap">
          <table class="log-table">
            <colgroup>
              <col class="col-date"><col class="col-hrs"><col class="col-cyc">
              <col class="col-mcq"><col class="col-sub">
            </colgroup>
            <thead>
              <tr>
                <th class="col-date">Date</th><th class="col-hrs">Hours</th>
                <th class="col-cyc">Cycles</th><th class="col-mcq">MCQs</th>
                <th class="col-sub">Subjects</th>
              </tr>
            </thead>
            <tbody id="logBody"></tbody>
          </table>
        </div>

        <div class="chart-sh" style="color:var(--primary);border-top:1px solid rgba(128,128,128,.1);padding-top:10px;margin-top:10px">Phase Matrix ‚Äî Days</div>
        <div style="overflow-x:auto"><table class="matrix-table"><thead><tr><th style="text-align:left">Subject</th><th>1st</th><th>2nd</th><th>3rd</th><th>Bonus</th></tr></thead><tbody id="matrixBody"></tbody></table></div>
        <div class="chart-sh" style="color:var(--green);margin-top:12px">Phase Matrix ‚Äî MCQs</div>
        <div style="overflow-x:auto"><table class="matrix-table"><thead><tr><th style="text-align:left">Subject</th><th>1st</th><th>2nd</th><th>3rd</th><th>Bonus</th></tr></thead><tbody id="mcqMatrixBody"></tbody></table></div>
      </div>
    </div>

    <!-- SWT TAB -->
    <div id="sq-swt" class="sub-pane">
      <div class="card">
        <div class="card-h" style="margin-bottom:12px">SWT Analytics</div>
        <span class="lbl">Reading Phase</span>
        <select id="swtPhase">
          <option>First Reading</option><option>Second Reading</option>
          <option>Third Reading</option><option>Extra Bonus</option>
        </select>
        <span class="lbl">Subject</span>
        <select id="swtSubject" onchange="renderSWT()">
          <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option>
          <option>Pathology</option><option>Microbiology</option><option>Pharmacology</option>
          <option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option>
          <option>Medicine</option><option>Surgery</option><option>OBG</option>
          <option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option>
          <option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option>
          <option>Mixed Bag</option><option>Integrated Systems</option>
        </select>
        <div class="row2" style="margin-top:8px">
          <div><span class="lbl">Date</span><input type="date" id="swtDate"><span class="hint">Today or past</span></div>
          <div><span class="lbl">Total Qs</span><input type="number" id="swtTotal" oninput="calcSWT()"></div>
        </div>
        <div class="row2" style="margin-top:6px">
          <div><span class="lbl">Correct</span><input type="number" id="swtCorrect" oninput="calcSWT()"></div>
          <div><span class="lbl">Unattempted</span><input type="number" id="swtUnat" oninput="calcSWT()"></div>
        </div>
        <div class="calc-prev">
          <span>Wrong: <b id="swtW">0</b></span>
          <span>Accuracy: <b id="swtP">0%</b></span>
        </div>
        <button class="btn btn-p" style="margin-top:10px" onclick="saveSWT()">Save SWT Result</button>
        <div class="chart-sh" style="color:var(--primary)">Subject Trend</div>
        <div class="chart-wrap"><canvas id="swtChart"></canvas></div>
        <div class="chart-sh" style="color:#3498db">Tests Taken per Phase</div>
        <div class="chart-wrap"><canvas id="swtPhaseCountChart"></canvas></div>
        <div class="chart-sh" style="color:#9b59b6">Average % per Phase</div>
        <div class="chart-wrap"><canvas id="swtPhaseAvgChart"></canvas></div>
        <div class="chart-sh" style="color:var(--accent2)">Cumulative (All Subjects)</div>
        <div class="chart-wrap"><canvas id="swtCumChart"></canvas></div>
        <div class="chart-sh" style="color:var(--green)">Total Questions Solved</div>
        <div class="chart-wrap"><canvas id="swtQChart"></canvas></div>
        <div class="perf-row"><span>Strong Subject:</span><span class="p-strong" id="swtStrong">--</span></div>
        <div class="perf-row"><span>Weak Subject:</span><span class="p-weak" id="swtWeak">--</span></div>
      </div>
    </div>

    <!-- GT TAB -->
    <div id="sq-gt" class="sub-pane">
      <div class="card">
        <div class="card-h" style="margin-bottom:10px">GT Intelligence</div>
        <div class="gt-types">
          <div class="gt-type-btn active" id="gtTabNeet" onclick="switchGT('NEET')"><b>NEET PG</b><br><small>+4/‚àí1</small></div>
          <div class="gt-type-btn" id="gtTabINICET" onclick="switchGT('INICET')"><b>INICET</b><br><small>+1/‚àí0.33</small></div>
          <div class="gt-type-btn" id="gtTabFMGE" onclick="switchGT('FMGE')"><b>FMGE</b><br><small>+1/0</small></div>
        </div>
        <span class="lbl">Reading Phase</span>
        <select id="gtPhase">
          <option>First Reading</option><option>Second Reading</option>
          <option>Third Reading</option><option>Extra Bonus</option>
        </select>
        <span class="lbl">Platform</span>
        <input type="text" id="gtPlatform" placeholder="Marrow, PrepLadder, etc.">
        <span class="lbl">Date</span>
        <input type="date" id="gtDate">

        <div id="gt-std-inputs">
          <div class="row2" style="margin-top:8px">
            <div><span class="lbl">Correct</span><input type="number" id="gtCorrect" oninput="calcGT()"></div>
            <div><span class="lbl">Unattempted</span><input type="number" id="gtUnat" oninput="calcGT()"></div>
          </div>
          <div class="calc-prev">
            <span>Wrong: <b id="gtW">0</b></span>
            <span>Score: <b id="gtS">0</b></span>
          </div>
        </div>

        <div id="gt-fmge-inputs" style="display:none">
          <div class="row2" style="margin-top:8px">
            <div>
              <span class="lbl" style="text-decoration:underline">Paper 1 (150)</span>
              <span class="lbl">Correct</span><input type="number" id="gtP1C" oninput="calcGT()">
              <span class="lbl">Unattempted</span><input type="number" id="gtP1U" oninput="calcGT()">
              <div style="font-size:10px;margin-top:4px">Score: <b id="gtS1">0</b></div>
            </div>
            <div>
              <span class="lbl" style="text-decoration:underline">Paper 2 (150)</span>
              <span class="lbl">Correct</span><input type="number" id="gtP2C" oninput="calcGT()">
              <span class="lbl">Unattempted</span><input type="number" id="gtP2U" oninput="calcGT()">
              <div style="font-size:10px;margin-top:4px">Score: <b id="gtS2">0</b></div>
            </div>
          </div>
          <div class="calc-prev">
            <span>Total: <b id="gtTotFmge">0</b></span>
            <span id="gtFmgeStatus">--</span>
          </div>
        </div>

        <button class="btn btn-g" style="margin-top:10px" onclick="openGTBreakdown()">Save &amp; Enter Breakdown</button>

        <hr class="divider">
        <span class="lbl">Review Past GT</span>
        <select id="gtHistorySelect" onchange="renderGTBreakdownGraph()">
          <option value="">Select a GT to review</option>
        </select>
        <div id="gtReviewMeta" style="display:none;margin:8px 0;font-size:12px;text-align:center;color:var(--primary);font-weight:800"></div>
        <div class="chart-scroll" id="gtBdChartWrap" style="display:none">
          <div class="chart-scroll-inner" id="gtBdScrollInner"><canvas id="gtBreakdownChart"></canvas></div>
        </div>

        <div id="neet-area">
          <div class="chart-sh" style="color:var(--accent2)">NEET PG Progress</div>
          <div class="chart-scroll"><div class="chart-scroll-inner" id="neet-scroll-inner"><canvas id="gtNeetChart"></canvas></div></div>
          <div class="chart-sh" style="color:#3498db">GTs per Phase</div>
          <div class="chart-wrap"><canvas id="neetPhaseCountChart"></canvas></div>
          <div class="chart-sh" style="color:#9b59b6">Avg Score per Phase</div>
          <div class="chart-wrap"><canvas id="neetPhaseAvgChart"></canvas></div>
          <div id="neetStats"></div>
        </div>

        <div id="ini-area" style="display:none">
          <div class="chart-sh" style="color:var(--green)">INICET Progress</div>
          <div class="chart-scroll"><div class="chart-scroll-inner" id="ini-scroll-inner"><canvas id="gtIniChart"></canvas></div></div>
          <div class="chart-sh" style="color:#3498db">GTs per Phase</div>
          <div class="chart-wrap"><canvas id="iniPhaseCountChart"></canvas></div>
          <div class="chart-sh" style="color:#9b59b6">Avg Score per Phase</div>
          <div class="chart-wrap"><canvas id="iniPhaseAvgChart"></canvas></div>
          <div id="iniStats"></div>
        </div>

        <div id="fmge-area" style="display:none">
          <div class="chart-sh" style="color:var(--accent2)">FMGE Total Progress</div>
          <div class="chart-scroll"><div class="chart-scroll-inner" id="fmge-scroll-inner"><canvas id="gtFmgeChart"></canvas></div></div>
          <div class="chart-sh" style="color:#3498db">GTs per Phase</div>
          <div class="chart-wrap"><canvas id="fmgePhaseCountChart"></canvas></div>
          <div class="chart-sh" style="color:#9b59b6">Avg Score per Phase</div>
          <div class="chart-wrap"><canvas id="fmgePhaseAvgChart"></canvas></div>
          <div id="fmgeStats"></div>
        </div>
      </div>
    </div>

    <!-- RANKINGS TAB -->
    <div id="sq-rank" class="sub-pane">
      <div class="card">
        <div style="text-align:center;margin-bottom:14px">
          <div style="font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:700;color:var(--accent2)">LEADERBOARD ARENA</div>
          <div style="font-size:10px;color:var(--muted)">Top 50 Elites ‚Ä¢ Live</div>
        </div>
        <div class="rank-nav">
          <button class="rank-nav-btn active" onclick="switchRank('streak',this)">üî• Streaks</button>
          <button class="rank-nav-btn" onclick="switchRank('swt',this)">üß† Subjects</button>
          <button class="rank-nav-btn" onclick="switchRank('gt',this)">üèõÔ∏è Hall of Fame</button>
        </div>
        <div id="rank-filter-streak">
          <div style="background:rgba(247,169,79,.1);border:1px solid var(--accent2);border-radius:8px;padding:10px;font-size:11px;color:var(--accent2);margin-bottom:12px">
            <strong>MCQ Marathon:</strong> Min 50 MCQs/day to maintain streak. Tie-breaker: Total volume.
          </div>
        </div>
        <div id="rank-filter-swt" style="display:none">
          <span class="lbl">Subject Arena</span>
          <select id="rankSubSelect" onchange="loadLeaderboard('swt')">
            <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option>
            <option>Pathology</option><option>Microbiology</option><option>Pharmacology</option>
            <option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option>
            <option>Medicine</option><option>Surgery</option><option>OBG</option>
            <option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option>
            <option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option>
          </select>
          <div style="font-size:9px;color:var(--muted);text-align:center;margin-top:4px">Min 300 Qs required to rank</div>
        </div>
        <div id="rank-filter-gt" style="display:none">
          <span class="lbl">Exam Category</span>
          <select id="rankGtSelect" onchange="loadLeaderboard('gt')">
            <option value="neet">NEET PG (out of 800)</option>
            <option value="ini">INICET (out of 200)</option>
            <option value="fmge">FMGE (out of 300)</option>
          </select>
          <div style="font-size:11px;color:var(--muted);margin:10px 0;padding:10px;border-left:2px solid var(--primary);background:rgba(0,0,0,.15);border-radius:0 8px 8px 0">
            Based on <strong>Arithmetic Mean</strong> of all GTs.<br>Minimum <strong>3 GTs</strong> to qualify. Platform hidden.
          </div>
        </div>
        <hr class="divider">
        <div id="leaderboard-list" class="rank-list">
          <div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">Fetching ranks‚Ä¶</div>
        </div>
      </div>
    </div>

  </div><!-- /pane-quant -->

  <!-- QUALITATIVE PANE -->
  <div id="pane-qual" class="main-pane">

    <!-- SLIDESHOW (upgraded: 10s timer, prev/next, swipe) -->
    <div class="slideshow" id="slideshow-card">
      <div class="ss-lbl">üìå High-Yield Fact Slideshow</div>
      <div class="ss-counter" id="ss-counter"></div>
      <div id="ss-box">Add facts in the <strong>Fact Salad</strong> tab to see them here!</div>
      <!-- progress bar -->
      <div class="ss-prog-bar"><div class="ss-prog-fill" id="ss-prog-fill" style="width:100%"></div></div>
      <!-- nav row -->
      <div class="ss-nav">
        <button class="ss-nav-btn" onclick="slideNav(-1)" title="Previous">‚Äπ</button>
        <div class="ss-timer" id="ss-timer"></div>
        <button class="ss-nav-btn" onclick="slideNav(1)" title="Next">‚Ä∫</button>
      </div>
    </div>

    <div class="qual-tabs">
      <button class="q-tab active" onclick="switchQual('qp-fact',this)">ü•ó Fact Salad</button>
      <button class="q-tab" onclick="switchQual('qp-swt',this)">‚ö° SWT Mistake</button>
      <button class="q-tab" onclick="switchQual('qp-gt',this)">üéØ GT Mistake</button>
    </div>

    <div id="qp-fact" class="qual-pane active">
      <div class="card">
        <span class="lbl">Subject</span>
        <select id="fs-sub" class="q-sub-list"></select>
        <span class="lbl">Question / Topic</span>
        <textarea id="fs-q" rows="3" placeholder="Enter question or topic‚Ä¶"></textarea>
        <span class="lbl">Answer / Key Fact</span>
        <textarea id="fs-a" rows="2" placeholder="Enter the key fact or answer‚Ä¶"></textarea>
        <button class="btn btn-g" style="margin-top:10px" onclick="saveQual('factSalad')">üíæ Save to Salad</button>
      </div>
    </div>

    <div id="qp-swt" class="qual-pane">
      <div class="card">
        <span class="lbl">Subject</span>
        <select id="qswt-sub" class="q-sub-list"></select>
        <span class="lbl">Question</span>
        <textarea id="qswt-q" rows="3" placeholder="Enter the question‚Ä¶"></textarea>
        <span class="lbl">Correct Answer</span>
        <textarea id="qswt-a" rows="2" placeholder="Correct answer‚Ä¶"></textarea>
        <span class="lbl">Your Incorrect Answer</span>
        <textarea id="qswt-w" rows="2" placeholder="What did you mark?"></textarea>
        <span class="lbl">Reason for Error</span>
        <select id="qswt-r">
          <option>Silly Mistake</option><option>Concept Gap</option>
          <option>Recall Failure</option><option>Out of Syllabus</option>
        </select>
        <button class="btn btn-p" style="margin-top:10px" onclick="saveQual('swt')">‚ö° Log SWT Error</button>
      </div>
    </div>

    <div id="qp-gt" class="qual-pane">
      <div class="card">
        <span class="lbl">Exam Type</span>
        <select id="qgt-type"><option>NEET PG</option><option>INICET</option><option>FMGE</option></select>
        <span class="lbl">Subject</span>
        <select id="qgt-sub" class="q-sub-list"></select>
        <span class="lbl">Question</span>
        <textarea id="qgt-q" rows="3" placeholder="Enter the question‚Ä¶"></textarea>
        <span class="lbl">Correct Answer</span>
        <textarea id="qgt-a" rows="2" placeholder="Correct answer‚Ä¶"></textarea>
        <span class="lbl">Your Incorrect Answer</span>
        <textarea id="qgt-w" rows="2" placeholder="What did you mark?"></textarea>
        <span class="lbl">Reason for Error</span>
        <select id="qgt-r">
          <option>Silly Mistake</option><option>Concept Gap</option>
          <option>Recall Failure</option><option>Out of Syllabus</option>
        </select>
        <button class="btn btn-r" style="margin-top:10px" onclick="saveQual('gt')">üéØ Log GT Error</button>
      </div>
    </div>

    <!-- PDF SECTION -->
    <div class="pdf-card">
      <div class="pdf-title">üìÑ Download Reports</div>
      <div class="warn-box">
        ‚ö†Ô∏è <strong>Monthly Reset:</strong> All qualitative data auto-deletes on the last day of every month.
        <strong>Download Monthly PDF before month-end!</strong>
      </div>
      <div class="pdf-grid">
        <button class="pdf-btn" onclick="openReport('daily')">
          üìÖ Daily PDF<br><small>Today's entries</small>
        </button>
        <button class="pdf-btn mo" onclick="openReport('monthly')">
          üóìÔ∏è Monthly PDF<br><small>This month's entries</small>
        </button>
      </div>
    </div>

  </div><!-- /pane-qual -->

  <!-- DATA SAFETY -->
  <div class="danger-zone">
    <div style="font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;color:var(--accent2);margin-bottom:8px">Data Safety</div>
    <div id="backup-reminder" style="font-weight:800;font-size:12px;text-align:center;margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px"></div>
    <ul style="font-size:10px;color:var(--muted);padding-left:15px;margin-bottom:12px;line-height:1.8">
      <li><strong>Step 1:</strong> Click "Backup" to copy your data code.</li>
      <li><strong>Step 2:</strong> Paste in Telegram Saved Messages.</li>
      <li><strong>Step 3:</strong> To restore, paste code in "Restore Data".</li>
    </ul>
    <button style="background:var(--primary);color:#fff;border:none;padding:11px;border-radius:8px;font-size:13px;width:100%;font-weight:800;margin-bottom:7px;cursor:pointer;font-family:'Nunito',sans-serif" onclick="exportData()">Backup Data</button>
    <button style="background:var(--green);color:#fff;border:none;padding:11px;border-radius:8px;font-size:13px;width:100%;font-weight:800;margin-bottom:7px;cursor:pointer;font-family:'Nunito',sans-serif" onclick="openRestorePopup()">Restore Data</button>
    <button class="btn-danger" style="padding:10px;border-radius:8px;font-size:12px;width:100%;font-weight:800;cursor:pointer;font-family:'Nunito',sans-serif;margin-top:2px" onclick="clearData()">Clear All Local Data</button>
  </div>

</div><!-- /wrap -->

<script>
/* ‚îÄ‚îÄ TELEGRAM ‚îÄ‚îÄ */
const tg = window.Telegram.WebApp;
tg.ready(); tg.expand();
const tgUser   = tg.initDataUnsafe?.user || { id:"OFFLINE", first_name:"Guest", last_name:"" };
const fullName = `${tgUser.first_name||""} ${tgUser.last_name||""}`.trim() || "Doctor";
const userId   = tgUser.id;
document.getElementById('uName').innerText = `Dr. ${fullName}`;
document.getElementById('uId').innerText   = `ID: ${userId}`;

const PREFIX = `SSS_PRO_V3_${userId}_`;
const KEYS = {
  LOGS: PREFIX+'LOGS', NEET: PREFIX+'NEET', INI: PREFIX+'INI',
  FMGE: PREFIX+'FMGE', SWT:  PREFIX+'SWT',  GOALS: PREFIX+'GOALS',
  PYQ:  PREFIX+'PYQ',  TOUGH: PREFIX+'TOUGH', QUAL: PREFIX+'QUAL'
};

const SUBS_19 = ["Anatomy","Physiology","Biochemistry","Pathology","Microbiology",
  "Pharmacology","FMT","PSM","Ophthalmology","ENT","Medicine","Surgery",
  "OBG","Pediatrics","Anaesthesia","Dermatology","Orthopedics","Psychiatry","Radiology"];
const SUBS_ALL = [...SUBS_19, "Mixed Bag", "Integrated Systems"];
const PHASES_CFG = [
  { id:'r1', name:'1. First Reading',   phase:'First Reading',  badge:'ü•â' },
  { id:'r2', name:'2. Second Reading',  phase:'Second Reading', badge:'ü•à' },
  { id:'r3', name:'3. Third Reading',   phase:'Third Reading',  badge:'ü•á' },
  { id:'r4', name:'4. Extra Bonus',     phase:'Extra Bonus',    badge:'üèÜ' }
];
const PYQ_CATS = [
  { id:'neet', label:'NEET PG', type:'list', start:2025, end:2020 },
  { id:'ini',  label:'INICET',  type:'cols', col1:'May', col2:'Nov', start:2025, end:2014 },
  { id:'fmge', label:'FMGE',   type:'cols', col1:'Jun', col2:'Dec', start:2025, end:2020 },
  { id:'upsc', label:'UPSC CMS',type:'list', start:2025, end:2020 }
];

const savedTheme = localStorage.getItem('SSS_THEME');
if (savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);
function toggleTheme() {
  const cur = document.documentElement.getAttribute('data-theme');
  const nxt = cur === 'light' ? 'dark' : 'light';
  document.documentElement.setAttribute('data-theme', nxt);
  localStorage.setItem('SSS_THEME', nxt);
  updateUI();
}
function tc() { return document.documentElement.getAttribute('data-theme')==='light' ? '#1a1a2e' : '#e8e8f2'; }
function gc() { return document.documentElement.getAttribute('data-theme')==='light' ? 'rgba(0,0,0,.08)' : 'rgba(255,255,255,.07)'; }

function showToast(msg, col='#3ecf7c') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.style.background = col;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
function toggleAcc(id, hdr) {
  document.getElementById(id).classList.toggle('open');
  hdr.classList.toggle('open');
}
function openPopup(id) {
  document.querySelectorAll('.pop-card').forEach(c => c.style.display='none');
  document.getElementById(id).style.display = 'block';
  document.getElementById('pop-overlay').classList.add('open');
}
function closePopup() {
  document.getElementById('pop-overlay').classList.remove('open');
  stopAlarm();
}
function switchMain(id, btn) {
  document.querySelectorAll('.main-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.m-tab').forEach(b => b.classList.remove('active'));
  document.getElementById('pane-'+id).classList.add('active');
  btn.classList.add('active');
  if (id === 'qual') initQualSubjects();
  updateUI();
}
function switchSub(id, btn) {
  document.querySelectorAll('.sub-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.s-tab').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  if (id === 'sq-rank') loadLeaderboard(currentRankMode);
  updateUI();
}
function switchQual(id, btn) {
  document.querySelectorAll('.qual-pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.q-tab').forEach(b => b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
}
function initQualSubjects() {
  document.querySelectorAll('.q-sub-list').forEach(sel => {
    if (sel.options.length > 0) return;
    SUBS_19.forEach(s => { const o = document.createElement('option'); o.textContent = s; sel.appendChild(o); });
  });
}
initQualSubjects();

/* ‚ïê‚ïê‚ïê LEADERBOARD ‚ïê‚ïê‚ïê */
let currentRankMode = 'streak';
window.calculateAndPushLeaderboard = function() {
  const logs = JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]");
  const dailyVol = {};
  logs.forEach(l => {
    if (!l.date) return;
    dailyVol[l.date] = (dailyVol[l.date]||0) + (parseInt(l.mcqs)||0);
  });
  let streak = 0, streakVol = 0;
  const today = new Date();
  for (let i = 0; i < 365; i++) {
    const d = new Date(today); d.setDate(today.getDate() - i);
    const key = d.toLocaleDateString('en-GB');
    const vol = dailyVol[key] || 0;
    if (i === 0 && vol < 50) continue;
    if (vol >= 50) { streak++; streakVol += vol; } else break;
  }
  const nd = JSON.parse(localStorage.getItem(KEYS.NEET)||"[]");
  const id = JSON.parse(localStorage.getItem(KEYS.INI)||"[]");
  const fd = JSON.parse(localStorage.getItem(KEYS.FMGE)||"[]");
  const mean = arr => arr.length >= 3 ? parseFloat((arr.reduce((s,l) => s+parseFloat(l.score),0)/arr.length).toFixed(2)) : 0;
  const swtLogs = JSON.parse(localStorage.getItem(KEYS.SWT)||"[]");
  const subAgg  = {};
  swtLogs.forEach(l => {
    if (!subAgg[l.subject]) subAgg[l.subject] = { c:0, t:0 };
    subAgg[l.subject].c += parseInt(l.correct||0);
    subAgg[l.subject].t += parseInt(l.total||0);
  });
  const swtStats = {};
  Object.keys(subAgg).forEach(s => {
    if (subAgg[s].t >= 300)
      swtStats[s] = parseFloat(((subAgg[s].c/subAgg[s].t)*100).toFixed(2));
  });
  if (window.pushToLeaderboard) window.pushToLeaderboard({ streak, streakVol, neet:mean(nd), ini:mean(id), fmge:mean(fd), swt:swtStats });
};
function switchRank(mode, btn) {
  currentRankMode = mode;
  document.querySelectorAll('.rank-nav-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  ['streak','swt','gt'].forEach(m =>
    document.getElementById('rank-filter-'+m).style.display = m===mode?'block':'none'
  );
  loadLeaderboard(mode);
}
function loadLeaderboard(mode) {
  document.getElementById('leaderboard-list').innerHTML =
    '<div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">Fetching Top 50‚Ä¶</div>';
  if (!window.fetchLeaderboard) return;
  if (mode === 'streak') window.fetchLeaderboard('streak');
  else if (mode === 'swt') window.fetchLeaderboard('swt', document.getElementById('rankSubSelect').value);
  else { const cat = document.getElementById('rankGtSelect').value; window.fetchLeaderboard(cat); }
}
window.renderLeaderboardUI = function(data, category) {
  const list = document.getElementById('leaderboard-list');
  if (!data || !data.length) {
    list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">No champions yet. Be the first! üèÜ</div>';
    return;
  }
  list.innerHTML = data.map((u, i) => {
    const rank = i + 1;
    const cls  = rank===1?'r1':rank===2?'r2':rank===3?'r3':'';
    const icon = rank===1?'ü•á':rank===2?'ü•à':rank===3?'ü•â':`<span class="elite-tag">ELITE</span>`;
    const score = category==='streak' ? `${u.score} Days` : category==='swt' ? `${u.accuracy}%` : u.score;
    const meta  = category==='streak' ? `Vol: ${u.vol||0} MCQs` : category==='swt' ? 'Accuracy' : 'Mean Score';
    return `<div class="rank-item ${cls}">
      <div class="rank-pos">${rank<=3?'<span style="font-size:18px">'+icon+'</span>':rank}</div>
      <div class="rank-info">
        <span class="rank-name">${u.name} ${rank>3?icon:''}</span>
        <span class="rank-meta">${meta}</span>
      </div>
      <div class="rank-score">${score}</div>
    </div>`;
  }).join('');
};

/* ‚ïê‚ïê‚ïê TIMER ‚ïê‚ïê‚ïê */
let timerIval, activeSub='', activePhase='', wakeLock=null;
let timeLeft=0, mode='idle', isPaused=false, currentGTMode='NEET';
let initDur=0, elapsedDur=0, skipped=false;
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playBeep(f,d){ const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value=f; g.gain.value=0.1; o.start(); setTimeout(()=>o.stop(),d); }
let alarmIval=null;
function startAlarm(f){ stopAlarm(); alarmIval=setInterval(()=>playBeep(f,200),1000); }
function stopAlarm(){ if(alarmIval){ clearInterval(alarmIval); alarmIval=null; } }
const reqWL = async () => { if('wakeLock' in navigator) { try { wakeLock=await navigator.wakeLock.request('screen'); } catch(e){} } };
document.addEventListener('visibilitychange', async () => { if(wakeLock && document.visibilityState==='visible') await reqWL(); });
function startSession() {
  const s = document.getElementById('subject').value;
  if (!s) { showToast('‚ö†Ô∏è Please select a subject','#e05c7a'); return; }
  audioCtx.resume(); reqWL();
  activeSub = s; activePhase = document.getElementById('studyPhase').value;
  startStudyTimer();
}
function startStudyTimer() {
  mode='study'; isPaused=false; skipped=false;
  const h=parseInt(document.getElementById('studyHr').value)||0, m=parseInt(document.getElementById('studyMin').value)||0;
  initDur = h*3600+m*60; timeLeft=initDur;
  if (!timeLeft) return;
  document.getElementById('startBtn').style.display='none';
  document.getElementById('timer-controls').style.display='block';
  runTimer();
}
function togglePause(){ isPaused=!isPaused; document.getElementById('pauseBtn').innerText=isPaused?'Resume':'Pause'; }
function runTimer(){
  clearInterval(timerIval);
  timerIval=setInterval(()=>{
    if(!isPaused){
      timeLeft--;
      const h=Math.floor(timeLeft/3600),m=Math.floor((timeLeft%3600)/60),s=timeLeft%60;
      document.getElementById('timer-display').innerText =
        `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      if(timeLeft<=0) handleTransition();
    }
  },1000);
}
function handleTransition(){
  clearInterval(timerIval);
  startAlarm(mode==='study'?880:440);
  if(mode==='study'){ elapsedDur=initDur-timeLeft; skipped=(timeLeft>5); openPopup('pop-mcq'); }
  else openPopup('pop-break');
}
function startBreak(){
  stopAlarm();
  const m=parseInt(document.getElementById('cycleMcqs').value)||0;
  saveStudyLog(activeSub,m,Math.floor(elapsedDur/60),activePhase,skipped);
  document.getElementById('cycleMcqs').value='';
  closePopup(); mode='break'; isPaused=false;
  timeLeft=parseInt(document.getElementById('breakTime').value)*60;
  runTimer();
}
function continueNextCycle(){ stopAlarm(); closePopup(); startStudyTimer(); }
function stopSession(){
  stopAlarm(); clearInterval(timerIval);
  if(wakeLock){ wakeLock.release(); wakeLock=null; }
  closePopup();
  document.getElementById('timer-display').innerText='00:00:00';
  document.getElementById('startBtn').style.display='block';
  document.getElementById('timer-controls').style.display='none';
  mode='idle'; updateUI();
}
function saveStudyLog(s,m,d,ph,sk){
  const logs=JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]");
  logs.unshift({ date:new Date().toLocaleDateString('en-GB'), subject:s, mcqs:m, duration:d, phase:ph, skipped:sk||false });
  localStorage.setItem(KEYS.LOGS,JSON.stringify(logs));
  if(window.syncToCloud) window.syncToCloud();
}

/* ‚ïê‚ïê‚ïê SWT ‚ïê‚ïê‚ïê */
function calcSWT(){
  const t=parseInt(document.getElementById('swtTotal').value)||0;
  const c=parseInt(document.getElementById('swtCorrect').value)||0;
  const u=parseInt(document.getElementById('swtUnat').value)||0;
  document.getElementById('swtW').innerText=Math.max(0,t-c-u);
  document.getElementById('swtP').innerText=t>0?((c/t)*100).toFixed(1)+'%':'0%';
}
function saveSWT(){
  const d=document.getElementById('swtDate').value;
  const t=parseInt(document.getElementById('swtTotal').value);
  if(!d||isNaN(t)){ showToast('‚ö†Ô∏è Fill date and totals','#e05c7a'); return; }
  const c=parseInt(document.getElementById('swtCorrect').value)||0;
  const u=parseInt(document.getElementById('swtUnat').value)||0;
  const data=JSON.parse(localStorage.getItem(KEYS.SWT)||"[]");
  data.push({ date:d, total:t, correct:c, unat:u, wrong:Math.max(0,t-c-u),
    percent:((c/t)*100).toFixed(1), subject:document.getElementById('swtSubject').value,
    phase:document.getElementById('swtPhase').value });
  data.sort((a,b)=>new Date(a.date)-new Date(b.date));
  localStorage.setItem(KEYS.SWT,JSON.stringify(data));
  if(window.syncToCloud) window.syncToCloud();
  showToast('‚úÖ SWT saved!');
  updateUI();
}
let swtChart, swtCumChart, swtQChart, swtPhaseCountChart, swtPhaseAvgChart;
function renderSWT(){
  const all=JSON.parse(localStorage.getItem(KEYS.SWT)||"[]");
  const sub=document.getElementById('swtSubject').value;
  const f=all.filter(x=>x.subject===sub);
  const textColor=tc(), gridColor=gc();
  const mk=(id,type,labels,datasets,opts)=>new Chart(document.getElementById(id),{type,data:{labels,datasets},options:{maintainAspectRatio:false,...opts}});
  if(swtChart) swtChart.destroy();
  if(f.length) swtChart=mk('swtChart','line',f.map(x=>x.date),[{label:'%',data:f.map(x=>x.percent),borderColor:'#4f8ef7',tension:.3}],{scales:{y:{min:0,max:100,ticks:{color:textColor},grid:{color:gridColor}},x:{ticks:{color:textColor,font:{size:7},maxRotation:90},grid:{color:gridColor}}},plugins:{legend:{display:false}}});
  const perf={}; SUBS_ALL.forEach(s=>perf[s]={sum:0,n:0,tot:0});
  all.forEach(l=>{ if(perf[l.subject]){ perf[l.subject].sum+=parseFloat(l.percent); perf[l.subject].n++; perf[l.subject].tot+=parseInt(l.total); }});
  if(swtCumChart) swtCumChart.destroy();
  swtCumChart=mk('swtCumChart','line',SUBS_ALL,[{data:SUBS_ALL.map(s=>perf[s].n>0?(perf[s].sum/perf[s].n).toFixed(1):null),borderColor:'#f7a94f',tension:.3,spanGaps:true}],{scales:{y:{min:0,max:100,ticks:{color:textColor},grid:{color:gridColor}},x:{ticks:{color:textColor,font:{size:7},maxRotation:90,autoSkip:false},grid:{color:gridColor}}},plugins:{legend:{display:false}}});
  if(swtQChart) swtQChart.destroy();
  swtQChart=mk('swtQChart','line',SUBS_ALL,[{data:SUBS_ALL.map(s=>perf[s].tot),borderColor:'#3ecf7c',backgroundColor:'rgba(62,207,124,.1)',fill:true,tension:.4,spanGaps:true}],{scales:{y:{beginAtZero:true,ticks:{color:textColor},grid:{color:gridColor}},x:{ticks:{color:textColor,font:{size:7},maxRotation:90,autoSkip:false},grid:{color:gridColor}}},plugins:{legend:{display:false}}});
  const phases=['First Reading','Second Reading','Third Reading','Extra Bonus'];
  const pd={'First Reading':{n:0,s:0},'Second Reading':{n:0,s:0},'Third Reading':{n:0,s:0},'Extra Bonus':{n:0,s:0}};
  all.forEach(x=>{const p=x.phase||'First Reading';if(pd[p]){pd[p].n++;pd[p].s+=parseFloat(x.percent);}});
  if(swtPhaseCountChart) swtPhaseCountChart.destroy();
  swtPhaseCountChart=mk('swtPhaseCountChart','bar',phases,[{data:phases.map(p=>pd[p].n),backgroundColor:'#3498db',borderRadius:4}],{scales:{y:{beginAtZero:true,ticks:{color:textColor,stepSize:1},grid:{color:gridColor}},x:{ticks:{color:textColor,font:{size:9}},grid:{color:gridColor}}},plugins:{legend:{display:false}}});
  if(swtPhaseAvgChart) swtPhaseAvgChart.destroy();
  swtPhaseAvgChart=mk('swtPhaseAvgChart','bar',phases,[{data:phases.map(p=>pd[p].n>0?(pd[p].s/pd[p].n).toFixed(1):0),backgroundColor:'#9b59b6',borderRadius:4}],{scales:{y:{beginAtZero:true,max:100,ticks:{color:textColor},grid:{color:gridColor}},x:{ticks:{color:textColor,font:{size:9}},grid:{color:gridColor}}},plugins:{legend:{display:false}}});
  let maxA=-1,minA=101,strong='--',weak='--';
  Object.keys(perf).forEach(k=>{ if(perf[k].n>0){ const a=perf[k].sum/perf[k].n; if(a>maxA){maxA=a;strong=k;} if(a<minA){minA=a;weak=k;} }});
  document.getElementById('swtStrong').innerText=strong;
  document.getElementById('swtWeak').innerText=weak;
}

/* ‚ïê‚ïê‚ïê GT ‚ïê‚ïê‚ïê */
function calcGT(){
  if(currentGTMode==='FMGE'){
    const c1=parseInt(document.getElementById('gtP1C').value)||0;
    const c2=parseInt(document.getElementById('gtP2C').value)||0;
    const tot=c1+c2;
    document.getElementById('gtS1').innerText=c1;
    document.getElementById('gtS2').innerText=c2;
    document.getElementById('gtTotFmge').innerText=tot;
    document.getElementById('gtFmgeStatus').innerText=tot>=150?'‚úÖ Qualified':'‚ùå Not Qualified';
    document.getElementById('gtFmgeStatus').style.color=tot>=150?'var(--green)':'var(--accent)';
  } else {
    const c=parseInt(document.getElementById('gtCorrect').value)||0;
    const u=parseInt(document.getElementById('gtUnat').value)||0;
    const w=Math.max(0,200-c-u);
    const s=currentGTMode==='NEET'?(c*4-w):(c-w*0.333);
    document.getElementById('gtW').innerText=w;
    document.getElementById('gtS').innerText=s.toFixed(2);
  }
}
function switchGT(m){
  currentGTMode=m;
  ['NEET','INICET','FMGE'].forEach(x=>{
    const el=document.getElementById('gtTab'+x);
    if(el) el.classList.toggle('active',x===m);
  });
  document.getElementById('gt-std-inputs').style.display=m==='FMGE'?'none':'block';
  document.getElementById('gt-fmge-inputs').style.display=m==='FMGE'?'block':'none';
  document.getElementById('neet-area').style.display=m==='NEET'?'block':'none';
  document.getElementById('ini-area').style.display=m==='INICET'?'block':'none';
  document.getElementById('fmge-area').style.display=m==='FMGE'?'block':'none';
  calcGT(); populateGTHistory(); renderGT();
}
function openGTBreakdown(){
  const container=document.getElementById('gt-sub-inputs');
  container.innerHTML='';
  SUBS_19.forEach(s=>{
    container.innerHTML+=`<div class="sb-row"><span>${s}</span><input type="number" class="sb-inp" id="sb_t_${s.replace(/\s/g,'_')}" placeholder="T" style="padding:5px;font-size:11px"><input type="number" class="sb-inp" id="sb_c_${s.replace(/\s/g,'_')}" placeholder="C" style="padding:5px;font-size:11px"><input type="number" class="sb-inp" id="sb_u_${s.replace(/\s/g,'_')}" placeholder="U" style="padding:5px;font-size:11px"></div>`;
  });
  openPopup('pop-gt-breakdown');
}
function finalizeGTSave(){
  if(!confirm('Save this GT result?')) return;
  const d=document.getElementById('gtDate').value;
  const ph=document.getElementById('gtPhase').value;
  const plat=document.getElementById('gtPlatform').value||'Unknown';
  let score,c,u,w; const details={};
  if(currentGTMode==='FMGE'){
    const c1=parseInt(document.getElementById('gtP1C').value)||0;
    const u1=parseInt(document.getElementById('gtP1U').value)||0;
    const c2=parseInt(document.getElementById('gtP2C').value)||0;
    const u2=parseInt(document.getElementById('gtP2U').value)||0;
    score=c1+c2; c=score; u=u1+u2; w=Math.max(0,300-c-u);
    details.p1={c:c1,u:u1,s:c1}; details.p2={c:c2,u:u2,s:c2};
    details.status=score>=150?'Qualified':'Not Qualified';
  } else {
    c=parseInt(document.getElementById('gtCorrect').value)||0;
    u=parseInt(document.getElementById('gtUnat').value)||0;
    w=Math.max(0,200-c-u);
    score=currentGTMode==='NEET'?(c*4-w):(c-w*0.333);
  }
  const breakdown={};
  SUBS_19.forEach(s=>{
    const key=s.replace(/\s/g,'_');
    const tot=parseInt(document.getElementById('sb_t_'+key)?.value)||0;
    const corr=parseInt(document.getElementById('sb_c_'+key)?.value)||0;
    const unat=parseInt(document.getElementById('sb_u_'+key)?.value)||0;
    breakdown[s]={total:tot,c:corr,u:unat,w:Math.max(0,tot-corr-unat),
      percent:tot>0?((corr/tot)*100).toFixed(1):0};
  });
  const storeKey=currentGTMode==='INICET'?KEYS.INI:(currentGTMode==='FMGE'?KEYS.FMGE:KEYS.NEET);
  const data=JSON.parse(localStorage.getItem(storeKey)||"[]");
  data.push({id:Date.now(),date:d,platform:plat,score,correct:c,unat:u,wrong:w,phase:ph,breakdown,...details});
  data.sort((a,b)=>new Date(a.date)-new Date(b.date));
  localStorage.setItem(storeKey,JSON.stringify(data));
  if(window.syncToCloud) window.syncToCloud();
  closePopup(); showToast('‚úÖ GT saved!'); updateUI();
}
function populateGTHistory(){
  const storeKey=currentGTMode==='INICET'?KEYS.INI:(currentGTMode==='FMGE'?KEYS.FMGE:KEYS.NEET);
  const data=JSON.parse(localStorage.getItem(storeKey)||"[]");
  const sel=document.getElementById('gtHistorySelect');
  sel.innerHTML='<option value="">Select a GT to review</option>';
  [...data].reverse().forEach((g,i)=>{
    sel.innerHTML+=`<option value="${g.id}">${currentGTMode} GT ${data.length-i} (${g.date})</option>`;
  });
}
let gtBdChart;
function renderGTBreakdownGraph(){
  const id=document.getElementById('gtHistorySelect').value;
  if(!id){ document.getElementById('gtBdChartWrap').style.display='none'; document.getElementById('gtReviewMeta').style.display='none'; return; }
  const storeKey=currentGTMode==='INICET'?KEYS.INI:(currentGTMode==='FMGE'?KEYS.FMGE:KEYS.NEET);
  const data=JSON.parse(localStorage.getItem(storeKey)||"[]");
  const g=data.find(x=>x.id==id);
  if(!g||!g.breakdown) return;
  document.getElementById('gtReviewMeta').style.display='block';
  document.getElementById('gtReviewMeta').innerText=`${g.platform} | ${g.date} | Score: ${parseFloat(g.score).toFixed(2)}`;
  document.getElementById('gtBdChartWrap').style.display='block';
  document.getElementById('gtBdScrollInner').style.width=Math.max(window.innerWidth-60,SUBS_19.length*32)+'px';
  if(gtBdChart) gtBdChart.destroy();
  const textColor=tc(), gridColor=gc();
  gtBdChart=new Chart(document.getElementById('gtBreakdownChart'),{type:'bar',data:{labels:SUBS_19,datasets:[{label:'Correct %',data:SUBS_19.map(s=>g.breakdown[s]?.percent||0),backgroundColor:'#3ecf7c',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{min:0,max:100,ticks:{color:textColor},grid:{color:gridColor}},x:{ticks:{color:textColor,font:{size:10},autoSkip:false,maxRotation:90},grid:{color:gridColor}}},plugins:{legend:{display:false}}}});
}
let gNeetChart, gIniChart, gFmgeChart, neetPCChart, neetPAChart, iniPCChart, iniPAChart, fmgePCChart, fmgePAChart;
function renderGT(){
  const nd=JSON.parse(localStorage.getItem(KEYS.NEET)||"[]");
  const id=JSON.parse(localStorage.getItem(KEYS.INI)||"[]");
  const fd=JSON.parse(localStorage.getItem(KEYS.FMGE)||"[]");
  const textColor=tc(), gridColor=gc();
  const makeScroll=(canvasId,scrollId,data,color,maxY)=>{
    const el=document.getElementById(canvasId), si=document.getElementById(scrollId);
    if(!el||!si||!data.length) return null;
    si.style.width=Math.max(window.innerWidth-60,data.length*42)+'px';
    return new Chart(el,{type:'line',data:{labels:data.map(x=>x.date),datasets:[{data:data.map(x=>x.score),borderColor:color,tension:.2,pointRadius:4}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{min:0,max:maxY,ticks:{color:textColor},grid:{color:gridColor}},x:{ticks:{color:textColor,font:{size:9}},grid:{color:gridColor}}},plugins:{legend:{display:false}}}});
  };
  const makePhaseCharts=(countId,avgId,data)=>{
    const phases=['First Reading','Second Reading','Third Reading','Extra Bonus'];
    const pd={'First Reading':{n:0,s:0},'Second Reading':{n:0,s:0},'Third Reading':{n:0,s:0},'Extra Bonus':{n:0,s:0}};
    data.forEach(x=>{ const p=x.phase||'First Reading'; if(pd[p]){pd[p].n++;pd[p].s+=parseFloat(x.score);} });
    const mk=(id,ds)=>new Chart(document.getElementById(id),{type:'bar',data:{labels:phases,datasets:[ds]},options:{maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{color:textColor},grid:{color:gridColor}},x:{ticks:{color:textColor,font:{size:9}},grid:{color:gridColor}}},plugins:{legend:{display:false}}}});
    return [mk(countId,{data:phases.map(p=>pd[p].n),backgroundColor:'#3498db',borderRadius:4}),
            mk(avgId,{data:phases.map(p=>pd[p].n>0?(pd[p].s/pd[p].n).toFixed(1):0),backgroundColor:'#9b59b6',borderRadius:4})];
  };
  const makeStats=(statsId,data)=>{
    if(!data.length) return;
    const max=Math.max(...data.map(x=>parseFloat(x.score)));
    const min=Math.min(...data.map(x=>parseFloat(x.score)));
    document.getElementById(statsId).innerHTML=`<div class="gt-stat-grid"><div class="gt-stat-box"><span class="gs-lbl">Highest</span><span class="gs-val v-good">${max.toFixed(2)}</span></div><div class="gt-stat-box"><span class="gs-lbl">Lowest</span><span class="gs-val v-bad">${min.toFixed(2)}</span></div></div>`;
  };
  if(gNeetChart) gNeetChart.destroy(); gNeetChart=makeScroll('gtNeetChart','neet-scroll-inner',nd,'#f7a94f',800);
  [neetPCChart,neetPAChart].forEach(c=>c&&c.destroy()); [neetPCChart,neetPAChart]=makePhaseCharts('neetPhaseCountChart','neetPhaseAvgChart',nd);
  makeStats('neetStats',nd);
  if(gIniChart) gIniChart.destroy(); gIniChart=makeScroll('gtIniChart','ini-scroll-inner',id,'#3ecf7c',200);
  [iniPCChart,iniPAChart].forEach(c=>c&&c.destroy()); [iniPCChart,iniPAChart]=makePhaseCharts('iniPhaseCountChart','iniPhaseAvgChart',id);
  makeStats('iniStats',id);
  if(gFmgeChart) gFmgeChart.destroy(); gFmgeChart=makeScroll('gtFmgeChart','fmge-scroll-inner',fd,'#e67e22',300);
  [fmgePCChart,fmgePAChart].forEach(c=>c&&c.destroy()); [fmgePCChart,fmgePAChart]=makePhaseCharts('fmgePhaseCountChart','fmgePhaseAvgChart',fd);
  makeStats('fmgeStats',fd);
}

/* ‚ïê‚ïê‚ïê GOALS & PHASES ‚ïê‚ïê‚ïê */
function saveGoals(){
  const g=JSON.parse(localStorage.getItem(KEYS.GOALS))||{exams:{},phases:[]};
  g.exams={
    i_j:document.getElementById('g_ini_jul').checked,
    u:document.getElementById('g_upsc').checked,
    n:document.getElementById('g_neet').checked,
    i_jan:document.getElementById('g_ini_jan').checked,
    f_jun:document.getElementById('g_fmge_jun').checked,
    f_dec:document.getElementById('g_fmge_dec').checked
  };
  g.phases=PHASES_CFG.map((_,idx)=>{
    const ex=g.phases[idx]||{}, s=ex.s||{};
    SUBS_19.forEach((_,si)=>{ const el=document.getElementById(`chk_${idx}_${si}`); if(el&&!el.disabled) s[si]=el.checked; });
    return {...ex,f:document.getElementById(`df_${idx}`)?.value||'',t:document.getElementById(`dt_${idx}`)?.value||'',s};
  });
  localStorage.setItem(KEYS.GOALS,JSON.stringify(g));
  if(window.syncToCloud) window.syncToCloud();
}
function lockExams(){
  saveGoals();
  const g=JSON.parse(localStorage.getItem(KEYS.GOALS));
  const map={i_j:'di_ini_jul',u:'di_upsc',n:'di_neet',i_jan:'di_ini_jan',f_jun:'di_fmge_jun',f_dec:'di_fmge_dec'};
  Object.entries(map).forEach(([k,v])=>{ const el=document.getElementById(v); if(el) el.classList.toggle('locked',!!(g.exams&&g.exams[k])); });
  showToast('Goals locked! üöÄ');
}
function lockTarget(idx,type){
  if(!confirm('Lock this goal?')) return;
  const g=JSON.parse(localStorage.getItem(KEYS.GOALS))||{phases:[]};
  if(!g.phases[idx]) g.phases[idx]={};
  if(type==='swt'){ g.phases[idx].tgt_swt=document.getElementById(`tgt_swt_${idx}`).value; g.phases[idx].locked_swt=true; }
  else { g.phases[idx].tgt_gt=document.getElementById(`tgt_gt_${idx}`).value; g.phases[idx].locked_gt=true; }
  localStorage.setItem(KEYS.GOALS,JSON.stringify(g));
  if(window.syncToCloud) window.syncToCloud();
  renderGoalHTML();
}
function saveSubjectProgress(idx){
  if(!confirm('Lock subject progress?')) return;
  const g=JSON.parse(localStorage.getItem(KEYS.GOALS))||{phases:[]};
  if(!g.phases[idx]) g.phases[idx]={s:{},s_locked:{}};
  if(!g.phases[idx].s_locked) g.phases[idx].s_locked={};
  SUBS_19.forEach((_,si)=>{ const el=document.getElementById(`chk_${idx}_${si}`); if(el&&el.checked){ g.phases[idx].s[si]=true; g.phases[idx].s_locked[si]=true; } });
  localStorage.setItem(KEYS.GOALS,JSON.stringify(g));
  if(window.syncToCloud) window.syncToCloud();
  showToast('Subjects locked! ‚úÖ');
  renderGoalHTML();
}
function renderGoalHTML(){
  const container=document.getElementById('phases-root'); container.innerHTML='';
  const swtD=JSON.parse(localStorage.getItem(KEYS.SWT)||"[]");
  const allGT=[...JSON.parse(localStorage.getItem(KEYS.NEET)||"[]"),...JSON.parse(localStorage.getItem(KEYS.INI)||"[]"),...JSON.parse(localStorage.getItem(KEYS.FMGE)||"[]")];
  PHASES_CFG.forEach((p,idx)=>{
    const g=JSON.parse(localStorage.getItem(KEYS.GOALS))||{phases:[]};
    const pd=g.phases[idx]||{};
    let actSWT=0; swtD.forEach(x=>{ if((x.phase||'First Reading')===p.phase) actSWT++; });
    let actGT=0,maxGT=0; allGT.forEach(x=>{ if((x.phase||'First Reading')===p.phase){ actGT++; if(x.score>maxGT) maxGT=x.score; }});
    const tgtSWT=parseInt(pd.tgt_swt)||0, tgtGT=parseInt(pd.tgt_gt)||0;
    let subsDone=true;
    if(pd.s_locked){ for(let i=0;i<SUBS_19.length;i++) if(!pd.s_locked[i]){subsDone=false;break;} }
    else subsDone=false;
    const isChamp=subsDone&&actSWT>=tgtSWT&&actGT>=tgtGT&&tgtSWT>0&&tgtGT>0;
    let subsHtml='<div class="sub-grid">';
    SUBS_19.forEach((s,si)=>{ const ck=pd.s?pd.s[si]:false,lk=pd.s_locked?pd.s_locked[si]:false; subsHtml+=`<label class="sub-chk" style="${lk?'color:var(--green);font-weight:800':''}"><input type="checkbox" id="chk_${idx}_${si}" ${ck?'checked':''} ${lk?'disabled':''} onchange="saveGoals()"><span>${s}</span></label>`; });
    subsHtml+='</div>';
    container.innerHTML+=`<div class="phase-blk ${isChamp?'done':''}">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="font-weight:800;font-size:13px;color:var(--primary)">${p.name}</div>
        <span class="phase-badge ${isChamp?'unlocked':''}">${isChamp?'üèÜ':p.badge}</span>
      </div>
      <div class="row2">
        <div><span class="lbl">From</span><input type="date" id="df_${idx}" value="${pd.f||''}" onchange="saveGoals()"></div>
        <div><span class="lbl">To</span><input type="date" id="dt_${idx}" value="${pd.t||''}" onchange="saveGoals()"></div>
      </div>
      <div class="goal-grid">
        <div class="goal-box"><span class="lbl">SWT Goal</span><input type="number" id="tgt_swt_${idx}" value="${pd.tgt_swt||''}" ${pd.locked_swt?'disabled':''}><button class="mini-lock ${pd.locked_swt?'locked':''}" onclick="lockTarget(${idx},'swt')">üîí</button></div>
        <div class="goal-box" style="background:rgba(0,0,0,.3)"><span class="lbl">Actual SWT</span><div class="goal-val">${actSWT}${actSWT>=tgtSWT&&tgtSWT>0?'‚úÖ':''}</div></div>
        <div class="goal-box"><span class="lbl">GT Goal</span><input type="number" id="tgt_gt_${idx}" value="${pd.tgt_gt||''}" ${pd.locked_gt?'disabled':''}><button class="mini-lock ${pd.locked_gt?'locked':''}" onclick="lockTarget(${idx},'gt')">üîí</button></div>
        <div class="goal-box" style="background:rgba(0,0,0,.3)"><span class="lbl">Actual GT</span><div class="goal-val">${actGT}${actGT>=tgtGT&&tgtGT>0?'‚úÖ':''}</div></div>
      </div>
      <div style="text-align:center;font-size:11px;padding:5px;background:rgba(0,0,0,.15);border-radius:6px;margin-bottom:8px">
        Best GT Score: <strong style="color:var(--accent2)">${maxGT.toFixed(2)}</strong>
      </div>
      <button class="btn btn-ol btn-sm" style="width:100%;margin-bottom:6px" onclick="document.getElementById('sg_${idx}').classList.toggle('open')">Subjects ‚ñº</button>
      <div id="sg_${idx}" class="sub-grid-wrap">${subsHtml}<button class="sub-save-btn" onclick="saveSubjectProgress(${idx})">Lock Subjects ‚úÖ</button></div>
    </div>`;
  });
}
function loadGoalsUI(){
  const g=JSON.parse(localStorage.getItem(KEYS.GOALS))||{exams:{}};
  ['g_ini_jul','g_upsc','g_neet','g_ini_jan','g_fmge_jun','g_fmge_dec'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.checked=false;
  });
  if(g.exams){
    if(g.exams.i_j)   document.getElementById('g_ini_jul').checked=true;
    if(g.exams.u)     document.getElementById('g_upsc').checked=true;
    if(g.exams.n)     document.getElementById('g_neet').checked=true;
    if(g.exams.i_jan) document.getElementById('g_ini_jan').checked=true;
    if(g.exams.f_jun) document.getElementById('g_fmge_jun').checked=true;
    if(g.exams.f_dec) document.getElementById('g_fmge_dec').checked=true;
    const map={i_j:'di_ini_jul',u:'di_upsc',n:'di_neet',i_jan:'di_ini_jan',f_jun:'di_fmge_jun',f_dec:'di_fmge_dec'};
    Object.entries(map).forEach(([k,v])=>{ const el=document.getElementById(v); if(el) el.classList.toggle('locked',!!g.exams[k]); });
  }
  renderGoalHTML();
}

/* ‚ïê‚ïê‚ïê PYQ ‚ïê‚ïê‚ïê */
function renderPYQ(){
  const root=document.getElementById('pyq-root'); if(root.innerHTML!=='') return;
  let html='';
  PYQ_CATS.forEach((cat,i)=>{
    const active=i===0?'active':'';
    html+=`<div id="pyq_panel_${cat.id}" class="pyq-panel ${active}">`;
    if(cat.type==='list'){
      for(let y=cat.start;y>=cat.end;y--) html+=`<label class="pyq-row"><span>${cat.label} ${y}</span><input type="checkbox" id="pyq_${cat.id}_${y}"></label>`;
    } else {
      html+=`<div class="pyq-col-grid"><div><div style="font-size:11px;color:var(--primary);font-weight:800;margin-bottom:6px">${cat.col1}</div>`;
      for(let y=cat.start;y>=cat.end;y--) html+=`<label class="pyq-row"><span>${y}</span><input type="checkbox" id="pyq_${cat.id}_${y}_1"></label>`;
      html+=`</div><div><div style="font-size:11px;color:var(--primary);font-weight:800;margin-bottom:6px">${cat.col2}</div>`;
      for(let y=cat.start;y>=cat.end;y--) html+=`<label class="pyq-row"><span>${y}</span><input type="checkbox" id="pyq_${cat.id}_${y}_2"></label>`;
      html+=`</div></div>`;
    }
    html+=`<button class="btn btn-p btn-sm" style="width:100%;margin-top:12px" onclick="savePYQ('${cat.id}')">Save &amp; Lock</button></div>`;
  });
  root.innerHTML=html; loadPYQ();
}
function switchPyq(id,btn){
  document.querySelectorAll('.pyq-tab').forEach(t=>t.classList.remove('active')); btn.classList.add('active');
  document.querySelectorAll('.pyq-panel').forEach(p=>p.classList.remove('active')); document.getElementById('pyq_panel_'+id).classList.add('active');
}
function savePYQ(catId){
  const data=JSON.parse(localStorage.getItem(KEYS.PYQ)||"{}")||{};
  const cat=PYQ_CATS.find(c=>c.id===catId); data[catId]={};
  let allChecked=true;
  if(cat.type==='list'){ for(let y=cat.start;y>=cat.end;y--){ const v=document.getElementById(`pyq_${catId}_${y}`).checked; data[catId][y]=v; if(!v)allChecked=false; }}
  else { for(let y=cat.start;y>=cat.end;y--){ const v1=document.getElementById(`pyq_${catId}_${y}_1`).checked, v2=document.getElementById(`pyq_${catId}_${y}_2`).checked; data[catId][`${y}_1`]=v1; data[catId][`${y}_2`]=v2; if(!v1||!v2)allChecked=false; }}
  localStorage.setItem(KEYS.PYQ,JSON.stringify(data));
  if(window.syncToCloud) window.syncToCloud();
  const cup=document.getElementById('cup_'+catId);
  if(allChecked){ cup.classList.add('show'); showToast(`üèÜ All ${cat.label} PYQs done!`,'#f7a94f'); }
  else { cup.classList.remove('show'); showToast('Progress saved!'); }
}
function loadPYQ(){
  const data=JSON.parse(localStorage.getItem(KEYS.PYQ)||"{}");
  PYQ_CATS.forEach(cat=>{
    if(!data[cat.id]) return; let all=true;
    if(cat.type==='list'){ for(let y=cat.start;y>=cat.end;y--){ const el=document.getElementById(`pyq_${cat.id}_${y}`); if(el){ el.checked=data[cat.id][y]||false; if(!el.checked)all=false; }}}
    else { for(let y=cat.start;y>=cat.end;y--){ const e1=document.getElementById(`pyq_${cat.id}_${y}_1`),e2=document.getElementById(`pyq_${cat.id}_${y}_2`); if(e1){ e1.checked=data[cat.id][`${y}_1`]||false; if(!e1.checked)all=false; } if(e2){ e2.checked=data[cat.id][`${y}_2`]||false; if(!e2.checked)all=false; }}}
    if(all) document.getElementById('cup_'+cat.id).classList.add('show');
  });
}

/* ‚ïê‚ïê‚ïê TOUGH SUBJECTS ‚ïê‚ïê‚ïê */
function renderToughSelector(){
  const saved=JSON.parse(localStorage.getItem(KEYS.TOUGH)||"{}");
  const c=document.getElementById('tough-selector');
  c.innerHTML=SUBS_19.map(s=>`<label class="sub-chk"><input type="checkbox" id="tough_${s.replace(/\s/g,'_')}" ${saved[s]?'checked':''} onchange="saveTough()"><span>${s}</span></label>`).join('');
}
function saveTough(){
  const sel={};
  SUBS_19.forEach(s=>{ const el=document.getElementById('tough_'+s.replace(/\s/g,'_')); if(el&&el.checked) sel[s]=true; });
  localStorage.setItem(KEYS.TOUGH,JSON.stringify(sel));
  if(window.syncToCloud) window.syncToCloud();
  renderToughDash();
}
function renderToughDash(){
  const saved=JSON.parse(localStorage.getItem(KEYS.TOUGH)||"{}");
  const subs=Object.keys(saved).filter(k=>saved[k]);
  const c=document.getElementById('tough-dash');
  if(!subs.length){ c.innerHTML=''; return; }
  const logs=JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]");
  const now=new Date(); now.setHours(0,0,0,0);
  let html=`<div style="font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;color:var(--accent);text-transform:uppercase;margin-bottom:8px;letter-spacing:1px">Tough Subjects Radar</div>`;
  subs.forEach(s=>{
    let last=null;
    logs.forEach(l=>{ if(l.subject===s){ const pts=l.date.split('/'); if(pts.length===3){ const d=new Date(pts[2],pts[1]-1,pts[0]); if(!last||d>last) last=d; }}});
    let cls='a-crit',msg='Never studied!',days='Never';
    if(last){ const diff=Math.ceil(Math.abs(now-last)/(864e5)); days=diff+' days ago'; if(diff<=10){cls='a-safe';msg='On Track';}else if(diff<=20){cls='a-warn';msg='Needs Revision';}else if(diff<=30){cls='a-orng';msg='Gap Warning';}else{cls='a-crit';msg='Critical Gap!';}}
    html+=`<div class="alert-item ${cls}"><span>${s}</span><span>${msg} (${days})</span></div>`;
  });
  c.innerHTML=html;
}

/* ‚ïê‚ïê‚ïê MONTHLY TABLE ‚ïê‚ïê‚ïê */
function renderMonthlyTable(){
  const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const data={};
  const init=k=>{ if(!data[k]) data[k]={mcq:0,swt:0,gt:0}; };
  JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]").forEach(l=>{
    const p=l.date.split('/'); if(p.length===3){ const k=`${p[2]}-${p[1].padStart(2,'0')}`; init(k); data[k].mcq+=(parseInt(l.mcqs)||0); }
  });
  JSON.parse(localStorage.getItem(KEYS.SWT)||"[]").forEach(s=>{
    const p=s.date.split('-'); if(p.length===3){ const k=`${p[0]}-${p[1]}`; init(k); data[k].swt++; }
  });
  [...JSON.parse(localStorage.getItem(KEYS.NEET)||"[]"),...JSON.parse(localStorage.getItem(KEYS.INI)||"[]"),...JSON.parse(localStorage.getItem(KEYS.FMGE)||"[]")].forEach(g=>{
    const p=g.date.split('-'); if(p.length===3){ const k=`${p[0]}-${p[1]}`; init(k); data[k].gt++; }
  });
  document.getElementById('monthlyBody').innerHTML=Object.keys(data).sort().reverse().map(k=>{
    const [y,m]=k.split('-'); const d=data[k];
    return d.mcq>0||d.swt>0||d.gt>0?`<tr><td>${months[parseInt(m)-1]} ${y}</td><td>${d.mcq}</td><td>${d.swt}</td><td>${d.gt}</td></tr>`:'';
  }).join('');
}

/* ‚ïê‚ïê‚ïê DAILY / CHARTS ‚ïê‚ïê‚ïê */
let hChart, mChart, viewDate=new Date();
function changeViewMonth(d){ viewDate.setMonth(viewDate.getMonth()+d); renderData(); }
function renderData(){
  const logs=JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]");
  const vm=viewDate.getMonth(), vy=viewDate.getFullYear();
  const mNames=["January","February","March","April","May","June","July","August","September","October","November","December"];
  document.getElementById('monthLabel').innerText=`${mNames[vm]} ${vy}`;
  const dim=new Date(vy,vm+1,0).getDate();
  const hoursData=Array(dim).fill(0), mcqsData=Array(dim).fill(0);
  const grouped={};
  logs.forEach(l=>{
    const p=l.date.split('/'); if(p.length!==3) return;
    const ld=new Date(p[2],p[1]-1,p[0]);
    if(ld.getMonth()===vm&&ld.getFullYear()===vy){
      hoursData[parseInt(p[0])-1]+=l.duration/60;
      mcqsData[parseInt(p[0])-1]+=l.mcqs;
      if(!grouped[l.date]) grouped[l.date]={h:0,m:0,subs:new Set(),cyc:0};
      grouped[l.date].h+=l.duration/60;
      grouped[l.date].m+=l.mcqs;
      grouped[l.date].subs.add(l.subject);
      if(!l.skipped) grouped[l.date].cyc++;
    }
  });
  const labels=Array.from({length:dim},(_,i)=>i+1);
  const textColor=tc(), gridColor=gc();
  const chartOpts={maintainAspectRatio:false,scales:{y:{ticks:{color:textColor},grid:{color:gridColor}},x:{ticks:{color:textColor,font:{size:9}},grid:{color:gridColor}}},plugins:{legend:{display:false}}};
  if(hChart) hChart.destroy();
  hChart=new Chart(document.getElementById('hoursChart'),{type:'line',data:{labels,datasets:[{data:hoursData,borderColor:'#f7a94f',backgroundColor:'rgba(247,169,79,.1)',fill:true,tension:.3}]},options:{...chartOpts,scales:{...chartOpts.scales,y:{...chartOpts.scales.y,min:0,max:16}}}});
  if(mChart) mChart.destroy();
  mChart=new Chart(document.getElementById('mcqChart'),{type:'line',data:{labels,datasets:[{data:mcqsData,borderColor:'#4f8ef7',backgroundColor:'rgba(79,142,247,.1)',fill:true,tension:.3}]},options:{...chartOpts,scales:{...chartOpts.scales,y:{...chartOpts.scales.y,beginAtZero:true}}}});
  const sortedDates=Object.keys(grouped).sort((a,b)=>{
    const [da,ma,ya]=a.split('/'), [db,mb,yb]=b.split('/');
    return new Date(yb,mb-1,db)-new Date(ya,ma-1,da);
  });
  document.getElementById('logBody').innerHTML=sortedDates.length
    ?sortedDates.map(d=>{
        const g=grouped[d];
        return `<tr>
          <td class="td-date">${d}</td>
          <td>${g.h.toFixed(1)}h</td>
          <td>${g.cyc}</td>
          <td>${g.m}</td>
          <td class="td-subs">${[...g.subs].join(', ')}</td>
        </tr>`;
      }).join('')
    :'<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:16px">No data this month</td></tr>';
}
function renderMatrix(){
  const logs=JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]");
  const map={'First Reading':0,'Second Reading':1,'Third Reading':2,'Extra Bonus':3};
  const dM={},mM={};
  SUBS_19.forEach(s=>{ dM[s]=[new Set(),new Set(),new Set(),new Set()]; mM[s]=[0,0,0,0]; });
  logs.forEach(l=>{ const s=l.subject, ph=l.phase||'First Reading', idx=map[ph]; if(dM[s]&&idx!==undefined){ dM[s][idx].add(l.date); mM[s][idx]+=(parseInt(l.mcqs)||0); }});
  const dTot=[0,0,0,0],mTot=[0,0,0,0];
  SUBS_19.forEach(s=>{ dM[s].forEach((set,i)=>dTot[i]+=set.size); mM[s].forEach((v,i)=>mTot[i]+=v); });
  document.getElementById('matrixBody').innerHTML=SUBS_19.map(s=>`<tr><td class="m-row-h">${s}</td>${dM[s].map(set=>`<td>${set.size||'-'}</td>`).join('')}</tr>`).join('')+`<tr><td class="m-total">TOTAL</td>${dTot.map(t=>`<td class="m-total">${t}</td>`).join('')}</tr>`;
  document.getElementById('mcqMatrixBody').innerHTML=SUBS_19.map(s=>`<tr><td class="m-row-h">${s}</td>${mM[s].map(v=>`<td>${v||'-'}</td>`).join('')}</tr>`).join('')+`<tr><td class="m-total">TOTAL</td>${mTot.map(t=>`<td class="m-total">${t}</td>`).join('')}</tr>`;
}

/* ‚ïê‚ïê‚ïê COUNTDOWNS + STREAK ‚ïê‚ïê‚ïê */
function updateCountdowns(){
  const now=new Date();
  const targets={
    ini_jul:new Date("2026-05-17T00:00:00+05:30"),
    upsc:new Date("2026-08-02T00:00:00+05:30"),
    neet:new Date("2026-08-30T00:00:00+05:30"),
    ini_jan:new Date("2026-11-01T00:00:00+05:30"),
    fmge_jun:new Date("2026-06-28T00:00:00+05:30"),
    fmge_dec:null
  };
  Object.entries(targets).forEach(([k,t])=>{
    const el=document.getElementById('d_'+k);
    if(!el) return;
    if(!t){ el.innerText='TBA'; return; }
    const diff=Math.ceil((t-now)/864e5);
    el.innerText=diff>0?diff:(diff===0?'TODAY':'DONE');
  });
  const ist=new Date(now.getTime()+(330*60000)).toISOString().split('T')[0];
  ['swtDate','gtDate'].forEach(id=>{ const el=document.getElementById(id); if(el) el.max=ist; });
}
function updateStreak(){
  const logs=JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]");
  const u=new Set(logs.map(l=>l.date)).size;
  document.getElementById('streakText').innerText=`Consistency: ${u} Days`;
  document.getElementById('streakIco').innerText='ü•á'.repeat(Math.floor(u/75))+'üî•'.repeat(Math.floor((u%75)/25));
}

/* ‚ïê‚ïê‚ïê BACKUP ‚ïê‚ïê‚ïê */
function updateBackupStatus(){
  const el=document.getElementById('backup-reminder');
  const last=localStorage.getItem('SSS_LAST_BACKUP');
  if(!last){ el.innerText='‚ö†Ô∏è NEVER BACKED UP'; el.style.color='var(--accent)'; return; }
  const diff=Math.floor((new Date()-new Date(last))/864e5);
  el.innerText=diff===0?'‚úÖ BACKED UP TODAY':`‚ö†Ô∏è LAST BACKUP: ${diff} DAYS AGO`;
  el.style.color=diff>7?'var(--accent)':diff>0?'var(--accent2)':'var(--green)';
}
function exportData(){
  localStorage.setItem('SSS_LAST_BACKUP',new Date().toISOString());
  updateBackupStatus();
  const b={}; Object.keys(KEYS).forEach(k=>b[k]=localStorage.getItem(KEYS[k]));
  const code=btoa(JSON.stringify({owner:userId,data:b}));
  navigator.clipboard.writeText(code).then(()=>showToast(`üìã Code copied! ID: ${userId}`));
}
function openRestorePopup(){ openPopup('pop-restore'); }
function processRestore(){
  try{
    const raw=JSON.parse(atob(document.getElementById('restoreInput').value));
    let d=raw;
    if(raw.owner){ if(String(raw.owner)!==String(userId)){ showToast('‚ùå Access denied!','#e05c7a'); return; } d=raw.data; }
    Object.keys(d).forEach(k=>localStorage.setItem(k,d[k]));
    localStorage.setItem('SSS_LAST_BACKUP',new Date().toISOString());
    if(window.syncToCloud) window.syncToCloud();
    showToast('‚úÖ Data restored!');
    setTimeout(()=>location.reload(),1500);
  } catch(e){ showToast('‚ùå Invalid code!','#e05c7a'); }
}
function clearData(){ if(confirm('Clear ALL local data?')){ Object.values(KEYS).forEach(k=>localStorage.removeItem(k)); location.reload(); } }

/* ‚ïê‚ïê‚ïê QUALITATIVE DATA ‚ïê‚ïê‚ïê */
function getQualDB(){
  return JSON.parse(localStorage.getItem(KEYS.QUAL)||'{"factSalad":[],"swt":[],"gt":[]}');
}
function saveQualDB(db){ localStorage.setItem(KEYS.QUAL,JSON.stringify(db)); if(window.syncToCloud) window.syncToCloud(); }

(function(){
  const now=new Date();
  const lastDay=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();
  const resetKey=`SSS_QUAL_RESET_${userId}_${now.getFullYear()}-${now.getMonth()}`;
  if(now.getDate()===lastDay&&!localStorage.getItem(resetKey)){
    saveQualDB({factSalad:[],swt:[],gt:[]});
    localStorage.setItem(resetKey,'done');
    setTimeout(()=>showToast('üìÖ Monthly qual data reset!','#e05c7a'),1500);
  }
})();

function saveQual(type){
  const db=getQualDB();
  const now=new Date();
  const entry={
    date:now.toLocaleDateString('en-GB',{day:'2-digit',month:'long',year:'numeric'}),
    timestamp:now.toLocaleString(),
    month:now.toLocaleString('default',{month:'long',year:'numeric'})
  };
  if(type==='factSalad'){
    entry.sub=document.getElementById('fs-sub').value;
    entry.q=document.getElementById('fs-q').value.trim();
    entry.a=document.getElementById('fs-a').value.trim();
    if(!entry.q||!entry.a){ showToast('‚ö†Ô∏è Fill Question & Answer','#e05c7a'); return; }
    document.getElementById('fs-q').value='';
    document.getElementById('fs-a').value='';
  } else if(type==='swt'){
    entry.sub=document.getElementById('qswt-sub').value;
    entry.q=document.getElementById('qswt-q').value.trim();
    entry.a=document.getElementById('qswt-a').value.trim();
    entry.w=document.getElementById('qswt-w').value.trim();
    entry.r=document.getElementById('qswt-r').value;
    if(!entry.q){ showToast('‚ö†Ô∏è Fill the question','#e05c7a'); return; }
    document.getElementById('qswt-q').value='';
    document.getElementById('qswt-a').value='';
    document.getElementById('qswt-w').value='';
  } else {
    entry.examType=document.getElementById('qgt-type').value;
    entry.sub=document.getElementById('qgt-sub').value;
    entry.q=document.getElementById('qgt-q').value.trim();
    entry.a=document.getElementById('qgt-a').value.trim();
    entry.w=document.getElementById('qgt-w').value.trim();
    entry.r=document.getElementById('qgt-r').value;
    if(!entry.q){ showToast('‚ö†Ô∏è Fill the question','#e05c7a'); return; }
    document.getElementById('qgt-q').value='';
    document.getElementById('qgt-a').value='';
    document.getElementById('qgt-w').value='';
  }
  db[type].push(entry);
  saveQualDB(db);
  showToast('‚úÖ Saved!');
  updateSlideshow();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SLIDESHOW ‚Äî 10-second auto-advance, ‚Äπ ‚Ä∫ navigation,
   touch swipe, animated progress bar
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SLIDE_DURATION = 10; // seconds
let curSlide = 0;
let slideCountdown = SLIDE_DURATION;
let slideIval = null;
let ssSwipeX = 0;

function slideNav(dir) {
  const db  = getQualDB();
  const len = db.factSalad.length;
  if (!len) return;
  curSlide = (curSlide + dir + len) % len;
  showSlide();
}

function showSlide() {
  const db  = getQualDB();
  const box = document.getElementById('ss-box');
  const ctr = document.getElementById('ss-counter');
  const tmr = document.getElementById('ss-timer');
  const fill= document.getElementById('ss-prog-fill');

  if (!db.factSalad.length) {
    box.innerHTML = 'Add facts in the <strong>Fact Salad</strong> tab to see them here!';
    ctr.textContent = ''; tmr.textContent = '';
    if (fill) fill.style.width = '0%';
    return;
  }

  if (curSlide >= db.factSalad.length) curSlide = 0;
  const f = db.factSalad[curSlide];
  box.innerHTML = `<div class="ss-sub">üìö ${f.sub}</div>
    <div class="ss-q">‚ùì ${f.q}</div>
    <div class="ss-a">‚úÖ ${f.a}</div>`;
  ctr.textContent = `${curSlide + 1} / ${db.factSalad.length}`;

  // Reset countdown & progress bar
  slideCountdown = SLIDE_DURATION;
  if (fill) fill.style.transition = 'none';
  if (fill) fill.style.width = '100%';
  // Trigger reflow so transition restarts
  if (fill) fill.getBoundingClientRect();
  if (fill) fill.style.transition = `width ${SLIDE_DURATION}s linear`;
  if (fill) fill.style.width = '0%';

  clearInterval(slideIval);
  slideIval = setInterval(() => {
    slideCountdown--;
    if (tmr) tmr.textContent = `Next in ${slideCountdown}s`;
    if (slideCountdown <= 0) {
      clearInterval(slideIval);
      curSlide = (curSlide + 1) % db.factSalad.length;
      showSlide();
    }
  }, 1000);
}

function updateSlideshow() {
  const db = getQualDB();
  if (!db.factSalad.length) {
    document.getElementById('ss-box').innerHTML = 'Add facts in the <strong>Fact Salad</strong> tab to see them here!';
    document.getElementById('ss-counter').textContent = '';
    document.getElementById('ss-timer').textContent   = '';
    const fill = document.getElementById('ss-prog-fill');
    if (fill) fill.style.width = '0%';
    clearInterval(slideIval);
    return;
  }
  showSlide();
}

/* Touch swipe support for slideshow */
(function(){
  const el = document.getElementById('slideshow-card');
  if (!el) return;
  el.addEventListener('touchstart', e => {
    ssSwipeX = e.touches[0].clientX;
  }, { passive: true });
  el.addEventListener('touchend', e => {
    const dx = e.changedTouches[0].clientX - ssSwipeX;
    if (Math.abs(dx) > 40) slideNav(dx < 0 ? 1 : -1);
  }, { passive: true });
})();

updateSlideshow();


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PDF ‚Äî Telegram-compatible: Share API ‚Üí Print ‚Üí Screenshot
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _pdfMode = 'daily';
let _pdfBlob = null;
let _pdfFileName = '';
let _pdfShareFile = null;

function closePdfOverlay() {
  document.getElementById('pdf-progress-overlay').classList.remove('open');
  document.getElementById('pdf-spinner-wrap').style.display = 'flex';
  document.getElementById('pdf-share-card').style.display   = 'none';
  _pdfBlob = null; _pdfShareFile = null;
}

function closePrintOverlay() {
  document.getElementById('print-overlay').classList.remove('open');
  document.body.style.overflow = '';
}

function doPrint() { window.print(); }

async function doNativeShare() {
  if (!_pdfShareFile) { showToast('No file ready','#e05c7a'); return; }
  try {
    await navigator.share({ files:[_pdfShareFile], title:_pdfFileName });
  } catch(e) {
    if (e.name !== 'AbortError') showToast('Share failed: '+e.message,'#e05c7a');
  }
}

function getFiltered(mode) {
  const db  = getQualDB();
  const now = new Date();
  const todayStr = now.toLocaleDateString('en-GB',{day:'2-digit',month:'long',year:'numeric'});
  const mStr     = now.toLocaleString('default',{month:'long',year:'numeric'});
  const fn = mode==='daily' ? i=>i.date===todayStr : i=>i.month===mStr;
  return { fs:db.factSalad.filter(fn), swt:db.swt.filter(fn), gt:db.gt.filter(fn) };
}

function buildReportHTML(mode) {
  const now   = new Date();
  const rtype = mode==='daily' ? 'Daily Revision Report' : 'Monthly Revision Report';
  const dstr  = mode==='daily'
    ? now.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'})
    : now.toLocaleString('default',{month:'long',year:'numeric'});
  const {fs,swt,gt} = getFiltered(mode);
  const noData = !fs.length && !swt.length && !gt.length;
  const grp = items => { const g={}; items.forEach(i=>{ const s=i.sub||'General'; (g[s]=g[s]||[]).push(i); }); return g; };
  const fields = (e,arr) => arr.map(({lbl,key})=>e[key]?`<div class="rpt-fl-lbl">${lbl}</div><div class="rpt-fl-val">${e[key]}</div>`:'').join('');
  const section = (hCls,label,items,flds) => {
    if(!items.length) return '';
    const grps=grp(items);
    return `<div class="rpt-sec"><div class="rpt-sec-h ${hCls}">${label}</div>${Object.entries(grps).map(([sub,entries])=>`<div class="rpt-sub-h">Subject: ${sub}</div>${entries.map((e,i)=>`<div class="rpt-entry"><div class="rpt-enum">ENTRY ${i+1} | ${e.date||''}</div>${fields(e,flds)}</div>`).join('')}`).join('')}</div>`;
  };
  const LOGO='https://raw.githubusercontent.com/dhruvathaare/Scaslpel-Study-Squad-Apps/789a623092f757f3cd2b32c9bc305aa3a9c0819f/photo_2026-02-12_20-08-36.jpg';
  return `<div class="rpt">
    <div class="rpt-hd">
      <div class="rpt-u"><b>Dr. ${fullName}</b><br>ID: ${userId}</div>
      <img src="${LOGO}" class="rpt-logo" onerror="this.style.display='none'">
      <div class="rpt-hd-n">Scalpel Study Squad</div>
      <div class="rpt-hd-t">Qualitative Revision Report</div>
    </div>
    <div class="rpt-stripe"></div>
    <div class="rpt-meta"><div class="rpt-rtype">${rtype}</div><div class="rpt-rdate">${dstr}</div></div>
    <div class="rpt-body">
      ${noData?'<div class="rpt-empty">üì≠ No entries for this period.</div>':`
        ${section('sh-g','1. Fact Salad',fs,[{lbl:'Question / Topic',key:'q'},{lbl:'Answer / Key Fact',key:'a'}])}
        ${section('sh-b','2. SWT Mistake Checkpoint',swt,[{lbl:'Question',key:'q'},{lbl:'Correct Answer',key:'a'},{lbl:'Your Incorrect Answer',key:'w'},{lbl:'Reason for Error',key:'r'}])}
        ${section('sh-r','3. GT Mistake Checkpoint',gt,[{lbl:'Exam Type',key:'examType'},{lbl:'Question',key:'q'},{lbl:'Correct Answer',key:'a'},{lbl:'Your Incorrect Answer',key:'w'},{lbl:'Reason for Error',key:'r'}])}`}
    </div>
    <div class="rpt-foot">Scalpel Study Squad ‚Äî Confidential ‚Äî Dr. ${fullName}</div>
  </div>`;
}

/* Opens the HTML report in the print overlay (viewer + print/share) */
function openReport(mode) {
  _pdfMode = mode;
  const now   = new Date();
  const label = mode==='daily'
    ? `Daily ‚Äì ${now.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})}`
    : `Monthly ‚Äì ${now.toLocaleString('default',{month:'long',year:'numeric'})}`;

  document.getElementById('print-bar-title').textContent = 'üìÑ ' + label;
  document.getElementById('print-content').innerHTML     = buildReportHTML(mode);

  // Also fill the old roverlay in case user taps the PDF button there
  if (document.getElementById('rov-title'))
    document.getElementById('rov-title').textContent = 'üìÑ ' + label;
  if (document.getElementById('roverlay-body'))
    document.getElementById('roverlay-body').innerHTML = buildReportHTML(mode);

  // Show/hide native share button in print bar
  const shareBarBtn = document.getElementById('pb-native-share');
  if (shareBarBtn) shareBarBtn.style.display = 'none'; // will show after PDF is built

  document.getElementById('print-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeOverlay() {
  document.getElementById('roverlay').classList.remove('open');
  document.body.style.overflow = '';
}

/* Main PDF build & Telegram-safe delivery */
async function downloadPDF() {
  const btn  = document.getElementById('dl-btn');
  const orig = btn ? btn.textContent : '';
  if (btn) { btn.textContent = '‚è≥ Building‚Ä¶'; btn.disabled = true; }

  document.getElementById('pdf-prog-text').textContent = 'Building PDF‚Ä¶';
  document.getElementById('pdf-spinner-wrap').style.display = 'flex';
  document.getElementById('pdf-share-card').style.display   = 'none';
  document.getElementById('pdf-progress-overlay').classList.add('open');

  // Hide report overlay so progress overlay is visible
  if (document.getElementById('roverlay'))
    document.getElementById('roverlay').classList.remove('open');
  // Hide print overlay too
  document.getElementById('print-overlay').classList.remove('open');

  try {
    const {jsPDF} = window.jspdf;
    const doc = new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
    const W=210, H=297, M=15; let y=0;

    const Cdk=[30,30,42], Cbl=[52,152,219], Cac=[224,92,122],
          Cgn=[26,122,72], Cbu=[37,88,176], Crd=[154,37,64],
          Ctx=[40,40,60],  Cmt=[130,130,160], Cwh=[255,255,255], Clb=[240,242,248];

    const addFoot = () => {
      doc.setFontSize(8); doc.setTextColor(...Cmt);
      doc.text('Scalpel Study Squad ‚Äî Confidential', W/2, H-8, {align:'center'});
      doc.text(`Dr. ${fullName}`, M, H-8);
      doc.text(`Page ${doc.internal.getNumberOfPages()}`, W-M, H-8, {align:'right'});
    };
    const nPage = () => { doc.addPage(); y=20; addFoot(); };
    const chk   = (n=15) => { if (y+n > H-22) nPage(); };

    // Load logo (non-blocking, 5s timeout)
    let logo = null;
    try {
      document.getElementById('pdf-prog-text').textContent = 'Loading logo‚Ä¶';
      const blob = await Promise.race([
        fetch('https://raw.githubusercontent.com/dhruvathaare/Scaslpel-Study-Squad-Apps/789a623092f757f3cd2b32c9bc305aa3a9c0819f/photo_2026-02-12_20-08-36.jpg').then(r=>r.blob()),
        new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),5000))
      ]);
      logo = await new Promise(res=>{ const fr=new FileReader(); fr.onload=e=>res(e.target.result); fr.readAsDataURL(blob); });
    } catch(e) { logo = null; }

    document.getElementById('pdf-prog-text').textContent = 'Generating pages‚Ä¶';

    // Cover page
    doc.setFillColor(...Cdk); doc.rect(0,0,W,72,'F');
    doc.setFillColor(...Cac); doc.rect(0,70,W,3,'F');
    if (logo) doc.addImage(logo,'JPEG',W/2-17,8,34,34);
    doc.setFont('helvetica','bold'); doc.setFontSize(20); doc.setTextColor(...Cwh);
    doc.text('Scalpel Study Squad',W/2,52,{align:'center'});
    doc.setFontSize(10); doc.setTextColor(...Cac);
    doc.text('QUALITATIVE REVISION REPORT',W/2,62,{align:'center'});
    doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(180,210,255);
    doc.text(`Dr. ${fullName}`,W-M,12,{align:'right'});
    doc.setFont('helvetica','normal'); doc.setFontSize(8); doc.setTextColor(140,170,220);
    doc.text(`ID: ${userId}`,W-M,19,{align:'right'});
    y = 82;

    const now   = new Date();
    const rtype = _pdfMode==='daily' ? 'Daily Revision Report' : 'Monthly Revision Report';
    const dstr  = _pdfMode==='daily'
      ? now.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'})
      : now.toLocaleString('default',{month:'long',year:'numeric'});

    doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.setTextColor(...Cbl);
    doc.text(rtype,W/2,y,{align:'center'}); y+=8;
    doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.setTextColor(...Ctx);
    doc.text(dstr,W/2,y,{align:'center'}); y+=12;
    doc.setDrawColor(...Cbl); doc.setLineWidth(0.7);
    doc.line(M,y,W-M,y); y+=12;

    const {fs,swt,gt} = getFiltered(_pdfMode);

    function pdfSection(title,clr,items,flds) {
      if (!items.length) return;
      chk(20);
      doc.setFillColor(...clr); doc.rect(M,y-4,W-M*2,11,'F');
      doc.setFont('helvetica','bold'); doc.setFontSize(13); doc.setTextColor(...Cwh);
      doc.text(title,M+4,y+4); y+=14;
      const grps={};
      items.forEach(i=>{ const s=i.sub||'General'; (grps[s]=grps[s]||[]).push(i); });
      Object.entries(grps).forEach(([sub,entries])=>{
        chk(14);
        doc.setFillColor(...Clb); doc.rect(M+4,y-3,W-M*2-8,9,'F');
        doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.setTextColor(...Cdk);
        doc.text(`Subject: ${sub}`,M+8,y+3); y+=11;
        entries.forEach((item,idx)=>{
          chk(12);
          doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(...Cbl);
          doc.text(`Entry ${idx+1}  |  ${item.date||''}`,M+10,y); y+=5;
          flds.forEach(({lbl,key})=>{
            const val=item[key]; if(!val) return; chk(8);
            doc.setFont('helvetica','bold'); doc.setFontSize(9); doc.setTextColor(...Cac);
            doc.text(`${lbl}:`,M+12,y);
            doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.setTextColor(...Ctx);
            const lines=doc.splitTextToSize(val,W-M*2-30);
            doc.text(lines,M+12,y+5); y+=5+lines.length*5; chk(6);
          });
          doc.setDrawColor(210,215,235); doc.setLineWidth(0.2);
          doc.line(M+10,y+2,W-M-10,y+2); y+=7;
        });
        y+=3;
      });
      y+=6;
    }

    pdfSection('1. FACT SALAD',          Cgn, fs,  [{lbl:'Question / Topic',key:'q'},{lbl:'Answer / Key Fact',key:'a'}]);
    pdfSection('2. SWT MISTAKE CHECKPOINT', Cbu, swt, [{lbl:'Question',key:'q'},{lbl:'Correct Answer',key:'a'},{lbl:'Your Incorrect Answer',key:'w'},{lbl:'Reason for Error',key:'r'}]);
    pdfSection('3. GT MISTAKE CHECKPOINT',  Crd, gt,  [{lbl:'Exam Type',key:'examType'},{lbl:'Question',key:'q'},{lbl:'Correct Answer',key:'a'},{lbl:'Your Incorrect Answer',key:'w'},{lbl:'Reason for Error',key:'r'}]);

    if (!fs.length && !swt.length && !gt.length) {
      doc.setFont('helvetica','italic'); doc.setFontSize(12); doc.setTextColor(...Cmt);
      doc.text('No entries found for this period.',W/2,y+20,{align:'center'});
    }
    addFoot();

    // Filename
    _pdfFileName = _pdfMode==='daily'
      ? `Scalpel_Daily_${now.toLocaleDateString('en-GB').replace(/\//g,'-')}.pdf`
      : `Scalpel_Monthly_${now.toLocaleString('default',{month:'long',year:'numeric'}).replace(' ','_')}.pdf`;

    document.getElementById('pdf-prog-text').textContent = 'Finalizing‚Ä¶';

    _pdfBlob      = doc.output('blob');
    _pdfShareFile = new File([_pdfBlob], _pdfFileName, {type:'application/pdf'});

    // Capability detection ‚Üí choose best delivery method
    const canShare = !!(navigator.canShare && navigator.canShare({files:[_pdfShareFile]}));
    const btnsEl   = document.getElementById('pdf-share-btns');
    const badgeEl  = document.getElementById('pdf-method-badge');
    const descEl   = document.getElementById('pdf-share-desc');
    btnsEl.innerHTML = '';

    if (canShare) {
      // ‚îÄ‚îÄ BEST: Android native share sheet ‚îÄ‚îÄ
      badgeEl.textContent         = '‚úÖ NATIVE SHARE';
      badgeEl.style.background    = 'var(--green)';
      descEl.textContent          = 'Tap below to save or share your PDF via Files, Drive, Telegram, etc.';
      const shareBtn              = document.createElement('button');
      shareBtn.className          = 'btn btn-g';
      shareBtn.style.padding      = '14px';
      shareBtn.textContent        = 'üì§ Share / Save PDF';
      shareBtn.onclick            = doNativeShare;
      btnsEl.appendChild(shareBtn);
      // Print fallback
      const printBtn              = document.createElement('button');
      printBtn.className          = 'btn btn-p';
      printBtn.style.padding      = '12px';
      printBtn.textContent        = 'üñ®Ô∏è Print / Save as PDF';
      printBtn.onclick            = () => { closePdfOverlay(); openViewerForPrint(); };
      btnsEl.appendChild(printBtn);
    } else {
      // ‚îÄ‚îÄ FALLBACK: Print ‚Üí Save as PDF ‚îÄ‚îÄ
      badgeEl.textContent         = 'üñ®Ô∏è PRINT METHOD';
      badgeEl.style.background    = 'var(--primary)';
      descEl.innerHTML            = '<strong>Telegram blocks direct downloads.</strong><br>Use <em>Print ‚Üí Save as PDF</em>, or take screenshots of the viewer.';
      const printBtn              = document.createElement('button');
      printBtn.className          = 'btn btn-g';
      printBtn.style.padding      = '14px';
      printBtn.textContent        = 'üñ®Ô∏è Open Print / Save as PDF';
      printBtn.onclick            = () => { closePdfOverlay(); openViewerForPrint(); };
      btnsEl.appendChild(printBtn);
      // Direct download attempt (works on desktop)
      const dlBtn                 = document.createElement('button');
      dlBtn.className             = 'btn btn-p';
      dlBtn.style.padding         = '12px';
      dlBtn.textContent           = '‚¨áÔ∏è Try Direct Download';
      dlBtn.onclick               = () => {
        try {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(_pdfBlob);
          a.download = _pdfFileName;
          document.body.appendChild(a); a.click();
          setTimeout(()=>document.body.removeChild(a), 1000);
        } catch(e) { showToast('‚ùå Blocked. Use Print instead.','#e05c7a'); }
      };
      btnsEl.appendChild(dlBtn);
    }

    document.getElementById('pdf-spinner-wrap').style.display = 'none';
    document.getElementById('pdf-share-card').style.display   = 'block';

    // Also update the print-bar native share btn visibility
    const shareBarBtn = document.getElementById('pb-native-share');
    if (shareBarBtn) shareBarBtn.style.display = canShare ? 'inline-block' : 'none';

  } catch(err) {
    console.error('PDF error:', err);
    closePdfOverlay();
    showToast('‚ö†Ô∏è PDF failed: '+err.message, '#e05c7a');
  }

  if (btn) { btn.textContent = orig; btn.disabled = false; }
}

/* Opens HTML report in print overlay (for print / screenshot delivery) */
function openViewerForPrint() {
  const now   = new Date();
  const label = _pdfMode==='daily'
    ? `Daily ‚Äì ${now.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})}`
    : `Monthly ‚Äì ${now.toLocaleString('default',{month:'long',year:'numeric'})}`;

  document.getElementById('print-bar-title').textContent = 'üìÑ ' + label;
  document.getElementById('print-content').innerHTML     = buildReportHTML(_pdfMode);

  const shareBarBtn = document.getElementById('pb-native-share');
  if (shareBarBtn) {
    const canShare = !!(navigator.canShare && _pdfShareFile && navigator.canShare({files:[_pdfShareFile]}));
    shareBarBtn.style.display = canShare ? 'inline-block' : 'none';
  }

  document.getElementById('print-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

/* ‚ïê‚ïê‚ïê MASTER UPDATE ‚ïê‚ïê‚ïê */
function updateUI(){
  updateBackupStatus();
  updateCountdowns();
  updateStreak();
  renderData();
  renderSWT();
  renderGT();
  renderMatrix();
  renderGoalHTML();
  renderPYQ();
  renderMonthlyTable();
  renderToughSelector();
  renderToughDash();
  loadGoalsUI();
  populateGTHistory();
  updateSlideshow();
}
updateUI();
setInterval(updateCountdowns, 60000);
</script>
</body>
</html>

