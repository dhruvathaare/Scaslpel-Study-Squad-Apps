<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scalpel Master Pro V8.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import { getDatabase, ref, set, get, child, update, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAmv7mm6rjaGPNx4IK9LXl3fO61uXxZgCQ",
        authDomain: "scalpel-pro.firebaseapp.com",
        projectId: "scalpel-pro",
        storageBucket: "scalpel-pro.firebasestorage.app",
        messagingSenderId: "244026009766",
        appId: "1:244026009766:web:3299c2dfa37cf378d1ac67"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // Globalizing DB functions for the script block
      window.db = db;
      window.ref = ref;
      window.set = set;
      window.get = get;
      window.child = child;
      window.update = update;
      window.query = query;
      window.orderByChild = orderByChild;
      window.limitToLast = limitToLast;

      const tgUser = window.Telegram.WebApp.initDataUnsafe?.user || { id: "OFFLINE", first_name: "Guest" };
      window.userId = tgUser.id;
      window.userName = tgUser.first_name || "Doctor";
      // --- 1. PERSONAL BACKUP SYNC ---
      window.syncToCloud = function() {
          const dataToSync = {};
          const keysToBackup = ['LOGS', 'NEET', 'INI', 'FMGE', 'SWT', 'GOALS', 'PYQ', 'TOUGH', 'FACTS', 'SWT_MISTAKES', 'GT_MISTAKES'];
          
          keysToBackup.forEach(key => {
              const prefix = `SSS_PRO_V3_${window.userId}_`;
              const localVal = localStorage.getItem(prefix + key);
              if (localVal) dataToSync[key] = JSON.parse(localVal);
          });

          if (window.userId !== "OFFLINE") {
              const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
              const statusEl = document.getElementById('cloud-sync-status');
              if(statusEl) statusEl.innerText = "Syncing...";

              window.set(window.ref(window.db, 'users/' + window.userId), dataToSync)
              .then(() => {
                  console.log("Auto-Sync Successful: " + now);
                  if(statusEl) {
                      statusEl.innerText = "Cloud: Online " + now + " ‚úÖ";
                      statusEl.style.color = "#2ecc71";
                  }
                  if(typeof window.calculateAndPushLeaderboard === 'function') {
                      window.calculateAndPushLeaderboard();
                  }
              })
              .catch((error) => {
                  console.error("Cloud Sync Failed", error);
                  if(statusEl) {
                      statusEl.innerText = "Sync Failed (Offline)";
                      statusEl.style.color = "#ef5350";
                  }
              });
          }
      };

      // --- 2. LEADERBOARD WRITE FUNCTION ---
      window.pushToLeaderboard = function(stats) {
          if (window.userId === "OFFLINE") return;
          const updates = {};
          if(stats.streak > 0) updates['/leaderboard/streak/' + window.userId] = { name: window.userName, score: stats.streak, vol: stats.streakVol };
          if(stats.neet > 0) updates['/leaderboard/neet/' + window.userId] = { name: window.userName, score: stats.neet };
          if(stats.ini > 0) updates['/leaderboard/ini/' + window.userId] = { name: window.userName, score: stats.ini };
          if(stats.fmge > 0) updates['/leaderboard/fmge/' + window.userId] = { name: window.userName, score: stats.fmge };

          Object.keys(stats.swt).forEach(sub => {
              if(stats.swt[sub] > 0) {
                  updates[`/leaderboard/swt/${sub}/${window.userId}`] = { name: window.userName, accuracy: stats.swt[sub] };
              }
          });
          window.update(window.ref(window.db), updates).catch(e => console.error("LB Update Error", e));
      };

      // --- 3. LEADERBOARD READ FUNCTION ---
      window.fetchLeaderboard = function(category, subject) {
          let path = `leaderboard/${category}`;
          if (category === 'swt' && subject) path += `/${subject}`;
          const qKey = category === 'swt' ? 'accuracy' : 'score';
          const lbQuery = window.query(window.ref(window.db, path), window.orderByChild(qKey), window.limitToLast(50));
          window.get(lbQuery).then((snapshot) => {
              if (snapshot.exists()) {
                  const data = [];
                  snapshot.forEach((child) => { data.push(child.val()); });
                  if(typeof window.renderLeaderboardUI === 'function') {
                      window.renderLeaderboardUI(data.reverse(), category);
                  }
              } else {
                  if(typeof window.renderLeaderboardUI === 'function') window.renderLeaderboardUI([], category);
              }
          }).catch((error) => console.error(error));
      };
      // --- 4. DATA PULL FUNCTION ---
      window.pullFromCloud = function() {
          if (window.userId === "OFFLINE") return;
          const dbRef = window.ref(window.db);
          window.get(window.child(dbRef, `users/${window.userId}`)).then((snapshot) => {
              if (snapshot.exists()) {
                  const cloudData = snapshot.val();
                  const prefix = `SSS_PRO_V3_${window.userId}_`;
                  Object.keys(cloudData).forEach(key => {
                      localStorage.setItem(prefix + key, JSON.stringify(cloudData[key]));
                  });
                  if(typeof updateUI === 'function') updateUI();
              }
          }).catch((error) => console.error(error));
      };

      window.pullFromCloud();
      setTimeout(() => { window.syncToCloud(); }, 3000); 
      setInterval(() => { window.syncToCloud(); }, 600000);
    </script>

    <style>
        /* CSS VARIABLES */
        :root { 
            --bg: #0e1621; 
            --card: #17212b; 
            --text: #ffffff; 
            --border: #2b5278; 
            --accent: #5288c1; 
            --input-bg: #0e1621; 
            --chart-text: #ffffff;
            --chart-grid: #aaaaaa;
            --instruction-bg: rgba(255,255,255,0.05);
            --tab-blue: #2481cc; /* Original Rounded Tab Blue */
            --tab-blue-dark: #1a5c96;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
        }
        [data-theme="light"] {
            --bg: #f2f2f7; 
            --card: #ffffff; 
            --text: #000000; 
            --border: #d1d1d6; 
            --accent: #007aff; 
            --input-bg: #ffffff;
            --chart-text: #000000;
            --chart-grid: #555555;
            --instruction-bg: rgba(0,0,0,0.05);
        }

        html, body { height: 100%; margin: 0; padding: 0; background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s; }
        body { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            padding: 15px; 
            padding-bottom: 90px;
            box-sizing: border-box; 
            overflow-y: auto !important; 
            -webkit-overflow-scrolling: touch;
            min-height: 100vh;
        }
        
        .container { width: 100%; max-width: 420px; display: flex; flex-direction: column; align-items: center; text-align: center; }

        /* --- RESTORED: QUANTITATIVE ROUNDED BLUE TABS --- */
        .nav-tabs { 
            display: flex; 
            justify-content: space-around; 
            gap: 5px; 
            margin-bottom: 15px; 
            width: 100%; 
        }

        .tab-btn { 
            background: rgba(82, 136, 193, 0.1); 
            border: 1px solid var(--border); 
            color: #888; 
            padding: 10px 5px; 
            font-size: 10px; 
            border-radius: 12px; /* Perfect Rounded Corners */
            cursor: pointer; 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 4px; 
            transition: all 0.2s; 
            font-weight: bold; 
            text-transform: uppercase; 
        }

        .tab-btn.active { 
            background: var(--tab-blue); /* Distinct Original Blue */
            color: white; 
            border-color: var(--tab-blue); 
            box-shadow: 0 4px 12px rgba(36, 129, 204, 0.3); 
            transform: translateY(-2px); 
        }

        .tab-btn span { font-size: 16px; margin-bottom: 2px; }

        /* TAB CONTENT VISIBILITY */
        .tab-content { display: none; width: 100%; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* CORE CARDS */
        .card { 
            background: var(--card); 
            border-radius: 15px; 
            padding: 15px; 
            margin-bottom: 15px; 
            width: 100%; 
            box-sizing: border-box; 
            border: 1px solid var(--border); 
            text-align: left;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .card h3 { margin-top: 0; color: var(--accent); font-size: 16px; display: flex; align-items: center; gap: 8px; }
        /* EXAM DASHBOARD & COUNTDOWNS */
        .exam-dashboard { width: 100%; margin-bottom: 20px; }
        .exam-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .exam-item { 
            background: var(--card); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 10px; 
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            min-height: 60px;
        }
        .exam-days { font-family: 'Oswald', sans-serif; font-size: 22px; color: var(--accent); line-height: 1; }
        .exam-label { font-size: 9px; text-transform: uppercase; margin-top: 4px; opacity: 0.8; font-weight: bold; letter-spacing: 0.5px; }

        /* LOGO & TITLE */
        .logo { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--accent); margin-bottom: 10px; object-fit: cover; }
        h1 { font-family: 'Oswald', sans-serif; font-size: 28px; margin: 0 0 5px 0; text-transform: uppercase; letter-spacing: 1px; color: var(--text); }
        
        /* MATRIX TABLES */
        .matrix-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; table-layout: fixed; }
        .matrix-table th, .matrix-table td { 
            padding: 8px 4px; 
            border: 1px solid var(--border); 
            text-align: center; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            white-space: nowrap; 
        }
        .matrix-table th { background: rgba(82, 136, 193, 0.1); color: var(--accent); font-weight: bold; }
        .matrix-table tr:nth-child(even) { background: rgba(255,255,255,0.02); }

        /* STREAK SECTION */
        .streak-section { margin-bottom: 15px; }
        .streak-text { font-family: 'Oswald', sans-serif; font-size: 20px; color: #f39c12; }
        .streak-icons-div { display: flex; justify-content: center; gap: 5px; margin: 5px 0; flex-wrap: wrap; }
        /* BUTTONS & INPUTS */
        .btn { 
            background: var(--accent); 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 10px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: opacity 0.2s, transform 0.2s; 
            font-size: 14px;
            text-transform: uppercase;
        }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        
        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            margin: 5px 0 12px 0; 
            background: var(--input-bg); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            color: var(--text); 
            font-size: 14px; 
            box-sizing: border-box; 
        }

        .sub-label { font-size: 10px; color: #888; margin-top: -8px; margin-bottom: 10px; }

        /* QUOTE */
        .quote { 
            font-style: italic; 
            font-size: 13px; 
            color: #888; 
            margin-bottom: 20px; 
            padding: 0 20px; 
            line-height: 1.4; 
        }

        /* TIMER & CLOCK */
        #timer-display { 
            font-family: 'Oswald', sans-serif; 
            font-size: 48px; 
            margin: 15px 0; 
            color: var(--accent); 
            text-shadow: 0 0 10px rgba(82,136,193,0.3);
        }

        .setting-label { 
            display: block; 
            text-align: left; 
            font-size: 11px; 
            font-weight: bold; 
            text-transform: uppercase; 
            color: var(--accent); 
            margin-bottom: 2px; 
        }

        /* ACCORDIONS */
        .accordion-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
        }
        .accordion-content { 
            display: none; 
            padding-top: 15px; 
            border-top: 1px dashed var(--border); 
            margin-top: 10px; 
        }
        .accordion-content.open { display: block; }
        .arrow { transition: transform 0.3s; font-size: 12px; }
        .active .arrow { transform: rotate(180deg); }        
        /* GT & SWT SPECIFIC UI */
        .calc-preview { 
            display: flex; 
            justify-content: space-between; 
            background: rgba(0,0,0,0.2); 
            padding: 10px; 
            border-radius: 8px; 
            font-size: 12px; 
            margin: 5px 0 10px 0; 
        }
        .calc-preview b { color: var(--accent); }

        .gt-tab-btn { transition: all 0.3s ease; border-radius: 8px; }
        .gt-tab-btn.active { background: var(--accent) !important; color: white !important; }

        /* PYQ NAVIGATION */
        .pyq-nav-container { 
            display: flex; 
            gap: 5px; 
            margin-bottom: 12px; 
            overflow-x: auto; 
            padding-bottom: 5px; 
        }
        .pyq-tab { 
            padding: 8px 12px; 
            background: var(--input-bg); 
            border: 1px solid var(--border); 
            border-radius: 20px; 
            font-size: 10px; 
            white-space: nowrap; 
            cursor: pointer; 
            font-weight: bold; 
        }
        .pyq-tab.active { background: var(--accent); color: white; border-color: var(--accent); }
        .pyq-tab-cup { margin-left: 4px; display: none; }

        /* CHART SCROLLER (For Landscape Charts) */
        .chart-scroller { width: 100%; overflow-x: auto; margin-top: 10px; background: rgba(0,0,0,0.1); border-radius: 10px; padding: 5px; }
        .chart-scroll-content { width: 600px; height: 200px; }

        /* LEADERBOARD ARENA CSS */
        .rank-nav { display: flex; gap: 5px; margin-bottom: 15px; }
        .rank-nav-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-size: 10px; cursor: pointer; font-weight: bold; }
        .rank-nav-btn.active { background: #f39c12; color: white; border-color: #f39c12; }

        .rank-list { margin-top: 10px; }
        .rank-item { 
            display: flex; 
            align-items: center; 
            background: var(--card); 
            border: 1px solid var(--border); 
            margin-bottom: 5px; 
            border-radius: 10px; 
            padding: 10px; 
            gap: 10px; 
        }
        .rank-pos { width: 30px; font-family: 'Oswald', sans-serif; font-size: 18px; text-align: center; }
        .rank-name { flex: 1; font-weight: bold; font-size: 13px; text-align: left; }
        .rank-score { font-family: 'Oswald', sans-serif; color: #f39c12; font-size: 16px; }
        .rank-meta { font-size: 9px; opacity: 0.6; display: block; }

        .rank-1 { border: 2px solid var(--gold); box-shadow: 0 0 10px rgba(255,215,0,0.2); }
        .rank-2 { border: 2px solid var(--silver); }
        .rank-3 { border: 2px solid var(--bronze); }
        .elite-badge { background: var(--accent); color: white; font-size: 8px; padding: 2px 4px; border-radius: 4px; }
        /* --- QUALITATIVE SECTION STYLES --- */
        .qual-card { 
            background: var(--card); 
            border-radius: 15px; 
            padding: 20px; 
            margin-bottom: 15px; 
            border: 1px solid var(--border); 
            text-align: left; 
        }

        .slide-container {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 25px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            margin-bottom: 15px;
            border: 1px dashed var(--accent);
            position: relative;
        }

        .qual-input-group { margin-bottom: 15px; }
        .qual-input-group label { 
            font-size: 11px; 
            text-transform: uppercase; 
            color: var(--accent); 
            font-weight: bold; 
            display: block; 
            margin-bottom: 5px; 
        }

        /* POPUPS */
        #popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .popup-card {
            background: var(--card); width: 90%; max-width: 350px;
            padding: 25px; border-radius: 20px; border: 1px solid var(--border);
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* BOTTOM NAVIGATION DOCK */
        .main-nav-dock {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--card); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; padding: 10px 0;
            z-index: 1500; padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }
        .main-nav-btn {
            background: none; border: none; color: #888;
            font-size: 11px; font-weight: bold; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .main-nav-btn.active { color: var(--accent); }
        .main-nav-btn span { font-size: 22px; }

        /* DANGER ZONE (Relocated) */
        .danger-zone {
            margin-top: 30px; padding: 15px; border-radius: 12px;
            background: rgba(239, 83, 80, 0.05); border: 1px solid rgba(239, 83, 80, 0.2);
            width: 100%; box-sizing: border-box;
        }

        /* UTILITY */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-online { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .status-offline { background: #ef5350; }
    </style>
</head>
    <body>
    <div id="popup-overlay">
        <div id="mcq-popup" class="popup-card">
            <h2 style="color:var(--accent); font-family:'Oswald';">SESSION COMPLETE!</h2>
            <p style="font-size:14px; opacity:0.8;">How many MCQs did you solve in this cycle?</p>
            <input type="number" id="cycleMcqs" placeholder="Enter count..." style="text-align:center; font-size:20px;">
            <button class="btn" style="width:100%; background:#2ecc71;" onclick="startBreak()">Log & Take Break</button>
            <button class="btn" style="width:100%; background:#8e44ad; margin-top:10px;" onclick="stopEntireSession()">Finish Study Day</button>
        </div>

        <div id="break-popup" class="popup-card">
            <h2 style="color:#f39c12; font-family:'Oswald';">BREAK OVER!</h2>
            <p style="font-size:14px; opacity:0.8;">Time to get back into the zone, Doctor.</p>
            <button class="btn" style="width:100%;" onclick="continueNextCycle()">Start Next Cycle</button>
            <button class="btn" style="width:100%; background:#ef5350; margin-top:10px;" onclick="stopEntireSession()">End Session</button>
        </div>

        <div id="restore-popup" class="popup-card" style="display:none;">
            <h3>Restore Data</h3>
            <p style="font-size:11px; color:#888;">Paste your backup code below:</p>
            <textarea id="restoreCode" style="height:100px; font-size:10px;"></textarea>
            <button class="btn" style="width:100%;" onclick="importData()">Execute Restore</button>
            <button class="btn" style="width:100%; background:#888; margin-top:10px;" onclick="closePopup()">Cancel</button>
        </div>
    </div>

    <div class="container">
        <div style="width:100%; display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
            <div style="text-align:left;">
                <div id="uFullName" style="font-weight:bold; font-size:14px; color:var(--accent);">Loading...</div>
                <div id="uID" style="font-size:10px; opacity:0.5;">ID: --</div>
            </div>
            <div style="text-align:right;">
                <div id="cloud-sync-status" style="font-size:10px; font-weight:bold; color:#888;">Cloud: Checking...</div>
                <div style="font-size:10px; opacity:0.5;"><span id="statusDot" class="status-dot"></span><span id="onlineText">System Live</span></div>
            </div>
        </div>
        <img src="https://github.com/dhruvathaare/Scaslpel-Study-Squad-Apps/blob/main/photo_2026-02-12_20-08-36.jpg?raw=true" class="logo">
        <h1>Scalpel Study Squad</h1>
        
        <div class="streak-section">
            <div id="streakText" class="streak-text">Consistency: 0 Days</div>
            <div id="streakIcons" class="streak-icons-div"></div>
            <div style="font-size:11px; color:#888;">üî• per 25 days | ü•á per 75 days</div>
        </div>
        
        <div class="quote">"I AM HERE TO WIN, CONSISTENCY IS MY KITH AND KIN"</div>

        <div class="exam-dashboard">
            <div class="exam-grid">
                <div class="exam-item" id="dash_ini_jul">
                    <span id="daysIniJuly" class="exam-days">--</span>
                    <span class="exam-label">INICET JULY</span>
                </div>
                <div class="exam-item" id="dash_upsc">
                    <span id="daysUpsc" class="exam-days">--</span>
                    <span class="exam-label">UPSC CMS</span>
                </div>
                <div class="exam-item" id="dash_neet">
                    <span id="daysNeet" class="exam-days">--</span>
                    <span class="exam-label">NEET PG 2026</span>
                </div>
                <div class="exam-item" id="dash_ini_jan">
                    <span id="daysIniJan" class="exam-days">--</span>
                    <span class="exam-label">INICET JAN '27</span>
                </div>
                <div class="exam-item" id="dash_fmge_jun">
                    <span id="daysFmgeJun" class="exam-days">--</span>
                    <span class="exam-label">FMGE JUNE '26</span>
                </div>
                <div class="exam-item" id="dash_fmge_dec">
                    <span id="daysFmgeDec" class="exam-days">--</span>
                    <span class="exam-label">FMGE DEC '26</span>
                </div>
            </div>
        </div>
        <div id="section-quant" class="section-container active">
            
            <div class="nav-tabs">
                <button class="tab-btn theme-toggle-tab" onclick="toggleTheme()">
                    <span>üåó</span>
                    THEME
                </button>
                <div class="tab-btn" onclick="switchTab('tab-goal', this)">
                    <span>üéØ</span>GOAL
                </div>
                <div class="tab-btn active" onclick="switchTab('tab-daily', this)">
                    <span>üìä</span>DAILY
                </div>
                <div class="tab-btn" onclick="switchTab('tab-swt', this)">
                    <span>üß†</span>SWT
                </div>
                <div class="tab-btn" onclick="switchTab('tab-gt', this)">
                    <span>üìà</span>GT
                </div>
                <div class="tab-btn" onclick="switchTab('tab-rank', this)">
                    <span>üèÜ</span>RANKS
                </div>
            </div>

            <div id="tab-goal" class="tab-content">
                <div class="card">
                    <div class="accordion-header" onclick="toggleAccordion('acc_exams', this)">
                        <h3>My Target Exams</h3>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div id="acc_exams" class="accordion-content">
                        <div class="goal-row" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <span>INICET July</span><input type="checkbox" id="goal_ini_jul" onchange="saveGoals()" style="width:20px;">
                        </div>
                        <div class="goal-row" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <span>UPSC CMS</span><input type="checkbox" id="goal_upsc" onchange="saveGoals()" style="width:20px;">
                        </div>
                        <div class="goal-row" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <span>NEET PG 2026</span><input type="checkbox" id="goal_neet" onchange="saveGoals()" style="width:20px;">
                        </div>
                        <div class="goal-row" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <span>INICET Jan '27</span><input type="checkbox" id="goal_ini_jan" onchange="saveGoals()" style="width:20px;">
                        </div>
                        <div class="goal-row" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <span>FMGE JUNE '26</span><input type="checkbox" id="goal_fmge_jun" onchange="saveGoals()" style="width:20px;">
                        </div>
                        <div class="goal-row" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <span>FMGE DEC '26</span><input type="checkbox" id="goal_fmge_dec" onchange="saveGoals()" style="width:20px;">
                        </div>
                        <button class="btn" style="width:100%; margin-top:10px; font-size:12px;" onclick="lockExamGoals()">Lock Selection</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Tough Subjects Radar</h3>
                    <div id="tough-dashboard" style="margin-bottom:10px;"></div>
                    <div class="accordion-header" onclick="toggleAccordion('acc_tough', this)">
                        <span style="font-size:11px; font-weight:bold; color:var(--accent);">Select Tough Subjects</span>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div id="acc_tough" class="accordion-content">
                        <div id="tough-subject-selector" style="display:grid; grid-template-columns:1fr 1fr; gap:5px; font-size:10px; text-align:left;">
                            </div>
                    </div>
                </div>

                <div class="card">
                    <div class="accordion-header" onclick="toggleAccordion('acc_pyq', this)">
                        <h3>PYQ Completion Goals</h3>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div id="acc_pyq" class="accordion-content">
                        <div class="pyq-nav-container" id="pyq-nav">
                            <div class="pyq-tab active" onclick="switchPyq('neet', this)">NEET PG</div>
                            <div class="pyq-tab" onclick="switchPyq('ini', this)">INICET</div>
                            <div class="pyq-tab" onclick="switchPyq('fmge', this)">FMGE</div>
                            <div class="pyq-tab" onclick="switchPyq('upsc', this)">UPSC CMS</div>
                        </div>
                        <div id="pyq-content" style="max-height: 250px; overflow-y: auto; padding: 5px; background: rgba(0,0,0,0.1); border-radius: 8px;">
                            </div>
                    </div>
                </div>
            </div>

            <div id="tab-daily" class="tab-content active">
                <div class="card">
                    <h3>Study Session Timer</h3>
                    <div class="timer-setup">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <div>
                                <label class="setting-label">Subject</label>
                                <select id="subject" style="margin-bottom:5px;">
                                    <option value="" disabled selected>Choose Subject</option>
                                    <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option>
                                    <option>Mixed Bag</option><option>Integrated Systems</option>
                                </select>
                            </div>
                            <div>
                                <label class="setting-label">Phase</label>
                                <select id="studyPhase" style="margin-bottom:5px;">
                                    <option value="r1">1st Reading ü•â</option>
                                    <option value="r2">2nd Reading ü•à</option>
                                    <option value="r3">3rd Reading ü•á</option>
                                    <option value="r4">Bonus/Rev üèÜ</option>
                                </select>
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:5px;">
                            <div>
                                <label class="setting-label">Session (Hr:Min)</label>
                                <div style="display:flex; gap:5px;">
                                    <input type="number" id="studyHr" value="2" min="0" max="12" style="margin:0;">
                                    <input type="number" id="studyMin" value="30" min="0" max="59" style="margin:0;">
                                </div>
                            </div>
                            <div>
                                <label class="setting-label">Break (Min)</label>
                                <input type="number" id="breakTime" value="15" min="0" style="margin:0;">
                            </div>
                        </div>

                        <div id="timer-display">00:00:00</div>
                        
                        <button id="startBtn" class="btn" style="width:100%;">Initialize Session üöÄ</button>
                        
                        <div id="timer-controls" style="display:none; gap:10px; margin-top:10px;">
                            <button id="pauseBtn" class="btn" style="flex:1; background:#f39c12;" onclick="togglePause()">Pause</button>
                            <button class="btn" style="flex:1; background:#ef5350;" onclick="handleTransition()">Skip to Log</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>Performance Analytics</h3>
                        <div style="display:flex; gap:10px;">
                            <button class="btn" style="padding:4px 8px; font-size:10px;" onclick="changeViewMonth(-1)">‚óÄ</button>
                            <span id="currentMonthYear" style="font-size:11px; font-weight:bold; width:80px; text-align:center;"></span>
                            <button class="btn" style="padding:4px 8px; font-size:10px;" onclick="changeViewMonth(1)">‚ñ∂</button>
                        </div>
                    </div>
                    
                    <div class="chart-scroller">
                        <div class="chart-scroll-content">
                            <canvas id="hoursChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-scroller" style="margin-top:10px;">
                        <div class="chart-scroll-content">
                            <canvas id="mcqChart"></canvas>
                        </div>
                    </div>

                    <div class="accordion-header" onclick="toggleAccordion('acc_logs', this)" style="margin-top:15px;">
                        <span style="font-size:11px; font-weight:bold; color:var(--accent);">View Detailed History</span>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div id="acc_logs" class="accordion-content">
                        <div style="max-height: 200px; overflow-y: auto;">
                            <table class="matrix-table">
                                <thead>
                                    <tr><th>Date</th><th>Hrs</th><th>Cyc</th><th>MCQ</th><th>Subjects</th></tr>
                                </thead>
                                <tbody id="dailyLogBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="tab-swt" class="tab-content">
                <div class="card">
                    <h3>Log Subject-Wise Test (SWT)</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label class="setting-label">Subject</label>
                            <select id="swtSubject">
                                <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option>
                                <option>Mixed Bag</option>
                            </select>
                        </div>
                        <div>
                            <label class="setting-label">Reading Phase</label>
                            <select id="swtPhase">
                                <option value="r1">1st Reading ü•â</option>
                                <option value="r2">2nd Reading ü•à</option>
                                <option value="r3">3rd Reading ü•á</option>
                                <option value="r4">Bonus/Rev üèÜ</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:5px;">
                        <div>
                            <label class="setting-label">Correct MCQs</label>
                            <input type="number" id="swtCorrect" placeholder="0" oninput="calculateSWTPerc()">
                        </div>
                        <div>
                            <label class="setting-label">Total MCQs</label>
                            <input type="number" id="swtTotal" placeholder="0" oninput="calculateSWTPerc()">
                        </div>
                    </div>
                    <div id="swt-calc-preview" class="calc-preview">
                        <span>Predicted Accuracy: <b id="swtAccPreview">0%</b></span>
                    </div>
                    <button class="btn" style="width:100%; background:var(--tab-blue);" onclick="saveSWT()">Log Score üß†</button>
                </div>

                <div class="card">
                    <h3>Subject Mastery Matrix</h3>
                    <div style="font-size: 10px; color: #888; margin-bottom: 10px;">Tracking cumulative performance across all reading phases.</div>
                    <div style="overflow-x: auto;">
                        <table class="matrix-table" id="swtMatrixTable">
                            <thead>
                                <tr>
                                    <th style="width: 35%;">Subject</th>
                                    <th>Total MCQ</th>
                                    <th>Accuracy</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="swtMatrixBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
                <div class="card">
                    <h3>Reading Phase Analysis</h3>
                    <div style="font-size: 10px; color: #888; margin-bottom: 10px;">MCQ Volume and Accuracy split by Reading Phase.</div>
                    <div class="chart-scroller">
                        <div class="chart-scroll-content">
                            <canvas id="swtPhaseCountChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-scroller" style="margin-top:10px;">
                        <div class="chart-scroll-content">
                            <canvas id="swtPhaseAvgChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-gt" class="tab-content">
                <div class="card">
                    <h3>Log Grand Test (GT)</h3>
                    <div style="display:flex; gap:5px; margin-bottom:15px;">
                        <button class="btn gt-tab-btn active" onclick="switchGTMode('NEET', this)" style="flex:1; background:rgba(82,136,193,0.1); color:var(--text); font-size:10px;">NEET PG</button>
                        <button class="btn gt-tab-btn" onclick="switchGTMode('INI', this)" style="flex:1; background:rgba(82,136,193,0.1); color:var(--text); font-size:10px;">INICET</button>
                        <button class="btn gt-tab-btn" onclick="switchGTMode('FMGE', this)" style="flex:1; background:rgba(82,136,193,0.1); color:var(--text); font-size:10px;">FMGE</button>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label class="setting-label">Score (Marks/%)</label>
                            <input type="number" id="gtScore" placeholder="Enter Score">
                        </div>
                        <div>
                            <label class="setting-label">Rank / Percentile</label>
                            <input type="number" id="gtRank" placeholder="Enter Rank">
                        </div>
                    </div>
                    
                    <div class="qual-input-group" style="margin-top:5px;">
                        <label>Exam Platform / Source</label>
                        <select id="gtPlatform">
                            <option>Marrow</option><option>Prepladder</option><option>Bhatia</option><option>DAMS</option><option>Cerebellum</option><option>Other</option>
                        </select>
                    </div>

                    <button class="btn" style="width:100%; background:#8e44ad;" onclick="saveGT()">Log GT Result üìà</button>
                </div>
                <div class="card">
                    <h3>GT Performance Tracking</h3>
                    <div style="font-size: 10px; color: #888; margin-bottom: 10px;">Visualizing your progress across different exam types.</div>
                    
                    <div id="gt-chart-neet" class="chart-scroller">
                        <div style="font-size:10px; font-weight:bold; color:var(--accent); margin-bottom:5px;">NEET PG TREND</div>
                        <div class="chart-scroll-content">
                            <canvas id="gtNeetChart"></canvas>
                        </div>
                    </div>

                    <div id="gt-chart-ini" class="chart-scroller" style="margin-top:10px;">
                        <div style="font-size:10px; font-weight:bold; color:var(--accent); margin-bottom:5px;">INICET TREND</div>
                        <div class="chart-scroll-content">
                            <canvas id="gtIniChart"></canvas>
                        </div>
                    </div>

                    <div id="gt-chart-fmge" class="chart-scroller" style="margin-top:10px;">
                        <div style="font-size:10px; font-weight:bold; color:var(--accent); margin-bottom:5px;">FMGE TREND</div>
                        <div class="chart-scroll-content">
                            <canvas id="gtFmgeChart"></canvas>
                        </div>
                    </div>

                    <div class="accordion-header" onclick="toggleAccordion('acc_gt_history', this)" style="margin-top:15px;">
                        <span style="font-size:11px; font-weight:bold; color:var(--accent);">View GT History Log</span>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div id="acc_gt_history" class="accordion-content">
                        <div style="max-height: 250px; overflow-y: auto;">
                            <table class="matrix-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Score</th>
                                        <th>Rank</th>
                                        <th>Source</th>
                                    </tr>
                                </thead>
                                <tbody id="gtHistoryBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="tab-rank" class="tab-content">
                <div class="card">
                    <h3>Leaderboard Arena üèÜ</h3>
                    <div class="rank-nav">
                        <button class="rank-nav-btn active" onclick="switchRankMode('streak', this)">Streaks</button>
                        <button class="rank-nav-btn" onclick="switchRankMode('swt', this)">SWT Accuracy</button>
                        <button class="rank-nav-btn" onclick="switchRankMode('gt', this)">GT Mean</button>
                    </div>

                    <div id="rank-filter-streak" style="font-size: 10px; color: #888; margin-bottom: 10px; text-align:center;">
                        Top 50: Consecutive days with ‚â• 50 MCQs.
                    </div>
                    
                    <div id="rank-filter-swt" style="display:none; margin-bottom:10px;">
                        <select id="rankSubjectSelect" onchange="loadLeaderboard('swt')" style="margin:0;">
                            <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option>
                        </select>
                    </div>
                    
                    <div id="rank-filter-gt" style="display:none; margin-bottom:10px;">
                        <select id="rankGtSelect" onchange="loadLeaderboard('gt')" style="margin:0;">
                            <option value="neet">NEET PG Average</option>
                            <option value="ini">INICET Average</option>
                            <option value="fmge">FMGE Average</option>
                        </select>
                    </div>

                    <div class="rank-list" id="leaderboard-list">
                        </div>
                </div>
            </div>
        </div> <div id="section-qual" class="tab-content" style="width:100%;">
            <h2 style="font-family:'Oswald'; color:var(--accent); text-transform:uppercase; margin-top:10px;">Qualitative Analysis</h2>
            
            <div class="qual-card">
                <h3>Fact Salad Bowl ü•ó</h3>
                <div class="slide-container">
                    <div id="fact-slideshow">Add facts below to start the show!</div>
                </div>
                
                <div style="display:flex; gap:10px; margin-bottom:15px; justify-content:center;">
                    <button id="slideShowBtn" class="btn" style="flex:1; background:#f39c12; font-size:10px;" onclick="toggleSlideShow()">‚èØ Play Slideshow (30s)</button>
                    <button class="btn" style="flex:1; background:var(--accent); font-size:10px;" onclick="showRandomFact()">üé≤ Shuffle Fact</button>
                </div>

                <div class="qual-input-group">
                    <label>Subject</label>
                    <select id="factSubject">
                        <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option>
                    </select>
                </div>
                <div class="qual-input-group">
                    <label>Fact / Question</label>
                    <textarea id="factQuestion" placeholder="e.g., Nerve supply of the diaphragm?"></textarea>
                </div>
                <div class="qual-input-group">
                    <label>The Answer</label>
                    <textarea id="factAnswer" placeholder="e.g., Phrenic Nerve (C3, C4, C5)"></textarea>
                </div>
                <button class="btn" style="width:100%;" onclick="saveFact()">Add to Salad Bowl ü•ó</button>
            </div>

            <div class="qual-card">
                <h3>SWT Mistake Checkpoint üß†</h3>
                <p style="font-size:11px; color:#888; margin-bottom:15px;">Log conceptual errors or silly mistakes from your Subject-Wise Tests.</p>
                
                <div class="qual-input-group">
                    <label>Subject</label>
                    <select id="swtMistakeSubject">
                        <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option>
                    </select>
                </div>
                
                <div class="qual-input-group">
                    <label>Question</label>
                    <textarea id="swtMistakeQ" placeholder="The question you got wrong..."></textarea>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="qual-input-group">
                        <label>Correct Answer</label>
                        <textarea id="swtMistakeA"></textarea>
                    </div>
                    <div class="qual-input-group">
                        <label>My Incorrect Answer</label>
                        <textarea id="swtMistakeWrong"></textarea>
                    </div>
                </div>

                <div class="qual-input-group">
                    <label>Why did I get this wrong?</label>
                    <textarea id="swtMistakeReason" placeholder="e.g., Confused with X, Didn't see 'EXCEPT'..."></textarea>
                </div>
                
                <button class="btn" style="width:100%; background:#e74c3c;" onclick="saveSWTMistake()">Log Mistake üß†</button>
            </div>
            <div class="qual-card">
                <h3>GT Mistake Autopsy üìâ</h3>
                <p style="font-size:11px; color:#888; margin-bottom:15px;">Deep dive into your Grand Test errors to improve your rank.</p>
                
                <div class="qual-input-group">
                    <label>Exam Type</label>
                    <select id="gtMistakeType">
                        <option>NEET PG</option><option>INICET</option><option>FMGE</option><option>UPSC CMS</option>
                    </select>
                </div>

                <div class="qual-input-group">
                    <label>Subject</label>
                    <select id="gtMistakeSubject">
                        <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option>
                    </select>
                </div>
                <div class="qual-input-group"><label>Question</label><textarea id="gtMistakeQ"></textarea></div>
                <div class="qual-input-group"><label>Correct Answer</label><textarea id="gtMistakeA"></textarea></div>
                <div class="qual-input-group"><label>My Incorrect Answer</label><textarea id="gtMistakeWrong"></textarea></div>
                <div class="qual-input-group"><label>Reason for Error</label><textarea id="gtMistakeReason" placeholder="e.g., Misread question, Recall error..."></textarea></div>
                <button class="btn" style="width:100%; background:#e74c3c;" onclick="saveGTMistake()">Log Autopsy üìâ</button>
            </div>

            <div class="danger-zone" style="margin-top:15px; background:var(--card); border:1px solid var(--border);">
                <h3 style="color:#2ecc71; margin:0 0 10px 0;">Revision Reports (PDF)</h3>
                <div style="font-size:10px; color:#ef5350; margin-bottom:10px; font-weight:bold;">‚ö†Ô∏è NOTE: Download "Month End" report on the last day. Data in this section is volatile!</div>
                
                <button class="btn" onclick="generatePDF('daily')" style="margin-bottom:10px; background:var(--tab-blue); width:100%;">üìÑ Download Today's Report</button>
                <button class="btn" onclick="generatePDF('monthly')" style="margin-bottom:10px; background:#8e44ad; width:100%;">üìÖ Download Month End Report</button>
                <button class="clear-btn" onclick="clearQualitativeData()" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ef5350; background:transparent; color:#ef5350; font-size:10px; font-weight:bold;">üóëÔ∏è Clear Qualitative Data (New Month)</button>
            </div>
        </div> ```
        <div class="danger-zone" style="margin-top: 40px; border-color: #f39c12; background: rgba(243, 156, 18, 0.05);">
            <h3 style="color:#f39c12; margin:0 0 10px 0;">Data Safety & Migration</h3>
            <div id="backup-reminder" style="font-weight:bold; margin-bottom:10px; font-size:11px; text-transform:uppercase; letter-spacing:0.5px; text-align: center;"></div>
            
            <ul style="text-align: left; font-size: 10px; opacity: 0.7; padding-left: 15px; margin-bottom: 15px;">
                <li><strong>Backup:</strong> Copies your data code. Save this in your Telegram "Saved Messages".</li>
                <li><strong>Restore:</strong> Paste your saved code to recover data on a new device.</li>
            </ul>

            <button class="btn" onclick="exportData()" style="width:100%; background:#f39c12; margin-bottom:10px;">Backup Data (Copy Code)</button>
            <button class="btn" onclick="openPopup('restore-popup')" style="width:100%; background:transparent; border:1px solid #f39c12; color:#f39c12; margin-bottom:10px;">Restore Data</button>
            <button class="btn" onclick="clearData()" style="width:100%; background:#ef5350; font-size:10px;">Wipe All Local Data</button>
        </div>

    </div> <div class="main-nav-dock">
        <button class="main-nav-btn active" id="nav-quant" onclick="switchMainSection('quant', this)">
            <span>üìä</span>Quant
        </button>
        <button class="main-nav-btn" id="nav-qual" onclick="switchMainSection('qual', this)">
            <span>üìù</span>Qual
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
        
        // Use window.userId and window.userName set in the Firebase block
        document.getElementById('uFullName').innerText = window.userName || "Guest User";
        document.getElementById('uID').innerText = `ID: ${window.userId}`;
        
        const statusDot = document.getElementById('statusDot');
        if (window.userId === "OFFLINE") { 
            statusDot.classList.add('status-offline'); 
            document.getElementById('onlineText').innerText = "Offline Mode";
        } else { 
            statusDot.classList.add('status-online'); 
        }

        const prefix = `SSS_PRO_V3_${window.userId}_`;
        
        const KEYS = { 
            LOGS: prefix+'LOGS', NEET: prefix+'NEET', INI: prefix+'INI', FMGE: prefix+'FMGE', 
            SWT: prefix+'SWT', GOALS: prefix+'GOALS', PYQ: prefix+'PYQ', TOUGH: prefix+'TOUGH',
            FACTS: prefix+'FACTS', SWT_MISTAKES: prefix+'SWT_MISTAKES', GT_MISTAKES: prefix+'GT_MISTAKES'
        };
        
        const SUBJECTS_19 = ["Anatomy", "Physiology", "Biochemistry", "Pathology", "Microbiology", "Pharmacology", "FMT", "PSM", "Ophthalmology", "ENT", "Medicine", "Surgery", "OBG", "Pediatrics", "Anaesthesia", "Dermatology", "Orthopedics", "Psychiatry", "Radiology"];
        
        const EXAMS_CONFIG = [
            { id: 'ini_jul', label: 'INICET JULY', date: '2026-05-10', el: 'daysIniJuly' },
            { id: 'upsc', label: 'UPSC CMS', date: '2026-07-20', el: 'daysUpsc' },
            { id: 'neet', label: 'NEET PG 2026', date: '2026-06-23', el: 'daysNeet' },
            { id: 'ini_jan', label: 'INICET JAN 27', date: '2026-11-15', el: 'daysIniJan' },
            { id: 'fmge_jun', label: 'FMGE JUNE 26', date: '2026-06-18', el: 'daysFmgeJun' },
            { id: 'fmge_dec', label: 'FMGE DEC 26', date: '2026-12-20', el: 'daysFmgeDec' }
        ];
        /* --- MAIN NAVIGATION --- */
        function switchMainSection(section, btn) {
            document.querySelectorAll('.main-nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Hide all main sections
            document.getElementById('section-quant').classList.remove('active');
            document.getElementById('section-quant').style.display = 'none';
            document.getElementById('section-qual').classList.remove('active');
            document.getElementById('section-qual').style.display = 'none';
            
            // Show target
            const target = document.getElementById('section-' + section);
            target.classList.add('active');
            target.style.display = 'block';
            window.scrollTo(0,0);
        }

        /* --- QUANTITATIVE TAB SWITCHING (Rounded Blue Tabs) --- */
        function switchTab(tabId, btn) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(c => {
                if(c.parentElement.id === 'section-quant') c.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        }

        function switchGTMode(mode, btn) {
            currentGTMode = mode;
            document.querySelectorAll('.gt-tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateUI();
        }

        /* --- EXAM TRACKER LOGIC (Days Remaining Fix) --- */
        function updateCountdowns() {
            const now = new Date();
            EXAMS_CONFIG.forEach(exam => {
                const examDate = new Date(exam.date);
                const diffTime = examDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const el = document.getElementById(exam.el);
                const card = document.getElementById('dash_' + exam.id);
                
                if (el) {
                    if (diffDays > 0) {
                        el.innerText = diffDays;
                        if(card) card.style.opacity = "1";
                    } else if (diffDays === 0) {
                        el.innerText = "TODAY";
                        el.style.fontSize = "14px";
                    } else {
                        el.innerText = "DONE";
                        if(card) card.style.opacity = "0.3";
                    }
                }
            });
        }

        /* --- GOAL & PYQ MANAGEMENT --- */
        function saveGoals() {
            const goals = {};
            EXAMS_CONFIG.forEach(ex => {
                const chk = document.getElementById('goal_' + ex.id);
                if(chk) goals[ex.id] = chk.checked;
            });
            localStorage.setItem(KEYS.GOALS, JSON.stringify(goals));
            renderGoalHTML();
            if(window.syncToCloud) window.syncToCloud();
        }

        function renderGoalHTML() {
            const goals = JSON.parse(localStorage.getItem(KEYS.GOALS) || "{}");
            EXAMS_CONFIG.forEach(ex => {
                const card = document.getElementById('dash_' + ex.id);
                if(card) {
                    card.style.display = goals[ex.id] ? "flex" : "none";
                }
            });
        }

        function loadGoalsToUI() {
            const goals = JSON.parse(localStorage.getItem(KEYS.GOALS) || "{}");
            EXAMS_CONFIG.forEach(ex => {
                const chk = document.getElementById('goal_' + ex.id);
                if(chk) chk.checked = !!goals[ex.id];
            });
        }

        function lockExamGoals() {
            toggleAccordion('acc_exams', document.querySelector('#tab-goal .accordion-header'));
            alert("Targets Locked. Focus on the mission! üéØ");
        }
        /* --- PYQ TRACKER LOGIC --- */
        let currentPyqCat = 'neet';
        function switchPyq(cat, btn) {
            currentPyqCat = cat;
            document.querySelectorAll('.pyq-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            renderPyq();
        }

        function renderPyq() {
            const container = document.getElementById('pyq-content');
            const data = JSON.parse(localStorage.getItem(KEYS.PYQ) || "{}");
            const catData = data[currentPyqCat] || {};
            
            // Generate years based on category
            let years = [];
            if(currentPyqCat === 'neet') years = [2025, 2024, 2023, 2022, 2021, 2020, 2019, 2018];
            else if(currentPyqCat === 'ini') years = ["Nov 25", "May 25", "Nov 24", "May 24", "Nov 23", "May 23"];
            else years = [2025, 2024, 2023, 2022];

            container.innerHTML = years.map(yr => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid rgba(255,255,255,0.05);">
                    <span style="font-size:12px; font-weight:bold;">${currentPyqCat.toUpperCase()} ${yr}</span>
                    <input type="checkbox" ${catData[yr] ? 'checked' : ''} onchange="togglePyq('${yr}', this.checked)" style="width:18px; height:18px;">
                </div>
            `).join('');
        }

        function togglePyq(yr, val) {
            const data = JSON.parse(localStorage.getItem(KEYS.PYQ) || "{}");
            if(!data[currentPyqCat]) data[currentPyqCat] = {};
            data[currentPyqCat][yr] = val;
            localStorage.setItem(KEYS.PYQ, JSON.stringify(data));
            if(window.syncToCloud) window.syncToCloud();
        }

        /* --- THE HEARTBEAT: SESSION TIMER --- */
        let timerInterval;
        let totalSeconds = 0;
        let isPaused = false;
        let sessionStartTime = null;

        document.getElementById('startBtn').addEventListener('click', function() {
            const sub = document.getElementById('subject').value;
            if(!sub) { alert("Please select a subject first, Doctor."); return; }
            
            const h = parseInt(document.getElementById('studyHr').value) || 0;
            const m = parseInt(document.getElementById('studyMin').value) || 0;
            totalSeconds = (h * 3600) + (m * 60);
            
            if(totalSeconds <= 0) { alert("Set a valid study duration."); return; }

            sessionStartTime = new Date();
            this.style.display = 'none';
            document.getElementById('timer-controls').style.display = 'flex';
            startInterval();
        });

        function startInterval() {
            timerInterval = setInterval(() => {
                if(!isPaused) {
                    if(totalSeconds > 0) {
                        totalSeconds--;
                        updateTimerDisplay();
                    } else {
                        handleTransition();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            document.getElementById('timer-display').innerText = 
                `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('pauseBtn').innerText = isPaused ? "Resume" : "Pause";
            document.getElementById('pauseBtn').style.background = isPaused ? "#2ecc71" : "#f39c12";
        }

        function handleTransition() {
            clearInterval(timerInterval);
            document.getElementById('popup-overlay').style.display = 'flex';
            document.getElementById('mcq-popup').style.display = 'block';
        }
        /* --- SESSION & BREAK LOGIC --- */
        function startBreak() {
            const mcqs = parseInt(document.getElementById('cycleMcqs').value) || 0;
            saveCycleData(mcqs);
            
            document.getElementById('mcq-popup').style.display = 'none';
            document.getElementById('break-popup').style.display = 'block';
            
            // Optional: Start a secondary break timer here if you wish
        }

        function continueNextCycle() {
            document.getElementById('popup-overlay').style.display = 'none';
            document.getElementById('break-popup').style.display = 'none';
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('timer-controls').style.display = 'none';
            document.getElementById('timer-display').innerText = "Ready ‚ö°";
        }

        function stopEntireSession() {
            const mcqs = parseInt(document.getElementById('cycleMcqs').value) || 0;
            saveCycleData(mcqs);
            location.reload(); // Refresh to reset state and update UI
        }

        /* --- DATA PERSISTENCE: LOGS & STREAKS --- */
        function saveCycleData(mcqCount) {
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS) || "[]");
            const today = new Date().toISOString().split('T')[0];
            const sub = document.getElementById('subject').value || "Mixed Bag";
            
            // Calculate elapsed time (minimum 1 min for testing)
            const endTime = new Date();
            const hrs = Math.max(0.1, (endTime - sessionStartTime) / (1000 * 60 * 60));

            const entry = {
                date: today,
                hrs: parseFloat(hrs.toFixed(2)),
                mcqs: mcqCount,
                subject: sub,
                timestamp: Date.now()
            };

            logs.push(entry);
            localStorage.setItem(KEYS.LOGS, JSON.stringify(logs));
            updateStreak();
            if(window.syncToCloud) window.syncToCloud();
        }

        function updateStreak() {
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS) || "[]");
            if (logs.length === 0) return;

            // Group by date
            const dailyStats = {};
            logs.forEach(log => {
                dailyStats[log.date] = (dailyStats[log.date] || 0) + log.mcqs;
            });

            const dates = Object.keys(dailyStats).sort().reverse();
            let streak = 0;
            let streakVol = 0;
            let today = new Date().toISOString().split('T')[0];
            
            // A "Valid Day" for a streak = 50+ MCQs
            for (let i = 0; i < dates.length; i++) {
                if (dailyStats[dates[i]] >= 50) {
                    streak++;
                    streakVol += dailyStats[dates[i]];
                } else {
                    break; 
                }
            }

            document.getElementById('streakText').innerText = `Consistency: ${streak} Days`;
            renderStreakIcons(streak);
            
            // Push to Leaderboard logic
            if(window.pushToLeaderboard) {
                window.pushToLeaderboard({ streak: streak, streakVol: streakVol, neet: 0, ini: 0, fmge: 0, swt: {} });
            }
        }

        function renderStreakIcons(count) {
            const container = document.getElementById('streakIcons');
            const fires = Math.floor(count / 25);
            const medals = Math.floor(count / 75);
            container.innerHTML = "üî•".repeat(fires) + "ü•á".repeat(medals) || "üåë";
        }

        /* --- ANALYTICS: CHART RENDERING --- */
        let hrsChart, mcqChart;
        function renderCharts() {
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS) || "[]");
            const ctxHrs = document.getElementById('hoursChart').getContext('2d');
            const ctxMcq = document.getElementById('mcqChart').getContext('2d');

            // Process last 7 days of data
            const labels = [];
            const hrData = [];
            const mcqData = [];

            for(let i=6; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const ds = d.toISOString().split('T')[0];
                labels.push(ds.split('-').slice(1).join('/'));
                
                const dayLogs = logs.filter(l => l.date === ds);
                hrData.push(dayLogs.reduce((acc, curr) => acc + curr.hrs, 0));
                mcqData.push(dayLogs.reduce((acc, curr) => acc + curr.mcqs, 0));
            }

            if(hrsChart) hrsChart.destroy();
            if(mcqChart) mcqChart.destroy();

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: { 
                    y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#888' } },
                    x: { ticks: { color: '#888' } }
                },
                plugins: { legend: { display: false } }
            };

            hrsChart = new Chart(ctxHrs, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Hours', data: hrData, borderColor: '#5288c1', tension: 0.3, fill: true, backgroundColor: 'rgba(82,136,193,0.1)' }]},
                options: chartOptions
            });

            mcqChart = new Chart(ctxMcq, {
                type: 'bar',
                data: { labels, datasets: [{ label: 'MCQs', data: mcqData, backgroundColor: '#2ecc71', borderRadius: 5 }]},
                options: chartOptions
            });
        }
        /* --- SWT MASTERY MATRIX & PHASE CHARTS --- */
        function renderSWTMatrix() {
            const swtData = JSON.parse(localStorage.getItem(KEYS.SWT) || "[]");
            const body = document.getElementById('swtMatrixBody');
            if(!body) return;

            const summary = {};
            SUBJECTS_19.forEach(s => summary[s] = { total: 0, correct: 0 });

            swtData.forEach(entry => {
                if(summary[entry.subject]) {
                    summary[entry.subject].total += entry.total;
                    summary[entry.subject].correct += entry.correct;
                }
            });

            body.innerHTML = SUBJECTS_19.map(s => {
                const total = summary[s].total;
                const acc = total > 0 ? Math.round((summary[s].correct / total) * 100) : 0;
                let status = "‚ö™";
                if(total > 0) {
                    if(acc >= 80) status = "üü¢";
                    else if(acc >= 60) status = "üü°";
                    else status = "üî¥";
                }
                return `<tr>
                    <td style="text-align:left;">${s}</td>
                    <td>${total}</td>
                    <td style="font-weight:bold; color:${acc >= 60 ? '#2ecc71' : '#ef5350'}">${acc}%</td>
                    <td>${status}</td>
                </tr>`;
            }).join('');
        }

        /* --- GT TREND ANALYTICS --- */
        let gtNeetChart, gtIniChart, gtFmgeChart;
        function renderGTCharts() {
            const neetData = JSON.parse(localStorage.getItem(KEYS.NEET) || "[]");
            const iniData = JSON.parse(localStorage.getItem(KEYS.INI) || "[]");
            const fmgeData = JSON.parse(localStorage.getItem(KEYS.FMGE) || "[]");

            const process = (data) => ({
                labels: data.map(d => d.date.split('-').slice(1).join('/')),
                scores: data.map(d => d.score)
            });

            const n = process(neetData);
            const i = process(iniData);
            const f = process(fmgeData);

            const cfg = (labels, scores, color) => ({
                type: 'line',
                data: { labels, datasets: [{ data: scores, borderColor: color, tension: 0.2, pointRadius: 4, fill: false }] },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: false, grid: { color: 'rgba(255,255,255,0.05)' } } }
                }
            });

            if(gtNeetChart) gtNeetChart.destroy();
            gtNeetChart = new Chart(document.getElementById('gtNeetChart'), cfg(n.labels, n.scores, '#5288c1'));
            
            if(gtIniChart) gtIniChart.destroy();
            gtIniChart = new Chart(document.getElementById('gtIniChart'), cfg(i.labels, i.scores, '#8e44ad'));
            
            if(gtFmgeChart) gtFmgeChart.destroy();
            gtFmgeChart = new Chart(document.getElementById('gtFmgeChart'), cfg(f.labels, f.scores, '#2ecc71'));
        }

        /* --- QUALITATIVE: FACT SALAD SLIDESHOW --- */
        let slideInterval;
        let isSlidePlaying = false;

        function toggleSlideShow() {
            const btn = document.getElementById('slideShowBtn');
            if(isSlidePlaying) {
                clearInterval(slideInterval);
                btn.innerText = "‚èØ Play Slideshow (30s)";
                btn.style.background = "#f39c12";
            } else {
                showRandomFact();
                slideInterval = setInterval(showRandomFact, 30000); // 30 second rotation
                btn.innerText = "‚è∏ Pause Slideshow";
                btn.style.background = "#ef5350";
            }
            isSlidePlaying = !isSlidePlaying;
        }

        function showRandomFact() {
            const facts = JSON.parse(localStorage.getItem(KEYS.FACTS) || "[]");
            const display = document.getElementById('fact-slideshow');
            if(facts.length === 0) {
                display.innerHTML = "Bowl is empty! Add your first fact below.";
                return;
            }
            const rand = facts[Math.floor(Math.random() * facts.length)];
            display.style.opacity = 0;
            setTimeout(() => {
                display.innerHTML = `
                    <div style="font-size:10px; text-transform:uppercase; color:var(--accent); margin-bottom:10px;">${rand.subject}</div>
                    <div style="font-size:16px; font-weight:bold; margin-bottom:15px;">${rand.q}</div>
                    <div id="fact-ans" style="display:none; color:#2ecc71; font-weight:bold; border-top:1px dashed #444; pt-10;">${rand.a}</div>
                    <button class="btn" style="padding:5px 10px; font-size:9px; margin-top:10px;" onclick="document.getElementById('fact-ans').style.display='block'">Show Answer</button>
                `;
                display.style.opacity = 1;
            }, 300);
        }

        function saveFact() {
            const sub = document.getElementById('factSubject').value;
            const q = document.getElementById('factQuestion').value;
            const a = document.getElementById('factAnswer').value;
            if(!q || !a) return;

            const facts = JSON.parse(localStorage.getItem(KEYS.FACTS) || "[]");
            facts.push({ subject: sub, q, a, id: Date.now() });
            localStorage.setItem(KEYS.FACTS, JSON.stringify(facts));
            
            document.getElementById('factQuestion').value = "";
            document.getElementById('factAnswer').value = "";
            alert("Fact tossed into the bowl! ü•ó");
            if(window.syncToCloud) window.syncToCloud();
        }
        /* --- REVISION REPORTS (PDF GENERATION) --- */
        function generatePDF(type) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const today = new Date().toLocaleDateString();
            
            doc.setFont("helvetica", "bold");
            doc.text(`Scalpel Study Squad - ${type.toUpperCase()} REPORT`, 10, 10);
            doc.setFontSize(10);
            doc.text(`Generated on: ${today} | User ID: ${window.userId}`, 10, 16);
            doc.line(10, 18, 200, 18);

            let yPos = 25;

            if(type === 'daily') {
                const facts = JSON.parse(localStorage.getItem(KEYS.FACTS) || "[]");
                doc.text("TODAY'S FACT BOWL", 10, yPos);
                yPos += 7;
                facts.slice(-20).forEach(f => {
                    if(yPos > 280) { doc.addPage(); yPos = 20; }
                    doc.setFont("helvetica", "bold");
                    doc.text(`${f.subject}: ${f.q}`, 12, yPos, { maxWidth: 180 });
                    yPos += 6;
                    doc.setFont("helvetica", "normal");
                    doc.text(`Ans: ${f.a}`, 15, yPos, { maxWidth: 170 });
                    yPos += 10;
                });
            } else {
                const swtM = JSON.parse(localStorage.getItem(KEYS.SWT_MISTAKES) || "[]");
                doc.text("MONTHLY MISTAKE AUTOPSY", 10, yPos);
                yPos += 7;
                swtM.forEach(m => {
                    if(yPos > 270) { doc.addPage(); yPos = 20; }
                    doc.setFont("helvetica", "bold");
                    doc.text(`[${m.subject}] Q: ${m.q}`, 12, yPos, { maxWidth: 180 });
                    yPos += 6;
                    doc.setFont("helvetica", "normal");
                    doc.text(`Correct: ${m.a} | My Error: ${m.wrong}`, 12, yPos);
                    yPos += 5;
                    doc.text(`Reason: ${m.reason}`, 12, yPos, { maxWidth: 180 });
                    yPos += 10;
                });
            }

            doc.save(`SSS_Report_${type}_${today.replace(/\//g,'-')}.pdf`);
        }

        /* --- THEME TOGGLE --- */
        function toggleTheme() {
            const body = document.body;
            const current = body.getAttribute('data-theme');
            const target = current === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', target);
            localStorage.setItem(prefix + 'THEME', target);
        }

        /* --- DATA MIGRATION --- */
        function exportData() {
            const backup = {};
            Object.keys(KEYS).forEach(k => {
                backup[k] = localStorage.getItem(KEYS[k]);
            });
            const code = btoa(JSON.stringify(backup));
            navigator.clipboard.writeText(code);
            alert("Backup Code Copied! Save this in your Telegram Saved Messages.");
        }

        function importData() {
            try {
                const code = document.getElementById('restoreCode').value;
                const data = JSON.parse(atob(code));
                Object.keys(data).forEach(k => {
                    if(data[k]) localStorage.setItem(KEYS[k], data[k]);
                });
                alert("Restoration Successful! Reloading...");
                location.reload();
            } catch(e) {
                alert("Invalid Backup Code.");
            }
        }

        /* --- UI HELPERS --- */
        function toggleAccordion(id, header) {
            const content = document.getElementById(id);
            content.classList.toggle('open');
            header.classList.toggle('active');
        }

        function openPopup(id) {
            document.getElementById('popup-overlay').style.display = 'flex';
            document.getElementById(id).style.display = 'block';
        }

        function closePopup() {
            document.getElementById('popup-overlay').style.display = 'none';
            document.querySelectorAll('.popup-card').forEach(p => p.style.display = 'none');
        }

        /* --- INITIALIZATION --- */
        window.onload = () => {
            // Set Theme
            const savedTheme = localStorage.getItem(prefix + 'THEME');
            if(savedTheme) document.body.setAttribute('data-theme', savedTheme);
            
            // Initialize Systems
            updateCountdowns();
            loadGoalsToUI();
            renderGoalHTML();
            renderPyq();
            updateStreak();
            renderCharts();
            renderSWTMatrix();
            renderGTCharts();
            showRandomFact();

            // Setup Leaderboard Default
            if(typeof window.fetchLeaderboard === 'function') {
                window.fetchLeaderboard('streak');
            }
        };
    </script>
</body>
</html>


