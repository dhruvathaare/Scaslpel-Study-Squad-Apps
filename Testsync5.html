<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scalpel Master Pro V8.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import { getDatabase, ref, set, get, child, update, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAmv7mm6rjaGPNx4IK9LXl3fO61uXxZgCQ",
        authDomain: "scalpel-pro.firebaseapp.com",
        projectId: "scalpel-pro",
        storageBucket: "scalpel-pro.firebasestorage.app",
        messagingSenderId: "244026009766",
        appId: "1:244026009766:web:3299c2dfa37cf378d1ac67"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // Make DB functions globally available for the rest of the code
      window.db = db;
      window.ref = ref;
      window.set = set;
      window.get = get;
      window.child = child;
      window.update = update;
      window.query = query;
      window.orderByChild = orderByChild;
      window.limitToLast = limitToLast;

      const tgUser = window.Telegram.WebApp.initDataUnsafe?.user || { id: "OFFLINE", first_name: "Guest" };
      window.userId = tgUser.id;
      window.userName = tgUser.first_name || "Doctor";
      // --- 1. PERSONAL BACKUP SYNC ---
      window.syncToCloud = function() {
          const dataToSync = {};
          // Added FACTS, SWT_MISTAKES, GT_MISTAKES to the backup list
          const keysToBackup = ['LOGS', 'NEET', 'INI', 'FMGE', 'SWT', 'GOALS', 'PYQ', 'TOUGH', 'FACTS', 'SWT_MISTAKES', 'GT_MISTAKES'];
          
          keysToBackup.forEach(key => {
              const prefix = `SSS_PRO_V3_${window.userId}_`;
              const localVal = localStorage.getItem(prefix + key);
              if (localVal) dataToSync[key] = JSON.parse(localVal);
          });

          if (window.userId !== "OFFLINE") {
              const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
              const statusEl = document.getElementById('cloud-sync-status');
              if(statusEl) statusEl.innerText = "Syncing...";

              window.set(window.ref(window.db, 'users/' + window.userId), dataToSync)
              .then(() => {
                  console.log("Auto-Sync Successful: " + now);
                  if(statusEl) {
                      statusEl.innerText = "Cloud: Online " + now + " ‚úÖ";
                      statusEl.style.color = "#2ecc71";
                  }
                  // Trigger Leaderboard Update after successful backup
                  if(typeof window.calculateAndPushLeaderboard === 'function') {
                      window.calculateAndPushLeaderboard();
                  }
              })
              .catch((error) => {
                  console.error("Cloud Sync Failed", error);
                  if(statusEl) {
                      statusEl.innerText = "Sync Failed (Offline)";
                      statusEl.style.color = "#ef5350";
                  }
              });
          }
      };

      // --- 2. LEADERBOARD WRITE FUNCTION ---
      window.pushToLeaderboard = function(stats) {
          if (window.userId === "OFFLINE") return;
          
          const updates = {};
          if(stats.streak > 0) updates['/leaderboard/streak/' + window.userId] = { name: window.userName, score: stats.streak, vol: stats.streakVol };
          
          if(stats.neet > 0) updates['/leaderboard/neet/' + window.userId] = { name: window.userName, score: stats.neet };
          if(stats.ini > 0) updates['/leaderboard/ini/' + window.userId] = { name: window.userName, score: stats.ini };
          if(stats.fmge > 0) updates['/leaderboard/fmge/' + window.userId] = { name: window.userName, score: stats.fmge };

          Object.keys(stats.swt).forEach(sub => {
              if(stats.swt[sub] > 0) {
                  updates[`/leaderboard/swt/${sub}/${window.userId}`] = { name: window.userName, accuracy: stats.swt[sub] };
              }
          });

          window.update(window.ref(window.db), updates).catch(e => console.error("LB Update Error", e));
      };

      // --- 3. LEADERBOARD READ FUNCTION ---
      window.fetchLeaderboard = function(category, subject) {
          let path = `leaderboard/${category}`;
          if (category === 'swt' && subject) path += `/${subject}`;
          
          const qKey = category === 'swt' ? 'accuracy' : 'score';
          const lbQuery = window.query(window.ref(window.db, path), window.orderByChild(qKey), window.limitToLast(50));
          
          window.get(lbQuery).then((snapshot) => {
              if (snapshot.exists()) {
                  const data = [];
                  snapshot.forEach((child) => { data.push(child.val()); });
                  if(typeof window.renderLeaderboardUI === 'function') {
                      window.renderLeaderboardUI(data.reverse(), category);
                  }
              } else {
                  if(typeof window.renderLeaderboardUI === 'function') window.renderLeaderboardUI([], category);
              }
          }).catch((error) => console.error(error));
      };

      // --- 4. PULL FUNCTION ---
      window.pullFromCloud = function() {
          if (window.userId === "OFFLINE") return;
          const dbRef = window.ref(window.db);
          window.get(window.child(dbRef, `users/${window.userId}`)).then((snapshot) => {
              if (snapshot.exists()) {
                  const cloudData = snapshot.val();
                  const prefix = `SSS_PRO_V3_${window.userId}_`;
                  Object.keys(cloudData).forEach(key => {
                      localStorage.setItem(prefix + key, JSON.stringify(cloudData[key]));
                  });
                  console.log("Data Restored from Cloud");
                  if(typeof updateUI === 'function') updateUI();
              }
          }).catch((error) => console.error(error));
      };

      window.pullFromCloud();
      setTimeout(() => { window.syncToCloud(); }, 3000); 
      setInterval(() => { window.syncToCloud(); }, 600000);
    </script>
    <style>
        /* CSS VARIABLES */
        :root { 
            --bg: #0e1621; 
            --card: #17212b; 
            --text: #ffffff; 
            --border: #2b5278; 
            --accent: #5288c1; 
            --input-bg: #0e1621; 
            --chart-text: #ffffff;
            --chart-grid: #aaaaaa;
            --instruction-bg: rgba(255,255,255,0.05);
            --tab-blue: #2481cc;
            --tab-blue-dark: #1a5c96;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --bronze: #cd7f32;
        }
        [data-theme="light"] {
            --bg: #f2f2f7; 
            --card: #ffffff; 
            --text: #000000; 
            --border: #d1d1d6; 
            --accent: #007aff; 
            --input-bg: #ffffff;
            --chart-text: #000000;
            --chart-grid: #555555;
            --instruction-bg: rgba(0,0,0,0.05);
        }

        html, body { height: 100%; margin: 0; padding: 0; background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s; }
        
        body { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            padding: 15px; 
            /* Added padding-bottom to prevent content from being hidden behind new bottom tabs */
            padding-bottom: 90px;
            box-sizing: border-box; 
            overflow-y: auto !important; 
            -webkit-overflow-scrolling: touch;
            min-height: 100vh;
        }
        
        /* CONTAINER & LANDSCAPE LOGIC */
        .container { width: 100%; max-width: 420px; display: flex; flex-direction: column; align-items: center; text-align: center; transition: max-width 0.3s ease; }
        
        @media (orientation: landscape) {
            .container { max-width: 95%; } 
            .card { width: 100%; padding: 20px; }
            .chart-container { height: 320px; } 
            .matrix-table th, .matrix-table td { white-space: normal; font-size: 11px; }
            body { font-size: 16px; }
            h1 { font-size: 28px !important; }
            .btn { font-size: 16px !important; padding: 18px !important; }
            .streak-text { font-size: 26px !important; }
            .quote { font-size: 16px !important; }
            
            .logo { width: 130px !important; height: 130px !important; border-width: 6px !important; }

            /* Desk Clock Mode */
            #study-timer-card {
                min-height: 85vh; 
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                border: 2px solid var(--accent);
                box-shadow: 0 0 30px rgba(0,0,0,0.5);
            }

            #timer-display {
                font-size: 16vh !important; 
                margin: 20px 0 !important;
                text-shadow: 0 0 20px rgba(82,136,193,0.3);
            }

            #study-timer-card input, 
            #study-timer-card select,
            #study-timer-card .btn {
                font-size: 18px !important;
                padding: 15px !important;
            }
        }
        .header-ui { width: 100%; display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .user-badge { background: rgba(82, 136, 193, 0.2); border: 1px solid var(--accent); padding: 8px 12px; border-radius: 15px; font-size: 11px; color: var(--accent); font-weight: bold; text-align: right; line-height: 1.3; }
        .user-badge span { display: block; }
        .user-id-tag { opacity: 0.7; font-size: 9px; font-family: monospace; }
        
        .status-dot { height: 6px; width: 6px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .status-online { background-color: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .status-offline { background-color: #f39c12; box-shadow: 0 0 5px #f39c12; }

        .logo { width: 85px; height: 85px; border-radius: 50%; border: 4px solid var(--accent); margin-bottom: 10px; box-shadow: 0 0 15px rgba(82,136,193,0.3); transition: all 0.3s; }
        h1 { color: var(--accent); font-size: 22px; margin: 5px 0; font-weight: bold; text-transform: uppercase; }
        
        .exam-dashboard { background: rgba(82, 136, 193, 0.15); border: 1px solid var(--accent); padding: 12px; border-radius: 15px; width: 100%; margin-bottom: 15px; box-sizing: border-box; }
        .exam-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .exam-item { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 10px; border: 1px solid rgba(82, 136, 193, 0.3); transition: all 0.3s ease; }
        [data-theme="light"] .exam-item { background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.1); }
        .exam-item.target-locked { border: 1px solid #2ecc71; background: rgba(46, 204, 113, 0.2); box-shadow: 0 0 10px rgba(46, 204, 113, 0.3); transform: scale(1.02); }

        .exam-days { font-size: 16px; font-weight: bold; color: var(--accent); display: block; }
        @media (orientation: landscape) { .exam-days { font-size: 20px; } }
        .exam-item.target-locked .exam-days { color: #2ecc71; } 
        
        .exam-label { font-size: 11px; font-weight: 900; text-transform: uppercase; opacity: 1; letter-spacing: 0.5px; margin-top: 2px; display: block; color: var(--text); }
        .streak-section { margin-bottom: 15px; width: 100%; text-align: center; padding: 5px; }
        .streak-text { font-size: 22px; font-weight: 800; color: #f39c12; display: block; }
        .streak-icons-div { font-size: 24px; margin: 5px 0; }
        .quote { font-family: 'Oswald', sans-serif; color: #ef5350; font-weight: 700; font-size: 14px; text-transform: uppercase; margin: 5px 0 20px 0; line-height: 1.4; text-align: center; width: 100%; }
        #timer-display { font-size: 60px; font-weight: bold; margin: 10px 0; font-variant-numeric: tabular-nums; letter-spacing: 2px; }
        .btn { background: #2481cc; color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; font-size: 14px; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .sm-btn { padding: 8px 12px; font-size: 11px; border-radius: 8px; }
        .log-table { width: 100%; font-size: 11px; text-align: left; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        .log-table th, .log-table td { padding: 10px 5px; border-bottom: 1px solid rgba(128,128,128,0.2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .col-date { width: 23%; } .col-hrs { width: 15%; } .col-cyc { width: 12%; } .col-mcq { width: 15%; } .col-sub { width: 35%; }

        .goal-row { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(128,128,128,0.1); }
        .phase-block { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border); transition: all 0.3s; }
        [data-theme="light"] .phase-block { background: rgba(0,0,0,0.05); }
        .phase-block.completed { border-color: #2ecc71; background: rgba(46, 204, 113, 0.1); box-shadow: 0 0 15px rgba(46, 204, 113, 0.2); }
        .phase-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .phase-title { font-size: 13px; font-weight: bold; color: var(--accent); }
        .phase-badge { font-size: 24px; filter: grayscale(100%); opacity: 0.3; transition: all 0.5s; }
        .phase-badge.unlocked { filter: grayscale(0%); opacity: 1; transform: scale(1.3); text-shadow: 0 0 10px gold; }
        
        .sub-grid-container { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: rgba(0,0,0,0.2); border-radius: 8px; margin-top: 5px; }
        [data-theme="light"] .sub-grid-container { background: rgba(0,0,0,0.05); }
        .sub-grid-container.open { max-height: 500px; padding: 8px; overflow-y: auto; }
        .sub-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; text-align: left; }
        .sub-check-item { display: flex; align-items: center; gap: 5px; font-size: 12px; color: var(--text); opacity: 0.8; padding: 5px; }
        
        /* Accordion CSS (Missing from previous version, restored for Goal tab) */
        .accordion-header { background: rgba(82, 136, 193, 0.1); padding: 12px; border-radius: 10px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid transparent; }
        .accordion-header h3 { font-size: 14px; margin: 0; color: var(--text); text-transform: uppercase; }
        .accordion-header.active { border-color: var(--accent); background: rgba(82, 136, 193, 0.2); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .accordion-content.open { max-height: 1200px; padding: 10px 0; overflow: visible; }
        .arrow { font-size: 10px; transition: transform 0.3s; }
        .accordion-header.active .arrow { transform: rotate(180deg); }
        .pyq-nav-container { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid rgba(128,128,128,0.2); padding-top: 15px; }
        .pyq-tab { background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: #888; padding: 10px 14px; font-size: 11px; border-radius: 8px; cursor: pointer; white-space: nowrap; flex: 1; text-align: center; position: relative; overflow: visible; font-weight: bold; }
        [data-theme="light"] .pyq-tab { background: rgba(0,0,0,0.05); }
        .pyq-tab.active { background: var(--accent); color: white; border-color: var(--accent); font-weight: bold; }
        .pyq-tab-cup { display: none; position: absolute; top: -12px; right: -5px; font-size: 18px; text-shadow: 0 0 10px gold; z-index: 100; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .pyq-tab-cup.show { display: block; }
        .pyq-panel { display: none; animation: fadeIn 0.3s; }
        .pyq-panel.active { display: block; }
        .pyq-list-row { display: flex; align-items: center; justify-content: space-between; background: rgba(128,128,128,0.1); margin-bottom: 5px; padding: 8px; border-radius: 6px; }
        .pyq-col-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .pyq-col-header { font-size: 11px; color: #5288c1; text-transform: uppercase; font-weight: bold; margin-bottom: 8px; border-bottom: 1px dashed rgba(128,128,128,0.3); padding-bottom: 4px; }
        
        .matrix-table { width: 100%; font-size: 10px; border-collapse: collapse; margin-top: 15px; }
        .matrix-table th, .matrix-table td { border: 1px solid rgba(128,128,128,0.2); padding: 6px; text-align: center; }
        .matrix-table th { background: rgba(82, 136, 193, 0.2); color: var(--text); font-weight: bold;}
        .matrix-row-head { text-align: left !important; font-weight: bold; background: rgba(0,0,0,0.2); }
        [data-theme="light"] .matrix-row-head { background: rgba(0,0,0,0.05); }
        .matrix-total { font-weight: bold; color: #f39c12; background: rgba(243, 156, 18, 0.1); }

        .calc-preview { background: rgba(82, 136, 193, 0.1); padding: 10px; border-radius: 10px; margin-top: 8px; font-size: 12px; border: 1px dashed var(--accent); display: flex; justify-content: space-around; align-items: center; font-weight: bold; }
        .chart-container { width: 100%; height: 200px; margin: 15px 0; position: relative; }
        .month-navigator { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 10px; padding: 8px; background: rgba(82, 136, 193, 0.1); border-radius: 10px; border: 1px solid var(--border); box-sizing: border-box;}
        .month-nav-btn { background: var(--accent); color: white; border: none; padding: 6px 14px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .month-display { font-family: 'Oswald', sans-serif; font-size: 16px; color: var(--accent); text-transform: uppercase; }

        #popup-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.96); z-index:2000; justify-content:center; align-items:center; flex-direction: column;}
        .popup-card { background: var(--card); padding: 25px; border-radius: 20px; border: 2px solid var(--accent); width: 85%; max-width: 320px; text-align: center; overflow-y: auto; max-height: 80vh; color: var(--text); display: none;}
        
        .danger-zone { margin-top: 30px; padding: 15px; border-top: 1px dashed rgba(128,128,128,0.3); width: 100%; opacity: 0.9; }
        .clear-btn { background: none; border: 1px solid #ef5350; color: #ef5350; padding: 10px; border-radius: 8px; font-size: 12px; cursor: pointer; width: 100%; font-weight: bold; }
        .backup-btn { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 12px; width: 100%; font-weight: bold; margin-bottom: 8px; cursor: pointer;}
        .restore-btn { background: #2ecc71; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 12px; width: 100%; font-weight: bold; cursor: pointer;}
        .strong-weak-container { display: flex; flex-direction: column; gap: 8px; margin: 15px 0; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 10px; text-align: left; }
        [data-theme="light"] .strong-weak-container { background: rgba(0,0,0,0.05); }
        .performance-label { font-family: 'Oswald', sans-serif; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; justify-content: space-between; align-items: center;}
        .stat-strong { color: #2ecc71; } .stat-weak { color: #ef5350; }
        .usage-box { margin-top: 15px; padding: 12px; border-radius: 10px; text-align: left; font-size: 11px; line-height: 1.4; border: 1px solid; margin-bottom: 10px; }
        .caution-box { background: rgba(243, 156, 18, 0.15); border-color: #f39c12; color: #f39c12; }
        .freq-box { background: rgba(255, 255, 255, 0.05); border-color: var(--border); color: var(--text); }
        [data-theme="light"] .freq-box { background: rgba(0,0,0,0.05); }
        .usage-title { font-weight: bold; display: block; margin-bottom: 5px; text-transform: uppercase; opacity: 0.9; font-size: 10px; }
        
        .gt-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; text-align: left; font-size: 10px; }
        .gt-stat-box { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px; }
        [data-theme="light"] .gt-stat-box { background: rgba(0,0,0,0.05); }
        .gt-stat-header { opacity: 0.7; margin-bottom: 4px; display: block; text-transform: uppercase; font-size: 9px; }
        .gt-stat-val { font-weight: bold; font-size: 13px; }
        .val-high { color: #2ecc71; } .val-low { color: #ef5350; }
        .phase-stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(128,128,128,0.2); padding: 3px 0; }

        .goal-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0; }
        .goal-input-box { background: rgba(255,255,255,0.05); padding: 6px; border-radius: 6px; text-align: center; position: relative; }
        [data-theme="light"] .goal-input-box { background: rgba(0,0,0,0.05); }
        .goal-input-box input { width: 70%; padding: 4px; font-size: 12px; margin-top: 2px; display: inline-block; }
        .goal-display-box { background: rgba(0,0,0,0.3); padding: 6px; border-radius: 6px; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        [data-theme="light"] .goal-display-box { background: rgba(0,0,0,0.05); }
        .goal-val { font-weight: bold; font-size: 16px; color: var(--accent); }
        .mini-lock-btn { background: none; border: 1px solid var(--border); color: #888; border-radius: 4px; cursor: pointer; padding: 2px 5px; font-size: 10px; position: absolute; right: 4px; top: 18px; }
        .mini-lock-btn.locked { border-color: #2ecc71; color: #2ecc71; pointer-events: none; }
        .save-sub-btn { background: #27ae60; color: white; border: none; padding: 12px; width: 100%; margin-top: 10px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; }

        .subject-breakdown-row { display: grid; grid-template-columns: 1fr 50px 50px 50px; gap: 5px; align-items: center; margin-bottom: 5px; font-size: 10px; }
        .subject-breakdown-header { font-weight: bold; color: var(--accent); margin-bottom: 8px; font-size: 11px; }
        .sb-input { padding: 6px !important; font-size: 11px !important; }

        .instruction-box { background: var(--instruction-bg); padding: 10px; border-radius: 8px; margin-top: 15px; font-size: 11px; color: #888; text-align: left; line-height: 1.5; border-left: 3px solid var(--accent); }
        .tough-dash-title { font-size: 20px; font-weight: 900; color: #ef5350; text-transform: uppercase; margin: 0 0 10px 0; text-align: center; letter-spacing: 1px; }
        .alert-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; margin-bottom: 5px; border-radius: 12px; font-size: 12px; font-weight: bold; border: 1px solid transparent; }
        .alert-item span.days { opacity: 0.9; font-size: 11px; }
        .alert-safe { background: rgba(46, 204, 113, 0.1); color: #2ecc71; border-color: #2ecc71; }
        .alert-yellow { background: rgba(241, 196, 15, 0.1); color: #f1c40f; border-color: #f1c40f; }
        .alert-orange { background: rgba(230, 126, 34, 0.1); color: #e67e22; border-color: #e67e22; }
        .alert-red { background: rgba(231, 76, 60, 0.1); color: #e74c3c; border-color: #e74c3c; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); } 70% { box-shadow: 0 0 0 5px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }

        .chart-scroller { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 15px; border: 1px solid rgba(128,128,128,0.2); border-radius: 10px; background: rgba(0,0,0,0.1); }
        .chart-scroll-content { height: 250px; position: relative; }

        /* --- NEW: MAIN SECTION DOCK (QUANT vs QUAL) --- */
        .main-nav-dock { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 10px 0; z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.3); }
        .main-nav-btn { background: transparent; border: none; color: #888; font-size: 10px; font-weight: bold; text-transform: uppercase; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; flex: 1; transition: all 0.2s; }
        .main-nav-btn span { font-size: 18px; }
        .main-nav-btn.active { color: var(--accent); transform: translateY(-2px); }
        
        .section-container { display: none; width: 100%; animation: fadeIn 0.3s ease; }
        .section-container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* QUALITATIVE CARDS */
        .qual-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .qual-input-group { margin-bottom: 12px; text-align: left; }
        .qual-input-group label { display: block; font-size: 10px; color: var(--accent); font-weight: bold; margin-bottom: 4px; text-transform: uppercase; }
        .qual-input-group textarea { width: 100%; background: var(--input-bg); color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 8px; font-size: 12px; resize: vertical; min-height: 60px; font-family: inherit; }
        .slide-container { min-height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 15px; border: 1px dashed var(--accent); border-radius: 10px; margin-bottom: 15px; background: rgba(82, 136, 193, 0.1); animation: fadeSlide 0.5s; }
        @keyframes fadeSlide { from { opacity: 0; } to { opacity: 1; } }

        /* --- RESTORED: QUALITATIVE TABS CENTERING (Portrait & Landscape) --- */
        #section-qual .nav-tabs {
            display: flex;
            justify-content: center; /* Center horizontally */
            width: 100%;
            margin-bottom: 15px;
            gap: 10px; /* Spacing between tabs */
        }
        
        #section-qual .nav-tabs .tab-btn {
            flex: 0 1 auto; /* Don't stretch, just fit content or fixed width if needed */
            min-width: 100px; /* Minimum width for touch targets */
            text-align: center;
        }

    </style>
</head>
<body>
    <div id="popup-overlay">
        <div class="popup-card" id="mcq-popup">
            <h3>Cycle Complete</h3>
            <p>Enter MCQs solved:</p>
            <input type="number" id="cycleMcqs" placeholder="0" style="width:100%;">
            <button class="btn" onclick="startBreak()" style="margin-top:15px; width:100%;">Record & Start Break</button>
        </div>

        <div class="popup-card" id="break-popup">
            <h3>Break Finished!</h3>
            <button class="btn" onclick="continueNextCycle()" style="background:#2ecc71; width:100%;">Start Next Cycle</button>
            <button class="btn" onclick="stopEntireSession()" style="background:#ef5350; margin-top:10px; width:100%;">End Session</button>
        </div>

        <div class="popup-card" id="restore-popup">
            <h3>Restore Data</h3>
            <p style="font-size:11px; color:#aaa; margin-bottom:10px;">Paste the code from your Saved Messages:</p>
            <textarea id="restoreInput" style="width:100%; height:80px; background:var(--input-bg); color:var(--text); border:1px solid var(--border); border-radius:8px; padding:5px; font-size:10px;"></textarea>
            <button class="btn" onclick="processRestore()" style="background:#2ecc71; margin-top:10px; width:100%;">Import Data</button>
            <button class="btn" onclick="closePopup()" style="background:transparent; border:1px solid #888; color:#888; margin-top:5px; width:100%;">Cancel</button>
        </div>

        <div class="popup-card" id="gt-breakdown-popup" style="width: 95%; max-width: 400px;">
            <h3>GT Subject Breakdown</h3>
            <p style="font-size: 10px; color: #888;">Enter Total Qs, Correct, Unattempted per subject.</p>
            <div class="subject-breakdown-row subject-breakdown-header">
                <span>Subject</span><span>Tot</span><span>C</span><span>U</span>
            </div>
            <div id="gt-subject-inputs" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>
            <button class="btn" onclick="finalizeGTSave()" style="background:#2ecc71; width:100%;">Finalize & Save</button>
            <button class="btn" onclick="closePopup()" style="background:transparent; border:1px solid #888; color:#888; margin-top:5px; width:100%;">Cancel</button>
        </div>
    </div>

    <div class="container">
        <div class="header-ui">
            <div class="user-badge">
                <span id="uFullName">...</span>
                <span id="cloud-sync-status" style="font-size: 8px; display: block; opacity: 0.8; color: #f39c12;">Cloud: Initializing...</span>
                <div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;">
                    <span id="statusDot" class="status-dot"></span>
                    <span id="uID" class="user-id-tag">ID: 0</span>
                </div>
            </div>
        </div>
        <img src="https://github.com/dhruvathaare/Scaslpel-Study-Squad-Apps/blob/main/photo_2026-02-12_20-08-36.jpg?raw=true" class="logo">
        <h1>Scalpel Study Squad</h1>
        
        <div class="streak-section">
            <div id="streakText" class="streak-text">Consistency: 0 Days</div>
            <div id="streakIcons" class="streak-icons-div"></div>
            <div style="font-size:11px; color:#888;">üî• per 25 days | ü•á per 75 days</div>
        </div>
        
        <div class="quote">"I AM HERE TO WIN, CONSISTENCY IS MY KITH AND KIN"</div>

        <div class="exam-dashboard">
            <div class="exam-grid">
                <div class="exam-item" id="dash_ini_jul"><span id="daysIniJuly" class="exam-days">--</span><span class="exam-label">INICET JULY</span></div>
                <div class="exam-item" id="dash_upsc"><span id="daysUpsc" class="exam-days">--</span><span class="exam-label">UPSC CMS</span></div>
                <div class="exam-item" id="dash_neet"><span id="daysNeet" class="exam-days">--</span><span class="exam-label">NEET PG 2026</span></div>
                <div class="exam-item" id="dash_ini_jan"><span id="daysIniJan" class="exam-days">--</span><span class="exam-label">INICET JAN '27</span></div>
                <div class="exam-item" id="dash_fmge_jun"><span id="daysFmgeJun" class="exam-days">--</span><span class="exam-label">FMGE JUNE '26</span></div>
                <div class="exam-item" id="dash_fmge_dec"><span id="daysFmgeDec" class="exam-days">--</span><span class="exam-label">FMGE DEC '26</span></div>
            </div>
        </div>
        <div id="section-quant" class="section-container active">
            
            <div class="nav-tabs">
                <button class="tab-btn theme-toggle-tab" onclick="toggleTheme()">
                    <span style="font-size:16px; display:block; margin-bottom:2px;">üåó</span>
                    <span style="font-size:9px; opacity:0.8;">THEME</span>
                </button>
                <div class="tab-btn" onclick="switchTab('tab-goal', this)">
                    <span style="font-size:16px; display:block;">üéØ</span>Goal
                </div>
                <div class="tab-btn active" onclick="switchTab('tab-daily', this)">
                    <span style="font-size:16px; display:block;">üìä</span>Daily
                </div>
                <div class="tab-btn" onclick="switchTab('tab-swt', this)">
                    <span style="font-size:16px; display:block;">üß†</span>SWT
                </div>
                <div class="tab-btn" onclick="switchTab('tab-gt', this)">
                    <span style="font-size:16px; display:block;">üìà</span>GT
                </div>
                <div class="tab-btn" onclick="switchTab('tab-rank', this)">
                    <span style="font-size:16px; display:block;">üèÜ</span>Rankings
                </div>
            </div>
            <div id="tab-goal" class="tab-content">
                <div class="card">
                    <div class="accordion-header" onclick="toggleAccordion('acc_exams', this)">
                        <h3>My Target Exams</h3>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div id="acc_exams" class="accordion-content">
                        <div class="goal-row"><span>INICET July</span><input type="checkbox" id="goal_ini_jul" onchange="saveGoals()"></div>
                        <div class="goal-row"><span>UPSC CMS</span><input type="checkbox" id="goal_upsc" onchange="saveGoals()"></div>
                        <div class="goal-row"><span>NEET PG 2026</span><input type="checkbox" id="goal_neet" onchange="saveGoals()"></div>
                        <div class="goal-row"><span>INICET Jan '27</span><input type="checkbox" id="goal_ini_jan" onchange="saveGoals()"></div>
                        <div class="goal-row"><span>FMGE JUNE '26</span><input type="checkbox" id="goal_fmge_jun" onchange="saveGoals()"></div>
                        <div class="goal-row"><span>FMGE DEC '26</span><input type="checkbox" id="goal_fmge_dec" onchange="saveGoals()"></div>
                        <button class="btn sm-btn" style="width:100%; margin-top:10px; background:var(--accent); font-weight:bold; font-size:12px; padding:12px;" onclick="lockExamGoals()">Lock & Let's Go!</button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="accordion-header" onclick="toggleAccordion('acc_tough', this)">
                        <h3>My Tough Subjects</h3>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div id="acc_tough" class="accordion-content">
                        <div style="font-size:12px; color:#888; margin-bottom:10px;">Select subjects you want to monitor closely:</div>
                        <div id="tough-subject-selector" class="sub-grid">
                            </div>
                    </div>
                </div>

                <div class="card">
                    <div class="accordion-header" onclick="toggleAccordion('acc_pyq', this)">
                        <h3>PYQ PAPERS GOAL</h3>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div id="acc_pyq" class="accordion-content">
                        <div class="pyq-nav-container">
                            <div class="pyq-tab active" onclick="switchPyq('neet', this)">NEET PG<span id="cup_neet" class="pyq-tab-cup">üèÜ</span></div>
                            <div class="pyq-tab" onclick="switchPyq('ini', this)">INICET<span id="cup_ini" class="pyq-tab-cup">üèÜ</span></div>
                            <div class="pyq-tab" onclick="switchPyq('fmge', this)">FMGE<span id="cup_fmge" class="pyq-tab-cup">üèÜ</span></div>
                            <div class="pyq-tab" onclick="switchPyq('upsc', this)">UPSC<span id="cup_upsc" class="pyq-tab-cup">üèÜ</span></div>
                        </div>
                        <div id="pyq-panels-root"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="accordion-header" onclick="toggleAccordion('acc_monthly', this)">
                        <h3>Monthly Goals Reached</h3>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div id="acc_monthly" class="accordion-content">
                        <div style="overflow-x:auto;">
                            <table class="matrix-table">
                                <thead><tr><th>Month</th><th>MCQs</th><th>SWTs</th><th>GTs</th></tr></thead>
                                <tbody id="monthlyGoalBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="accordion-header" onclick="toggleAccordion('acc_phases', this)">
                        <h3>Reading Phases</h3>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div id="acc_phases" class="accordion-content">
                        <div id="goal-phases-container"></div>
                        <div class="instruction-box">
                            <strong>How to use Phases:</strong><br>
                            1. Define start/end dates for each reading.<br>
                            2. Set numerical targets for SWTs and GTs.<br>
                            3. Check off subjects as you complete them.<br>
                            4. Click "Lock" to save your goal.<br>
                            Achieve all targets + all subjects to unlock the trophy!
                        </div>
                    </div>
                </div>
            </div>
            <div id="tab-daily" class="tab-content active">
                <div id="tough-dashboard" style="width:100%; margin-bottom:15px;"></div>

                <div class="card" id="study-timer-card">
                    <span class="setting-label">Reading Phase</span>
                    <select id="studyPhase">
                        <option value="First Reading">First Reading</option>
                        <option value="Second Reading">Second Reading</option>
                        <option value="Third Reading">Third Reading</option>
                        <option value="Extra Bonus">Extra Bonus Reading</option>
                    </select>

                    <span class="setting-label">Subject</span>
                    <select id="subject">
                        <option value="" disabled selected>Select Subject</option>
                        <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option>
                        <option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option><option>Mixed Bag</option><option>Integrated Systems</option>
                    </select>
                    
                    <div class="clock-row" style="display:flex; gap:10px; margin-top:8px; text-align:center;">
                        <div style="flex:2;">
                            <span class="setting-label" style="text-align:center;">Study Duration</span>
                            <div style="display:flex; gap:5px;">
                                <div style="flex:1;"><input type="number" id="studyHr" value="2"><div class="sub-label">Hours</div></div>
                                <div style="flex:1;"><input type="number" id="studyMin" value="0"><div class="sub-label">Minutes</div></div>
                            </div>
                        </div>
                        <div style="flex:1;">
                            <span class="setting-label" style="text-align:center;">Break</span>
                            <input type="number" id="breakTime" value="15"><div class="sub-label">Minutes</div>
                        </div>
                    </div>

                    <div id="timer-display">00:00:00</div>
                    <button id="startBtn" class="btn" style="width:100%;">Start Session</button>
                    <div id="timer-controls" style="display:none; width:100%;">
                        <div style="display:flex; gap:8px;"><button id="pauseBtn" class="btn" style="background:#f39c12;flex:1;" onclick="togglePause()">Pause</button><button class="btn" style="background:#8e44ad;flex:1;" onclick="handleTransition()">Skip</button></div>
                        <button class="btn" style="background:#ef5350; margin-top:12px; width:100%;" onclick="stopEntireSession()">End Session</button>
                    </div>
                </div>
                <div class="card">
                    <div class="month-navigator">
                        <button class="month-nav-btn" onclick="changeViewMonth(-1)">‚óÄ</button>
                        <div class="month-display" id="currentViewMonthDisplay">MONTH YEAR</div>
                        <button class="month-nav-btn" onclick="changeViewMonth(1)">‚ñ∂</button>
                    </div>

                    <h3 style="margin:0; color:#f39c12; font-size:16px;">Study Hours Trends</h3>
                    <div class="chart-container"><canvas id="hoursChart"></canvas></div>
                    <h3 style="margin:10px 0 0 0; color:#5288c1; font-size:16px;">MCQs Solved Trends</h3>
                    <div class="chart-container"><canvas id="mcqChart"></canvas></div>
                    
                    <div style="overflow-x: auto; width: 100%; margin-top: 15px;">
                        <table class="log-table">
                            <thead><tr><th class="col-date">Date</th><th class="col-hrs">Hrs</th><th class="col-cyc">Cyc</th><th class="col-mcq">MCQ</th><th class="col-sub">Subjects</th></tr></thead>
                            <tbody id="dailyLogBody"></tbody>
                        </table>
                    </div>

                    <h3 style="margin:15px 0 5px 0; color:var(--accent); font-size:14px; border-top:1px solid rgba(128,128,128,0.2); padding-top:10px;">Phase Matrix (Days Spent)</h3>
                    <div style="overflow-x:auto;"><table class="matrix-table"><thead><tr><th style="text-align:left;">Subject</th><th>1st</th><th>2nd</th><th>3rd</th><th>Bonus</th></tr></thead><tbody id="matrixBody"></tbody></table></div>

                    <h3 style="margin:15px 0 5px 0; color:#2ecc71; font-size:14px; border-top:1px solid rgba(128,128,128,0.2); padding-top:10px;">Phase Matrix (MCQs Solved)</h3>
                    <div style="overflow-x:auto;"><table class="matrix-table"><thead><tr><th style="text-align:left;">Subject</th><th>1st</th><th>2nd</th><th>3rd</th><th>Bonus</th></tr></thead><tbody id="mcqMatrixBody"></tbody></table></div>
                </div>
            </div>
            <div id="tab-swt" class="tab-content">
                <div class="card">
                    <h3>SWT Analytics</h3>
                    <span class="setting-label">Reading Phase</span>
                    <select id="swtPhase">
                        <option value="First Reading">First Reading</option>
                        <option value="Second Reading">Second Reading</option>
                        <option value="Third Reading">Third Reading</option>
                        <option value="Extra Bonus">Extra Bonus Reading</option>
                    </select>

                    <span class="setting-label">Subject</span>
                    <select id="swtSubject" onchange="renderSWT()">
                        <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option><option>Mixed Bag</option><option>Integrated Systems</option>
                    </select>
                    <div style="display:flex; gap:5px; margin-top:8px;"><div style="flex:1.5;"><span class="setting-label">Date</span><input type="date" id="swtDate"><span style="font-size:9px; color:#888;">(Today or Past)</span></div><div style="flex:1;"><span class="setting-label">Total Qs</span><input type="number" id="swtTotal" oninput="calcSWT()"></div></div>
                    <div style="display:flex; gap:5px; margin-top:5px;"><div style="flex:1;"><span class="setting-label">Correct</span><input type="number" id="swtCorrect" oninput="calcSWT()"></div><div style="flex:1;"><span class="setting-label">Unattempted</span><input type="number" id="swtUnat" oninput="calcSWT()"></div></div>
                    <div class="calc-preview"><span>Wrong: <b id="swtW">0</b></span><span>Accuracy: <b id="swtP">0%</b></span></div>
                    <button class="btn" onclick="saveSWT()" style="background:var(--accent); margin-top:10px; width:100%;">Save Result</button>
                    
                    <h4 style="margin: 20px 0 5px 0; font-size: 14px; font-weight: bold; opacity: 1;">Subject Trend</h4>
                    <div class="chart-container"><canvas id="swtChart"></canvas></div>
                    
                    <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #3498db; text-transform: uppercase;">SWTs Taken per Phase</h4>
                    <div class="chart-container"><canvas id="swtPhaseCountChart"></canvas></div>

                    <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #9b59b6; text-transform: uppercase;">Average % per Phase</h4>
                    <div class="chart-container"><canvas id="swtPhaseAvgChart"></canvas></div>

                    <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #f39c12; text-transform: uppercase;">Cumulative Performance (All Subjects)</h4>
                    <div class="chart-container"><canvas id="swtCumulativeChart"></canvas></div>

                    <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #2ecc71; text-transform: uppercase;">Total Questions Solved (All Subjects)</h4>
                    <div class="chart-container"><canvas id="swtQuestionsChart"></canvas></div>

                    <div class="strong-weak-container">
                        <div class="performance-label stat-strong">
                            <span>Strong Subject:</span>
                            <strong id="swtStrong">--</strong>
                        </div>
                        <div class="performance-label stat-weak">
                            <span>Weak Subject:</span>
                            <strong id="swtWeak">--</strong>
                        </div>
                    </div>

                    <div id="swtUsageAnalysis"></div>
                </div>
            </div>
            <div id="tab-gt" class="tab-content">
                <div class="card">
                    <h3>GT Intelligence</h3>
                    <div style="display:flex; margin-bottom:10px;">
                        <div class="gt-tab-btn active" id="tabNeet" style="flex:1; padding:10px; text-align:center; background:var(--border); font-size:10px; cursor:pointer;" onclick="switchGT('NEET')"><b>NEET PG</b> <span style="font-size:9px;">(+4/-1)</span></div>
                        <div class="gt-tab-btn" id="tabInicet" style="flex:1; padding:10px; text-align:center; background:rgba(0,0,0,0.2); font-size:10px; cursor:pointer;" onclick="switchGT('INICET')"><b>INICET</b> <span style="font-size:9px;">(+1/-0.33)</span></div>
                        <div class="gt-tab-btn" id="tabFmge" style="flex:1; padding:10px; text-align:center; background:rgba(0,0,0,0.2); font-size:10px; cursor:pointer;" onclick="switchGT('FMGE')"><b>FMGE</b> <span style="font-size:9px;">(+1/0)</span></div>
                    </div>
                    
                    <span class="setting-label">Reading Phase</span>
                    <select id="gtPhase">
                        <option value="First Reading">First Reading</option>
                        <option value="Second Reading">Second Reading</option>
                        <option value="Third Reading">Third Reading</option>
                        <option value="Extra Bonus">Extra Bonus Reading</option>
                    </select>

                    <div style="margin-bottom: 8px;">
                        <span class="setting-label">Platform (Marrow, Prepladder, etc.)</span>
                        <input type="text" id="gtPlatform" placeholder="Enter Platform Name">
                    </div>
                    
                    <div style="margin-bottom: 8px;">
                       <span class="setting-label">Date</span>
                       <input type="date" id="gtDate">
                       <span style="font-size:9px; color:#888;">(Today or Past)</span>
                    </div>

                    <div id="gt-inputs-std">
                        <div style="display:flex; gap:5px;"><div style="flex:1;"><span class="setting-label">Correct</span><input type="number" id="gtCorrect" oninput="calcGT()"></div><div style="flex:1;"><span class="setting-label">Unattempted</span><input type="number" id="gtUnat" oninput="calcGT()"></div></div>
                        <div class="calc-preview"><span>Wrong: <b id="gtW">0</b></span><span>Score: <b id="gtS">0</b></span></div>
                    </div>

                    <div id="gt-inputs-fmge" style="display:none;">
                         <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                             <div>
                                 <span class="setting-label" style="text-decoration:underline;">PAPER 1 (150)</span>
                                 <span class="setting-label">Correct</span><input type="number" id="gtP1C" oninput="calcGT()">
                                 <span class="setting-label">Unattempted</span><input type="number" id="gtP1U" oninput="calcGT()">
                                 <div style="font-size:10px; margin-top:2px;">Score 1: <b id="gtS1">0</b></div>
                             </div>
                             <div>
                                 <span class="setting-label" style="text-decoration:underline;">PAPER 2 (150)</span>
                                 <span class="setting-label">Correct</span><input type="number" id="gtP2C" oninput="calcGT()">
                                 <span class="setting-label">Unattempted</span><input type="number" id="gtP2U" oninput="calcGT()">
                                 <div style="font-size:10px; margin-top:2px;">Score 2: <b id="gtS2">0</b></div>
                             </div>
                         </div>
                         <div class="calc-preview"><span>Total: <b id="gtTotalFmge">0</b></span><span id="gtStatusFmge">--</span></div>
                    </div>

                    <button class="btn" onclick="openGTBreakdown()" style="background:#2ecc71; margin-top:10px; width:100%;">Save Result & Enter Breakdown</button>
                    
                    <hr style="border: 0; border-top: 1px solid rgba(128,128,128,0.2); margin: 20px 0;">

                    <div id="gt-review-section">
                        <span class="setting-label">Review Past GT Breakdown</span>
                        <select id="gtHistorySelect" onchange="renderGTBreakdownGraph()">
                            <option value="">Select a GT to View Details</option>
                        </select>
                        <div id="gtReviewMeta" style="margin:10px 0; font-size:12px; text-align:center; color:var(--accent); font-weight:bold; display:none;"></div>
                        <div class="chart-scroller" id="gtBreakdownChartContainer" style="display:none;">
                             <div class="chart-scroll-content" id="gtBreakdownScrollInner">
                                <canvas id="gtBreakdownChart"></canvas>
                             </div>
                        </div>
                    </div>
                    <div id="neet-area">
                        <h4 style="color:#f39c12; margin-top:25px; font-size:13px;">NEET PG General Progress</h4>
                        <div class="chart-scroller"><div class="chart-scroll-content" id="neetScrollInner"><canvas id="gtNeetChart"></canvas></div></div>
                        
                        <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #3498db; text-transform: uppercase;">GTs Attempted per Phase</h4>
                        <div class="chart-container"><canvas id="gtNeetPhaseCountChart"></canvas></div>

                        <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #9b59b6; text-transform: uppercase;">Average Score per Phase</h4>
                        <div class="chart-container"><canvas id="gtNeetPhaseAvgChart"></canvas></div>

                        <div id="gtNeetStats" style="margin-top:10px;"></div>
                    </div>

                    <div id="inicet-area" style="display:none;">
                        <h4 style="color:#2ecc71; margin-top:25px; font-size:13px;">INICET General Progress</h4>
                        <div class="chart-scroller"><div class="chart-scroll-content" id="iniScrollInner"><canvas id="gtInicetChart"></canvas></div></div>
                        
                        <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #3498db; text-transform: uppercase;">GTs Attempted per Phase</h4>
                        <div class="chart-container"><canvas id="gtIniPhaseCountChart"></canvas></div>

                        <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #9b59b6; text-transform: uppercase;">Average Score per Phase</h4>
                        <div class="chart-container"><canvas id="gtIniPhaseAvgChart"></canvas></div>

                        <div id="gtIniStats" style="margin-top:10px;"></div>
                    </div>

                    <div id="fmge-area" style="display:none;">
                        <h4 style="color:#e67e22; margin-top:25px; font-size:13px;">FMGE Total Score Progress</h4>
                        <div class="chart-scroller"><div class="chart-scroll-content" id="fmgeScrollInner"><canvas id="gtFmgeChart"></canvas></div></div>
                        
                        <div style="display:flex; flex-direction:column; gap:15px; margin-top:15px;">
                            <div>
                                <h4 style="font-size:10px; color:#3498db; text-align:center;">Paper 1 Progress</h4>
                                <div class="chart-scroller" style="height:150px;"><div class="chart-scroll-content" style="height:150px;" id="fmgeP1ScrollInner"><canvas id="gtFmgeP1Chart"></canvas></div></div>
                            </div>
                            <div>
                                <h4 style="font-size:10px; color:#9b59b6; text-align:center;">Paper 2 Progress</h4>
                                <div class="chart-scroller" style="height:150px;"><div class="chart-scroll-content" style="height:150px;" id="fmgeP2ScrollInner"><canvas id="gtFmgeP2Chart"></canvas></div></div>
                            </div>
                        </div>

                        <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #3498db; text-transform: uppercase;">GTs Attempted per Phase</h4>
                        <div class="chart-container"><canvas id="gtFmgePhaseCountChart"></canvas></div>
                        
                        <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #9b59b6; text-transform: uppercase;">Average Score per Phase</h4>
                        <div class="chart-container"><canvas id="gtFmgePhaseAvgChart"></canvas></div>

                        <div id="gtFmgeStats" style="margin-top:10px;"></div>
                    </div>
                </div>
            </div>
            <div id="tab-rank" class="tab-content">
                <div class="card">
                    <div style="text-align:center; margin-bottom:15px;">
                        <h3 style="margin:0; color:#f39c12; font-size:18px;">LEADERBOARD ARENA</h3>
                        <div style="font-size:10px; opacity:0.7;">Top 50 Elites ‚Ä¢ Live Updates</div>
                    </div>

                    <div class="rank-nav">
                        <button class="rank-nav-btn active" onclick="switchRankMode('streak', this)">üî• Streaks</button>
                        <button class="rank-nav-btn" onclick="switchRankMode('swt', this)">üß† Subjects</button>
                        <button class="rank-nav-btn" onclick="switchRankMode('gt', this)">üèõÔ∏è Hall of Fame</button>
                    </div>

                    <div id="rank-filter-streak" style="display:block;">
                        <div class="usage-box freq-box" style="text-align:center;">
                            <span class="usage-title" style="color:#f39c12;">üî• The MCQ Marathon</span>
                            Rule: Minimum 50 MCQs/day to maintain streak.<br>
                            Tie-breaker: Total Volume.
                        </div>
                    </div>
                    <div id="rank-filter-swt" style="display:none;">
                        <span class="setting-label">Select Subject Arena</span>
                        <select id="rankSubjectSelect" onchange="loadLeaderboard('swt')">
                            <option value="Anatomy">Anatomy</option><option value="Physiology">Physiology</option><option value="Biochemistry">Biochemistry</option>
                            <option value="Pathology">Pathology</option><option value="Microbiology">Microbiology</option><option value="Pharmacology">Pharmacology</option>
                            <option value="FMT">FMT</option><option value="PSM">PSM</option><option value="Ophthalmology">Ophthalmology</option><option value="ENT">ENT</option>
                            <option value="Medicine">Medicine</option><option value="Surgery">Surgery</option><option value="OBG">OBG</option><option value="Pediatrics">Pediatrics</option>
                            <option value="Anaesthesia">Anaesthesia</option><option value="Dermatology">Dermatology</option><option value="Orthopedics">Orthopedics</option>
                            <option value="Psychiatry">Psychiatry</option><option value="Radiology">Radiology</option>
                        </select>
                        <div style="font-size:9px; color:#888; text-align:center; margin-top:5px;">*Min 300 Qs required to rank</div>
                    </div>

                    <div id="rank-filter-gt" style="display:none;">
                        <span class="setting-label">Select Exam Category</span>
                        <select id="rankGtSelect" onchange="loadLeaderboard('gt')">
                            <option value="neet">NEET PG (Out of 800)</option>
                            <option value="ini">INICET (Out of 200)</option>
                            <option value="fmge">FMGE (Out of 300)</option>
                        </select>
                        <div style="font-size:10px; color:#888; margin-top:10px; padding:8px; border-left:2px solid var(--accent); background:rgba(0,0,0,0.2); text-align:left;">
                            <strong>Ranking Criteria:</strong><br>
                            1. Based on the <b>Arithmetic Mean</b> (Average) of all your GTs.<br>
                            2. You must attempt a minimum of <b>3 GTs</b> to qualify.<br>
                            3. Platform names are hidden for privacy.
                        </div>
                    </div>

                    <hr style="border: 0; border-top: 1px dashed rgba(128,128,128,0.2); margin: 15px 0;">

                    <div id="leaderboard-list" class="rank-list">
                        <div style="text-align:center; padding:20px; color:#888; font-size:12px;">
                            Loading Ranks... <br>
                            <span style="font-size:10px; opacity:0.5;">(Syncing with Cloud)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div> 
        
        <div id="section-qual" class="section-container">
            <div class="nav-tabs">
                <div class="tab-btn active" onclick="switchTab('tab-fact', this)">Fact Salad ü•ó</div>
                <div class="tab-btn" onclick="switchTab('tab-swt-mistake', this)">SWT Mistakes üß†</div>
                <div class="tab-btn" onclick="switchTab('tab-gt-mistake', this)">GT Mistakes üìà</div>
            </div>

            <div id="tab-fact" class="tab-content active">
                <div class="qual-card">
                    <h3 style="color:var(--accent); margin-top:0;">Fact Salad Slideshow</h3>
                    <div id="fact-slideshow" class="slide-container">
                        <div style="font-size:12px; opacity:0.7;">Add facts below to start the show!</div>
                    </div>
                    <button class="btn sm-btn" onclick="toggleSlideShow()" id="slideShowBtn" style="background:#f39c12; margin-bottom:15px;">‚èØ Play Slideshow (30s)</button>
                    <hr style="border:0; border-top:1px dashed var(--border); margin:15px 0;">
                    
                    <h4 style="margin:0 0 10px 0;">Add New Fact</h4>
                    <div class="qual-input-group">
                        <label>Subject</label>
                        <select id="factSubject">
                            <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option>
                        </select>
                    </div>
                    <div class="qual-input-group">
                        <label>Question / Fact Title</label>
                        <textarea id="factQuestion" placeholder="e.g., Drug of choice for..."></textarea>
                    </div>
                    <div class="qual-input-group">
                        <label>Answer / Key Point</label>
                        <textarea id="factAnswer" placeholder="e.g., Methotrexate"></textarea>
                    </div>
                    <button class="btn" onclick="saveFact()">Save to Salad Bowl ü•ó</button>
                </div>
            </div>
            <div id="tab-swt-mistake" class="tab-content">
                <div class="qual-card">
                    <h3 style="color:var(--accent); margin-top:0;">SWT Mistake Analysis</h3>
                    <div class="qual-input-group">
                        <label>Subject</label>
                        <select id="swtMistakeSubject">
                            <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option>
                        </select>
                    </div>
                    <div class="qual-input-group"><label>Question</label><textarea id="swtMistakeQ"></textarea></div>
                    <div class="qual-input-group"><label>Correct Answer</label><textarea id="swtMistakeA"></textarea></div>
                    <div class="qual-input-group"><label>My Incorrect Answer</label><textarea id="swtMistakeWrong"></textarea></div>
                    <div class="qual-input-group"><label>Reason for Error</label><textarea id="swtMistakeReason" placeholder="e.g., Silly mistake, Concept gap..."></textarea></div>
                    <button class="btn" style="background:#e74c3c;" onclick="saveSWTMistake()">Log Mistake üß†</button>
                </div>
            </div>

            <div id="tab-gt-mistake" class="tab-content">
                <div class="qual-card">
                    <h3 style="color:var(--accent); margin-top:0;">GT Mistake Autopsy</h3>
                    <div class="qual-input-group">
                        <label>Exam Type</label>
                        <select id="gtMistakeType">
                            <option>NEET PG</option><option>INICET</option><option>FMGE</option>
                        </select>
                    </div>
                    <div class="qual-input-group">
                        <label>Subject</label>
                        <select id="gtMistakeSubject">
                            <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option>
                        </select>
                    </div>
                    <div class="qual-input-group"><label>Question</label><textarea id="gtMistakeQ"></textarea></div>
                    <div class="qual-input-group"><label>Correct Answer</label><textarea id="gtMistakeA"></textarea></div>
                    <div class="qual-input-group"><label>My Incorrect Answer</label><textarea id="gtMistakeWrong"></textarea></div>
                    <div class="qual-input-group"><label>Reason for Error</label><textarea id="gtMistakeReason" placeholder="e.g., Misread question, Recall error..."></textarea></div>
                    <button class="btn" style="background:#e74c3c;" onclick="saveGTMistake()">Log Autopsy üìâ</button>
                </div>
            </div>

            <div class="danger-zone" style="margin-top:15px; background:var(--card); border:1px solid var(--border);">
                <h3 style="color:#2ecc71; margin:0 0 10px 0;">Revision Reports (PDF)</h3>
                <div style="font-size:10px; color:#ef5350; margin-bottom:10px; font-weight:bold;">‚ö†Ô∏è NOTE: Download "Month End" report on the last day. Data in this section is volatile!</div>
                
                <button class="btn" onclick="generatePDF('daily')" style="margin-bottom:10px; background:var(--tab-blue);">üìÑ Download Today's Report</button>
                <button class="btn" onclick="generatePDF('monthly')" style="margin-bottom:10px; background:#8e44ad;">üìÖ Download Month End Report</button>
                <button class="clear-btn" onclick="clearQualitativeData()">üóëÔ∏è Clear Qualitative Data (New Month)</button>
            </div>
        </div>

        <div class="danger-zone">
            <h3 style="color:#f39c12; margin:0 0 10px 0;">Data Safety</h3>
            <div id="backup-reminder" style="font-weight:bold; margin-bottom:10px; font-size:12px; text-transform:uppercase; letter-spacing:0.5px; text-align: center;"></div>
            <ul style="text-align: left; font-size: 10px; opacity: 0.7; padding-left: 15px; margin-bottom: 10px;">
                <li><strong>Step 1:</strong> Click "Backup Data" below to copy your code.</li>
                <li><strong>Step 2:</strong> Paste the code in your "Saved Messages" on Telegram.</li>
                <li><strong>Step 3:</strong> To restore later, copy that code, click "Restore Data", and paste it.</li>
            </ul>
            <button class="backup-btn" onclick="exportData()">Backup Data (Copy Code)</button>
            <button class="restore-btn" onclick="openRestore()">Restore Data</button>
            <button class="clear-btn" onclick="clearData()" style="margin-top:10px;">Clear All Local Data</button>
        </div>

    </div> 
    <div class="main-nav-dock">
        <button class="main-nav-btn active" onclick="switchMainSection('quant', this)">
            <span>üìä</span>Quantitative
        </button>
        <button class="main-nav-btn" onclick="switchMainSection('qual', this)">
            <span>üìù</span>Qualitative
        </button>
    </div>
    <script>
        const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
        const tgUser = tg.initDataUnsafe?.user || { id: "OFFLINE", first_name: "Local", last_name: "User" };
        const fullName = `${tgUser.first_name || ""} ${tgUser.last_name || ""}`.trim();
        document.getElementById('uFullName').innerText = fullName || "Guest User";
        document.getElementById('uID').innerText = `ID: ${tgUser.id}`;
        
        const statusDot = document.getElementById('statusDot');
        if (tgUser.id === "OFFLINE") { statusDot.classList.add('status-offline'); } else { statusDot.classList.add('status-online'); }

        const prefix = `SSS_PRO_V3_${tgUser.id}_`;
        
        // UPDATED KEYS: Added FACTS, SWT_MISTAKES, GT_MISTAKES
        const KEYS = { 
            LOGS: prefix+'LOGS', NEET: prefix+'NEET', INI: prefix+'INI', FMGE: prefix+'FMGE', 
            SWT: prefix+'SWT', GOALS: prefix+'GOALS', PYQ: prefix+'PYQ', TOUGH: prefix+'TOUGH',
            FACTS: prefix+'FACTS', SWT_MISTAKES: prefix+'SWT_MISTAKES', GT_MISTAKES: prefix+'GT_MISTAKES'
        };
        
        const SUBJECTS_19 = ["Anatomy", "Physiology", "Biochemistry", "Pathology", "Microbiology", "Pharmacology", "FMT", "PSM", "Ophthalmology", "ENT", "Medicine", "Surgery", "OBG", "Pediatrics", "Anaesthesia", "Dermatology", "Orthopedics", "Psychiatry", "Radiology"];
        const SUBJECTS_EXTRA = ["Mixed Bag", "Integrated Systems"];
        const ALL_SWT_SUBS = [...SUBJECTS_19, ...SUBJECTS_EXTRA];

        const PHASES_CONFIG = [{ id: 'r1', name: '1. First Reading', badge: 'ü•â' },{ id: 'r2', name: '2. Second Reading', badge: 'ü•à' },{ id: 'r3', name: '3. Third Reading', badge: 'ü•á' },{ id: 'r4', name: '4. Extra Bonus', badge: 'üèÜ' }];
        
        const PYQ_CATS = [
            { id: 'neet', label: 'NEET PG', type: 'list', start: 2025, end: 2020 },
            { id: 'ini', label: 'INICET', type: 'cols', col1: 'May', col2: 'Nov', start: 2025, end: 2014 },
            { id: 'fmge', label: 'FMGE', type: 'cols', col1: 'July', col2: 'Dec', start: 2025, end: 2020 },
            { id: 'upsc', label: 'UPSC CMS', type: 'list', start: 2025, end: 2020 }
        ];

        /* --- NEW: MAIN SECTION SWITCHER --- */
        function switchMainSection(section, btn) {
            document.querySelectorAll('.main-nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            document.querySelectorAll('.section-container').forEach(c => c.classList.remove('active'));
            document.getElementById('section-' + section).classList.add('active');
            
            // Scroll to top when switching
            window.scrollTo(0,0);
        }
        /* --- NEW: FACT SALAD SLIDESHOW LOGIC --- */
        let slideInterval;
        let isSlidePlaying = false;

        function saveFact() {
            const sub = document.getElementById('factSubject').value;
            const q = document.getElementById('factQuestion').value;
            const a = document.getElementById('factAnswer').value;
            
            if(!q || !a) return alert("Please enter both Question and Answer");
            
            const facts = JSON.parse(localStorage.getItem(KEYS.FACTS) || "[]");
            facts.push({ id: Date.now(), date: new Date().toLocaleDateString('en-GB'), sub, q, a });
            localStorage.setItem(KEYS.FACTS, JSON.stringify(facts));
            
            document.getElementById('factQuestion').value = "";
            document.getElementById('factAnswer').value = "";
            
            if(window.syncToCloud) window.syncToCloud();
            alert("Fact Added to Salad Bowl! ü•ó");
            renderSlideShow();
        }

        function renderSlideShow() {
            const facts = JSON.parse(localStorage.getItem(KEYS.FACTS) || "[]");
            const container = document.getElementById('fact-slideshow');
            
            if(facts.length === 0) {
                container.innerHTML = '<div style="font-size:12px; opacity:0.7;">Add facts below to start the show!</div>';
                return;
            }
            // If static, show random fact
            if(!isSlidePlaying) {
                showRandomFact();
            }
        }

        function showRandomFact() {
            const facts = JSON.parse(localStorage.getItem(KEYS.FACTS) || "[]");
            if(facts.length === 0) return;
            const f = facts[Math.floor(Math.random() * facts.length)];
            const container = document.getElementById('fact-slideshow');
            container.innerHTML = `
                <div style="font-size:10px; color:#f39c12; margin-bottom:5px; text-transform:uppercase; font-weight:bold;">${f.sub}</div>
                <div style="font-size:14px; font-weight:bold; margin-bottom:10px;">Q: ${f.q}</div>
                <div style="font-size:12px; color:#2ecc71; font-style:italic;">A: ${f.a}</div>
            `;
        }

        function toggleSlideShow() {
            const btn = document.getElementById('slideShowBtn');
            if(isSlidePlaying) {
                clearInterval(slideInterval);
                isSlidePlaying = false;
                btn.innerHTML = "‚èØ Play Slideshow (30s)";
                btn.style.background = "#f39c12";
            } else {
                const facts = JSON.parse(localStorage.getItem(KEYS.FACTS) || "[]");
                if(facts.length === 0) return alert("Add facts first!");
                
                showRandomFact(); // Show first immediately
                isSlidePlaying = true;
                btn.innerHTML = "‚èπ Stop Slideshow";
                btn.style.background = "#ef5350";
                
                slideInterval = setInterval(() => {
                    showRandomFact();
                }, 30000); // 30 Seconds
            }
        }
        
        /* --- NEW: QUALITATIVE DATA SAVING --- */
        function saveSWTMistake() {
            const sub = document.getElementById('swtMistakeSubject').value;
            const q = document.getElementById('swtMistakeQ').value;
            const a = document.getElementById('swtMistakeA').value;
            const w = document.getElementById('swtMistakeWrong').value;
            const r = document.getElementById('swtMistakeReason').value;

            if(!q || !r) return alert("Please fill in the Mistake details.");

            const mistakes = JSON.parse(localStorage.getItem(KEYS.SWT_MISTAKES) || "[]");
            mistakes.push({ id: Date.now(), date: new Date().toLocaleDateString('en-GB'), sub, q, a, w, r });
            localStorage.setItem(KEYS.SWT_MISTAKES, JSON.stringify(mistakes));
            
            // Clear inputs
            document.getElementById('swtMistakeQ').value = "";
            document.getElementById('swtMistakeA').value = "";
            document.getElementById('swtMistakeWrong').value = "";
            document.getElementById('swtMistakeReason').value = "";

            if(window.syncToCloud) window.syncToCloud();
            alert("SWT Mistake Logged. Don't repeat it! üß†");
        }

        function saveGTMistake() {
            const type = document.getElementById('gtMistakeType').value;
            const sub = document.getElementById('gtMistakeSubject').value;
            const q = document.getElementById('gtMistakeQ').value;
            const a = document.getElementById('gtMistakeA').value;
            const w = document.getElementById('gtMistakeWrong').value;
            const r = document.getElementById('gtMistakeReason').value;

            if(!q || !r) return alert("Please fill in the Autopsy details.");

            const mistakes = JSON.parse(localStorage.getItem(KEYS.GT_MISTAKES) || "[]");
            mistakes.push({ id: Date.now(), date: new Date().toLocaleDateString('en-GB'), type, sub, q, a, w, r });
            localStorage.setItem(KEYS.GT_MISTAKES, JSON.stringify(mistakes));
            
            // Clear inputs
            document.getElementById('gtMistakeQ').value = "";
            document.getElementById('gtMistakeA').value = "";
            document.getElementById('gtMistakeWrong').value = "";
            document.getElementById('gtMistakeReason').value = "";

            if(window.syncToCloud) window.syncToCloud();
            alert("GT Autopsy Saved. üìâ");
        }

        function clearQualitativeData() {
            if(confirm("‚ö†Ô∏è ARE YOU SURE?\n\nThis will delete all Fact Salad, SWT Mistakes, and GT Mistakes.\n\nOnly do this after downloading your Month End Report!")) {
                localStorage.removeItem(KEYS.FACTS);
                localStorage.removeItem(KEYS.SWT_MISTAKES);
                localStorage.removeItem(KEYS.GT_MISTAKES);
                if(window.syncToCloud) window.syncToCloud();
                alert("Qualitative Data Wiped. Ready for a fresh month!");
                renderSlideShow(); // Reset UI
            }
        }
        
        /* --- NEW: PDF GENERATION ENGINE --- */
        async function generatePDF(type) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const today = new Date().toLocaleDateString('en-GB');
            const currentMonth = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
            
            // --- 1. HEADER ---
            doc.setFont("helvetica", "bold");
            doc.setFontSize(18);
            doc.setTextColor(82, 136, 193); // Accent Color
            doc.text("Scalpel Study Squad", 105, 15, { align: "center" });
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`User: ${window.userName}`, 200, 15, { align: "right" });
            doc.text(`ID: ${window.userId}`, 200, 20, { align: "right" });
            
            doc.setLineWidth(0.5);
            doc.line(10, 25, 200, 25);
            
            // --- 2. REPORT TITLE ---
            doc.setFontSize(14);
            doc.setTextColor(0);
            let reportTitle = "Scalpel Squad Revision Report";
            let subTitle = type === 'daily' ? `Daily Insight: ${today}` : `Monthly Compilation: ${currentMonth}`;
            
            doc.text(reportTitle, 14, 35);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(subTitle, 14, 42);

            let yPos = 50;

            // HELPER: Filter Data
            const filterData = (key) => {
                const data = JSON.parse(localStorage.getItem(KEYS[key]) || "[]");
                if (type === 'daily') {
                    // Filter where date matches today
                    return data.filter(d => d.date === today);
                }
                return data; // Monthly returns all data (before wipe)
            };

            // HELPER: Group by Subject (Sort)
            const sortData = (data) => {
                return data.sort((a, b) => a.sub.localeCompare(b.sub));
            };

            // --- SECTION A: FACT SALAD ---
            const facts = sortData(filterData('FACTS'));
            
            if (facts.length > 0) {
                doc.setFontSize(12);
                doc.setTextColor(243, 156, 18); // Orange
                doc.text("1. FACT SALAD ü•ó", 14, yPos);
                yPos += 5;
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Subject', 'Fact / Question', 'Answer']],
                    body: facts.map(f => [f.sub, f.q, f.a]),
                    theme: 'grid',
                    headStyles: { fillColor: [243, 156, 18] },
                    styles: { fontSize: 9 },
                    columnStyles: { 0: { fontStyle: 'bold', width: 40 } }
                });
                yPos = doc.lastAutoTable.finalY + 15;
            } else if (type === 'daily') {
                doc.setFontSize(10);
                doc.setTextColor(150);
                doc.text("(No Facts added today)", 14, yPos + 5);
                yPos += 15;
            }

            // --- SECTION B: SWT MISTAKES ---
            const swtMistakes = sortData(filterData('SWT_MISTAKES'));
            
            if (swtMistakes.length > 0) {
                doc.setFontSize(12);
                doc.setTextColor(231, 76, 60); // Red
                doc.text("2. SWT MISTAKE CHECKPOINT üß†", 14, yPos);
                yPos += 5;

                doc.autoTable({
                    startY: yPos,
                    head: [['Subject', 'Question', 'Correct', 'My Wrong', 'Reason']],
                    body: swtMistakes.map(m => [m.sub, m.q, m.a, m.w, m.r]),
                    theme: 'grid',
                    headStyles: { fillColor: [231, 76, 60] },
                    styles: { fontSize: 9 },
                    columnStyles: { 0: { fontStyle: 'bold', width: 30 } }
                });
                yPos = doc.lastAutoTable.finalY + 15;
            }

            // --- SECTION C: GT MISTAKES ---
            const gtMistakes = sortData(filterData('GT_MISTAKES'));
            
            if (gtMistakes.length > 0) {
                doc.setFontSize(12);
                doc.setTextColor(142, 68, 173); // Purple
                doc.text("3. GT MISTAKE CHECKPOINT üìà", 14, yPos);
                yPos += 5;

                doc.autoTable({
                    startY: yPos,
                    head: [['Exam', 'Subject', 'Question', 'Correct', 'My Wrong', 'Reason']],
                    body: gtMistakes.map(m => [m.type, m.sub, m.q, m.a, m.w, m.r]),
                    theme: 'grid',
                    headStyles: { fillColor: [142, 68, 173] },
                    styles: { fontSize: 9 },
                    columnStyles: { 1: { fontStyle: 'bold' } }
                });
            }

            // SAVE
            const fileName = `Scalpel_Report_${type}_${window.userId}.pdf`;
            doc.save(fileName);
        }
        /* --- RESTORED LOGIC: LEADERBOARD CALCULATION --- */
        window.calculateAndPushLeaderboard = function() {
            // 1. Calculate Streak
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS) || "[]");
            const dailyVol = {};
            logs.forEach(l => {
                if(l.date) {
                    if(!dailyVol[l.date]) dailyVol[l.date] = 0;
                    dailyVol[l.date] += (parseInt(l.mcqs) || 0);
                }
            });

            let streak = 0, streakVol = 0;
            const today = new Date();
            for(let i = 0; i < 365; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const dayStr = d.toLocaleDateString('en-GB');
                const vol = dailyVol[dayStr] || 0;
                
                if (i === 0 && vol < 50) { continue; }
                if (vol >= 50) { streak++; streakVol += vol; } else { break; }
            }

            // 2. Calculate Top GT Scores (Arithmetic Mean)
            const neetLogs = JSON.parse(localStorage.getItem(KEYS.NEET) || "[]");
            const iniLogs = JSON.parse(localStorage.getItem(KEYS.INI) || "[]");
            const fmgeLogs = JSON.parse(localStorage.getItem(KEYS.FMGE) || "[]");
            
            let meanNeet = 0;
            if(neetLogs.length >= 3) {
                let sum = 0;
                neetLogs.forEach(l => sum += parseFloat(l.score));
                meanNeet = parseFloat((sum / neetLogs.length).toFixed(2));
            }

            let meanIni = 0;
            if(iniLogs.length >= 3) {
                let sum = 0;
                iniLogs.forEach(l => sum += parseFloat(l.score));
                meanIni = parseFloat((sum / iniLogs.length).toFixed(2));
            }

            let meanFmge = 0;
            if(fmgeLogs.length >= 3) {
                let sum = 0;
                fmgeLogs.forEach(l => sum += parseFloat(l.score));
                meanFmge = parseFloat((sum / fmgeLogs.length).toFixed(2));
            }

            // 3. Calculate SWT Accuracy
            const swtLogs = JSON.parse(localStorage.getItem(KEYS.SWT) || "[]");
            const swtStats = {};
            const subjectAgg = {};
            
            swtLogs.forEach(l => {
                if(!subjectAgg[l.subject]) subjectAgg[l.subject] = { corr:0, tot:0 };
                subjectAgg[l.subject].corr += parseInt(l.correct||0);
                subjectAgg[l.subject].tot += parseInt(l.total||0);
            });
            
            Object.keys(subjectAgg).forEach(sub => {
                if(subjectAgg[sub].tot >= 300) {
                    swtStats[sub] = parseFloat(((subjectAgg[sub].corr / subjectAgg[sub].tot) * 100).toFixed(2));
                }
            });

            // 4. Send to Cloud
            if(window.pushToLeaderboard) {
                window.pushToLeaderboard({
                    streak: streak,
                    streakVol: streakVol,
                    neet: meanNeet, neetPlat: "Hidden",
                    ini: meanIni, iniPlat: "Hidden",
                    fmge: meanFmge, fmgePlat: "Hidden",
                    swt: swtStats
                });
            }
        };

        /* --- RESTORED LOGIC: UI HELPERS --- */
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', next);
            localStorage.setItem('SSS_THEME', next);
            updateUI(); 
        }
        const savedTheme = localStorage.getItem('SSS_THEME');
        if(savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);

        function getThemeColor(type) {
            const isLight = document.documentElement.getAttribute('data-theme') === 'light';
            if(type === 'text') return isLight ? '#000000' : '#ffffff';
            if(type === 'grid') return isLight ? '#e0e0e0' : 'rgba(255,255,255,0.1)';
            return '#ffffff';
        }

        function toggleAccordion(id, header) {
            const content = document.getElementById(id);
            content.classList.toggle('open');
            header.classList.toggle('active');
        }

        function openPopup(popupId) {
            document.querySelectorAll('.popup-card').forEach(card => card.style.display = 'none');
            document.getElementById(popupId).style.display = 'block';
            document.getElementById('popup-overlay').style.display = 'flex';
        }

        function closePopup() {
            document.getElementById('popup-overlay').style.display = 'none';
            document.querySelectorAll('.popup-card').forEach(card => card.style.display = 'none');
            stopAlarm();
        }
        /* TOUGH SUBJECTS LOGIC */
        function renderToughSubjectsSelector() {
            const saved = JSON.parse(localStorage.getItem(KEYS.TOUGH) || "{}");
            const container = document.getElementById('tough-subject-selector');
            let html = "";
            SUBJECTS_19.forEach(s => {
                const checked = saved[s] ? "checked" : "";
                html += `<label class="sub-check-item"><input type="checkbox" id="tough_${s}" ${checked} onchange="saveToughSubjects()"><span>${s}</span></label>`;
            });
            container.innerHTML = html;
        }

        function saveToughSubjects() {
            const selection = {};
            SUBJECTS_19.forEach(s => {
                const el = document.getElementById(`tough_${s}`);
                if (el && el.checked) selection[s] = true;
            });
            localStorage.setItem(KEYS.TOUGH, JSON.stringify(selection));
            if(window.syncToCloud) window.syncToCloud();
            renderToughDashboard();
        }

        function renderToughDashboard() {
            const saved = JSON.parse(localStorage.getItem(KEYS.TOUGH) || "{}");
            const selectedSubjects = Object.keys(saved).filter(k => saved[k]);
            const container = document.getElementById('tough-dashboard');
            if (selectedSubjects.length === 0) { container.innerHTML = ""; return; }
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS) || "[]");
            let html = `<div class="tough-dash-title">Tough Subjects Radar</div>`;
            const now = new Date(); now.setHours(0,0,0,0);
            selectedSubjects.forEach(s => {
                let lastDate = null;
                for(let l of logs) {
                    if (l.subject === s) {
                        const parts = l.date.split('/');
                        if(parts.length === 3) {
                            const d = new Date(parts[2], parts[1]-1, parts[0]);
                            if (!lastDate || d > lastDate) lastDate = d;
                        }
                    }
                }
                let statusClass = "alert-red", msg = "Not studied recently!", days = "Never";
                if (lastDate) {
                    const diffTime = Math.abs(now - lastDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    days = `${diffDays} days ago`;
                    if (diffDays <= 10) { statusClass = "alert-safe"; msg = "On Track"; }
                    else if (diffDays <= 20) { statusClass = "alert-yellow"; msg = "Needs Revision"; }
                    else if (diffDays <= 30) { statusClass = "alert-orange"; msg = "Gap Warning"; }
                    else { statusClass = "alert-red"; msg = "Critical Gap"; }
                }
                html += `<div class="alert-item ${statusClass}"><span>${s}</span><span class="days">${msg} (${days})</span></div>`;
            });
            container.innerHTML = html;
        }
        /* TIMER LOGIC */
        let timerInterval, activeSub = "", activePhase = "", wakeLock = null, timeLeft = 0, mode = "idle", isPaused = false, currentGTMode = "NEET";
        let initialDuration = 0, elapsedDuration = 0, isStudySkipped = false;

        const requestWakeLock = async () => { if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) { console.error(e); } } };
        document.addEventListener('visibilitychange', async () => { if (wakeLock !== null && document.visibilityState === 'visible') { await requestWakeLock(); } });

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep(f, d) { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value = f; g.gain.value = 0.1; o.start(); setTimeout(() => o.stop(), d); }
        let alarmInterval = null;
        function startAlarm(f) { stopAlarm(); alarmInterval = setInterval(() => playBeep(f, 200), 1000); }
        function stopAlarm() { if(alarmInterval) { clearInterval(alarmInterval); alarmInterval = null; } }

        document.getElementById('startBtn').onclick = () => { 
            const s = document.getElementById('subject').value;
            if (!s) { alert("‚ö†Ô∏è Please select a Subject."); return; }
            audioCtx.resume(); requestWakeLock(); activeSub = s; activePhase = document.getElementById('studyPhase').value; startStudyTimer(); 
        };

        function startStudyTimer() { 
            mode = "study"; isPaused = false; isStudySkipped = false;
            let h = parseInt(document.getElementById('studyHr').value) || 0, m = parseInt(document.getElementById('studyMin').value) || 0;
            initialDuration = (h * 3600) + (m * 60); timeLeft = initialDuration;
            if(timeLeft <= 0) return; 
            document.getElementById('startBtn').style.display='none'; document.getElementById('timer-controls').style.display='block'; 
            runTimer(); 
        }
        
        function togglePause() { isPaused = !isPaused; document.getElementById('pauseBtn').innerText = isPaused ? "Resume" : "Pause"; }
        
        function runTimer() { 
            clearInterval(timerInterval); 
            timerInterval = setInterval(() => { 
                if (!isPaused) { 
                    timeLeft--; 
                    let h=Math.floor(timeLeft/3600), m=Math.floor((timeLeft%3600)/60), s=timeLeft%60; 
                    document.getElementById('timer-display').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; 
                    if (timeLeft<=0) handleTransition(); 
                } 
            }, 1000); 
        }

        function handleTransition() { 
            clearInterval(timerInterval); startAlarm(mode==="study"?880:440); 
            if (mode === "study") { elapsedDuration = initialDuration - timeLeft; isStudySkipped = (timeLeft > 5); openPopup('mcq-popup'); } else { openPopup('break-popup'); }
        }
        function startBreak() { 
            stopAlarm(); const m = parseInt(document.getElementById('cycleMcqs').value)||0; 
            saveStudyLog(activeSub, m, Math.floor(elapsedDuration / 60), activePhase, isStudySkipped); 
            document.getElementById('cycleMcqs').value=''; closePopup(); mode="break"; isPaused=false; timeLeft=parseInt(document.getElementById('breakTime').value)*60; runTimer(); 
        }

        function continueNextCycle() { stopAlarm(); closePopup(); startStudyTimer(); }
        function stopEntireSession() { stopAlarm(); clearInterval(timerInterval); if (wakeLock) { wakeLock.release(); wakeLock=null; } closePopup(); document.getElementById('timer-display').innerText="00:00:00"; document.getElementById('startBtn').style.display='block'; document.getElementById('timer-controls').style.display='none'; mode="idle"; updateUI(); }
        
        function saveStudyLog(s, m, d, ph, skipped) { 
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]"); 
            logs.unshift({ date: new Date().toLocaleDateString('en-GB'), subject: s, mcqs: m, duration: d, phase: ph, skipped: skipped || false }); 
            localStorage.setItem(KEYS.LOGS, JSON.stringify(logs)); 
            if(window.syncToCloud) window.syncToCloud();
        }

        /* LEADERBOARD UI LOGIC */
        let currentRankMode = 'streak';

        function switchRankMode(mode, btn) {
            currentRankMode = mode;
            document.querySelectorAll('.rank-nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            document.getElementById('rank-filter-streak').style.display = mode === 'streak' ? 'block' : 'none';
            document.getElementById('rank-filter-swt').style.display = mode === 'swt' ? 'block' : 'none';
            document.getElementById('rank-filter-gt').style.display = mode === 'gt' ? 'block' : 'none';
            
            loadLeaderboard(mode);
        }

        function loadLeaderboard(mode) {
            document.getElementById('leaderboard-list').innerHTML = '<div style="text-align:center; padding:20px; color:#888; font-size:12px;">Fetching Top 50...</div>';
            
            if (mode === 'streak') {
                if(window.fetchLeaderboard) window.fetchLeaderboard('streak');
            } else if (mode === 'swt') {
                const sub = document.getElementById('rankSubjectSelect').value;
                if(window.fetchLeaderboard) window.fetchLeaderboard('swt', sub);
            } else if (mode === 'gt') {
                const cat = document.getElementById('rankGtSelect').value;
                if(window.fetchLeaderboard) window.fetchLeaderboard(cat);
            }
        }

        window.renderLeaderboardUI = function(data, category) {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = "";
            
            if (!data || data.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.6;">No champions yet. Be the first! üèÜ</div>';
                return;
            }

            let html = "";
            data.forEach((user, index) => {
                const rank = index + 1;
                let rankClass = "", icon = "";
                
                if (rank === 1) { rankClass = "rank-1"; icon = "ü•á"; }
                else if (rank === 2) { rankClass = "rank-2"; icon = "ü•à"; }
                else if (rank === 3) { rankClass = "rank-3"; icon = "ü•â"; }
                else { icon = `<span class="elite-badge">ELITE</span>`; }

                let scoreDisplay = "";
                let metaDisplay = "";

                if (category === 'streak') {
                    scoreDisplay = `${user.score} Days`;
                    metaDisplay = `Vol: ${user.vol || 0} MCQs`;
                } else if (category === 'swt') {
                    scoreDisplay = `${user.accuracy}%`;
                    metaDisplay = "Accuracy";
                } else {
                    scoreDisplay = user.score; 
                    metaDisplay = "Mean Score";
                }

                html += `
                <div class="rank-item ${rankClass}">
                    <div class="rank-pos">${rank <= 3 ? icon : rank}</div>
                    <div class="rank-info">
                        <span class="rank-name">${user.name}</span>
                        <span class="rank-meta">${metaDisplay}</span>
                    </div>
                    <div class="rank-score">${scoreDisplay}</div>
                </div>`;
            });
            list.innerHTML = html;
        };

        /* STANDARD ANALYTICS & RENDERING */
        function renderData() {
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]");
            const viewMonth = currentViewDate.getMonth(), viewYear = currentViewDate.getFullYear();
            const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
            const labels = [], hoursData = Array(daysInMonth).fill(0), mcqsData = Array(daysInMonth).fill(0);
            const tableLogs = [];
            logs.forEach(l => {
                const parts = l.date.split('/'); if(parts.length !== 3) return;
                const d = parts[0], m = parts[1], y = parts[2];
                const logDate = new Date(y, m - 1, d);
                if (logDate.getMonth() === viewMonth && logDate.getFullYear() === viewYear) {
                    const dayIdx = parseInt(d) - 1;
                    hoursData[dayIdx] += l.duration / 60;
                    mcqsData[dayIdx] += l.mcqs;
                    tableLogs.push(l);
                }
            });
            for (let i = 1; i <= daysInMonth; i++) labels.push(i);
            const textColor = getThemeColor('text'), gridColor = getThemeColor('grid');
            if(hChart) hChart.destroy(); hChart = new Chart(document.getElementById('hoursChart'), { type:'line', data:{labels:labels, datasets:[{label:'Hours', data:hoursData, borderColor:'#f39c12', backgroundColor: 'rgba(243, 156, 18, 0.1)', fill: true, tension:0.3}]}, options:{maintainAspectRatio:false, scales:{y:{min:0, max:16, ticks:{color:textColor}, grid:{color:gridColor}}, x:{ticks:{color:textColor, font:{size:9}}, grid:{color:gridColor}}}, plugins:{legend:{display:false}}}});
            if(mChart) mChart.destroy(); mChart = new Chart(document.getElementById('mcqChart'), { type:'line', data:{labels:labels, datasets:[{label:'MCQs', data:mcqsData, borderColor:'#5288c1', backgroundColor: 'rgba(82, 136, 193, 0.1)', fill: true, tension:0.3}]}, options:{maintainAspectRatio:false, scales:{y:{beginAtZero:true, ticks:{color:textColor}, grid:{color:gridColor}}, x:{ticks:{color:textColor, font:{size:9}}, grid:{color:gridColor}}}, plugins:{legend:{display:false}}}});
            
            let html = ""; const groupedTable = {};
            tableLogs.forEach(l => { if(!groupedTable[l.date]) groupedTable[l.date] = {h:0, m:0, subs:new Set(), cyc:0}; groupedTable[l.date].h += l.duration/60; groupedTable[l.date].m += l.mcqs; groupedTable[l.date].subs.add(l.subject); if (!l.skipped) groupedTable[l.date].cyc++; });
            Object.keys(groupedTable).reverse().forEach(d => { html += `<tr><td>${d}</td><td>${groupedTable[d].h.toFixed(1)}h</td><td>${groupedTable[d].cyc}</td><td>${groupedTable[d].m}</td><td>${Array.from(groupedTable[d].subs).join(', ')}</td></tr>`; });
            document.getElementById('dailyLogBody').innerHTML = html || '<tr><td colspan="5">No data</td></tr>';
        }

        // --- GLOBAL VARIABLES FOR CHARTS ---
        let hChart, mChart, sChart, scuChart, sqChart, swtPhaseCountChart, swtPhaseAvgChart, gNeetChart, gIniChart, gFmgeChart, gtBreakdownChart;
        let currentViewDate = new Date();

        function changeViewMonth(offset) { currentViewDate.setMonth(currentViewDate.getMonth() + offset); updateUI(); }

        /* MASTER UPDATE LOOP */
        function updateUI() { 
            renderBackupStatus(); 
            renderData(); 
            renderSWT(); 
            renderGT(); 
            updateConsistency(); 
            renderMatrix(); 
            renderGoalHTML(); 
            renderPYQ(); 
            updateCountdowns(); 
            renderMonthlyTable(); 
            populateGTHistory(); 
            renderToughSubjectsSelector(); 
            renderToughDashboard(); 
            loadGoalsToUI(); 
            renderSlideShow();
        }

        updateUI(); 
        setInterval(updateCountdowns, 60000);
    </script>
</body>
</html>

