<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scalpel Study Squad Diary</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #0e1621; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .container { width: 100%; max-width: 380px; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .header-ui { width: 100%; display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .user-badge { background: rgba(82, 136, 193, 0.2); border: 1px solid #5288c1; padding: 6px 12px; border-radius: 20px; font-size: 12px; color: #5288c1; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .logo { width: 120px; height: 120px; border-radius: 50%; border: 4px solid #5288c1; margin-bottom: 10px; box-shadow: 0 0 20px rgba(82,136,193,0.3); }
        h1 { color: #5288c1; font-size: 26px; margin: 5px 0; font-weight: bold; text-transform: uppercase; }
        .streak-section { margin-bottom: 20px; }
        .streak-text { font-size: 16px; font-weight: bold; color: #f39c12; }
        .quote { font-family: 'Oswald', sans-serif; color: #ef5350; font-weight: 700; font-size: 13px; text-transform: uppercase; margin-top: 5px; }
        .sub-title { font-size: 11px; color: #888; margin-bottom: 15px; text-transform: uppercase; font-weight: bold; }
        .countdown-box { width: 100%; background: #17212b; padding: 12px; border-radius: 15px; border: 1px solid #2b5278; margin-bottom: 20px; box-sizing: border-box; }
        .count-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #2b5278; }
        .count-item:last-child { border-bottom: none; }
        .days-left { font-weight: bold; color: #f39c12; font-size: 14px; }
        .card { background: #17212b; padding: 20px; border-radius: 20px; border: 1px solid #2b5278; width: 100%; box-sizing: border-box; margin-bottom: 20px; }
        .setting-label { font-size: 10px; color: #888; text-transform: uppercase; margin: 8px 0 4px 0; display: block; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #2b5278; background: #0e1621; color: white; text-align: center; font-size: 14px; box-sizing: border-box; margin-top: 5px; }
        #timer-display { font-size: 52px; font-weight: bold; margin: 10px 0; color: #fff; }
        .btn { background: #2481cc; color: white; border: none; padding: 16px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .chart-container { width: 100%; height: 160px; margin: 15px 0; }
        .subject-tag { display: inline-block; background: #2b5278; padding: 4px 8px; border-radius: 5px; font-size: 11px; margin: 2px; }
        .log-day-header { color: #5288c1; font-weight: bold; font-size: 15px; border-bottom: 1px solid #2b5278; padding-bottom: 5px; margin-top: 20px; text-align: center; }
        .log-detail { font-size: 13px; color: #b1c3d5; line-height: 1.6; padding: 10px 0; border-bottom: 1px dashed #2b5278; text-align: left; }
        #popup-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; justify-content:center; align-items:center; }
    </style>
</head>
<body>
    <div id="popup-overlay">
        <div style="background:#17212b; padding:25px; border-radius:20px; border:1px solid #5288c1; width:80%; max-width:300px; text-align:center;">
            <h3>Session Complete!</h3>
            <p>Did you solve any MCQs?</p>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button style="flex:1; padding:12px; background:#2ecc71; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;" onclick="handleMcqResponse(true)">YES</button>
                <button style="flex:1; padding:12px; background:#ef5350; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;" onclick="handleMcqResponse(false)">NO</button>
            </div>
        </div>
    </div>

    <div class="container" id="pdfContent">
        <div class="header-ui">
            <div class="user-badge" onclick="document.getElementById('progressSection').scrollIntoView({behavior:'smooth'})">üë§ <span id="uName">@User</span></div>
        </div>
        <img src="https://github.com/dhruvathaare/Scaslpel-Study-Squad-Apps/blob/main/photo_2026-02-12_20-08-36.jpg?raw=true" class="logo">
        <h1>Scalpel Study Squad</h1>
        <div class="streak-section">
            <div class="streak-text" id="streakText">Consistency: 0 Days Logged</div>
            <div id="streakIcons" style="font-size:18px; margin:5px 0;"></div>
            <div class="quote">"I AM HERE TO WIN, CONSISTENCY IS MY KITH AND KIN"</div>
        </div>
        <div class="sub-title">PRE PG ENTRANCE EXAMS 2026</div>
        <div class="countdown-box">
            <div class="count-item"><span>INICET July 2026</span><span class="days-left" id="d1">--</span></div>
            <div class="count-item"><span>UPSC CMS 2026</span><span class="days-left" id="d2">--</span></div>
            <div class="count-item"><span>NEET PG 2026</span><span class="days-left" id="d3">--</span></div>
            <div class="count-item"><span>INICET Jan 2027</span><span class="days-left" id="d4">--</span></div>
        </div>
        <div class="card">
            <span class="setting-label">Reading Stage</span>
            <select id="readingStage"><option>First Reading üìì</option><option>Second Reading üßëüèª‚Äçüíª</option><option>Third Reading üíØ</option><option>Extra Bonus üî•</option></select>
            <span class="setting-label">Subject</span>
            <select id="subject"><option value="" disabled selected>Select Subject</option><option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option></select>
            <div style="display:flex; gap:10px;"><div style="flex:1;"><span class="setting-label">Study (M)</span><input type="number" id="studyTime" value="120"></div><div style="flex:1;"><span class="setting-label">Break (M)</span><input type="number" id="breakTime" value="15"></div></div>
            <div id="timer-display">00:00</div>
            <button id="startBtn" class="btn">Start Session</button>
            <button id="stopBtn" class="btn" style="background:#ef5350; display:none;">Stop & Record</button>
        </div>
        <div class="card" id="progressSection">
            <h3 style="margin:0; color:#f39c12;">Daily Analytics</h3>
            <div id="subjectTotals" style="margin-top:10px; text-align:left;"></div>
            <div class="chart-container"><canvas id="hoursChart"></canvas></div>
            <div class="chart-container"><canvas id="mcqChart"></canvas></div>
            <div id="logContainer"></div>
        </div>
        <div class="card">
            <h3 style="margin:0; color:#2ecc71;">GT Intelligence</h3>
            <input type="text" id="gtPlatform" placeholder="Platform Name">
            <div style="display:flex; gap:5px;"><input type="date" id="gtDate"><input type="number" id="gtScore" placeholder="Score"></div>
            <div style="display:flex; gap:5px;"><input type="number" id="gtCorrect" placeholder="Correct"><input type="number" id="gtIncorrect" placeholder="Incorrect"></div>
            <button class="btn" onclick="saveGT()" style="background:#2ecc71;">Record GT Score</button>
            <div class="chart-container"><canvas id="gtChart"></canvas></div>
            <div id="gtAnalysis" style="font-size:12px; text-align:left; color:#f39c12; margin-top:10px; line-height:1.5;"></div>
        </div>
        <button class="btn" onclick="exportToPDF()" style="background:#5288c1;">üìÑ Generate PDF Report</button>
        <button class="btn" onclick="copyTextReport()" style="background:#2ecc71;">üìã Copy Text Summary</button>
        <button class="btn" onclick="clearHistory()" style="background:transparent; border:1px solid #ef5350; color:#ef5350; font-size:10px; padding:5px; width:auto; margin-bottom:50px;">Clear Data</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
        const user = tg.initDataUnsafe?.user;
        if (user) document.getElementById('uName').innerText = user.username ? `@${user.username}` : user.first_name;

        let timerInterval, mode = "study", timeLeft = 0, activeSub = "", setMins = 0;
        const examDates = [new Date("May 16, 2026"), new Date("August 2, 2026"), new Date("August 30, 2026"), new Date("November 1, 2026")];
        
        function updateUI() {
            examDates.forEach((d, i) => { document.getElementById(`d${i+1}`).innerText = Math.ceil((d - new Date()) / 86400000) + "d"; });
            renderData(); renderGT(); updateConsistency();
        }

        function updateConsistency() {
            const logs = JSON.parse(localStorage.getItem('scalpel_vFinal') || "[]");
            const uniqueDays = new Set(logs.map(l => l.date)).size;
            document.getElementById('streakText').innerText = `Consistency: ${uniqueDays} Days Logged`;
            const flames = Math.floor(uniqueDays / 50);
            let iconStr = ""; for(let i=0; i<flames; i++) iconStr += "üî•";
            document.getElementById('streakIcons').innerText = iconStr;
        }

        const startBtn = document.getElementById('startBtn'), stopBtn = document.getElementById('stopBtn'), display = document.getElementById('timer-display'), subjectInput = document.getElementById('subject');

        startBtn.onclick = () => {
            if (!subjectInput.value) return tg.showAlert("Select a Subject!");
            activeSub = subjectInput.value; setMins = parseInt(document.getElementById('studyTime').value);
            mode = "study"; timeLeft = setMins * 60; startTimer();
        };

        function startTimer() {
            clearInterval(timerInterval); startBtn.style.display = 'none'; stopBtn.style.display = 'block';
            timerInterval = setInterval(() => {
                timeLeft--; let m = Math.floor(timeLeft / 60), s = timeLeft % 60;
                display.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                if (timeLeft <= 0) handleTransition();
            }, 1000);
        }

        function handleTransition() { clearInterval(timerInterval); if (mode === "study") document.getElementById('popup-overlay').style.display = 'flex'; else resetUI(); }
        stopBtn.onclick = () => { if (mode === "study") { setMins = Math.floor(((setMins * 60) - timeLeft) / 60); document.getElementById('popup-overlay').style.display = 'flex'; } else resetUI(); };

        function handleMcqResponse(isYes) {
            document.getElementById('popup-overlay').style.display = 'none';
            let mcqs = isYes ? (parseInt(prompt("MCQs solved?")) || 0) : 0;
            saveLog(activeSub, mcqs, setMins, document.getElementById('readingStage').value);
            mode = "break"; timeLeft = document.getElementById('breakTime').value * 60; startTimer();
        }

        function resetUI() { clearInterval(timerInterval); startBtn.style.display = 'block'; stopBtn.style.display = 'none'; display.innerText = "00:00"; subjectInput.selectedIndex = 0; }

        function saveLog(s, m, d, st) {
            const logs = JSON.parse(localStorage.getItem('scalpel_vFinal') || "[]");
            logs.unshift({ date: new Date().toLocaleDateString('en-GB'), subject: s.toUpperCase(), mcqs: m, duration: d, stage: st });
            localStorage.setItem('scalpel_vFinal', JSON.stringify(logs)); updateUI();
        }

        function saveGT() {
            const date = document.getElementById('gtDate').value, score = document.getElementById('gtScore').value, plat = document.getElementById('gtPlatform').value;
            const cor = parseInt(document.getElementById('gtCorrect').value) || 0, inc = parseInt(document.getElementById('gtIncorrect').value) || 0;
            if(!date || !score) return;
            const gts = JSON.parse(localStorage.getItem('scalpel_gt_vFinal') || "[]");
            gts.push({ date, score: parseInt(score), platform: plat, correct: cor, incorrect: inc });
            gts.sort((a,b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem('scalpel_gt_vFinal', JSON.stringify(gts)); updateUI();
        }

        let hChart, mChart, gChart;
        function renderData() {
            const logs = JSON.parse(localStorage.getItem('scalpel_vFinal') || "[]");
            const grouped = {}, subTots = {};
            logs.forEach(l => {
                if (!grouped[l.date]) grouped[l.date] = { h: 0, m: 0, c: 0, s: [] };
                grouped[l.date].h += l.duration/60; grouped[l.date].m += l.mcqs; grouped[l.date].c++;
                if(!grouped[l.date].s.includes(l.subject)) grouped[l.date].s.push(l.subject);
                subTots[l.subject] = (subTots[l.subject] || 0) + l.mcqs;
            });
            const labels = Object.keys(grouped).reverse().slice(-7);
            if(hChart) hChart.destroy(); if(mChart) mChart.destroy();
            hChart = new Chart(document.getElementById('hoursChart'), { type: 'line', data: { labels, datasets: [{ label: 'Hours', data: labels.map(l => grouped[l].h), borderColor: '#f39c12' }] }, options: { maintainAspectRatio: false }});
            mChart = new Chart(document.getElementById('mcqChart'), { type: 'line', data: { labels, datasets: [{ label: 'MCQs', data: labels.map(l => grouped[l].m), borderColor: '#5288c1' }] }, options: { maintainAspectRatio: false }});
            document.getElementById('subjectTotals').innerHTML = Object.entries(subTots).map(([s, t]) => `<span class="subject-tag">${s}: ${t}</span>`).join('');
            document.getElementById('logContainer').innerHTML = Object.keys(grouped).map(d => `<div class="log-day-header">${d}</div><div class="log-detail">Cycles: ${grouped[d].c}<br>Subs: ${grouped[d].s.join(", ")}<br>Time: ${grouped[d].h.toFixed(1)}h | MCQs: ${grouped[d].m}</div>`).join('');
        }

        function renderGT() {
            const gts = JSON.parse(localStorage.getItem('scalpel_gt_vFinal') || "[]");
            if (gts.length === 0) return;
            if(gChart) gChart.destroy();
            gChart = new Chart(document.getElementById('gtChart'), { type: 'line', data: { labels: gts.map(g => g.date), datasets: [{ label: 'Score', data: gts.map(g => g.score), borderColor: '#2ecc71' }] }, options: { maintainAspectRatio: false }});
            let a = "<b>GT Analysis:</b><br>";
            gts.forEach(g => {
                const acc = g.correct > 0 ? ((g.correct / (g.correct + g.incorrect)) * 100).toFixed(1) : 0;
                a += `‚Ä¢ ${g.date} (${g.platform}): Score <b>${g.score}</b> | Acc <b>${acc}%</b><br>`;
            });
            document.getElementById('gtAnalysis').innerHTML = a;
        }

        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById('pdfContent');
            const btns = document.querySelectorAll('.btn');
            btns.forEach(b => b.style.display = 'none');

            try {
                const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#0e1621' });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                pdf.addImage(imgData, 'PNG', 0, 0, 210, (canvas.height * 210) / canvas.width);
                
                const blob = pdf.output('blob');
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
                tg.showAlert("If download didn't start, check the new tab in your browser.");
            } catch (err) {
                tg.showAlert("PDF Export Blocked. Use 'Copy Text Summary' instead.");
            } finally {
                btns.forEach(b => b.style.display = 'block');
                document.getElementById('stopBtn').style.display = 'none';
            }
        }

        function copyTextReport() {
            const logs = JSON.parse(localStorage.getItem('scalpel_vFinal') || "[]");
            const gts = JSON.parse(localStorage.getItem('scalpel_gt_vFinal') || "[]");
            let report = "SCALPEL STUDY SQUAD REPORT\n\nSTUDY LOGS:\n";
            logs.forEach(l => report += `${l.date} | ${l.subject} | ${l.duration}m | MCQs: ${l.mcqs}\n`);
            report += "\nGT RECORDS:\n";
            gts.forEach(g => report += `${g.date} | ${g.platform} | Score: ${g.score}\n`);
            
            navigator.clipboard.writeText(report).then(() => {
                tg.showAlert("Report copied! Paste it into your Notes app.");
            });
        }

        function clearHistory() { if(confirm("Erase all tracking data?")) { localStorage.clear(); location.reload(); }}
        updateUI();
    </script>
</body>
</html>
