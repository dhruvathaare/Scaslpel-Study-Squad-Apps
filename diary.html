<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scalpel Master Standard</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <style>
        :root { --bg: #0e1621; --card: #17212b; --text: #ffffff; --border: #2b5278; --accent: #5288c1; --input-bg: #0e1621; }
        html, body { height: 100%; margin: 0; padding: 0; background: var(--bg); color: var(--text); }
        body { display: flex; flex-direction: column; align-items: center; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 15px; box-sizing: border-box; overflow-y: auto; min-height: 100vh; }
        .container { width: 100%; max-width: 420px; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .header-ui { width: 100%; display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .user-badge { background: rgba(82, 136, 193, 0.2); border: 1px solid var(--accent); padding: 8px 12px; border-radius: 15px; font-size: 11px; color: var(--accent); font-weight: bold; text-align: right; line-height: 1.3; }
        .logo { width: 85px; height: 85px; border-radius: 50%; border: 4px solid var(--accent); margin-bottom: 10px; box-shadow: 0 0 15px rgba(82,136,193,0.3); }
        h1 { color: var(--accent); font-size: 22px; margin: 5px 0; font-weight: bold; text-transform: uppercase; }
        .exam-dashboard { background: rgba(82, 136, 193, 0.15); border: 1px solid var(--accent); padding: 12px; border-radius: 15px; width: 100%; margin-bottom: 15px; box-sizing: border-box; }
        .exam-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .exam-item { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 10px; border: 1px solid rgba(82, 136, 193, 0.3); }
        .exam-days { font-size: 16px; font-weight: bold; color: var(--accent); display: block; }
        .exam-label { font-size: 8px; text-transform: uppercase; opacity: 0.9; letter-spacing: 0.5px; margin-top: 2px; display: block; }
        .nav-tabs { display: flex; width: 100%; background: var(--card); border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border); overflow: hidden; }
        .tab-btn { flex: 1; padding: 12px 2px; font-size: 9px; font-weight: bold; cursor: pointer; border: none; background: none; color: white; opacity: 0.5; }
        .tab-btn.active { opacity: 1; background: var(--accent); }
        .tab-content { width: 100%; display: none; }
        .tab-content.active { display: block; }
        .card { background: var(--card); padding: 12px; border-radius: 20px; border: 1px solid var(--border); width: 100%; box-sizing: border-box; margin-bottom: 15px; }
        .setting-label { font-size: 9px; color: #888; text-transform: uppercase; margin: 6px 0 2px 0; display: block; font-weight: bold; text-align: left; }
        input, select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); text-align: center; font-size: 13px; box-sizing: border-box; }
        input[type="date"] { color-scheme: dark; }
        .btn { background: #2481cc; color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; font-size: 14px; }
        .log-table { width: 100%; font-size: 10px; text-align: left; border-collapse: collapse; margin-top: 10px; }
        .log-table th, .log-table td { padding: 8px 4px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .matrix-table { font-size: 8px; width: 100%; border-collapse: collapse; margin-top: 10px; color: #fff; }
        .matrix-table th, .matrix-table td { border: 1px solid var(--border); padding: 4px 2px; text-align: center; }
        .check-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 10px; }
        .check-item { font-size: 8px; text-align: center; }
        .streak-text { font-size: 18px; font-weight: bold; color: #f39c12; }
        #timer-display { font-size: 52px; font-weight: bold; margin: 5px 0; font-variant-numeric: tabular-nums; }
        .danger-zone { margin-top: 30px; padding: 15px; border-top: 1px dashed rgba(255,255,255,0.1); width: 100%; opacity: 0.6; }
        .clear-btn { background: none; border: 1px solid #ef5350; color: #ef5350; padding: 8px; border-radius: 8px; font-size: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="popup-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.96); z-index:2000; justify-content:center; align-items:center; flex-direction: column;">
        <div class="popup-card" id="mcq-popup">
            <h3>Cycle Complete</h3>
            <p>Enter MCQs solved:</p>
            <input type="number" id="cycleMcqs" placeholder="0" style="width:100%;">
            <button class="btn" onclick="startBreak()" style="margin-top:15px; width:100%;">Record & Start Break</button>
        </div>
        <div class="popup-card" id="break-popup" style="display:none;">
            <h3>Break Finished!</h3>
            <button class="btn" onclick="continueNextCycle()" style="background:#2ecc71; width:100%;">Start Next Cycle</button>
            <button class="btn" onclick="stopEntireSession()" style="background:#ef5350; margin-top:10px; width:100%;">End Session</button>
        </div>
    </div>

    <div class="container">
        <div class="header-ui"><div class="user-badge"><span id="uFullName">...</span><span id="uID" style="opacity: 0.7; font-size: 9px;">ID: 0</span></div></div>
        <img src="https://github.com/dhruvathaare/Scaslpel-Study-Squad-Apps/blob/main/photo_2026-02-12_20-08-36.jpg?raw=true" class="logo">
        <h1>Scalpel Study Squad</h1>

        <div class="exam-dashboard">
            <div class="exam-grid">
                <div class="exam-item"><span id="daysIniJuly" class="exam-days">--</span><span class="exam-label">INICET JULY</span></div>
                <div class="exam-item"><span id="daysUpsc" class="exam-days">--</span><span class="exam-label">UPSC CMS</span></div>
                <div class="exam-item"><span id="daysNeet" class="exam-days">--</span><span class="exam-label">NEET PG 2026</span></div>
                <div class="exam-item"><span id="daysIniJan" class="exam-days">--</span><span class="exam-label">INICET JAN '27</span></div>
            </div>
        </div>

        <div class="nav-tabs">
            <div class="tab-btn active" onclick="switchTab('tab-goal', this)">Goal</div>
            <div class="tab-btn" onclick="switchTab('tab-daily', this)">Daily Tracker</div>
            <div class="tab-btn" onclick="switchTab('tab-swt', this)">SWT Analysis</div>
            <div class="tab-btn" onclick="switchTab('tab-gt', this)">GT Analysis</div>
        </div>

        <div id="tab-goal" class="tab-content active">
            <div class="card">
                <span class="setting-label">Target Exams (Permanent)</span>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">
                    <label style="font-size:10px;"><input type="checkbox" class="target-exam" value="NEET"> NEET PG</label>
                    <label style="font-size:10px;"><input type="checkbox" class="target-exam" value="INI_J"> INICET JULY</label>
                    <label style="font-size:10px;"><input type="checkbox" class="target-exam" value="UPSC"> UPSC CMS</label>
                    <label style="font-size:10px;"><input type="checkbox" class="target-exam" value="INI_N"> INICET JAN</label>
                </div>
                <button class="btn" style="padding:5px; font-size:10px; margin-top:10px;" onclick="lockExams()">Lock Targets</button>
            </div>
            <div class="card">
                <h3>Reading Phases</h3>
                <div id="phase-controls"></div>
            </div>
            <div class="card">
                <h3>Reading Medals</h3>
                <div id="reading-medals" style="font-size:24px;"></div>
                <div id="subject-checks" style="text-align:left; margin-top:10px;"></div>
            </div>
        </div>

        <div id="tab-daily" class="tab-content">
            <div class="card">
                <span class="setting-label">Reading Phase</span>
                <select id="readingPhase">
                    <option>First Reading</option>
                    <option>Second Reading</option>
                    <option>Third Reading</option>
                    <option>Extra Bonus Reading</option>
                </select>
                <span class="setting-label">Subject</span>
                <select id="subject"><option value="" disabled selected>Select Subject</option><option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option></select>
                <div style="display:flex; gap:10px; margin-top:8px;">
                    <div style="flex:1;"><input type="number" id="studyHr" value="2"><div style="font-size:8px;">Hours</div></div>
                    <div style="flex:1;"><input type="number" id="studyMin" value="0"><div style="font-size:8px;">Mins</div></div>
                </div>
                <div id="timer-display">00:00:00</div>
                <button id="startBtn" class="btn">Start Session</button>
            </div>
            <div class="card">
                <h3>Reading vs Subject Analytics</h3>
                <div style="overflow-x:auto;"><table class="matrix-table" id="matrixTable"></table></div>
            </div>
        </div>

        <div id="tab-swt" class="tab-content"><div class="card"><h3>SWT Analysis Logic Active</h3></div></div>
        <div id="tab-gt" class="tab-content"><div class="card"><h3>GT Analysis Logic Active</h3></div></div>

        <div class="danger-zone"><button class="clear-btn" onclick="clearData()">Clear All Local Data</button></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        const tgUser = tg.initDataUnsafe?.user || { id: "OFFLINE", first_name: "Local" };
        const prefix = `SSS_GOAL_V1_${tgUser.id}_`;
        const SUBJECTS = ["Anatomy", "Physiology", "Biochemistry", "Pathology", "Microbiology", "Pharmacology", "FMT", "PSM", "Ophthalmology", "ENT", "Medicine", "Surgery", "OBG", "Pediatrics", "Anaesthesia", "Dermatology", "Orthopedics", "Psychiatry", "Radiology"];
        const PHASES = ["First Reading", "Second Reading", "Third Reading", "Extra Bonus Reading"];

        let timerInterval, timeLeft = 0, isPaused = false, mode = "idle";

        // GOAL LOGIC
        function lockExams() {
            const selected = Array.from(document.querySelectorAll('.target-exam:checked')).map(cb => cb.value);
            localStorage.setItem(prefix + 'TARGETS', JSON.stringify(selected));
            tg.showAlert("Target Exams Locked Permanently.");
        }

        function initPhases() {
            const container = document.getElementById('phase-controls');
            let html = '';
            PHASES.forEach(p => {
                const saved = JSON.parse(localStorage.getItem(prefix + p.replace(/ /g,'')) || '{"from":"","to":""}');
                html += `<div style="margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:5px;">
                    <span class="setting-label">${p}</span>
                    <div style="display:flex; gap:5px;">
                        <input type="date" value="${saved.from}" onchange="savePhase('${p}', 'from', this.value)">
                        <input type="date" value="${saved.to}" onchange="savePhase('${p}', 'to', this.value)">
                    </div>
                    <div style="font-size:9px; color:var(--accent); margin-top:2px;">Days: ${calcDays(saved.from, saved.to)}</div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function savePhase(phase, field, val) {
            let key = prefix + phase.replace(/ /g,'');
            let data = JSON.parse(localStorage.getItem(key) || '{"from":"","to":""}');
            data[field] = val;
            localStorage.setItem(key, JSON.stringify(data));
            initPhases();
        }

        function calcDays(f, t) { if(!f || !t) return 0; return Math.ceil((new Date(t) - new Date(f))/(1000*60*60*24)) + 1; }

        function initChecklist() {
            const container = document.getElementById('subject-checks');
            let html = '';
            PHASES.forEach(p => {
                html += `<div style="margin-top:10px;"><b style="font-size:10px;">${p} Progress</b><div class="check-grid">`;
                SUBJECTS.forEach(s => {
                    const checked = localStorage.getItem(prefix + p + s) === 'true' ? 'checked' : '';
                    html += `<div class="check-item"><input type="checkbox" ${checked} onchange="toggleSubject('${p}','${s}', this.checked)"><br>${s.substring(0,4)}</div>`;
                });
                html += `</div></div>`;
            });
            container.innerHTML = html;
            updateMedals();
        }

        function toggleSubject(p, s, val) { localStorage.setItem(prefix + p + s, val); updateMedals(); }

        function updateMedals() {
            const medals = ["ðŸ¥‰", "ðŸ¥ˆ", "ðŸ¥‡", "ðŸ†"];
            let html = '';
            PHASES.forEach((p, i) => {
                const completed = SUBJECTS.every(s => localStorage.getItem(prefix + p + s) === 'true');
                if(completed) html += medals[i];
            });
            document.getElementById('reading-medals').innerHTML = html || '<span style="font-size:10px; opacity:0.5;">Complete readings to earn medals</span>';
        }

        // ANALYTICS TABLE
        function renderMatrix() {
            const table = document.getElementById('matrixTable');
            const logs = JSON.parse(localStorage.getItem(prefix + 'LOGS') || "[]");
            let html = `<tr><th>Subject</th><th>1st</th><th>2nd</th><th>3rd</th><th>Bonus</th></tr>`;
            let totals = [0, 0, 0, 0];
            
            SUBJECTS.forEach(s => {
                html += `<tr><td>${s}</td>`;
                PHASES.forEach((p, pi) => {
                    const sessions = logs.filter(l => l.subject === s && l.phase === p);
                    const days = new Set(sessions.map(l => l.date)).size;
                    html += `<td>${days}</td>`;
                    totals[pi] += days;
                });
                html += `</tr>`;
            });
            html += `<tr style="background:var(--accent); font-weight:bold;"><td>TOTAL</td><td>${totals[0]}</td><td>${totals[1]}</td><td>${totals[2]}</td><td>${totals[3]}</td></tr>`;
            table.innerHTML = html;
        }

        function switchTab(id, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active'); document.getElementById(id).classList.add('active');
            if(id === 'tab-daily') renderMatrix();
        }

        function initWeb() {
            const targets = JSON.parse(localStorage.getItem(prefix + 'TARGETS') || "[]");
            document.querySelectorAll('.target-exam').forEach(cb => { if(targets.includes(cb.value)) cb.checked = true; });
            document.getElementById('uFullName').innerText = tgUser.first_name;
            document.getElementById('uID').innerText = `ID: ${tgUser.id}`;
            initPhases(); initChecklist(); updateCountdowns();
        }

        function updateCountdowns() {
            const now = new Date();
            const dates = { iniJuly: new Date("2026-05-17"), upsc: new Date("2026-08-02"), neet: new Date("2026-08-30"), iniJan: new Date("2026-11-01") };
            Object.keys(dates).forEach(k => {
                const d = Math.ceil((dates[k] - now)/(1000*60*60*24));
                document.getElementById('days' + k.charAt(0).toUpperCase() + k.slice(1)).innerText = d > 0 ? d : "LIVE";
            });
        }

        document.getElementById('startBtn').onclick = () => {
            const s = document.getElementById('subject').value;
            if(!s) return tg.showAlert("Select Subject");
            timeLeft = (parseInt(document.getElementById('studyHr').value)*3600) + (parseInt(document.getElementById('studyMin').value)*60);
            if(timeLeft <= 0) return;
            mode = "study"; isPaused = false;
            document.getElementById('startBtn').style.display='none';
            runTimer();
        };

        function runTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if(!isPaused) {
                    timeLeft--;
                    let h=Math.floor(timeLeft/3600), m=Math.floor((timeLeft%3600)/60), s=timeLeft%60;
                    document.getElementById('timer-display').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                    if(timeLeft <= 0) handleTransition();
                }
            }, 1000);
        }

        function handleTransition() {
            clearInterval(timerInterval);
            document.getElementById('popup-overlay').style.display='flex';
        }

        function startBreak() {
            const mcqs = parseInt(document.getElementById('cycleMcqs').value) || 0;
            const logs = JSON.parse(localStorage.getItem(prefix + 'LOGS') || "[]");
            logs.unshift({
                date: new Date().toLocaleDateString('en-GB'),
                subject: document.getElementById('subject').value,
                phase: document.getElementById('readingPhase').value,
                mcqs: mcqs,
                duration: (parseInt(document.getElementById('studyHr').value)*60) + parseInt(document.getElementById('studyMin').value)
            });
            localStorage.setItem(prefix + 'LOGS', JSON.stringify(logs));
            document.getElementById('popup-overlay').style.display='none';
            tg.showAlert("Session Recorded");
            stopEntireSession();
        }

        function stopEntireSession() {
            clearInterval(timerInterval);
            document.getElementById('timer-display').innerText="00:00:00";
            document.getElementById('startBtn').style.display='block';
            mode = "idle";
        }

        function clearData() { if(confirm("Clear all?")) { localStorage.clear(); location.reload(); } }

        window.onload = initWeb;
    </script>
</body>
</html>

