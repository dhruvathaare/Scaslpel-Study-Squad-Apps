<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scalpel Master Pro V6.30</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0"></script>
    <style>
        /* CSS VARIABLES */
        :root { 
            --bg: #0e1621; 
            --card: #17212b; 
            --text: #ffffff; 
            --border: #2b5278; 
            --accent: #5288c1; 
            --input-bg: #0e1621; 
            --chart-text: #ffffff;
            --chart-grid: #aaaaaa;
            --instruction-bg: rgba(255,255,255,0.05);
            /* Fixed Blue for Tabs */
            --tab-blue: #2481cc;
            --tab-blue-dark: #1a5c96;
        }
        
        [data-theme="light"] {
            --bg: #f2f2f7; 
            --card: #ffffff; 
            --text: #000000; 
            --border: #d1d1d6; 
            --accent: #007aff; 
            --input-bg: #ffffff;
            --chart-text: #000000;
            --chart-grid: #555555;
            --instruction-bg: rgba(0,0,0,0.05);
        }

        html, body { height: 100%; margin: 0; padding: 0; background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s; }
        
        body { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            padding: 15px; 
            box-sizing: border-box; 
            overflow-y: auto !important; 
            -webkit-overflow-scrolling: touch;
            min-height: 100vh;
        }
        
        /* Landscape Mode & Font Scaling */
        .container { width: 100%; max-width: 420px; display: flex; flex-direction: column; align-items: center; text-align: center; transition: max-width 0.3s ease; }
        
        @media (orientation: landscape) {
            .container { max-width: 95%; } 
            .card { width: 100%; padding: 20px; }
            .chart-container { height: 320px; } 
            .matrix-table th, .matrix-table td { white-space: normal; font-size: 11px; }
            /* Increase font sizes to fill gaps */
            body { font-size: 16px; }
            h1 { font-size: 28px !important; }
            .btn { font-size: 16px !important; padding: 18px !important; }
            .streak-text { font-size: 26px !important; }
            .quote { font-size: 16px !important; }
        }

        .header-ui { width: 100%; display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .user-badge { background: rgba(82, 136, 193, 0.2); border: 1px solid var(--accent); padding: 8px 12px; border-radius: 15px; font-size: 11px; color: var(--accent); font-weight: bold; text-align: right; line-height: 1.3; }
        .user-badge span { display: block; }
        .user-id-tag { opacity: 0.7; font-size: 9px; font-family: monospace; }
        
        .status-dot { height: 6px; width: 6px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .status-online { background-color: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .status-offline { background-color: #f39c12; box-shadow: 0 0 5px #f39c12; }

        .logo { width: 85px; height: 85px; border-radius: 50%; border: 4px solid var(--accent); margin-bottom: 10px; box-shadow: 0 0 15px rgba(82,136,193,0.3); }
        h1 { color: var(--accent); font-size: 22px; margin: 5px 0; font-weight: bold; text-transform: uppercase; }
        
        .exam-dashboard { background: rgba(82, 136, 193, 0.15); border: 1px solid var(--accent); padding: 12px; border-radius: 15px; width: 100%; margin-bottom: 15px; box-sizing: border-box; }
        .exam-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .exam-item { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 10px; border: 1px solid rgba(82, 136, 193, 0.3); transition: all 0.3s ease; }
        [data-theme="light"] .exam-item { background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.1); }
        
        .exam-item.target-locked { border: 1px solid #2ecc71; background: rgba(46, 204, 113, 0.2); box-shadow: 0 0 10px rgba(46, 204, 113, 0.3); transform: scale(1.02); }

        .exam-days { font-size: 16px; font-weight: bold; color: var(--accent); display: block; }
        @media (orientation: landscape) { .exam-days { font-size: 20px; } }
        .exam-item.target-locked .exam-days { color: #2ecc71; } 
        
        .exam-label { font-size: 8px; text-transform: uppercase; opacity: 0.9; letter-spacing: 0.5px; margin-top: 2px; display: block; }

        /* MODIFIED STREAK SECTION */
        .streak-section { margin-bottom: 15px; width: 100%; text-align: center; padding: 5px; }
        .streak-text { font-size: 22px; font-weight: 800; color: #f39c12; display: block; }
        .streak-icons-div { font-size: 24px; margin: 5px 0; }
        .quote { font-family: 'Oswald', sans-serif; color: #ef5350; font-weight: 700; font-size: 14px; text-transform: uppercase; margin: 5px 0 20px 0; line-height: 1.4; text-align: center; width: 100%; }

        /* NEW NAV TABS STYLE */
        .nav-tabs { display: flex; width: 100%; gap: 6px; background: transparent; border: none; overflow: visible; align-items: stretch; margin-bottom: 15px; }
        .tab-btn { 
            flex: 1; 
            padding: 12px 2px; 
            font-size: 11px; 
            font-weight: 800; /* BOLD */
            cursor: pointer; 
            border: 1px solid var(--border); 
            background: var(--card); /* Default card bg */
            color: var(--text);
            text-align: center; 
            border-radius: 12px; /* Rounded Squares */
            opacity: 0.8;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        /* PERMANENT BLUE FOR SPECIFIC TABS */
        .tab-btn { 
            background: var(--tab-blue-dark); 
            color: white !important; 
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .tab-btn.active { 
            opacity: 1; 
            background: var(--tab-blue); 
            transform: translateY(-4px); /* Pop up effect */
            box-shadow: 0 6px 12px rgba(36, 129, 204, 0.4);
            border-color: #5ab1f5;
            z-index: 10;
        }
        
        .tab-content { width: 100%; display: none; }
        .tab-content.active { display: block; }
        
        .theme-toggle-tab { flex: 0.7; color: white !important; }

        .card { background: var(--card); padding: 12px; border-radius: 20px; border: 1px solid var(--border); width: 100%; box-sizing: border-box; margin-bottom: 15px; position: relative; }
        /* ACCORDION STYLES - NOW BLUE */
        .accordion-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 5px 0; }
        .accordion-header h3 { margin: 0; font-size: 16px; font-weight: bold; text-transform: uppercase; color: var(--accent) !important; }
        .arrow { transition: transform 0.3s ease; font-size: 12px; opacity: 0.7; }
        .accordion-content { display: none; margin-top: 15px; animation: slideDown 0.3s ease-out; }
        .accordion-content.open { display: block; }
        .accordion-header.active .arrow { transform: rotate(180deg); }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        .setting-label { font-size: 11px; color: #888; text-transform: uppercase; margin: 8px 0 4px 0; display: block; font-weight: bold; text-align: left; }
        .sub-label { font-size: 9px; color: #5288c1; text-transform: uppercase; margin-top: 2px; font-weight: bold; }
        
        /* INPUTS - Increase size for better touch/landscape */
        input, select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); text-align: center; font-size: 14px; font-weight: bold; box-sizing: border-box; appearance: none; -webkit-appearance: none; margin-bottom: 5px; }
        input[type="date"] { color-scheme: dark; }
        [data-theme="light"] input[type="date"] { color-scheme: light; }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: var(--accent); -webkit-appearance: checkbox; appearance: checkbox; }

        #timer-display { font-size: 60px; font-weight: bold; margin: 10px 0; font-variant-numeric: tabular-nums; letter-spacing: 2px; }
        .btn { background: #2481cc; color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; font-size: 14px; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .sm-btn { padding: 8px 12px; font-size: 11px; border-radius: 8px; }

        .log-table { width: 100%; font-size: 11px; text-align: left; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        .log-table th, .log-table td { padding: 10px 5px; border-bottom: 1px solid rgba(128,128,128,0.2); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .col-date { width: 23%; } .col-hrs { width: 15%; } .col-cyc { width: 12%; } .col-mcq { width: 15%; } .col-sub { width: 35%; }

        .goal-row { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(128,128,128,0.1); }
        .phase-block { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border); transition: all 0.3s; }
        [data-theme="light"] .phase-block { background: rgba(0,0,0,0.05); }
        .phase-block.completed { border-color: #2ecc71; background: rgba(46, 204, 113, 0.1); box-shadow: 0 0 15px rgba(46, 204, 113, 0.2); }
        .phase-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .phase-title { font-size: 13px; font-weight: bold; color: var(--accent); }
        .phase-badge { font-size: 24px; filter: grayscale(100%); opacity: 0.3; transition: all 0.5s; }
        .phase-badge.unlocked { filter: grayscale(0%); opacity: 1; transform: scale(1.3); text-shadow: 0 0 10px gold; }
        
        .sub-grid-container { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: rgba(0,0,0,0.2); border-radius: 8px; margin-top: 5px; }
        [data-theme="light"] .sub-grid-container { background: rgba(0,0,0,0.05); }
        .sub-grid-container.open { max-height: 500px; padding: 8px; overflow-y: auto; }
        .sub-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; text-align: left; }
        .sub-check-item { display: flex; align-items: center; gap: 5px; font-size: 12px; color: #aaa; padding: 5px; }

        .pyq-nav-container { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid rgba(128,128,128,0.2); padding-top: 15px; }
        .pyq-tab { background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: #888; padding: 10px 14px; font-size: 11px; border-radius: 8px; cursor: pointer; white-space: nowrap; flex: 1; text-align: center; position: relative; overflow: visible; font-weight: bold; }
        [data-theme="light"] .pyq-tab { background: rgba(0,0,0,0.05); }
        .pyq-tab.active { background: var(--accent); color: white; border-color: var(--accent); font-weight: bold; }
        .pyq-tab-cup { display: none; position: absolute; top: -12px; right: -5px; font-size: 18px; text-shadow: 0 0 10px gold; z-index: 100; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .pyq-tab-cup.show { display: block; }
        .pyq-panel { display: none; animation: fadeIn 0.3s; }
        .pyq-panel.active { display: block; }
        .pyq-list-row { display: flex; align-items: center; justify-content: space-between; background: rgba(128,128,128,0.1); margin-bottom: 5px; padding: 8px; border-radius: 6px; }
        .pyq-col-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .pyq-col-header { font-size: 11px; color: #5288c1; text-transform: uppercase; font-weight: bold; margin-bottom: 8px; border-bottom: 1px dashed rgba(128,128,128,0.3); padding-bottom: 4px; }
        
        .matrix-table { width: 100%; font-size: 10px; border-collapse: collapse; margin-top: 15px; }
        .matrix-table th, .matrix-table td { border: 1px solid rgba(128,128,128,0.2); padding: 6px; text-align: center; }
        .matrix-table th { background: rgba(82, 136, 193, 0.2); color: var(--text); font-weight: bold;}
        .matrix-row-head { text-align: left !important; font-weight: bold; background: rgba(0,0,0,0.2); }
        [data-theme="light"] .matrix-row-head { background: rgba(0,0,0,0.05); }
        .matrix-total { font-weight: bold; color: #f39c12; background: rgba(243, 156, 18, 0.1); }

        .calc-preview { background: rgba(82, 136, 193, 0.1); padding: 10px; border-radius: 10px; margin-top: 8px; font-size: 12px; border: 1px dashed var(--accent); display: flex; justify-content: space-around; align-items: center; font-weight: bold; }
        .chart-container { width: 100%; height: 200px; margin: 15px 0; position: relative; }
        
        .month-navigator { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 10px; padding: 8px; background: rgba(82, 136, 193, 0.1); border-radius: 10px; border: 1px solid var(--border); box-sizing: border-box;}
        .month-nav-btn { background: var(--accent); color: white; border: none; padding: 6px 14px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .month-display { font-family: 'Oswald', sans-serif; font-size: 16px; color: var(--accent); text-transform: uppercase; }

        #popup-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.96); z-index:2000; justify-content:center; align-items:center; flex-direction: column;}
        .popup-card { background: var(--card); padding: 25px; border-radius: 20px; border: 2px solid var(--accent); width: 85%; max-width: 320px; text-align: center; overflow-y: auto; max-height: 80vh; color: var(--text); display: none;}
        
        .danger-zone { margin-top: 30px; padding: 15px; border-top: 1px dashed rgba(128,128,128,0.3); width: 100%; opacity: 0.9; }
        .clear-btn { background: none; border: 1px solid #ef5350; color: #ef5350; padding: 10px; border-radius: 8px; font-size: 12px; cursor: pointer; width: 100%; font-weight: bold; }
        .backup-btn { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 12px; width: 100%; font-weight: bold; margin-bottom: 8px; cursor: pointer;}
        .restore-btn { background: #2ecc71; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 12px; width: 100%; font-weight: bold; cursor: pointer;}

        .strong-weak-container { display: flex; flex-direction: column; gap: 8px; margin: 15px 0; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 10px; text-align: left; }
        [data-theme="light"] .strong-weak-container { background: rgba(0,0,0,0.05); }
        .performance-label { font-family: 'Oswald', sans-serif; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; justify-content: space-between; align-items: center;}
        .stat-strong { color: #2ecc71; } .stat-weak { color: #ef5350; }
        
        .usage-box { margin-top: 15px; padding: 12px; border-radius: 10px; text-align: left; font-size: 11px; line-height: 1.4; border: 1px solid; margin-bottom: 10px; }
        .caution-box { background: rgba(243, 156, 18, 0.15); border-color: #f39c12; color: #f39c12; }
        .freq-box { background: rgba(255, 255, 255, 0.05); border-color: var(--border); color: var(--text); }
        [data-theme="light"] .freq-box { background: rgba(0,0,0,0.05); }
        .usage-title { font-weight: bold; display: block; margin-bottom: 5px; text-transform: uppercase; opacity: 0.9; font-size: 10px; }
        
        .gt-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; text-align: left; font-size: 10px; }
        .gt-stat-box { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px; }
        [data-theme="light"] .gt-stat-box { background: rgba(0,0,0,0.05); }
        .gt-stat-header { opacity: 0.7; margin-bottom: 4px; display: block; text-transform: uppercase; font-size: 9px; }
        .gt-stat-val { font-weight: bold; font-size: 13px; }
        .val-high { color: #2ecc71; } .val-low { color: #ef5350; }
        .phase-stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(128,128,128,0.2); padding: 3px 0; }

        .goal-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0; }
        .goal-input-box { background: rgba(255,255,255,0.05); padding: 6px; border-radius: 6px; text-align: center; position: relative; }
        [data-theme="light"] .goal-input-box { background: rgba(0,0,0,0.05); }
        .goal-input-box input { width: 70%; padding: 4px; font-size: 12px; margin-top: 2px; display: inline-block; }
        .goal-display-box { background: rgba(0,0,0,0.3); padding: 6px; border-radius: 6px; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        [data-theme="light"] .goal-display-box { background: rgba(0,0,0,0.05); }
        .goal-val { font-weight: bold; font-size: 16px; color: var(--accent); }
        .mini-lock-btn { background: none; border: 1px solid var(--border); color: #888; border-radius: 4px; cursor: pointer; padding: 2px 5px; font-size: 10px; position: absolute; right: 4px; top: 18px; }
        .mini-lock-btn.locked { border-color: #2ecc71; color: #2ecc71; pointer-events: none; }
        .save-sub-btn { background: #27ae60; color: white; border: none; padding: 12px; width: 100%; margin-top: 10px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; }

        .subject-breakdown-row { display: grid; grid-template-columns: 1fr 50px 50px 50px; gap: 5px; align-items: center; margin-bottom: 5px; font-size: 10px; }
        .subject-breakdown-header { font-weight: bold; color: var(--accent); margin-bottom: 8px; font-size: 11px; }
        .sb-input { padding: 6px !important; font-size: 11px !important; }

        .instruction-box { background: var(--instruction-bg); padding: 10px; border-radius: 8px; margin-top: 15px; font-size: 11px; color: #888; text-align: left; line-height: 1.5; border-left: 3px solid var(--accent); }

        /* TOUGH SUBJECT ALERT STYLES */
        .tough-dash-title { font-size: 20px; font-weight: 900; color: #ef5350; text-transform: uppercase; margin: 0 0 10px 0; text-align: center; letter-spacing: 1px; }
        
        .alert-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; margin-bottom: 5px; border-radius: 12px; font-size: 12px; font-weight: bold; border: 1px solid transparent; }
        .alert-item span.days { opacity: 0.9; font-size: 11px; }
        .alert-safe { background: rgba(46, 204, 113, 0.1); color: #2ecc71; border-color: #2ecc71; }
        .alert-yellow { background: rgba(241, 196, 15, 0.1); color: #f1c40f; border-color: #f1c40f; }
        .alert-orange { background: rgba(230, 126, 34, 0.1); color: #e67e22; border-color: #e67e22; }
        .alert-red { background: rgba(231, 76, 60, 0.1); color: #e74c3c; border-color: #e74c3c; animation: pulse 2s infinite; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); } 70% { box-shadow: 0 0 0 5px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
    </style>
</head>
<body>
    <div id="popup-overlay">
        <div class="popup-card" id="mcq-popup">
            <h3>Cycle Complete</h3>
            <p>Enter MCQs solved:</p>
            <input type="number" id="cycleMcqs" placeholder="0" style="width:100%;">
            <button class="btn" onclick="startBreak()" style="margin-top:15px; width:100%;">Record & Start Break</button>
        </div>
        <div class="popup-card" id="break-popup">
            <h3>Break Finished!</h3>
            <button class="btn" onclick="continueNextCycle()" style="background:#2ecc71; width:100%;">Start Next Cycle</button>
            <button class="btn" onclick="stopEntireSession()" style="background:#ef5350; margin-top:10px; width:100%;">End Session</button>
        </div>
        <div class="popup-card" id="restore-popup">
            <h3>Restore Data</h3>
            <p style="font-size:11px; color:#aaa; margin-bottom:10px;">Paste the code from your Saved Messages:</p>
            <textarea id="restoreInput" style="width:100%; height:80px; background:var(--input-bg); color:var(--text); border:1px solid var(--border); border-radius:8px; padding:5px; font-size:10px;"></textarea>
            <button class="btn" onclick="processRestore()" style="background:#2ecc71; margin-top:10px; width:100%;">Import Data</button>
            <button class="btn" onclick="closePopup()" style="background:transparent; border:1px solid #888; color:#888; margin-top:5px; width:100%;">Cancel</button>
        </div>
        <div class="popup-card" id="gt-breakdown-popup" style="width: 95%; max-width: 400px;">
            <h3>GT Subject Breakdown</h3>
            <p style="font-size: 10px; color: #888;">Enter Correct/Incorrect/Unattempted per subject</p>
            <div class="subject-breakdown-row subject-breakdown-header">
                <span>Subject</span><span>C</span><span>I</span><span>U</span>
            </div>
            <div id="gt-subject-inputs" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>
            <button class="btn" onclick="finalizeGTSave()" style="background:#2ecc71; width:100%;">Finalize & Save</button>
            <button class="btn" onclick="closePopup()" style="background:transparent; border:1px solid #888; color:#888; margin-top:5px; width:100%;">Cancel</button>
        </div>
    </div>
    <div class="container">
        <div class="header-ui">
            <div class="user-badge">
                <span id="uFullName">...</span>
                <div style="display:flex; align-items:center; justify-content:flex-end; gap:4px;">
                    <span id="statusDot" class="status-dot"></span>
                    <span id="uID" class="user-id-tag">ID: 0</span>
                </div>
            </div>
        </div>
        
        <img src="https://github.com/dhruvathaare/Scaslpel-Study-Squad-Apps/blob/main/photo_2026-02-12_20-08-36.jpg?raw=true" class="logo">
        <h1>Scalpel Study Squad</h1>

        <div class="streak-section">
            <div id="streakText" class="streak-text">Consistency: 0 Days</div>
            <div id="streakIcons" class="streak-icons-div"></div>
            <div style="font-size:11px; color:#888;">üî• per 25 days | ü•á per 75 days</div>
        </div>
        <div class="quote">"I AM HERE TO WIN, CONSISTENCY IS MY KITH AND KIN"</div>

        <div class="exam-dashboard">
            <div class="exam-grid">
                <div class="exam-item" id="dash_ini_jul"><span id="daysIniJuly" class="exam-days">--</span><span class="exam-label">INICET JULY</span></div>
                <div class="exam-item" id="dash_upsc"><span id="daysUpsc" class="exam-days">--</span><span class="exam-label">UPSC CMS</span></div>
                <div class="exam-item" id="dash_neet"><span id="daysNeet" class="exam-days">--</span><span class="exam-label">NEET PG 2026</span></div>
                <div class="exam-item" id="dash_ini_jan"><span id="daysIniJan" class="exam-days">--</span><span class="exam-label">INICET JAN '27</span></div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="tab-btn theme-toggle-tab" onclick="toggleTheme()">
                <span style="font-size:16px; display:block; margin-bottom:2px;">üåó</span>
                <span style="font-size:9px; opacity:0.8;">THEME</span>
            </button>
            <div class="tab-btn" onclick="switchTab('tab-goal', this)">
                <span style="font-size:16px; display:block;">üéØ</span>Goal
            </div>
            <div class="tab-btn active" onclick="switchTab('tab-daily', this)">
                <span style="font-size:16px; display:block;">üìä</span>Daily
            </div>
            <div class="tab-btn" onclick="switchTab('tab-swt', this)">
                <span style="font-size:16px; display:block;">üß†</span>SWT
            </div>
            <div class="tab-btn" onclick="switchTab('tab-gt', this)">
                <span style="font-size:16px; display:block;">üìà</span>GT
            </div>
        </div>

        <div id="tab-goal" class="tab-content">
            <div class="card">
                <div class="accordion-header" onclick="toggleAccordion('acc_exams', this)">
                    <h3>My Target Exams</h3>
                    <span class="arrow">‚ñº</span>
                </div>
                <div id="acc_exams" class="accordion-content">
                    <div class="goal-row"><span>INICET July</span><input type="checkbox" id="goal_ini_jul" onchange="saveGoals()"></div>
                    <div class="goal-row"><span>UPSC CMS</span><input type="checkbox" id="goal_upsc" onchange="saveGoals()"></div>
                    <div class="goal-row"><span>NEET PG 2026</span><input type="checkbox" id="goal_neet" onchange="saveGoals()"></div>
                    <div class="goal-row"><span>INICET Jan '27</span><input type="checkbox" id="goal_ini_jan" onchange="saveGoals()"></div>
                    <button class="btn sm-btn" style="width:100%; margin-top:10px; background:var(--accent); font-weight:bold; font-size:12px; padding:12px;" onclick="lockExamGoals()">Lock & Let's Go!</button>
                </div>
            </div>
            
            <div class="card">
                <div class="accordion-header" onclick="toggleAccordion('acc_tough', this)">
                    <h3>My Tough Subjects</h3>
                    <span class="arrow">‚ñº</span>
                </div>
                <div id="acc_tough" class="accordion-content">
                    <div style="font-size:12px; color:#888; margin-bottom:10px;">Select subjects you want to monitor closely:</div>
                    <div id="tough-subject-selector" class="sub-grid">
                        </div>
                </div>
            </div>

            <div class="card">
                <div class="accordion-header" onclick="toggleAccordion('acc_pyq', this)">
                    <h3>PYQ PAPERS GOAL</h3>
                    <span class="arrow">‚ñº</span>
                </div>
                <div id="acc_pyq" class="accordion-content">
                    <div class="pyq-nav-container">
                        <div class="pyq-tab active" onclick="switchPyq('neet', this)">NEET PG<span id="cup_neet" class="pyq-tab-cup">üèÜ</span></div>
                        <div class="pyq-tab" onclick="switchPyq('ini', this)">INICET<span id="cup_ini" class="pyq-tab-cup">üèÜ</span></div>
                        <div class="pyq-tab" onclick="switchPyq('fmge', this)">FMGE<span id="cup_fmge" class="pyq-tab-cup">üèÜ</span></div>
                        <div class="pyq-tab" onclick="switchPyq('upsc', this)">UPSC<span id="cup_upsc" class="pyq-tab-cup">üèÜ</span></div>
                    </div>
                    <div id="pyq-panels-root"></div>
                </div>
            </div>

            <div class="card">
                <div class="accordion-header" onclick="toggleAccordion('acc_monthly', this)">
                    <h3>Monthly Goals Reached</h3>
                    <span class="arrow">‚ñº</span>
                </div>
                <div id="acc_monthly" class="accordion-content">
                    <div style="overflow-x:auto;">
                        <table class="matrix-table">
                            <thead><tr><th>Month</th><th>MCQs</th><th>SWTs</th><th>GTs</th></tr></thead>
                            <tbody id="monthlyGoalBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="accordion-header" onclick="toggleAccordion('acc_phases', this)">
                    <h3>Reading Phases</h3>
                    <span class="arrow">‚ñº</span>
                </div>
                <div id="acc_phases" class="accordion-content">
                    <div id="goal-phases-container"></div>
                    <div class="instruction-box">
                        <strong>How to use Phases:</strong><br>
                        1. Define start/end dates for each reading.<br>
                        2. Set numerical targets for SWTs and GTs.<br>
                        3. Check off subjects as you complete them.<br>
                        4. Click "Lock" to save your goal.<br>
                        Achieve all targets + all subjects to unlock the trophy!
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-daily" class="tab-content active">
            <div id="tough-dashboard" style="width:100%; margin-bottom:15px;"></div>

            <div class="card">
                <span class="setting-label">Reading Phase</span>
                <select id="studyPhase">
                    <option value="First Reading">First Reading</option>
                    <option value="Second Reading">Second Reading</option>
                    <option value="Third Reading">Third Reading</option>
                    <option value="Extra Bonus">Extra Bonus Reading</option>
                </select>

                <span class="setting-label">Subject</span>
                <select id="subject">
                    <option value="" disabled selected>Select Subject</option>
                    <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option>
                    <option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option><option>Mixed Bag</option><option>Integrated Systems</option>
                </select>
                
                <div style="display:flex; gap:10px; margin-top:8px; text-align:center;">
                    <div style="flex:2;">
                        <span class="setting-label" style="text-align:center;">Study Duration</span>
                        <div style="display:flex; gap:5px;">
                            <div style="flex:1;"><input type="number" id="studyHr" value="2"><div class="sub-label">Hours</div></div>
                            <div style="flex:1;"><input type="number" id="studyMin" value="0"><div class="sub-label">Minutes</div></div>
                        </div>
                    </div>
                    <div style="flex:1;">
                        <span class="setting-label" style="text-align:center;">Break</span>
                        <input type="number" id="breakTime" value="15"><div class="sub-label">Minutes</div>
                    </div>
                </div>

                <div id="timer-display">00:00:00</div>
                <button id="startBtn" class="btn" style="width:100%;">Start Session</button>
                <div id="timer-controls" style="display:none; width:100%;">
                    <div style="display:flex; gap:8px;"><button id="pauseBtn" class="btn" style="background:#f39c12;flex:1;" onclick="togglePause()">Pause</button><button class="btn" style="background:#8e44ad;flex:1;" onclick="handleTransition()">Skip</button></div>
                    <button class="btn" style="background:#ef5350; margin-top:12px; width:100%;" onclick="stopEntireSession()">End Session</button>
                </div>
            </div>
            
            <div class="card">
                <div class="month-navigator">
                    <button class="month-nav-btn" onclick="changeViewMonth(-1)">‚óÄ</button>
                    <div class="month-display" id="currentViewMonthDisplay">MONTH YEAR</div>
                    <button class="month-nav-btn" onclick="changeViewMonth(1)">‚ñ∂</button>
                </div>

                <h3 style="margin:0; color:#f39c12; font-size:16px;">Study Hours Trends</h3>
                <div class="chart-container"><canvas id="hoursChart"></canvas></div>
                <h3 style="margin:10px 0 0 0; color:#5288c1; font-size:16px;">MCQs Solved Trends</h3>
                <div class="chart-container"><canvas id="mcqChart"></canvas></div>
                
                <div style="overflow-x: auto; width: 100%; margin-top: 15px;">
                    <table class="log-table">
                        <thead><tr><th class="col-date">Date</th><th class="col-hrs">Hrs</th><th class="col-cyc">Cyc</th><th class="col-mcq">MCQ</th><th class="col-sub">Subjects</th></tr></thead>
                        <tbody id="dailyLogBody"></tbody>
                    </table>
                </div>

                <h3 style="margin:15px 0 5px 0; color:var(--accent); font-size:14px; border-top:1px solid rgba(128,128,128,0.2); padding-top:10px;">Phase Matrix (Days Spent)</h3>
                <div style="overflow-x:auto;"><table class="matrix-table"><thead><tr><th style="text-align:left;">Subject</th><th>1st</th><th>2nd</th><th>3rd</th><th>Bonus</th></tr></thead><tbody id="matrixBody"></tbody></table></div>

                <h3 style="margin:15px 0 5px 0; color:#2ecc71; font-size:14px; border-top:1px solid rgba(128,128,128,0.2); padding-top:10px;">Phase Matrix (MCQs Solved)</h3>
                <div style="overflow-x:auto;"><table class="matrix-table"><thead><tr><th style="text-align:left;">Subject</th><th>1st</th><th>2nd</th><th>3rd</th><th>Bonus</th></tr></thead><tbody id="mcqMatrixBody"></tbody></table></div>
            </div>
        </div>
        <div id="tab-swt" class="tab-content">
            <div class="card">
                <h3>SWT Analysis</h3>
                <span class="setting-label">Reading Phase</span>
                <select id="swtPhase">
                    <option value="First Reading">First Reading</option>
                    <option value="Second Reading">Second Reading</option>
                    <option value="Third Reading">Third Reading</option>
                    <option value="Extra Bonus">Extra Bonus Reading</option>
                </select>

                <span class="setting-label">Subject</span>
                <select id="swtSubject" onchange="renderSWT()">
                    <option>Anatomy</option><option>Physiology</option><option>Biochemistry</option><option>Pathology</option><option>Microbiology</option><option>Pharmacology</option><option>FMT</option><option>PSM</option><option>Ophthalmology</option><option>ENT</option><option>Medicine</option><option>Surgery</option><option>OBG</option><option>Pediatrics</option><option>Anaesthesia</option><option>Dermatology</option><option>Orthopedics</option><option>Psychiatry</option><option>Radiology</option><option>Mixed Bag</option><option>Integrated Systems</option>
                </select>
                <div style="display:flex; gap:5px; margin-top:8px;"><div style="flex:1.5;"><span class="setting-label">Date</span><input type="date" id="swtDate"></div><div style="flex:1;"><span class="setting-label">Total Qs</span><input type="number" id="swtTotal" oninput="calcSWT()"></div></div>
                <div style="display:flex; gap:5px; margin-top:5px;"><div style="flex:1;"><span class="setting-label">Correct</span><input type="number" id="swtCorrect" oninput="calcSWT()"></div><div style="flex:1;"><span class="setting-label">Unattempted</span><input type="number" id="swtUnat" oninput="calcSWT()"></div></div>
                <div class="calc-preview"><span>Wrong: <b id="swtW">0</b></span><span>Accuracy: <b id="swtP">0%</b></span></div>
                <button class="btn" onclick="saveSWT()" style="background:var(--accent); margin-top:10px; width:100%;">Save Result</button>
                
                <h4 style="margin: 20px 0 5px 0; font-size: 14px; font-weight: bold; opacity: 1;">Subject Trend</h4>
                <div class="chart-container"><canvas id="swtChart"></canvas></div>
                
                <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #3498db; text-transform: uppercase;">SWTs Taken per Phase</h4>
                <div class="chart-container"><canvas id="swtPhaseCountChart"></canvas></div>

                <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #9b59b6; text-transform: uppercase;">Average % per Phase</h4>
                <div class="chart-container"><canvas id="swtPhaseAvgChart"></canvas></div>

                <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #f39c12; text-transform: uppercase;">Cumulative Performance (All Subjects)</h4>
                <div class="chart-container"><canvas id="swtCumulativeChart"></canvas></div>

                <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #2ecc71; text-transform: uppercase;">Total Questions Solved (All Subjects)</h4>
                <div class="chart-container"><canvas id="swtQuestionsChart"></canvas></div>

                <div class="strong-weak-container">
                    <div class="performance-label stat-strong">
                        <span>Strong Subject:</span>
                        <strong id="swtStrong">--</strong>
                    </div>
                    <div class="performance-label stat-weak">
                        <span>Weak Subject:</span>
                        <strong id="swtWeak">--</strong>
                    </div>
                </div>

                <div id="swtUsageAnalysis"></div>
            </div>
        </div>

        <div id="tab-gt" class="tab-content">
            <div class="card">
                <h3>GT Intelligence</h3>
                <div style="display:flex; margin-bottom:10px;"><div class="gt-tab-btn active" id="tabNeet" style="flex:1; padding:10px; text-align:center; background:var(--border); font-size:10px; cursor:pointer;" onclick="switchGT('NEET')">NEET PG (+4/-1)</div><div class="gt-tab-btn" id="tabInicet" style="flex:1; padding:10px; text-align:center; background:rgba(0,0,0,0.2); font-size:10px; cursor:pointer;" onclick="switchGT('INICET')">INICET (+1/-0.33)</div></div>
                
                <span class="setting-label">Reading Phase</span>
                <select id="gtPhase">
                    <option value="First Reading">First Reading</option>
                    <option value="Second Reading">Second Reading</option>
                    <option value="Third Reading">Third Reading</option>
                    <option value="Extra Bonus">Extra Bonus Reading</option>
                </select>

                <div style="margin-bottom: 8px;">
                    <span class="setting-label">Platform (Marrow, Prepladder, etc.)</span>
                    <input type="text" id="gtPlatform" placeholder="Enter Platform Name">
                </div>

                <div style="display:flex; gap:5px;"><div style="flex:1.5;"><span class="setting-label">Date</span><input type="date" id="gtDate"></div><div style="flex:1;"><span class="setting-label">Correct</span><input type="number" id="gtCorrect" oninput="calcGT()"></div><div style="flex:1;"><span class="setting-label">Unattempted</span><input type="number" id="gtUnat" oninput="calcGT()"></div></div>
                <div class="calc-preview"><span>Wrong: <b id="gtW">0</b></span><span>Score: <b id="gtS">0</b></span></div>
                <button class="btn" onclick="openGTBreakdown()" style="background:#2ecc71; margin-top:10px; width:100%;">Save Result & Enter Breakdown</button>
                
                <hr style="border: 0; border-top: 1px solid rgba(128,128,128,0.2); margin: 20px 0;">

                <div id="gt-review-section">
                    <span class="setting-label">Review Past GT Breakdown</span>
                    <select id="gtHistorySelect" onchange="renderGTBreakdownGraph()">
                        <option value="">Select a GT to View Details</option>
                    </select>
                    <div class="chart-container" id="gtBreakdownChartContainer" style="display:none; height: 220px;">
                        <canvas id="gtBreakdownChart"></canvas>
                    </div>
                    <div id="gtSubjectStats" style="display:none; margin-top:10px;"></div>
                </div>

                <div id="neet-area">
                    <h4 style="color:#f39c12; margin-top:25px; font-size:13px;">NEET PG General Progress</h4>
                    <div class="chart-container"><canvas id="gtNeetChart"></canvas></div>
                    
                    <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #3498db; text-transform: uppercase;">GTs Attempted per Phase</h4>
                    <div class="chart-container"><canvas id="gtNeetPhaseCountChart"></canvas></div>

                    <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #9b59b6; text-transform: uppercase;">Average Score per Phase</h4>
                    <div class="chart-container"><canvas id="gtNeetPhaseAvgChart"></canvas></div>

                    <div id="gtNeetStats" style="margin-top:10px;"></div>
                </div>

                <div id="inicet-area" style="display:none;">
                    <h4 style="color:#2ecc71; margin-top:25px; font-size:13px;">INICET General Progress</h4>
                    <div class="chart-container"><canvas id="gtInicetChart"></canvas></div>
                    
                    <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #3498db; text-transform: uppercase;">GTs Attempted per Phase</h4>
                    <div class="chart-container"><canvas id="gtIniPhaseCountChart"></canvas></div>

                    <h4 style="margin: 15px 0 5px 0; font-size: 11px; color: #9b59b6; text-transform: uppercase;">Average Score per Phase</h4>
                    <div class="chart-container"><canvas id="gtIniPhaseAvgChart"></canvas></div>

                    <div id="gtIniStats" style="margin-top:10px;"></div>
                </div>
            </div>
        </div>

        <div class="danger-zone">
            <h3 style="color:#f39c12; margin:0 0 10px 0;">Data Safety</h3>
            <div id="backup-reminder" style="font-weight:bold; margin-bottom:10px; font-size:12px; text-transform:uppercase; letter-spacing:0.5px; text-align: center;"></div>
            <ul style="text-align: left; font-size: 10px; opacity: 0.7; padding-left: 15px; margin-bottom: 10px;">
                <li><strong>Step 1:</strong> Click "Backup Data" below to copy your code.</li>
                <li><strong>Step 2:</strong> Paste the code in your "Saved Messages" on Telegram.</li>
                <li><strong>Step 3:</strong> To restore later, copy that code, click "Restore Data", and paste it.</li>
            </ul>
            <button class="backup-btn" onclick="exportData()">Backup Data (Copy Code)</button>
            <button class="restore-btn" onclick="openRestore()">Restore Data</button>
            <button class="clear-btn" onclick="clearData()" style="margin-top:10px;">Clear All Local Data</button>
        </div>
    </div>
    <script>
        const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
        const tgUser = tg.initDataUnsafe?.user || { id: "OFFLINE", first_name: "Local", last_name: "User" };
        const fullName = `${tgUser.first_name || ""} ${tgUser.last_name || ""}`.trim();
        document.getElementById('uFullName').innerText = fullName || "Guest User";
        document.getElementById('uID').innerText = `ID: ${tgUser.id}`;
        
        const statusDot = document.getElementById('statusDot');
        if (tgUser.id === "OFFLINE") { statusDot.classList.add('status-offline'); } else { statusDot.classList.add('status-online'); }

        const prefix = `SSS_PRO_V3_${tgUser.id}_`;
        const KEYS = { LOGS: prefix+'LOGS', NEET: prefix+'NEET', INI: prefix+'INI', SWT: prefix+'SWT', GOALS: prefix+'GOALS', PYQ: prefix+'PYQ', TOUGH: prefix+'TOUGH' };
        
        const SUBJECTS_19 = ["Anatomy", "Physiology", "Biochemistry", "Pathology", "Microbiology", "Pharmacology", "FMT", "PSM", "Ophthalmology", "ENT", "Medicine", "Surgery", "OBG", "Pediatrics", "Anaesthesia", "Dermatology", "Orthopedics", "Psychiatry", "Radiology"];
        const SUBJECTS_EXTRA = ["Mixed Bag", "Integrated Systems"];
        const ALL_SWT_SUBS = [...SUBJECTS_19, ...SUBJECTS_EXTRA];

        const PHASES_CONFIG = [{ id: 'r1', name: '1. First Reading', badge: 'ü•â' },{ id: 'r2', name: '2. Second Reading', badge: 'ü•à' },{ id: 'r3', name: '3. Third Reading', badge: 'ü•á' },{ id: 'r4', name: '4. Extra Bonus', badge: 'üèÜ' }];
        
        const PYQ_CATS = [
            { id: 'neet', label: 'NEET PG', type: 'list', start: 2025, end: 2020 },
            { id: 'ini', label: 'INICET', type: 'cols', col1: 'May', col2: 'Nov', start: 2025, end: 2014 },
            { id: 'fmge', label: 'FMGE', type: 'cols', col1: 'July', col2: 'Dec', start: 2025, end: 2020 },
            { id: 'upsc', label: 'UPSC CMS', type: 'list', start: 2025, end: 2020 }
        ];

        /* THEME & UI LOGIC */
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', next);
            localStorage.setItem('SSS_THEME', next);
            updateUI(); 
        }
        const savedTheme = localStorage.getItem('SSS_THEME');
        if(savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);

        function getThemeColor(type) {
            const isLight = document.documentElement.getAttribute('data-theme') === 'light';
            if(type === 'text') return isLight ? '#000000' : '#ffffff';
            if(type === 'grid') return isLight ? '#e0e0e0' : 'rgba(255,255,255,0.1)';
            return '#ffffff';
        }

        function toggleAccordion(id, header) {
            const content = document.getElementById(id);
            content.classList.toggle('open');
            header.classList.toggle('active');
        }

        function openPopup(popupId) {
            document.querySelectorAll('.popup-card').forEach(card => card.style.display = 'none');
            document.getElementById(popupId).style.display = 'block';
            document.getElementById('popup-overlay').style.display = 'flex';
        }

        function closePopup() {
            document.getElementById('popup-overlay').style.display = 'none';
            document.querySelectorAll('.popup-card').forEach(card => card.style.display = 'none');
            stopAlarm();
        }

        /* TOUGH SUBJECTS LOGIC */
        function renderToughSubjectsSelector() {
            const saved = JSON.parse(localStorage.getItem(KEYS.TOUGH) || "{}");
            const container = document.getElementById('tough-subject-selector');
            let html = "";
            SUBJECTS_19.forEach(s => {
                const checked = saved[s] ? "checked" : "";
                html += `<label class="sub-check-item"><input type="checkbox" id="tough_${s}" ${checked} onchange="saveToughSubjects()"><span>${s}</span></label>`;
            });
            container.innerHTML = html;
        }

        function saveToughSubjects() {
            const selection = {};
            SUBJECTS_19.forEach(s => {
                const el = document.getElementById(`tough_${s}`);
                if (el && el.checked) selection[s] = true;
            });
            localStorage.setItem(KEYS.TOUGH, JSON.stringify(selection));
            renderToughDashboard();
        }

        function renderToughDashboard() {
            const saved = JSON.parse(localStorage.getItem(KEYS.TOUGH) || "{}");
            const selectedSubjects = Object.keys(saved).filter(k => saved[k]);
            const container = document.getElementById('tough-dashboard');
            if (selectedSubjects.length === 0) { container.innerHTML = ""; return; }
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS) || "[]");
            let html = `<div class="tough-dash-title">Tough Question Tracker</div>`;
            const now = new Date(); now.setHours(0,0,0,0);
            selectedSubjects.forEach(s => {
                let lastDate = null;
                for(let l of logs) {
                    if (l.subject === s) {
                        const parts = l.date.split('/');
                        if(parts.length === 3) {
                            const d = new Date(parts[2], parts[1]-1, parts[0]);
                            if (!lastDate || d > lastDate) lastDate = d;
                        }
                    }
                }
                let statusClass = "alert-red", msg = "Not studied recently!", days = "Never";
                if (lastDate) {
                    const diffTime = Math.abs(now - lastDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    days = `${diffDays} days ago`;
                    if (diffDays <= 10) { statusClass = "alert-safe"; msg = "On Track"; }
                    else if (diffDays <= 20) { statusClass = "alert-yellow"; msg = "Needs Revision"; }
                    else if (diffDays <= 30) { statusClass = "alert-orange"; msg = "Gap Warning"; }
                    else { statusClass = "alert-red"; msg = "Critical Gap"; }
                }
                html += `<div class="alert-item ${statusClass}"><span>${s}</span><span class="days">${msg} (${days})</span></div>`;
            });
            container.innerHTML = html;
        }

        let timerInterval, activeSub = "", activePhase = "", wakeLock = null, timeLeft = 0, mode = "idle", isPaused = false, currentGTMode = "NEET";
        let initialDuration = 0, elapsedDuration = 0, isStudySkipped = false;

        const requestWakeLock = async () => { if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) { console.error(e); } } };
        document.addEventListener('visibilitychange', async () => { if (wakeLock !== null && document.visibilityState === 'visible') { await requestWakeLock(); } });

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep(f, d) { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value = f; g.gain.value = 0.1; o.start(); setTimeout(() => o.stop(), d); }
        let alarmInterval = null;
        function startAlarm(f) { stopAlarm(); alarmInterval = setInterval(() => playBeep(f, 200), 1000); }
        function stopAlarm() { if(alarmInterval) { clearInterval(alarmInterval); alarmInterval = null; } }

        document.getElementById('startBtn').onclick = () => { 
            const s = document.getElementById('subject').value;
            if (!s) { alert("‚ö†Ô∏è Please select a Subject."); return; }
            audioCtx.resume(); requestWakeLock(); activeSub = s; activePhase = document.getElementById('studyPhase').value; startStudyTimer(); 
        };

        function startStudyTimer() { 
            mode = "study"; isPaused = false; isStudySkipped = false;
            let h = parseInt(document.getElementById('studyHr').value) || 0, m = parseInt(document.getElementById('studyMin').value) || 0;
            initialDuration = (h * 3600) + (m * 60); timeLeft = initialDuration;
            if(timeLeft <= 0) return; 
            document.getElementById('startBtn').style.display='none'; document.getElementById('timer-controls').style.display='block'; 
            runTimer(); 
        }
        
        function togglePause() { isPaused = !isPaused; document.getElementById('pauseBtn').innerText = isPaused ? "Resume" : "Pause"; }
        
        function runTimer() { 
            clearInterval(timerInterval); 
            timerInterval = setInterval(() => { 
                if (!isPaused) { 
                    timeLeft--; 
                    let h=Math.floor(timeLeft/3600), m=Math.floor((timeLeft%3600)/60), s=timeLeft%60; 
                    document.getElementById('timer-display').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; 
                    if (timeLeft<=0) handleTransition(); 
                } 
            }, 1000); 
        }

        function handleTransition() { 
            clearInterval(timerInterval); startAlarm(mode==="study"?880:440); 
            if (mode === "study") { elapsedDuration = initialDuration - timeLeft; isStudySkipped = (timeLeft > 5); openPopup('mcq-popup'); } else { openPopup('break-popup'); }
        }

        function startBreak() { 
            stopAlarm(); const m = parseInt(document.getElementById('cycleMcqs').value)||0; 
            saveStudyLog(activeSub, m, Math.floor(elapsedDuration / 60), activePhase, isStudySkipped); 
            document.getElementById('cycleMcqs').value=''; closePopup(); mode="break"; isPaused=false; timeLeft=parseInt(document.getElementById('breakTime').value)*60; runTimer(); 
        }

        function continueNextCycle() { stopAlarm(); closePopup(); startStudyTimer(); }
        function stopEntireSession() { stopAlarm(); clearInterval(timerInterval); if (wakeLock) { wakeLock.release(); wakeLock=null; } closePopup(); document.getElementById('timer-display').innerText="00:00:00"; document.getElementById('startBtn').style.display='block'; document.getElementById('timer-controls').style.display='none'; mode="idle"; updateUI(); }
        function saveStudyLog(s, m, d, ph, skipped) { const logs = JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]"); logs.unshift({ date: new Date().toLocaleDateString('en-GB'), subject: s, mcqs: m, duration: d, phase: ph, skipped: skipped || false }); localStorage.setItem(KEYS.LOGS, JSON.stringify(logs)); }

        let hChart, mChart, gNeetChart, gIniChart, sChart, scuChart, sqChart, swtPhaseCountChart, swtPhaseAvgChart, gtBreakdownChart;
        let currentViewDate = new Date();

        function changeViewMonth(offset) { currentViewDate.setMonth(currentViewDate.getMonth() + offset); updateUI(); }

        function renderData() {
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]");
            const viewMonth = currentViewDate.getMonth(), viewYear = currentViewDate.getFullYear();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('currentViewMonthDisplay').innerText = `${monthNames[viewMonth]} ${viewYear}`;
            const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
            const labels = [], hoursData = Array(daysInMonth).fill(0), mcqsData = Array(daysInMonth).fill(0);
            const tableLogs = [];
            logs.forEach(l => {
                const [d, m, y] = l.date.split('/'); const logDate = new Date(y, m - 1, d);
                if (logDate.getMonth() === viewMonth && logDate.getFullYear() === viewYear) { const dayIdx = parseInt(d) - 1; hoursData[dayIdx] += l.duration / 60; mcqsData[dayIdx] += l.mcqs; tableLogs.push(l); }
            });
            for (let i = 1; i <= daysInMonth; i++) labels.push(i);
            const textColor = getThemeColor('text'), gridColor = getThemeColor('grid');
            if(hChart) hChart.destroy(); hChart = new Chart(document.getElementById('hoursChart'), { type:'line', data:{labels:labels, datasets:[{label:'Hours', data:hoursData, borderColor:'#f39c12', backgroundColor: 'rgba(243, 156, 18, 0.1)', fill: true, tension:0.3}]}, options:{maintainAspectRatio:false, scales:{y:{min:0, max:16, ticks:{color:textColor}, grid:{color:gridColor}}, x:{ticks:{color:textColor, font:{size:9}}, grid:{color:gridColor}}}, plugins:{legend:{display:false}}}});
            if(mChart) mChart.destroy(); mChart = new Chart(document.getElementById('mcqChart'), { type:'line', data:{labels:labels, datasets:[{label:'MCQs', data:mcqsData, borderColor:'#5288c1', backgroundColor: 'rgba(82, 136, 193, 0.1)', fill: true, tension:0.3}]}, options:{maintainAspectRatio:false, scales:{y:{beginAtZero:true, ticks:{color:textColor}, grid:{color:gridColor}}, x:{ticks:{color:textColor, font:{size:9}}, grid:{color:gridColor}}}, plugins:{legend:{display:false}}}});
            let html = ""; const groupedTable = {};
            tableLogs.forEach(l => { if(!groupedTable[l.date]) groupedTable[l.date] = {h:0, m:0, subs:new Set(), cyc:0}; groupedTable[l.date].h += l.duration/60; groupedTable[l.date].m += l.mcqs; groupedTable[l.date].subs.add(l.subject); if (!l.skipped) { groupedTable[l.date].cyc++; } });
            Object.keys(groupedTable).reverse().forEach(d => { html += `<tr><td>${d}</td><td>${groupedTable[d].h.toFixed(1)}h</td><td>${groupedTable[d].cyc}</td><td>${groupedTable[d].m}</td><td>${Array.from(groupedTable[d].subs).join(', ')}</td></tr>`; });
            document.getElementById('dailyLogBody').innerHTML = html || '<tr><td colspan="5">No data for this month</td></tr>';
        }

        function renderMonthlyTable() {
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"], data = Array(12).fill().map(() => ({mcq:0, swt:0, gt:0}));
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]"); logs.forEach(l => { const parts = l.date.split('/'); if(parts.length === 3) { const m = parseInt(parts[1]) - 1; if(m >= 0 && m < 12) data[m].mcq += (parseInt(l.mcqs)||0); } });
            const swts = JSON.parse(localStorage.getItem(KEYS.SWT)||"[]"); swts.forEach(s => { const parts = s.date.split('-'); if(parts.length === 3) { const m = parseInt(parts[1]) - 1; if(m >= 0 && m < 12) data[m].swt++; } });
            const neet = JSON.parse(localStorage.getItem(KEYS.NEET)||"[]"), ini = JSON.parse(localStorage.getItem(KEYS.INI)||"[]");
            [...neet, ...ini].forEach(g => { const parts = g.date.split('-'); if(parts.length === 3) { const m = parseInt(parts[1]) - 1; if(m >= 0 && m < 12) data[m].gt++; } });
            let html = ""; months.forEach((mName, idx) => { const d = data[idx]; if(d.mcq > 0 || d.swt > 0 || d.gt > 0) html += `<tr><td>${mName}</td><td>${d.mcq}</td><td>${d.swt}</td><td>${d.gt}</td></tr>`; });
            document.getElementById('monthlyGoalBody').innerHTML = html;
        }

        function renderMatrix() {
            const logs = JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]"), mapKey = { "First Reading": 0, "Second Reading": 1, "Third Reading": 2, "Extra Bonus": 3 }, dMatrix = {}, mMatrix = {};
            SUBJECTS_19.forEach(s => { dMatrix[s] = [new Set(), new Set(), new Set(), new Set()]; mMatrix[s] = [0, 0, 0, 0]; });
            logs.forEach(l => { const s = l.subject, ph = l.phase || "First Reading", idx = mapKey[ph]; if (dMatrix[s] && idx !== undefined) { dMatrix[s][idx].add(l.date); mMatrix[s][idx] += (parseInt(l.mcqs)||0); } });
            let dHtml = "", mHtml = ""; const dTotals = [0,0,0,0], mTotals = [0,0,0,0];
            SUBJECTS_19.forEach(s => { const days = dMatrix[s].map(set => set.size), mcqs = mMatrix[s]; days.forEach((d, i) => dTotals[i] += d); mcqs.forEach((m, i) => mTotals[i] += m); dHtml += `<tr><td class="matrix-row-head">${s}</td>${days.map(d => `<td>${d||'-'}</td>`).join('')}</tr>`; mHtml += `<tr><td class="matrix-row-head">${s}</td>${mcqs.map(m => `<td>${m||'-'}</td>`).join('')}</tr>`; });
            dHtml += `<tr><td class="matrix-total">TOTAL</td>${dTotals.map(t => `<td class="matrix-total">${t}</td>`).join('')}</tr>`; mHtml += `<tr><td class="matrix-total">TOTAL</td>${mTotals.map(t => `<td class="matrix-total">${t}</td>`).join('')}</tr>`;
            document.getElementById('matrixBody').innerHTML = dHtml; document.getElementById('mcqMatrixBody').innerHTML = mHtml;
        }

        function renderPYQ() {
            const container = document.getElementById('pyq-panels-root'); if(container.innerHTML !== "") return;
            let html = ""; PYQ_CATS.forEach((cat, index) => {
                const activeClass = index === 0 ? "active" : ""; html += `<div id="pyq_panel_${cat.id}" class="pyq-panel ${activeClass}">`;
                if (cat.type === 'list') { for(let y=cat.start; y>=cat.end; y--) html += `<label class="pyq-list-row"><span>${cat.label} ${y}</span><input type="checkbox" id="pyq_${cat.id}_${y}"></label>`; }
                else { html += `<div class="pyq-col-grid"><div><div class="pyq-col-header">${cat.col1}</div>`; for(let y=cat.start; y>=cat.end; y--) html += `<label class="pyq-list-row"><span>${y}</span><input type="checkbox" id="pyq_${cat.id}_y_${cat.col1}_1"></label>`; html += `</div><div><div class="pyq-col-header">${cat.col2}</div>`; for(let y=cat.start; y>=cat.end; y--) html += `<label class="pyq-list-row"><span>${y}</span><input type="checkbox" id="pyq_${cat.id}_y_${cat.col2}_2"></label>`; html += `</div></div>`; }
                html += `<button class="btn sm-btn" style="margin-top:15px; background:var(--accent);" onclick="saveLockPYQ('${cat.id}')">Save & Lock Progress</button></div>`;
            });
            container.innerHTML = html; loadPYQ();
        }

        function switchPyq(id, btn) { document.querySelectorAll('.pyq-tab').forEach(t => t.classList.remove('active')); btn.classList.add('active'); document.querySelectorAll('.pyq-panel').forEach(p => p.classList.remove('active')); document.getElementById(`pyq_panel_${id}`).classList.add('active'); }
        function saveLockPYQ(catId) { const data = JSON.parse(localStorage.getItem(KEYS.PYQ)) || {}, catConfig = PYQ_CATS.find(c => c.id === catId); data[catId] = {}; let allChecked = true; if(catConfig.type === 'list') { for(let y=catConfig.start; y>=catConfig.end; y--) { const isChecked = document.getElementById(`pyq_${catId}_${y}`).checked; data[catId][y] = isChecked; if(!isChecked) allChecked = false; } } else { for(let y=catConfig.start; y>=catConfig.end; y--) { const c1 = document.getElementById(`pyq_${catId}_y_${catConfig.col1}_1`).checked, c2 = document.getElementById(`pyq_${catId}_y_${catConfig.col2}_2`).checked; data[catId][`${y}_1`] = c1; data[catId][`${y}_2`] = c2; if(!c1 || !c2) allChecked = false; } } localStorage.setItem(KEYS.PYQ, JSON.stringify(data)); const cup = document.getElementById(`cup_${catId}`); if(allChecked) { cup.classList.add('show'); alert(`üèÜ All ${catConfig.label} PYQs Completed!`); } else { cup.classList.remove('show'); alert("Progress Saved."); } }
        function loadPYQ() { const data = JSON.parse(localStorage.getItem(KEYS.PYQ)) || {}; PYQ_CATS.forEach(cat => { if(!data[cat.id]) return; let allChecked = true; if(cat.type === 'list') { for(let y=cat.start; y>=cat.end; y--) { const el = document.getElementById(`pyq_${cat.id}_${y}`); if(el) { el.checked = data[cat.id][y] || false; if(!el.checked) allChecked = false; } } } else { for(let y=cat.start; y>=cat.end; y--) { const el1 = document.getElementById(`pyq_${cat.id}_y_${cat.col1}_1`), el2 = document.getElementById(`pyq_${cat.id}_y_${cat.col2}_2`); if(el1) { el1.checked = data[cat.id][`${y}_1`] || false; if(!el1.checked) allChecked = false; } if(el2) { el2.checked = data[cat.id][`${y}_2`] || false; if(!el2.checked) allChecked = false; } } } if(allChecked) document.getElementById(`cup_${cat.id}`).classList.add('show'); }); }
        function lockTarget(phaseIdx, type) { if(!confirm("Lock goal?")) return; const g = JSON.parse(localStorage.getItem(KEYS.GOALS)) || { phases:[] }; if(!g.phases[phaseIdx]) g.phases[phaseIdx] = {}; if(type === 'swt') { g.phases[phaseIdx].tgt_swt = document.getElementById(`tgt_swt_${phaseIdx}`).value; g.phases[phaseIdx].locked_swt = true; } else { g.phases[phaseIdx].tgt_gt = document.getElementById(`tgt_gt_${phaseIdx}`).value; g.phases[phaseIdx].locked_gt = true; } localStorage.setItem(KEYS.GOALS, JSON.stringify(g)); renderGoalHTML(); }
        function saveSubjectProgress(phaseIdx) { if(!confirm(`Lock subject progress?`)) return; const g = JSON.parse(localStorage.getItem(KEYS.GOALS)) || { phases:[] }; if(!g.phases[phaseIdx]) g.phases[phaseIdx] = {s:{}, s_locked:{}}; if(!g.phases[phaseIdx].s_locked) g.phases[phaseIdx].s_locked = {}; SUBJECTS_19.forEach((s, si) => { const el = document.getElementById(`chk_${phaseIdx}_${si}`); if(el && el.checked) { g.phases[phaseIdx].s[si] = true; g.phases[phaseIdx].s_locked[si] = true; } }); localStorage.setItem(KEYS.GOALS, JSON.stringify(g)); renderGoalHTML(); }

        function renderGoalHTML() {
            const container = document.getElementById('goal-phases-container'); container.innerHTML = "";
            const swtData = JSON.parse(localStorage.getItem(KEYS.SWT) || "[]"), nGT = JSON.parse(localStorage.getItem(KEYS.NEET) || "[]"), iGT = JSON.parse(localStorage.getItem(KEYS.INI) || "[]"), allGT = [...nGT, ...iGT];
            PHASES_CONFIG.forEach((p, idx) => {
                const g = JSON.parse(localStorage.getItem(KEYS.GOALS)) || { phases:[] }, pData = g.phases[idx] || {}, pNameMap = { 0: "First Reading", 1: "Second Reading", 2: "Third Reading", 3: "Extra Bonus Reading" }, phaseNameStr = pNameMap[idx];
                let actSWT = 0; swtData.forEach(x => { let ph = x.phase || "First Reading"; if(ph === "Extra Bonus") ph = "Extra Bonus Reading"; if (ph === phaseNameStr) actSWT++; });
                let actGT = 0, maxGT = 0; allGT.forEach(x => { let ph = x.phase || "First Reading"; if(ph === "Extra Bonus") ph = "Extra Bonus Reading"; if (ph === phaseNameStr) { actGT++; if(x.score > maxGT) maxGT = x.score; } });
                const tgtSWT = parseInt(pData.tgt_swt) || 0, tgtGT = parseInt(pData.tgt_gt) || 0;
                let isChamp = false, subsDone = true; if (pData.s_locked) { for(let i=0; i<SUBJECTS_19.length; i++) if(!pData.s_locked[i]) subsDone = false; } else subsDone = false;
                if (subsDone && actSWT >= tgtSWT && actGT >= tgtGT && tgtSWT > 0 && tgtGT > 0) isChamp = true;
                const champClass = isChamp ? 'completed' : '', champBadge = isChamp ? 'üèÜ' : p.badge;
                let subjectsHtml = `<div class="sub-grid">`; SUBJECTS_19.forEach((s, si) => { const isChecked = pData.s ? pData.s[si] : false, isLocked = pData.s_locked ? pData.s_locked[si] : false; subjectsHtml += `<label class="sub-check-item" style="${isLocked ? 'color:#2ecc71; font-weight:bold;' : ''}"><input type="checkbox" id="chk_${idx}_${si}" ${isChecked ? 'checked' : ''} ${isLocked ? 'disabled' : ''} onchange="saveGoals()"><span>${s}</span></label>`; });
                subjectsHtml += `</div>`;
                container.innerHTML += `<div class="phase-block ${champClass}"><div class="phase-header"><span>${p.name}</span><span class="phase-badge">${champBadge}</span></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px"><div><span class="setting-label">From</span><input type="date" id="d_${idx}_f" value="${pData.f||''}" onchange="saveGoals()"></div><div><span class="setting-label">To</span><input type="date" id="d_${idx}_t" value="${pData.t||''}" onchange="saveGoals()"></div></div><div class="goal-stats-grid"><div class="goal-input-box"><span class="setting-label">SWT Goal</span><input type="number" id="tgt_swt_${idx}" value="${pData.tgt_swt || ''}" ${pData.locked_swt ? 'disabled' : ''}><button class="mini-lock-btn ${pData.locked_swt?'locked':''}" onclick="lockTarget(${idx}, 'swt')">üîí</button></div><div class="goal-display-box"><span class="setting-label">Actual</span><span class="goal-val">${actSWT}${actSWT>=tgtSWT&&tgtSWT>0?'‚úÖ':''}</span></div><div class="goal-input-box"><span class="setting-label">GT Goal</span><input type="number" id="tgt_gt_${idx}" value="${pData.tgt_gt || ''}" ${pData.locked_gt ? 'disabled' : ''}><button class="mini-lock-btn ${pData.locked_gt?'locked':''}" onclick="lockTarget(${idx}, 'gt')">üîí</button></div><div class="goal-display-box"><span class="setting-label">Actual</span><span class="goal-val">${actGT}${actGT>=tgtGT&&tgtGT>0?'‚úÖ':''}</span></div></div><button class="btn sm-btn" style="background:rgba(255,255,255,0.1);" onclick="document.getElementById('sg_${idx}').classList.toggle('open')">Subjects ‚ñº</button><div id="sg_${idx}" class="sub-grid-container">${subjectsHtml}<button class="save-sub-btn" onclick="saveSubjectProgress(${idx})">Lock Subjects</button></div></div>`;
            }); 
        }

        function saveGoals() { 
            const g = JSON.parse(localStorage.getItem(KEYS.GOALS)) || { exams:{}, phases:[] };
            const exams = { i_j: document.getElementById('goal_ini_jul').checked, u: document.getElementById('goal_upsc').checked, n: document.getElementById('goal_neet').checked, i_jan: document.getElementById('goal_ini_jan').checked };
            const phases = PHASES_CONFIG.map((_, idx) => { const ex = g.phases[idx] || {}, s = ex.s || {}; SUBJECTS_19.forEach((_, si) => { const el = document.getElementById(`chk_${idx}_${si}`); if(el && !el.disabled) s[si] = el.checked; }); return { ...ex, f: document.getElementById(`d_${idx}_f`).value, t: document.getElementById(`d_${idx}_t`).value, s: s }; });
            localStorage.setItem(KEYS.GOALS, JSON.stringify({ exams, phases })); 
        }

        function lockExamGoals() { saveGoals(); const g = JSON.parse(localStorage.getItem(KEYS.GOALS)), m = { 'i_j': 'dash_ini_jul', 'u': 'dash_upsc', 'n': 'dash_neet', 'i_jan': 'dash_ini_jan' }; Object.keys(m).forEach(k => { const el = document.getElementById(m[k]); if (g.exams[k]) el.classList.add('target-locked'); else el.classList.remove('target-locked'); }); alert("Locked! üöÄ"); }
        function loadGoalsToUI() { const g = JSON.parse(localStorage.getItem(KEYS.GOALS)) || { exams:{}, phases:[] }; document.getElementById('goal_ini_jul').checked = g.exams?.i_j; document.getElementById('goal_upsc').checked = g.exams?.u; document.getElementById('goal_neet').checked = g.exams?.n; document.getElementById('goal_ini_jan').checked = g.exams?.i_jan; if(g.exams) { const m = { 'i_j': 'dash_ini_jul', 'u': 'dash_upsc', 'n': 'dash_neet', 'i_jan': 'dash_ini_jan' }; Object.keys(m).forEach(k => { if (g.exams[k]) document.getElementById(m[k]).classList.add('target-locked'); }); } renderGoalHTML(); }
        function exportData() { localStorage.setItem('SSS_LAST_BACKUP', new Date().toISOString()); renderBackupStatus(); const b = {}; Object.keys(KEYS).forEach(k => b[k] = localStorage.getItem(KEYS[k])); const payload = { owner: tgUser.id, data: b }; const code = btoa(JSON.stringify(payload)); navigator.clipboard.writeText(code).then(() => alert(`Code Copied! Locked to ID: ${tgUser.id}`)); }
        function openRestore() { openPopup('restore-popup'); }
        function processRestore() { try { const raw = JSON.parse(atob(document.getElementById('restoreInput').value)); let d = raw; if (raw.owner) { if (String(raw.owner) !== String(tgUser.id)) { alert(`Access Denied!`); return; } d = raw.data; } Object.keys(d).forEach(k => localStorage.setItem(k, d[k])); localStorage.setItem('SSS_LAST_BACKUP', new Date().toISOString()); alert("Restored!"); location.reload(); } catch(e) { alert("Invalid Code!"); } }
        function switchTab(id, btn) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(id).classList.add('active'); updateUI(); }
        function updateCountdowns() { 
            const now = new Date(), targets = { iniJuly: new Date("2026-05-17"), upsc: new Date("2026-08-02"), neet: new Date("2026-08-30"), iniJan: new Date("2026-11-01") };
            Object.keys(targets).forEach(k => { const diff = Math.ceil((targets[k] - now) / (1000 * 60 * 60 * 24)); const el = document.getElementById('days' + k.charAt(0).toUpperCase() + k.slice(1)); if(el) el.innerText = diff > 0 ? diff : (diff === 0 ? "TODAY" : "DONE"); });
        }
        function updateConsistency() { const logs = JSON.parse(localStorage.getItem(KEYS.LOGS)||"[]"), u = new Set(logs.map(l => l.date)).size; document.getElementById('streakText').innerText = `Consistency: ${u} Days`; document.getElementById('streakIcons').innerText = "ü•á".repeat(Math.floor(u/75)) + "üî•".repeat(Math.floor((u%75)/25)); }
        function clearData() { if(confirm("Clear all?")) { Object.values(KEYS).forEach(k => localStorage.removeItem(k)); location.reload(); } }
        function calcSWT() { const t=parseInt(document.getElementById('swtTotal').value)||0, c=parseInt(document.getElementById('swtCorrect').value)||0, u=parseInt(document.getElementById('swtUnat').value)||0; document.getElementById('swtW').innerText=Math.max(0, t-c-u); document.getElementById('swtP').innerText=t>0?((c/t)*100).toFixed(1)+"%":"0%"; }
        function calcGT() { const c=parseInt(document.getElementById('gtCorrect').value)||0, u=parseInt(document.getElementById('gtUnat').value)||0, w=Math.max(0, 200-c-u); const s=(currentGTMode==='NEET')?(c*4-w):(c-(w*0.333)); document.getElementById('gtW').innerText=w; document.getElementById('gtS').innerText=s.toFixed(2); }
        function saveSWT() { const sub=document.getElementById('swtSubject').value, ph=document.getElementById('swtPhase').value, d=document.getElementById('swtDate').value, t=parseInt(document.getElementById('swtTotal').value); if(!d || isNaN(t)) return; const data = JSON.parse(localStorage.getItem(KEYS.SWT)||"[]"); data.push({ date: d, total: t, correct: parseInt(document.getElementById('swtCorrect').value), unat: parseInt(document.getElementById('swtUnat').value), wrong: Math.max(0, t-parseInt(document.getElementById('swtCorrect').value)-parseInt(document.getElementById('swtUnat').value)), percent: ((parseInt(document.getElementById('swtCorrect').value)/t)*100).toFixed(1), subject: sub, phase: ph }); data.sort((a,b)=>new Date(a.date)-new Date(b.date)); localStorage.setItem(KEYS.SWT, JSON.stringify(data)); updateUI(); }
        function openGTBreakdown() { const ph = document.getElementById('gtPhase').value; const container = document.getElementById('gt-subject-inputs'); container.innerHTML = ""; SUBJECTS_19.forEach(s => { container.innerHTML += `<div class="subject-breakdown-row"><span>${s}</span><input type="number" class="sb-input" id="sb_c_${s}" placeholder="C"><input type="number" class="sb-input" id="sb_w_${s}" placeholder="I"><input type="number" class="sb-input" id="sb_u_${s}" placeholder="U"></div>`; }); openPopup('gt-breakdown-popup'); }
        function finalizeGTSave() { const d=document.getElementById('gtDate').value, c=parseInt(document.getElementById('gtCorrect').value), u=parseInt(document.getElementById('gtUnat').value), ph=document.getElementById('gtPhase').value, plat=document.getElementById('gtPlatform').value || "Unknown", w=Math.max(0,200-c-u), score=(currentGTMode==='NEET'?(c*4-w):(c-w*0.333)), breakdown = {}; SUBJECTS_19.forEach(s => { breakdown[s] = { c: parseInt(document.getElementById(`sb_c_${s}`).value)||0, w: parseInt(document.getElementById(`sb_w_${s}`).value)||0, u: parseInt(document.getElementById(`sb_u_${s}`).value)||0 }; }); const data = JSON.parse(localStorage.getItem(currentGTMode==='NEET'?KEYS.NEET:KEYS.INI)||"[]"); data.push({ id: Date.now(), date: d, platform: plat, score, correct: c, unat: u, wrong: w, phase: ph, breakdown }); data.sort((a,b)=>new Date(a.date)-new Date(b.date)); localStorage.setItem(currentGTMode==='NEET'?KEYS.NEET:KEYS.INI, JSON.stringify(data)); closePopup(); updateUI(); }
        function populateGTHistory() { const data = JSON.parse(localStorage.getItem(currentGTMode==='NEET'?KEYS.NEET:KEYS.INI)||"[]"), select = document.getElementById('gtHistorySelect'); select.innerHTML = '<option value="">Select a GT</option>'; data.reverse().forEach((g, idx) => { select.innerHTML += `<option value="${g.id}">GT ${data.length - idx} (${g.date})</option>`; }); }
        function renderGTBreakdownGraph() { const id = document.getElementById('gtHistorySelect').value; if(!id) { document.getElementById('gtBreakdownChartContainer').style.display='none'; return; } const data = JSON.parse(localStorage.getItem(currentGTMode==='NEET'?KEYS.NEET:KEYS.INI)||"[]"), g = data.find(x => x.id == id); if(!g) return; document.getElementById('gtBreakdownChartContainer').style.display='block'; const yData = SUBJECTS_19.map(s => { const b = g.breakdown[s], t = b.c + b.w + b.u; return t > 0 ? ((b.c/t)*100).toFixed(1) : 0; }); const tc = getThemeColor('text'), gc = getThemeColor('grid'); if(gtBreakdownChart) gtBreakdownChart.destroy(); gtBreakdownChart = new Chart(document.getElementById('gtBreakdownChart'), { type:'line', data:{ labels:SUBJECTS_19, datasets:[{ label:'Acc %', data:yData, borderColor:'#2ecc71', fill:true, tension:0.4 }] }, options:{ maintainAspectRatio:false, scales:{ y:{ min:0, max:100, ticks:{color:tc}, grid:{color:gc} }, x:{ ticks:{color:tc, font:{size:7}, autoSkip:false, maxRotation:90}, grid:{color:gc} } }, plugins:{legend:{display:false}} } }); }
        function switchGT(m) { currentGTMode=m; document.querySelectorAll('.gt-tab-btn').forEach(b=>b.style.background='rgba(0,0,0,0.2)'); document.getElementById(m==='NEET'?'tabNeet':'tabInicet').style.background='var(--border)'; document.getElementById('neet-area').style.display=m==='NEET'?'block':'none'; document.getElementById('inicet-area').style.display=m==='INICET'?'block':'none'; calcGT(); populateGTHistory(); renderGT(); }
        function renderSWT() {
            const all = JSON.parse(localStorage.getItem(KEYS.SWT)||"[]"), sub = document.getElementById('swtSubject').value, f = all.filter(x => x.subject === sub), tc = getThemeColor('text'), gc = getThemeColor('grid');
            if(sChart) sChart.destroy(); if(f.length>0) sChart = new Chart(document.getElementById('swtChart'), { type:'line', data:{labels:f.map(x=>x.date), datasets:[{label:'%', data:f.map(x=>x.percent), borderColor:'#5288c1'}]}, options:{maintainAspectRatio:false, scales:{y:{min:0, max:100, ticks:{color:tc}, grid:{color:gc}}, x:{ticks:{color:tc}, grid:{color:gc}}}}});
            const perf = {}; ALL_SWT_SUBS.forEach(s => perf[s] = {sum:0, count:0, totalQs:0}); all.forEach(l => { if(perf[l.subject]) { perf[l.subject].sum += parseFloat(l.percent); perf[l.subject].count++; perf[l.subject].totalQs += parseInt(l.total); } });
            if(scuChart) scuChart.destroy(); scuChart = new Chart(document.getElementById('swtCumulativeChart'), { type: 'line', data: { labels: ALL_SWT_SUBS, datasets: [{ data: ALL_SWT_SUBS.map(s => perf[s].count > 0 ? (perf[s].sum / perf[s].count).toFixed(1) : null), borderColor: '#f39c12' }] }, options: { maintainAspectRatio: false, scales: { y: { min: 0, max: 100, ticks:{color:tc}, grid:{color:gc} }, x:{ticks:{color:tc, font:{size:7}, maxRotation:90}, grid:{color:gc}} }, plugins:{legend:{display:false}} } });
            let maxA = -1, minA = 101, sS = "--", wS = "--"; Object.keys(perf).forEach(k => { if(perf[k].count > 0) { const a = perf[k].sum / perf[k].count; if(a > maxA) { maxA = a; sS = k; } if(a < minA) { minA = a; wS = k; } } }); document.getElementById('swtStrong').innerText = sS; document.getElementById('swtWeak').innerText = wS;
        }
        function renderGT() {
            const nd = JSON.parse(localStorage.getItem(KEYS.NEET)||"[]"), id = JSON.parse(localStorage.getItem(KEYS.INI)||"[]"), tc = getThemeColor('text'), gc = getThemeColor('grid');
            if(gNeetChart) gNeetChart.destroy(); if(nd.length>0) gNeetChart = new Chart(document.getElementById('gtNeetChart'), { type:'line', data:{labels:nd.map(x=>x.date), datasets:[{data:nd.map(x=>x.score), borderColor:'#f39c12'}]}, options:{maintainAspectRatio:false, scales:{y:{min:0, max:800, ticks:{color:tc}, grid:{color:gc}}, x:{ticks:{color:tc}, grid:{color:gc}}}}});
            if(gIniChart) gIniChart.destroy(); if(id.length>0) gIniChart = new Chart(document.getElementById('gtInicetChart'), { type:'line', data:{labels:id.map(x=>x.date), datasets:[{data:id.map(x=>x.score), borderColor:'#2ecc71'}]}, options:{maintainAspectRatio:false, scales:{y:{min:0, max:200, ticks:{color:tc}, grid:{color:gc}}, x:{ticks:{color:tc}, grid:{color:gc}}}}});
        }
        function renderBackupStatus() {
            const el = document.getElementById('backup-reminder'), last = localStorage.getItem('SSS_LAST_BACKUP');
            if(!last) { el.innerText = "‚ö†Ô∏è NEVER BACKED UP"; el.style.color = "#ef5350"; return; }
            const diff = Math.floor((new Date() - new Date(last)) / (1000 * 60 * 60 * 24));
            el.innerText = diff === 0 ? "‚úÖ BACKED UP TODAY" : `‚ö†Ô∏è LAST BACKUP: ${diff} DAYS AGO`;
            el.style.color = diff > 7 ? "#ef5350" : (diff > 0 ? "#f1c40f" : "#2ecc71");
        }
        function updateUI() { renderBackupStatus(); renderData(); renderSWT(); renderGT(); updateConsistency(); renderMatrix(); renderGoalHTML(); renderPYQ(); updateCountdowns(); renderMonthlyTable(); populateGTHistory(); renderToughSubjectsSelector(); renderToughDashboard(); loadGoalsToUI(); }
        updateUI(); setInterval(updateCountdowns, 60000);
    </script>
</body>
</html>

